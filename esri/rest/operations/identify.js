// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../core/maybe ../../core/sql ../../geometry/support/jsonUtils ../../geometry/support/scaleUtils ../../layers/support/floorFilterUtils ../../layers/support/sublayerUtils".split(" "),function(r,t,D,E,F,A,G){function B(a){const {mapExtent:c,floors:m,width:e,sublayers:f,layerIds:h,layerOption:u,gdbVersion:p}=a;var d=f?.find(b=>null!=b.layer)?.layer?.serviceSublayers;const v="popup"===u;a={};const n=F.getScale({extent:c,width:e,spatialReference:c?.spatialReference}),g=[],q=b=>{const k=
0===n,w=0===b.minScale||n<=b.minScale,x=0===b.maxScale||n>=b.maxScale;b.visible&&(k||w&&x)&&(b.sublayers?b.sublayers.forEach(q):!1!==h?.includes(b.id)&&(!v||b.popupTemplate&&b.popupEnabled)&&g.unshift(b))};f?.forEach(q);if(f&&!g.length)a.layerIds=[];else{d=G.isExportDynamic(g,d,p);var l=g.map(b=>{const k=A.getLayerFloorFilterClause(m,b);return b.toExportImageJSON(k)});if(d)a.dynamicLayers=JSON.stringify(l);else if(f?(d=g.map(({id:b})=>b),h&&(d=d.filter(b=>h.includes(b))),a.layerIds=d):h?.length&&
(a.layerIds=h),d=H(m,g),t.isSome(d)&&d.length){l={};for(const b of d)b.definitionExpression&&(l[b.id]=b.definitionExpression);Object.keys(l).length&&(a.layerDefs=JSON.stringify(l))}}return a}function H(a,c){const m=!!a?.length;c=c.filter(e=>null!=e.definitionExpression||m&&null!=e.floorInfo);return c.length?c.map(e=>{var f=A.getLayerFloorFilterClause(a,e);f=D.sqlAnd(f,e.definitionExpression);return{id:e.id,definitionExpression:t.unwrapOr(f,void 0)}}):null}r.identifyToIdentifyRESTParameters=function(a,
c){const {dpi:m,gdbVersion:e,geometry:f,geometryPrecision:h,height:u,layerOption:p,mapExtent:d,maxAllowableOffset:v,returnFieldName:n,returnGeometry:g,returnUnformattedValues:q,returnZ:l,spatialReference:b,timeExtent:k,tolerance:w,width:x}=a.toJSON(),{dynamicLayers:y,layerDefs:z,layerIds:C}=B(a);c=c&&t.isSome(c.geometry)?c.geometry:null;a={geometryPrecision:h,maxAllowableOffset:v,returnFieldName:n,returnGeometry:g,returnUnformattedValues:q,returnZ:l,tolerance:w};c=c&&c.toJSON()||f;a.imageDisplay=
`${x},${u},${m}`;e&&(a.gdbVersion=e);c&&(delete c.spatialReference,a.geometry=JSON.stringify(c),a.geometryType=E.getJsonType(c));b?a.sr=b.wkid||JSON.stringify(b):c&&c.spatialReference?a.sr=c.spatialReference.wkid||JSON.stringify(c.spatialReference):d&&d.spatialReference&&(a.sr=d.spatialReference.wkid||JSON.stringify(d.spatialReference));a.time=k?[k.start,k.end].join():null;if(d){const {xmin:I,ymin:J,xmax:K,ymax:L}=d;a.mapExtent=`${I},${J},${K},${L}`}z&&(a.layerDefs=z);y&&!z&&(a.dynamicLayers=y);a.layers=
"popup"===p?"visible":p;C&&!y&&(a.layers+=`:${C.join(",")}`);return a};r.toDynamicLayersJSON=B;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});