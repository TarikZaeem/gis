// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Color ../../Graphic ../../symbols ../../core/analysisThemeUtils ../../core/Collection ../../core/deprecate ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/decorators/cast ../../core/arrayUtils ../../core/accessorSupport/decorators/subclass ../../intl/locale ../../layers/GraphicsLayer ../../layers/RouteLayer ../../layers/support/RouteStopSymbols ../../layers/support/RouteSymbols ../../rest/networkService ../../rest/support/RouteParameters ../../rest/support/Stop ../../rest/support/TravelMode ../support/GoTo ../../symbols/SimpleLineSymbol ../../symbols/SimpleMarkerSymbol ../../symbols/PictureMarkerSymbol".split(" "),
function(u,e,I,J,d,K,E,p,x,L,M,N,b,F,v,g,O,ca,P,Q,R,S,T,U,V,G,A,W,X,Y,B,H){function D(h){return"esri.Graphic"===h?.declaredClass}function Z(h){return Array.isArray(h)&&h.length&&D(h[0])}function aa(h){return E.isCollection(h)&&h.length&&D(h.getItemAt(0))}var m;(function(h){h[h.Active=0]="Active";h[h.Complete=1]="Complete";h[h.Failed=2]="Failed";h[h.Idle=3]="Idle";h[h.Suspended=4]="Suspended"})(m||(m={}));const q=N.getLogger("esri.widgets.Directions.DirectionsViewModel");d=function(h){function C(a){a=
h.call(this,a)||this;a._highlightLayer=new R({listMode:"hide",internal:!0});a._highlight=null;a._legacyLayer=null;a._loadPromise=null;a._loadController=null;a._routeController=null;a._serviceDescriptionStatus=m.Idle;a.apiKey=void 0;a.defaultTravelMode=null;a.departureTime="now";a.lastError=null;a.lastRoute=null;a.layer=null;a.maxStops=50;a.routeParameters=new G({directionsLengthUnits:"kilometers",findBestSequence:!1,returnZ:!0,startTime:null,startTimeIsUTC:!0,useTimeWindows:!1});a.serviceDescription=
null;a.view=null;return a}u._inheritsLoose(C,h);var k=C.prototype;k.initialize=function(){this.addHandles([v.on(()=>b.applySome(this.layer,a=>a.stops),"change",()=>{this.clearResults()}),v.watch(()=>this.layer,(a,c)=>{if(b.isSome(a)){for(;2>a.stops.length;)a.stops.add(new A);this._set("defaultTravelMode",null);this.addHandles(v.when(()=>b.isSome(this.serviceDescription)&&b.unwrap(b.unwrap(a.routeInfo)?.analysisSettings)?.travelMode,f=>{this.defaultTravelMode=this._resolveDefaultTravelMode(f)},{once:!0}))}b.isNone(a)&&
(this.layer=this.legacyLayer);b.isSome(c)&&c===this.legacyLayer&&this.view?.map?.remove(c)},v.syncAndInitial),v.watch(()=>this.view?.map,(a,c)=>{this.layer===this.legacyLayer&&(c?.remove(this.layer),a?.add(this.layer));c?.remove(this._highlightLayer);a?.add(this._highlightLayer)},v.initial)])};k.destroy=function(){this.view?.map?.remove(this._highlightLayer);this.layer===this.legacyLayer&&this.view?.map?.remove(this.layer)};k.castStops=function(a){return Z(a)||aa(a)?a.map(c=>A.fromGraphic(c)):a};
k.load=function(){var a=u._asyncToGenerator(function*(){if(b.isSome(this._loadPromise))return this._loadPromise;this._loadPromise=this._load();yield this._loadPromise;this._loadPromise=null});return function(){return a.apply(this,arguments)}}();k.highlight=function(){var a=u._asyncToGenerator(function*(c){this.clearHighlights();this._highlight=(yield this.view.whenLayerView(this.layer)).highlight(c)});return function(c){return a.apply(this,arguments)}}();k.highlightSegment=function(a){p.deprecatedFunction(q,
"highlightSegment",{replacement:"highlight",version:"4.24",warnOnce:!0});const {geometry:c,symbol:f}=a;b.isNone(this.view)||b.isNone(c)||b.isNone(f)||(this.clearHighlights(),a=f.clone(),a.color=new I([0,0,0,.8]),a.width=Math.ceil(a.width/2),a=new J({geometry:c,symbol:a}),this._highlightLayer.add(a))};k.clearHighlights=function(){this._highlightLayer.removeAll();b.isSome(this._highlight)&&(this._highlight.remove(),this._highlight=null)};k.centerAt=function(a){b.isNone(this.view)||(a="esri.rest.support.Stop"===
a?.declaredClass||D(a)?a.geometry:a,b.isNone(a)||this.callGoTo({target:a}))};k.clearResults=function(){this._set("lastRoute",null);this.layer.removeResult()};k.getDirections=function(){var a=u._asyncToGenerator(function*(){const {apiKey:c,departureTime:f,layer:l,state:r}=this;if(b.isNone(l))throw new x("directions-view-model:missing-route-layer","A route layer must be associated with the view model.");l===this.legacyLayer&&p.deprecated(q,"Using the Directions widget or view model without setting `layer` is deprecated.",
{see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-widgets-Directions-DirectionsViewModel.html#layer",version:"4.24",warnOnce:!0});if("unauthenticated"===r||"initializing"===r||"disabled"===r||this._serviceDescriptionStatus===m.Failed)throw new x("directions-view-model:not-loaded","Cannot get directions until view model loads.");this._set("lastError",null);b.isSome(this._routeController)&&(this._routeController.abort(),this._routeController=null);var w="now"===f,n="now"===f?
new Date:f;if(n&&!w){var y=6E4*n.getTimezoneOffset();n.setTime(n.getTime()-y)}const ba=b.isSome(this.view)?this.view.spatialReference:null;y=this.routeParameters.clone();y.set({startTime:n,startTimeIsUTC:w,directionsLanguage:this._directionsLanguage,apiKey:c,outSpatialReference:ba});b.isSome(this.selectedTravelMode)&&(y.travelMode=this.selectedTravelMode);if(2>l.stops.filter(({geometry:t})=>b.isSome(t)).length){var z=new x("directions-view-model:not-enough-stops","Not enough stops for routing");this._set("lastError",
z);throw z;}this._routeController=new AbortController;({signal:w}=this._routeController);n=null;try{n=yield l.solve(y,{signal:w})}catch(t){if(!F.isAbortError(t))throw z=new x("directions-view-model:unable-to-route","Unable to route to these addresses",{error:t}),this._set("lastError",z),this._set("lastRoute",null),z;}finally{this._routeController=null}for(const t of n.stops)b.isNone(t.geometry)&&(t.name=null);l.update(n);this._set("lastRoute",n);this.zoomToRoute();return n});return function(){return a.apply(this,
arguments)}}();k.getCostAttribute=function(a){return(b.unwrap(this.serviceDescription)?.networkDataset.networkAttributes??[]).find(({name:c,usageType:f})=>c===a&&"cost"===f)??null};k.reset=function(){this.clearHighlights();this.clearResults();b.isSome(this.layer)&&(this.layer.removeAll(),this.layer.stops=new E([new A,new A]))};k.save=function(){return this.layer.save()};k.saveAs=function(a,c={}){return this.layer.saveAs(a,c)};k.zoomToRoute=function(){const {view:a,layer:{routeInfo:c}}=this;if(!b.isNone(a)&&
!b.isNone(c)){var {geometry:f}=c;if(!b.isNone(f)){({extent:f}=f);var l=f.width>f.height;f=f.clone().expand(l?2:1);this.callGoTo({target:f})}}};k._getLegacyLayer=function(){const a=K.getAccentColor();return new S({listMode:"hide",defaultSymbols:new U({directionLines:new Y({color:a,width:7,cap:"round",join:"round"}),directionPoints:null,routeInfo:null,stops:new T({break:new B({color:[255,255,255],size:10,outline:{color:[20,89,127],width:2.5}}),first:new B({color:a,size:19,outline:{color:[51,51,51],
width:3}}),last:new H({width:23,height:23,url:`data:image/svg+xml;base64,${btoa(`<svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><path d="M15.15.3C6.9.3.3 6.9.3 15.15S6.9 29.7 15.15 29.7 29.7 23.1 29.7 15.15C29.7 6.9 23.25.3 15.15.3z" fill="#333"/><path d="M15 4.8C9.3 4.8 4.8 9.45 4.8 15c0 5.55 4.65 10.2 10.2 10.2 5.55 0 10.2-4.5 10.2-10.2 0-5.55-4.5-10.2-10.2-10.2z" fill="${a.toHex()}"/><path fill="#333" d="M10.5 10.5h9v9h-9z"/></g></svg>`)}`}),
middle:new B({color:[51,51,51],size:12,outline:{color:a,width:3}}),unlocated:new H({height:18,width:18,url:`data:image/svg+xml;base64,${btoa(`<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M10.1.2C4.6.2.2 4.6.2 10.1s4.4 9.7 9.9 9.7 9.7-4.4 9.7-9.7c0-5.5-4.3-9.9-9.7-9.9z" fill="#333" fill-rule="nonzero"/><path d="M10 2.7c-4.08 0-7.3 3.328-7.3 7.3s3.328 7.3 7.3 7.3 7.3-3.22 7.3-7.3c0-3.972-3.22-7.3-7.3-7.3z" fill="${a.toHex()}" fill-rule="nonzero"/><path d="M11.414 10l5.304-5.303-1.415-1.415L10 8.586 4.697 3.282 3.282 4.697 8.586 10l-5.304 5.303 1.415 1.415L10 11.414l5.303 5.304 1.415-1.415L11.414 10z" fill="#333"/></g></svg>`)}`}),
waypoint:new B({color:[255,255,255],size:10,outline:{color:[20,89,127],width:2.5}})})}),stops:[{},{}]})};k._load=function(){var a=u._asyncToGenerator(function*(){if(!b.isSome(this.serviceDescription)&&!b.isNone(this.layer)){b.isSome(this._loadController)&&(this._loadController.abort(),this._loadController=null);this._loadController=new AbortController;var {signal:c}=this._loadController;try{this._serviceDescriptionStatus=m.Active;const l=yield V.fetchServiceDescription(this.layer.url,this.apiKey,
{signal:c});this._set("serviceDescription",l);this._serviceDescriptionStatus=m.Complete}catch(l){if(F.isAbortError(l))this._serviceDescriptionStatus=m.Idle;else if("identity-manager:user-aborted"===l.name)this._serviceDescriptionStatus=m.Suspended;else{var f=new x("directions-view-model:service-metadata-unavailable","Cannot load route service metadata",{error:l});this._serviceDescriptionStatus=m.Failed;this._set("lastError",f);throw f;}}finally{this._loadController=null}}});return function(){return a.apply(this,
arguments)}}();k._resolveDefaultTravelMode=function(a){if(b.isNone(this.serviceDescription))return null;const {defaultTravelMode:c,supportedTravelModes:f}=this.serviceDescription,l=/^<(?<name>.*)>$/i.exec(a.name)?.groups?.name;if(l){const r=f?.find(({name:w})=>w.toLocaleLowerCase()===l.trim().toLocaleLowerCase());return W.fromJSON({...(r??c).toJSON(),...a.toJSON()})}return f?.find(({name:r})=>r.toLocaleLowerCase()===a.name.toLocaleLowerCase())??c};u._createClass(C,[{key:"_directionsLanguage",get:function(){if(!b.isNone(this.serviceDescription)){var a=
this.serviceDescription.directionsSupportedLanguages;if(a){var c=b.unwrapOr(this.routeParameters.directionsLanguage,Q.getLocale()).slice(0,2);return a.find(f=>f.toLowerCase().slice(0,2)===c)}}}},{key:"impedanceAttribute",get:function(){const a=b.unwrap(this.routeParameters.travelMode)?.impedanceAttributeName??b.unwrap(this.routeParameters.impedanceAttribute)??b.unwrap(this.serviceDescription)?.impedance??null;return this.getCostAttribute(a)}},{key:"legacyLayer",get:function(){b.isNone(this._legacyLayer)&&
(this._legacyLayer=this._getLegacyLayer());return this._legacyLayer}},{key:"routeServiceUrl",get:function(){p.deprecatedProperty(q,"routeServiceUrl",{replacement:"layer.url",version:"4.24",warnOnce:!0});return this.legacyLayer.url},set:function(a){p.deprecatedProperty(q,"routeServiceUrl",{replacement:"layer.url",version:"4.24",warnOnce:!0});this.legacyLayer.url=a}},{key:"routeSymbol",get:function(){p.deprecatedProperty(q,"routeSymbol",{replacement:"layer.defaultSymbols.directionLines",version:"4.24",
warnOnce:!0});return this.legacyLayer.defaultSymbols.directionLines},set:function(a){p.deprecatedProperty(q,"routeSymbol",{replacement:"layer.defaultSymbols.directionLines",version:"4.24",warnOnce:!0});this.legacyLayer.defaultSymbols.directionLines=a}},{key:"selectedTravelMode",get:function(){return b.isNone(this.serviceDescription)?null:this.defaultTravelMode??this.serviceDescription.defaultTravelMode??this.serviceDescription.supportedTravelModes?.[0]??null},set:function(a){this._override("selectedTravelMode",
a)}},{key:"state",get:function(){if(b.isSome(this._routeController))return"routing";if(b.isSome(this.lastError))return"error";switch(this._serviceDescriptionStatus){case m.Suspended:return"unauthenticated";case m.Idle:return"disabled";case m.Active:return"initializing";case m.Failed:return"error";default:return"ready"}}},{key:"stops",get:function(){p.deprecatedProperty(q,"stops",{replacement:"layer.stops",version:"4.24",warnOnce:!0});return this.legacyLayer.stops},set:function(a){p.deprecatedProperty(q,
"stops",{replacement:"layer.stops",version:"4.24",warnOnce:!0});this.legacyLayer.stops=a}},{key:"stopSymbols",get:function(){p.deprecatedProperty(q,"stopSymbols",{replacement:"layer.defaultSymbols.stops",version:"4.24",warnOnce:!0});return this.legacyLayer.defaultSymbols.stops},set:function(a){p.deprecatedProperty(q,"stopSymbols",{replacement:"layer.defaultSymbols.stops",version:"4.24",warnOnce:!0});this.legacyLayer.defaultSymbols.stops=a}},{key:"timeAttribute",get:function(){const a=b.unwrap(this.routeParameters.travelMode)?.timeAttributeName??
b.unwrap(this.routeParameters.directionsTimeAttribute)??b.unwrap(this.serviceDescription)?.directionsTimeAttribute??null;return this.getCostAttribute(a)}},{key:"travelModes",get:function(){const a=b.unwrap(this.serviceDescription)?.supportedTravelModes?.slice()??[];b.isSome(this.defaultTravelMode)&&!a.includes(this.defaultTravelMode)&&a.unshift(this.defaultTravelMode);return a}}]);return C}(M.HandleOwnerMixin(X.GoToMixin(L.EventedAccessor)));e.__decorate([g.property()],d.prototype,"_directionsLanguage",
null);e.__decorate([g.property()],d.prototype,"_routeController",void 0);e.__decorate([g.property()],d.prototype,"_serviceDescriptionStatus",void 0);e.__decorate([g.property()],d.prototype,"apiKey",void 0);e.__decorate([g.property()],d.prototype,"defaultTravelMode",void 0);e.__decorate([g.property()],d.prototype,"departureTime",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"impedanceAttribute",null);e.__decorate([g.property()],d.prototype,"lastError",void 0);e.__decorate([g.property({readOnly:!0})],
d.prototype,"lastRoute",void 0);e.__decorate([g.property()],d.prototype,"layer",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"legacyLayer",null);e.__decorate([g.property({type:Number,range:{min:2,max:50},nonNullable:!0})],d.prototype,"maxStops",void 0);e.__decorate([g.property({type:G,nonNullable:!0})],d.prototype,"routeParameters",void 0);e.__decorate([g.property()],d.prototype,"routeServiceUrl",null);e.__decorate([g.property()],d.prototype,"routeSymbol",null);e.__decorate([g.property()],
d.prototype,"selectedTravelMode",null);e.__decorate([g.property({readOnly:!0})],d.prototype,"serviceDescription",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"state",null);e.__decorate([g.property()],d.prototype,"stops",null);e.__decorate([O.cast("stops")],d.prototype,"castStops",null);e.__decorate([g.property()],d.prototype,"stopSymbols",null);e.__decorate([g.property({readOnly:!0})],d.prototype,"timeAttribute",null);e.__decorate([g.property()],d.prototype,"travelModes",null);e.__decorate([g.property()],
d.prototype,"view",void 0);e.__decorate([g.property()],d.prototype,"getDirections",null);e.__decorate([g.property()],d.prototype,"zoomToRoute",null);return d=e.__decorate([P.subclass("esri.widgets.Directions.DirectionsViewModel")],d)});