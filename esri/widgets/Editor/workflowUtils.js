// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("require exports ../../chunks/_rollupPluginBabelHelpers ../../Graphic ../../core/has ../../core/handleUtils ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/screenUtils ../../core/accessorSupport/diffUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/lengthUtils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../symbols/support/symbolConversion ../../symbols/support/symbolUtils ../../views/3d/layers/graphics/GraphicState ../../views/support/drapedUtils ../../views/support/hitTestSelectUtils".split(" "),
function(Y,q,p,ia,za,ja,n,w,B,F,ka,la,ma,Z,aa,na,G,oa,pa,H){function ba(b){const a=b.sourceLayer;var c;if(!(c=!a||"feature"!==a.type)){a:switch(a.renderer?.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":case "pie-chart":c=!0;break a;default:c=!1}c=!c}if(c)return{rotation:null,size:null};let d=c=null;var g=a.renderer.getVisualVariablesForType("rotation").filter(k=>(!k.axis||"heading"===k.axis)&&k.field&&!k.valueExpression&&n.isSome(aa.getRotationAngle(k,
b)));1===g.length&&(c=qa(g[0],a));g=a.renderer.getVisualVariablesForType("size").filter(k=>k.field&&!k.useSymbolValue&&!k.valueExpression&&Z.getTransformationType(k)===Z.TransformationType.RealWorldSize&&n.isSome(aa.getSize(k,b)));1===g.length&&(d=ra(g[0],a));return{rotation:c,size:d}}function qa(b,a){const c="heading"===(b.axis||"heading")&&"arithmetic"===b.rotationType?-1:1,d=b.field,g=(a=a.fields&&a.fields.filter(f=>f.name===d))&&1===a.length?a[0].type:"double";var k=0,e=0;return{field:d,fieldType:g,
getDefault:()=>Promise.resolve(0),getValue:f=>{e=k-c*f;return I((e+360)%360,g)},initValue:f=>{k=null!=f?f:e;e=0},isUpdatingInteractively:!1,rotationType:b.rotationType??"geographic"}}function sa(b,a){switch(a){case "width":return b[0];case "depth":return b[1];case "height":return b[2];default:return b[2]||b[1]||b[0]}}function ta(b,a,c){return J.apply(this,arguments)}function J(){J=p._asyncToGenerator(function*(b,a,c){if(n.isNone(a))return 0;({symbol:a}=na.to3D(a));if(n.isNone(a)||"web-style"===a.type||
"cim"===a.type)return 0;a=a.symbolLayers.getItemAt(0);if(!a)return 0;switch(a.type){case "icon":return{computeIconLayerResourceSize:c}=yield new Promise((g,k)=>Y(["../../symbols/support/symbolLayerUtils"],g,k)),a.size||Math.min(v.icon,(yield c(a,v.icon))[0])||v.icon;case "text":return a.size||v.text;case "line":return a.size||v.line;case "object":const {computeObjectLayerResourceSize:d}=yield new Promise((g,k)=>Y(["../../symbols/support/symbolLayerUtils"],g,k));b=yield d(a,b.scale/v.viewScaleSizeFactor);
return sa(b,c);case "path":return(null!=a.width?a.width:a.height)||b.scale/v.viewScaleSizeFactor;case "extrude":return a.size||b.scale/v.viewScaleSizeFactor;case "fill":case "water":return 0;default:return 0}});return J.apply(this,arguments)}function ra(b,a){const c=b.field,d=b.axis,g=(a=a.fields&&a.fields.filter(h=>h.name===c))&&1===a.length?a[0].type:"double";var k=0,e=0;const f=ma.meterIn[b.valueUnit]??1;let l;l="area"===b.valueRepresentation?h=>(h*f/2)**2*Math.PI:"radius"===b.valueRepresentation||
"distance"===b.valueRepresentation?h=>h*f/2:h=>h*f;return{field:c,fieldType:g,getDefault:function(){var h=p._asyncToGenerator(function*(m,t){return I(l(yield ta(t,m,d)),g)});return function(m,t){return h.apply(this,arguments)}}(),getValue:(h,m)=>{k||(k=m.pixelSizeAt(m.center));e=k*h;return I(e,g)},initValue:h=>{k=null!=h?h:e;e=0},isUpdatingInteractively:!1,displayUnit:ca(b.valueUnit),axis:b.axis}}function I(b,a){switch(a){case "small-integer":case "integer":case "long":return Math.round(b);case "double":case "single":return b;
default:return 0}}function x(b,a){return K.apply(this,arguments)}function K(){K=p._asyncToGenerator(function*(b,a){a=yield G.getDisplayedSymbol(b,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:a});const c=ka.diff(b.symbol,a);n.isSome(c)&&(b.symbol=a)});return K.apply(this,arguments)}function L(){L=p._asyncToGenerator(function*(b,a,c,d){yield M(b,a,d);const g=b.on("create",function(){var k=p._asyncToGenerator(function*(e){if("cancel"===e.state)return M(b,a,d);"complete"===e.state&&(e=e.graphic,
e.sourceLayer||(e.sourceLayer=a.layer),e.attributes||(e.attributes={...a.template.prototype.attributes}),yield x(e,d),c(e))});return function(e){return k.apply(this,arguments)}}());return{remove:()=>{g.remove();b.cancel()}}});return L.apply(this,arguments)}function M(b,a,c){return N.apply(this,arguments)}function N(){N=p._asyncToGenerator(function*(b,a,c){var d=a.layer;a={...a.template.prototype.attributes};yield ua(b,d,a,c);c={graphicProperties:{attributes:a,sourceLayer:d},hasZ:d.capabilities.data.supportsZ};
b.layer.elevationInfo=d.elevationInfo;a=b.create;d=d.geometryType;if(!d)throw Error("no geometry type");if("mesh"===d||"multipatch"===d)throw Error("Mesh and Multipatch not supported");return a.call(b,d,c)});return N.apply(this,arguments)}function ua(b,a,c,d){return O.apply(this,arguments)}function O(){O=p._asyncToGenerator(function*(b,a,c,d){a=new ia({sourceLayer:a,attributes:c});const {rotation:g,size:k}=ba(a);let e=yield G.getDisplayedSymbol(a,{useSourceLayer:!0,webStyleCache:d}),f=!1;for(const l of[k,
g])n.isNone(l)||null!=c[l.field]||(c[l.field]=yield l.getDefault(e,b.view),f=!0);f&&(e=yield G.getDisplayedSymbol(a,{useSourceLayer:!0,webStyleCache:d}));switch(e?.type){case "simple-fill":case "polygon-3d":b.polygonSymbol=e;break;case "simple-line":case "line-3d":b.polylineSymbol=e;break;case "simple-marker":case "picture-marker":case "point-3d":case "cim":b.pointSymbol=e}da(b.tooltipOptions,k,g)});return O.apply(this,arguments)}function da(b,a,c){n.isSome(a)||n.isSome(c)?b.visualVariables={size:n.isSome(a)?
{unit:a.displayUnit,axis:a.axis,valueType:a.fieldType}:null,rotation:n.isSome(c)?{valueType:c.fieldType,rotationType:c.rotationType??"geographic"}:null}:b.visualVariables=null}function va(b,a,c,d){return P.apply(this,arguments)}function P(){P=p._asyncToGenerator(function*(b,a,c,d){if(0===b.length)return[];const {updatable:g,graphicsByLayer:k}=yield c.async(p._asyncToGenerator(function*(){var {results:e}=yield w.whenOrAbort(H.hitTestSelectSimilarDistance(a,c),d);const f=new Map;H.filterGraphicHits(e).forEach(({graphic:l})=>
{var h=l.layer;var m=f.get(h);m?h=m:(m=[],f.set(h,m),h=m);return h.push(l)});e=b.filter(({supports:l,layer:h})=>l.includes("update")&&f.has(h));0!==e.length&&c.stopPropagation();return{updatable:e,graphicsByLayer:f}}));return w.whenOrAbort(w.eachAlways(g.map(function(){var e=p._asyncToGenerator(function*({layer:f}){var {objectIdField:l}=f,h="displayField"in f?f.displayField:null;const m=[l];null!=h&&f.fieldsIndex.has(h)&&m.push(h);l=k.get(f);return l.some(t=>m.some(A=>!(A in t.attributes)))?(h=f.createQuery(),
h.outFields=m,h.returnGeometry=!1,h.objectIds=l.map(t=>t.getObjectId()),f.queryFeatures(h,{signal:d}).then(({features:t})=>t)):l});return function(f){return e.apply(this,arguments)}}())),d)});return P.apply(this,arguments)}function wa(b,a,c,d){return Q.apply(this,arguments)}function Q(){Q=p._asyncToGenerator(function*(b,a,c,d){if(0===b.length)return[];let g=null;const k=yield c.async(p._asyncToGenerator(function*(){var {results:e}=yield w.whenOrAbort(a.hitTest(c),d);if(0===e.length)return[];const f=
new Set;g=H.filterGraphicHits(e);g.forEach(({graphic:l})=>l&&f.add(l.layer));e=b.items.filter(({layer:l,supports:h,attachmentsOnUpdateEnabled:m})=>f.has(l)&&(h.includes("update")||h.includes("delete")||m));0<e.length&&c.stopPropagation();return e}));return w.whenOrAbort(w.eachAlways(k.map(({layer:e})=>{var f="displayField"in e?e.displayField:null,l=[e.objectIdField];null!=f&&e.fieldsIndex.has(f)&&l.push(f);f=e.createQuery();f.outFields=l;f.returnGeometry=!1;l="renderer"in e?la.calculateTolerance({renderer:e.renderer,
event:c}):0;f.geometry=pa.createQueryGeometry(c.mapPoint,l,a);f.outSpatialReference=a.spatialReference;return e.queryFeatures(f,{signal:d}).then(({features:h})=>{g?.forEach(({graphic:m})=>{m.layer!==e||h.some(t=>t.getObjectId()===m.getObjectId())||h.push(m)});return h})})),d)});return Q.apply(this,arguments)}function R(){R=p._asyncToGenerator(function*(b,a,c,d){switch(a.type){case "3d":return va(b,a,c,d);case "2d":return wa(b,a,c,d)}});return R.apply(this,arguments)}function S(){S=p._asyncToGenerator(function*(b,
a,c){const {sourceLayer:d}=b,g=d.createQuery();g.objectIds=[b.getAttribute(d.objectIdField)];g.outFields=["*"];g.outSpatialReference=a.spatialReference;g.returnM=d.capabilities.data.supportsM;g.returnZ=d.capabilities.data.supportsZ;return(yield d.queryFeatures(g,{signal:c})).features[0]});return S.apply(this,arguments)}function T(b,a,c,d,g){return U.apply(this,arguments)}function U(){U=p._asyncToGenerator(function*(b,a,c,d,g){let k=!1;const {rotation:e,size:f}=d;[e,f].forEach(function(){var l=p._asyncToGenerator(function*(h){if(!n.isNone(h)){var m=
a.attributes[h.field];n.isSome(m)?h.initValue(m):(m=yield h.getDefault(a.symbol,b.view),h.initValue(m),a.setAttribute(h.field,m),k=!0)}});return function(h){return l.apply(this,arguments)}}());k&&(yield x(a,g));d={multipleSelectionEnabled:!1};"point"===c.geometryType&&(d.enableRotation=n.isSome(e),d.enableScaling=n.isSome(f));da(b.tooltipOptions,f,e);b.layer.elevationInfo=c.elevationInfo;return b.update(a,d)});return U.apply(this,arguments)}function ea(b,a,c,d,g){return V.apply(this,arguments)}function V(){V=
p._asyncToGenerator(function*(b,a,c,d,g){if(n.isSome(a.geometry)&&"point"===a.geometry?.type){var k=d.rotation;var e=c.toolEventInfo;e=!n.isSome(e)||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e;if(n.isSome(k)&&n.isSome(e))if("rotate-stop"===e.type)k.isUpdatingInteractively=!1,k.initValue();else{k.isUpdatingInteractively=!0;const {field:f,getValue:l}=k;a.attributes[f]=l(e.angle,b)}d=d.size;c=c.toolEventInfo;c=!n.isSome(c)||"scale-start"!==c.type&&"scale"!==c.type&&"scale-stop"!==
c.type?null:c;if(n.isSome(d)&&n.isSome(c))if("scale-stop"===c.type)d.isUpdatingInteractively=!1,d.initValue();else{d.isUpdatingInteractively=!0;const {field:f,getValue:l}=d;a.attributes[f]=l(c.xScale,b)}yield x(a,g)}});return V.apply(this,arguments)}function W(){W=p._asyncToGenerator(function*(b,a,c,d,g,k){const e=b.clone();yield x(e,k);d.map.add(c.layer);c.layer.add(e);const f=b.sourceLayer,l=X(d,f),h=()=>{const u=b.attributes[b.layer.objectIdField];l.then(r=>r.setVisibility?.(u,!1),()=>{});return{remove(){l.then(r=>
r.setVisibility?.(u,!0),()=>{})}}};let m=null,t=null;if("3d"===d.type){const u=new oa.GraphicState({graphic:e});m=ja.handlesGroup([d.trackGraphicState(u),B.watch(()=>u.displaying,r=>{t=r?h():n.removeMaybe(t)},B.initial)])}else t=h();yield T(c,e,f,a,k);let A=null;l.then(u=>A=u,()=>{});const C=a.size,D=a.rotation,fa=B.watch(()=>b.attributes,function(){var u=p._asyncToGenerator(function*(r){let y=!1;for(const z in r){const E=r[z];E!==e.attributes[z]&&(e.setAttribute(z,E),n.isSome(C)&&!C.isUpdatingInteractively&&
C.field===z&&C.initValue(E),n.isSome(D)&&!D.isUpdatingInteractively&&D.field===z&&D.initValue(E),n.isNone(A)||A.requiredFields.includes(z))&&(y=!0)}y&&(yield x(e,k))});return function(r){return u.apply(this,arguments)}}()),xa=c.on("update",function(){var u=p._asyncToGenerator(function*(r){const y=r.graphics[0];if("complete"===r.state)return T(c,y,f,a,k);yield ea(d,y,r,a,k);g(y.clone(),r)});return function(r){return u.apply(this,arguments)}}()),ya=c.on(["undo","redo"],function(){var u=p._asyncToGenerator(function*(r){g(r.graphics[0].clone(),
r)});return function(r){return u.apply(this,arguments)}}()),ha=()=>{};return{interactive:{remove(){ya.remove();xa.remove();c.cancel();fa&&fa.remove();this.remove=ha}},visual:{remove(){n.removeMaybe(t);X(d,f).then(u=>B.whenOnce(()=>!u.updating)).then(()=>{n.removeMaybe(m);c.layer.remove(e);this.remove=ha})}}}});return W.apply(this,arguments)}function ca(b){switch(b){case "unknown":case "decimal-degrees":return null;default:return b}}const v={icon:F.px2pt(24),text:F.px2pt(12),line:F.px2pt(1),viewScaleSizeFactor:100},
X=(b,a)=>b.whenLayerView("subtype-sublayer"===a.type?a.parent:a);q.avoidFeatureTemplateSelectionWithOnlyOneItem=function(b,a){b.viewModel.refreshCreationTemplates();if("awaiting-feature-creation-info"===a[0].id){var c=b.viewModel.featureTemplatesViewModel.items;1!==c.length?c=null:(c=c[0],c="items"in c?1===c.items.length?c.items[0]:null:c);n.isSome(c)&&(b.creationInfo=c,a.shift())}return a};q.createWorkflowSteps=function(b,a,c){let d=!1;return b.filter(g=>d?!0:d=g===a).map(g=>c[g]())};q.fetchCandidates=
function(b,a,c,d){return R.apply(this,arguments)};q.fetchFullFeature=function(b,a,c){return S.apply(this,arguments)};q.findLayerInfo=function(b,a){return b?b.find(c=>c.layer===a):void 0};q.getVisualVariableAttributes=ba;q.isTerminalUpdateEventType=b=>/-stop/.test(b)||/vertex-/.test(b);q.prepareAttachmentsForCreateWorkflow=function(b){b.set({abilities:{editing:!0,operations:{add:!0,update:!0,delete:!0}},filesEnabled:!0,mode:"view"})};q.setUpFeatureAdd=function(b,a,c,d){return L.apply(this,arguments)};
q.setUpGeometryUpdate=function(b,a,c,d,g,k){return W.apply(this,arguments)};q.shouldShowAttachmentsForCreateWorkflow=function(b){const {creationInfo:{layer:a},viewModel:c}=b;if(b=c.editableItems.find(g=>g.layer===a))return b.attachmentsOnCreateEnabled;b=a.capabilities?.data;const d=c.layerInfos?.find(g=>g.layer===a);return!(!(b&&"supportsAttachment"in b&&b.supportsAttachment)||d&&(!1===d.allowAttachments||!1===d.attachmentsOnUpdateEnabled))};q.sizeDefaults=v;q.sizeVariableUnitToLengthUnit=ca;q.startCreatingNewFeature=
M;q.startUpdatingFeature=T;q.updateGraphicSymbolWhenRequired=x;q.visualVariableInteractiveUpdate=ea;q.whenEditorLayerView=X;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});