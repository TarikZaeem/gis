// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../analysis/LineOfSightAnalysis ../../analysis/LineOfSightAnalysisObserver ../../analysis/LineOfSightAnalysisTarget ../../core/Collection ../../core/collectionUtils ../../core/Handles ../../core/handleUtils ../../core/maybe ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/accessorSupport/decorators/subclass ../../support/elevationInfoUtils ./LineOfSightTarget ../support/AnalysisViewModel".split(" "),
function(p,l,u,z,A,g,v,B,C,d,k,m,G,H,D,q,w,E){const r=g.ofType(w);g=function(x){function n(a){a=x.call(this,a)||this;a.analysis=null;a.supportedViewType="3d";a.unsupportedErrorMessage="LineOfSightViewModel is only supported in 3D views.";a._handles=new B;a._vmTargetsToConnection=new Map;a._analysisTargetsToConnection=new Map;return a}p._inheritsLoose(n,x);var e=n.prototype;e.initialize=function(){this._handles.add([this.targets.on("after-add",a=>this._onViewModelTargetAdded(a.item)),this.targets.on("after-remove",
a=>this._onViewModelTargetRemoved(a.item)),k.watch(()=>this.analysis,a=>this._onAnalysisChange(a),k.syncAndInitial)])};e.destroy=function(){this._analysisTargetsToConnection.forEach(a=>a.remove());this._handles=d.destroyMaybe(this._handles)};e.continue=function(){d.isSome(this.tool)&&this.tool.continue()};e.stop=function(){d.isSome(this.tool)&&this.tool.stop()};e.constructAnalysis=function(){return new u};e.onConnectToAnalysisView=function(){var a=p._asyncToGenerator(function*(b){this._handles.add([b.on("result-changed",
c=>{const f=this._analysisTargetsToConnection.get(c.target);f&&(d.isSome(c.result)?(f.viewModelTarget.intersectedGraphic=c.result.intersectedGraphic,f.viewModelTarget.intersectedLocation=d.unwrap(c.result.intersectedLocation),f.viewModelTarget.visible=c.result.visible):(f.viewModelTarget.intersectedGraphic=null,f.viewModelTarget.intersectedLocation=null,f.viewModelTarget.visible=void 0))})],"view")});return function(b){return a.apply(this,arguments)}}();e.onDisconnectFromAnalysisView=function(){null!=
this._handles&&this._handles.remove("view")};e._onViewModelTargetAdded=function(a){if(!this._vmTargetsToConnection.get(a)){var b=new A({position:a.location});this._connectViewModelWithAnalysisTarget(a,b);this.analysis.targets.add(b)}};e._onViewModelTargetRemoved=function(a){if(a=this._vmTargetsToConnection.get(a))a.remove(),this.analysis.targets.remove(a.analysisTarget)};e._onAnalysisTargetAdded=function(a){if(!this._analysisTargetsToConnection.get(a)){var b=new w({location:d.applySome(a.position,
c=>this._convertAnalysisPointToAbsoluteHeight(c,a.elevationInfo))});this._connectViewModelWithAnalysisTarget(b,a);this.targets.add(b)}};e._onAnalysisTargetRemoved=function(a){if(a=this._analysisTargetsToConnection.get(a))a.remove(),this.targets.remove(a.viewModelTarget)};e._connectViewModelWithAnalysisTarget=function(a,b){let c=!1;const f=C.handlesGroup([k.watch(()=>({position:b.position,elevationInfo:b.elevationInfo}),({position:t,elevationInfo:h})=>{c||(c=!0,a.location=d.applySome(t,F=>this._convertAnalysisPointToAbsoluteHeight(F,
h)),c=!1)},k.sync),k.watch(()=>a.location,t=>{c||(c=!0,b.position=d.applySome(t,h=>{h=h.clone();h.hasZ||(h.z=0);return h}),b.elevationInfo=null,c=!1)},k.sync)]),y={analysisTarget:b,viewModelTarget:a,remove:()=>{f.remove();this._vmTargetsToConnection.delete(a);this._analysisTargetsToConnection.delete(b)}};this._vmTargetsToConnection.set(a,y);this._analysisTargetsToConnection.set(b,y)};e._onAnalysisChange=function(a){this._handles.remove("analysis");this._handles.add([this.analysis.targets.on("after-add",
b=>this._onAnalysisTargetAdded(b.item)),this.analysis.targets.on("after-remove",b=>this._onAnalysisTargetRemoved(b.item))],"analysis");this.targets.removeAll();a.targets.forEach(b=>{this._onAnalysisTargetAdded(b)})};e._convertAnalysisPointToAbsoluteHeight=function(a,b){const c=a.clone();d.isSome(this.view)&&(b=q.getEffectiveElevationInfo(a.hasZ,b),c.z=q.getConvertedElevation(this.view,a,b,q.absoluteHeightElevationInfo));return c};p._createClass(n,[{key:"state",get:function(){return this.disabled||
!this.ready?"disabled":d.isNone(this.tool)?"ready":this.tool.state}},{key:"observer",get:function(){const {observer:a}=this.analysis;return d.isNone(a)||d.isNone(a.position)?null:this._convertAnalysisPointToAbsoluteHeight(a.position,a.elevationInfo)},set:function(a){a=d.applySome(a,b=>{b=b.clone();b.hasZ||(b.z=0);return b});this.analysis.observer=new z({position:a})}},{key:"targets",get:function(){return this._get("targets")||new r},set:function(a){this._set("targets",v.referenceSetter(a,this.targets,
r))}},{key:"testInfo",get:function(){return{analysisView:this.analysisView,getAnalysisTargetFromViewModelTarget:a=>d.applySome(this._vmTargetsToConnection.get(a),b=>b.analysisTarget)}}}]);return n}(E.AnalysisViewModel);l.__decorate([m.property({type:u})],g.prototype,"analysis",void 0);l.__decorate([m.property({readOnly:!0})],g.prototype,"state",null);l.__decorate([m.property()],g.prototype,"observer",null);l.__decorate([m.property({type:r,cast:v.castForReferenceSetter,nonNullable:!0})],g.prototype,
"targets",null);return g=l.__decorate([D.subclass("esri.widgets.lineOfSight.LineOfSightViewModel")],g)});