// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/asyncUtils ../../../core/handleUtils ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/aaBoundingRect ./interfaces ./LayerView3D ./support/overlayImageUtils ./support/projectExtentUtils ../support/debugFlags ../terrain/interfaces ../webgl-engine/lib/ModelDirtyTypes ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ../webgl-engine/lib/UpdatePolicy ../webgl-engine/materials/ImageMaterial ../../layers/LayerView ../../layers/RefreshableLayerView ../../support/layerViewUtils ../../webgl/enums".split(" "),
function(k,p,E,H,u,r,l,I,v,q,Y,J,F,m,K,L,x,M,N,w,y,O,P,Q,R,S,T,U,G){q=function(z){function A(){var a=z.apply(this,arguments)||this;a.drapeSourceType=K.DrapeSourceType.RasterImage;a.updatePolicy=Q.UpdatePolicy.SYNC;a.fullExtentInLocalViewSpatialReference=null;a.maximumDataResolution=null;a._images=[];a._extents=[];a._overlays=[];a.updateWhenStationary=!0;a._drapeSourceRenderer=null;a.refreshDebounced=l.debounce(function(){var c=k._asyncToGenerator(function*(b){a.destroyed||(yield a._doRefresh(b).catch(e=>
{l.isAbortError(e)||u.getLogger(a.declaredClass).error(e)}))});return function(b){return c.apply(this,arguments)}}(),2E3);return a}k._inheritsLoose(A,z);var h=A.prototype;h.initialize=function(){this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerGeometryDrapeSource(this);this.handles.add(H.makeHandle(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this)));this.addResolvingPromise(M.toViewIfLocal(this).then(a=>this._set("fullExtentInLocalViewSpatialReference",
a)));this.updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler());this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{}));this._isScaleRangeLayer()&&this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.notifyChange("suspended"))};h.destroy=function(){this.clear()};h.setDrapingExtent=function(a,c){this._spatialReference=c;a.forEach(b=>{this._overlays[b.index]=b;this._updateImageExtent(b)})};
h._updateImageExtent=function(a){const c=this._clippedExtent(a.extent,V);if(!r.isNone(c)){var b=x.computeImageExportSize(a.extent,c,a.resolution),e=a.pixelRatio*this.view.state.pixelRatio,{layer:g}=this;if("imageMaxWidth"in g&&null!=g.imageMaxWidth||"imageMaxHeight"in g&&null!=g.imageMaxHeight){var d=g.imageMaxWidth;g=g.imageMaxHeight;if(b.width>d){const f=d/b.width;b.height=Math.floor(b.height*f);b.width=d;e*=f}b.height>g&&(d=g/b.height,b.width=Math.floor(b.width*d),b.height=g,e*=d)}d=this._extents[a.index];
d&&m.equals(d.extent,c)&&this._imageSizeEquals(c,d.imageSize,b)||(this._extents[a.index]={extent:m.create(c),imageSize:b,pixelRatio:e},this.suspended||this._fetch(a.index).catch(f=>{l.isAbortError(f)||u.getLogger(this.declaredClass).error(f)}))}};h.clear=function(){for(let a=0;a<this._images.length;a++)this._clearImage(a)};h.doRefresh=function(){var a=k._asyncToGenerator(function*(){return this._doRefresh()});return function(){return a.apply(this,arguments)}}();h._doRefresh=function(){var a=k._asyncToGenerator(function*(c){if(!this.suspended){var b=
[];for(let e=0;e<this._extents.length;e++)this._extents[e]&&b.push(this._fetch(e,c));yield l.eachAlways(b)}});return function(c){return a.apply(this,arguments)}}();h.canResume=function(){if(!z.prototype.canResume.call(this))return!1;var a=this.layer;if(this._isScaleRangeActive()){const {minScale:c,maxScale:b}=a.effectiveScaleRange;a=this.view.scale;if(a<b||0<c&&a>c)return!1}return!0};h.isUpdating=function(){return this._images.some(a=>!!a.loadingPromise)};h.processResult=function(){var a=k._asyncToGenerator(function*(c,
b,e){if(b instanceof HTMLImageElement||b instanceof HTMLCanvasElement)c.image=b});return function(c,b,e){return a.apply(this,arguments)}}();h.findExtentInfoAt=function(a){for(const c of this._extents){const b=c.extent;if((new F(b[0],b[1],b[2],b[3],this._spatialReference)).contains(a))return c}return null};h.getFetchOptions=function(){};h.redraw=function(){var a=k._asyncToGenerator(function*(c,b){var e=this;yield E.forEach(this._images,function(){var g=k._asyncToGenerator(function*(d,f){d&&(yield c(d,
b),yield e._createStageObjects(f,d.image,b))});return function(d,f){return g.apply(this,arguments)}}())});return function(c,b){return a.apply(this,arguments)}}();h._imageSizeEquals=function(a,c,b){if(!this.maximumDataResolution)return!1;const e=m.width(a)/this.maximumDataResolution.x;a=m.height(a)/this.maximumDataResolution.y;a=Math.abs(a/c.height-a/b.height);const g=N.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return Math.abs(e/c.width-e/b.width)<=g&&a<=g};h._fetch=function(){var a=k._asyncToGenerator(function*(c,
b){var e=this;if(!this.suspended){var g=this._extents[c],d=g.extent;this._images[c]||(this._images[c]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:m.create(d)});var f=this._images[c];f.loadingAbortController=r.abortMaybe(f.loadingAbortController);var B=new F(d[0],d[1],d[2],d[3],this._spatialReference);if(0===B.width||0===B.height)this._clearImage(c);else{var C=new AbortController;f.loadingAbortController=C;l.onAbort(b,
()=>C.abort());var t=C.signal,D=this._waitFetchReady(t).then(k._asyncToGenerator(function*(){const n={requestAsImageElement:!0,pixelRatio:e._overlays[c].pixelRatio,...e.getFetchOptions(),signal:t},{height:W,width:X}=g.imageSize;return e.layer.fetchImage(B,X,W,n)})).then(n=>{if(l.isAborted(t))throw u.getLogger(this.declaredClass).warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),l.createAbortError();return this.processResult(f,
n)}).then(()=>{m.copy(f.renderExtent,d)}).finally(()=>{D===f.loadingPromise&&(f.loadingPromise=null,f.loadingAbortController=null)});f.loadingPromise=D;this.notifyChange("updating");yield D.then(k._asyncToGenerator(function*(){if(t.aborted)throw l.createAbortError();yield e._createStageObjects(c,f.image,t);e.notifyChange("updating")})).catch(n=>{n&&!l.isAbortError(n)&&u.getLogger(this.declaredClass).error(n);this.notifyChange("updating");throw n;})}}});return function(c,b){return a.apply(this,arguments)}}();
h._clearImage=function(a){if(a=this._images[a]){r.isSome(a.renderGeometry)&&(this._drapeSourceRenderer.removeGeometries([a.renderGeometry],y.DirtyOperation.UPDATE),a.renderGeometry=null);const c=this.view._stage;c.remove(a.texture);a.texture=null;c.remove(a.material);a.material=null;a.loadingAbortController=r.abortMaybe(a.loadingAbortController);a.loadingPromise=null;a.image=null;a.pixelData=null}};h._createStageObjects=function(){var a=k._asyncToGenerator(function*(c,b,e){const g=this.view._stage,
d=this._images[c];var f=()=>{g.remove(d.texture);d.texture=null;r.isSome(d.renderGeometry)&&(this._drapeSourceRenderer.removeGeometries([d.renderGeometry],y.DirtyOperation.UPDATE),d.renderGeometry=null)};if(b){b=new P.Texture(b,{width:b.width,height:b.height,preMultiplyAlpha:!0,wrap:{s:G.TextureWrapMode.CLAMP_TO_EDGE,t:G.TextureWrapMode.CLAMP_TO_EDGE}});yield E.result(this._images[c===w.OverlayIndex.INNER?w.OverlayIndex.OUTER:w.OverlayIndex.INNER].loadingPromise);l.throwIfAborted(e);f();g.add(b);
yield g.loadImmediate(b);d.texture=b;r.isNone(d.material)?(d.material=new R.ImageMaterial({transparent:!0,textureId:b.id}),g.add(d.material)):d.material.setParameters({textureId:b.id});if(c===w.OverlayIndex.INNER)f=x.createGeometryForExtent(d.material,d.renderExtent);else{e=this._images[0].renderExtent;if(!e){f();return}f=x.createOuterImageGeometry(d.material,e,d.renderExtent)}d.renderGeometry=new O.RenderGeometry(f);d.renderGeometry.localOrigin=this._overlays[c].renderLocalOrigin;this._drapeSourceRenderer.addGeometries([d.renderGeometry],
y.DirtyOperation.UPDATE)}else f(),g.remove(d.material),d.material=null});return function(c,b,e){return a.apply(this,arguments)}}();h._isScaleRangeLayer=function(){return"effectiveScaleRange"in this.layer};h._isScaleRangeActive=function(){const a=this.layer;if(!this._isScaleRangeLayer())return!1;const {minScale:c,maxScale:b}=a.effectiveScaleRange;return U.isScaleRangeActive(c,b)};h._clippedExtent=function(a,c){if("local"!==this.view.viewingMode)return m.copy(c,a);const b=this.view.basemapTerrain;return b.ready?
m.intersection(a,b.extent,c):m.copy(c,a)};h._suspendedChangeHandler=function(){this.suspended?this.clear():this.refreshDebounced()};h._waitFetchReady=function(){var a=k._asyncToGenerator(function*(c){yield I.whenOnce(()=>this.view.stationary,c);l.throwIfAborted(c)});return function(c){return a.apply(this,arguments)}}();return A}(T(L.LayerView3D(S)));p.__decorate([v.property()],q.prototype,"layer",void 0);p.__decorate([v.property()],q.prototype,"suspended",void 0);p.__decorate([v.property({readOnly:!0})],
q.prototype,"fullExtentInLocalViewSpatialReference",void 0);p.__decorate([v.property()],q.prototype,"updating",void 0);p=q=p.__decorate([J.subclass("esri.views.3d.layers.DynamicLayerView3D")],q);const V=m.create();return p});