// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/Error ../../../../core/mathUtils ../../../../core/maybe ../../../../chunks/mat2 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DPathSymbolLayerConstants ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ../support/FastSymbolUpdates ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/DoubleArray ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/PathGeometry ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/PathMaterial".split(" "),
function(L,M,N,da,A,z,O,I,P,d,B,Q,C,R,D,ea,fa,E,F,S,J,T,U,V,ha,x,n,ia,ja){function W(h,v,k){switch(v){default:case x.UpVectorAlignment.World:for(var b of h.vertices){d.add(e,b.pos,h.offset);k.worldUpAtPosition(e,e);b.setFrameFromUpVector(e);b.rotationFrameUp=b.frame.up;I.set(b.rotationRight,1,0);d.scale(e,b.frame.up,d.dot(b.frame.up,b.vLeft));d.subtract(e,b.vLeft,e);d.negate(e,e);d.normalize(e,e);d.scale(y,b.frame.up,d.dot(b.frame.up,b.vRight));d.subtract(y,b.vRight,y);d.normalize(y,y);d.cross(X,
b.rotationFrameUp,b.vLeft);var a=Math.sign(d.dot(X,b.vRight));b.rotationAngle=a*(Math.PI-A.acosClamped(d.dot(e,y)));0<Math.abs(b.rotationAngle)&&(a=A.reciprocalClamped(Math.cos(.5*b.rotationAngle)),O.set(b.miterStretch,1+(a-1),0,0,1));b.maxStretchDistance=Math.abs(b.vMinSiblingLength/Math.cos(.5*(Math.PI-b.rotationAngle)))}break;case x.UpVectorAlignment.Path:d.add(e,h.vertices[0].pos,h.offset);k.worldUpAtPosition(e,e);n.computeMinimumRotationTangentFrame(h,e);for(a of h.vertices)h=Math.sign(d.dot(a.frame.right,
a.vRight)),d.cross(a.rotationFrameUp,a.vRight,a.vLeft),d.scale(a.rotationFrameUp,a.rotationFrameUp,h),d.normalize(a.rotationFrameUp,a.rotationFrameUp),k=d.dot(a.rotationFrameUp,a.frame.up),b=d.dot(a.rotationFrameUp,a.frame.right),d.scale(e,a.frame.up,-b),d.scale(y,a.frame.right,k),d.add(e,e,y),d.normalize(e,e),n.vertexSpaceToProfileSpace(a.rotationRight,a.frame,e),d.negate(e,a.vLeft),a.rotationAngle=-h*(Math.PI-A.acosClamped(d.dot(e,a.vRight))),0<Math.abs(a.rotationAngle)&&(h=A.reciprocalClamped(Math.cos(.5*
a.rotationAngle)),O.set(a.miterStretch,1+(h-1)*a.rotationRight[0]*a.rotationRight[0],(h-1)*a.rotationRight[0]*a.rotationRight[1],(h-1)*a.rotationRight[0]*a.rotationRight[1],1+(h-1)*a.rotationRight[1]*a.rotationRight[1])),a.maxStretchDistance=Math.abs(a.vMinSiblingLength*A.reciprocalClamped(Math.cos(.5*(Math.PI-a.rotationAngle))))}}function Y(h,v,k){switch(h){case "symbol-value":return k;case "proportional":return v;default:return h}}function ka(h,v,k,b,a){h=h.stageObject;v=h.geometries;var m=0;la.spatialReference=
a.spatialReference;for(const t of v){if(!x.isPathGeometry(t))continue;k=t.path;const r=k.builder.path;Z.spatialReference=t.geometrySR;var g=r,c=b,f=a;let w=0;for(const p of g.vertices)c(p.posES,K),w+=K.sampledElevation,d.add(e,p.pos,g.offset),f.setAltitude(e,K.z),d.subtract(p.pos,e,g.offset);g.updatePathVertexInformation();m+=w/g.vertices.length;t.upVectorAlignment!==x.UpVectorAlignment.World&&W(r,t.upVectorAlignment,a);k.onPathChanged();t.invalidateBoundingInfo();h.geometryVertexAttrsUpdated(t)}return m/
v.length}const ma=["polyline"];N=function(h){function v(b,a,m,g){b=h.call(this,b,a,m,g)||this;b._intrinsicSize=P.fromValues(1,1);b._upVectorAlignment=x.UpVectorAlignment.Path;b._stencilWidth=.1;b.ensureDrapedStatus(!1);return b}M._inheritsLoose(v,h);var k=v.prototype;k.doLoad=function(){var b=M._asyncToGenerator(function*(){var a=z.isSome(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height;const m=z.isSome(this.symbolLayer.height)?this.symbolLayer.height:a;this._vvConvertOptions=
{modelSize:[1,1,1],symbolSize:[a,1,m],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?T.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};var g=this.symbolLayer.anchor||"center";this._upVectorAlignment=
"heading"===this.symbolLayer.profileRotation?x.UpVectorAlignment.World:x.UpVectorAlignment.Path;var c=this.symbolLayer.profile||"circle";switch(c){default:case "circle":this._profile=n.createCircleProfile(E.PATH_NUM_CIRCLE_PROFILE_SUBDIVISIONS);break;case "quad":this._profile=n.creatQuadProfile()}var f=[0,0];"center"!==g&&(f={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[g],this._profile.translate(f[0],f[1]));switch(this.symbolLayer.join){case "round":this._extruder=new n.MiterExtruder(0,E.PATH_NUM_ROUND_JOIN_SUBDIVISIONS);
break;case "bevel":this._extruder=new n.MiterExtruder(0,1);break;case "miter":this._extruder=new n.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new n.SimpleExtruder}g=this.symbolLayer.cap||"butt";switch(g){case "none":this._startCap=new n.NoCapBuilder;this._endCap=new n.NoCapBuilder;break;default:this._startCap=new n.TriangulationCapBuilder(this._profile,0);this._endCap=new n.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new n.TriangulationCapBuilder(this._profile,
-.5);this._endCap=new n.TriangulationCapBuilder(this._profile,.5,!0);break;case "round":c="quad"===c?!0:!1,this._startCap=new n.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:c,subdivisions:E.PATH_NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),this._endCap=new n.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:c,subdivisions:E.PATH_NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}c=z.get(this.symbolLayer,"material","color");f=this._getCombinedOpacityAndColor(c);c=B.fromArray(f);f=f[3];const t=
1>f||this.needsDrivenTransparentPass;g={diffuse:c,ambient:c,opacity:f,transparent:t,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:t||"none"===g?U.CullFaceOptions.None:U.CullFaceOptions.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(I.set(this._intrinsicSize,a,m),!S.isValidSize(this._intrinsicSize[0])||!S.isValidSize(this._intrinsicSize[1])))throw new da("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");
this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||I.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);this._fastUpdates.enabled?(a={...g,...this._fastUpdates.materialParameters,size:P.fromArray(this._intrinsicSize)},this._material=new ja.PathMaterial(a)):(g.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new ia.DefaultMaterial(g));this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!0});this._context.stage.add(this._material)});return function(){return b.apply(this,arguments)}}();k.destroy=function(){h.prototype.destroy.call(this);this._context.stage.remove(this._material);this._material=null};k.createGraphics3DGraphic=function(b){const a=b.graphic;if(!this._validateGeometry(a.geometry,ma,this.symbolLayer.type))return null;const m=this.setGraphicElevationContext(a,new ea.ElevationContext);return this._createAs3DShape(a,b.renderingInfo,m,a.uid)};k.layerOpacityChanged=
function(){var b=z.get(this.symbolLayer,"material","color");b=this._getCombinedOpacity(b);this._material.setParameters({opacity:b,transparent:1>b||this.needsDrivenTransparentPass})};k.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,D.needsElevationUpdates3D)};k.slicePlaneEnabledChanged=function(){this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0};k.physicalBasedRenderingChanged=function(){this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!0});return!0};k.pixelRatioChanged=function(){return!0};k.skipHighSymbolLodsChanged=function(){return!0};k.applyRendererDiff=function(b,a){for(const m in b.diff)switch(m){case "visualVariables":if(T.updateFastSymbolUpdatesState(this._fastUpdates,a,this._vvConvertOptions))this._material.setParameters(this._fastUpdates.materialParameters);else return J.ApplyRendererDiffResult.Recreate_Symbol;break;default:return J.ApplyRendererDiffResult.Recreate_Symbol}return J.ApplyRendererDiffResult.Fast_Update};
k._getVertexData=function(b){let a=0;const m=b.paths,g=[],c=b.spatialReference,f=this._context.elevationProvider.spatialReference,t=this._context.renderCoordsHelper.spatialReference;for(var r of m)a+=r.length;r=V.newDoubleArray(3*a);const w=V.newDoubleArray(3*a);let p=0;for(const q of m){g.push({index:p,numVertices:q.length});for(const l of q)r[p++]=l[0],r[p++]=l[1],r[p++]=b.hasZ?l[2]:0}b=!0;z.isSome(f)&&!c.equals(f)&&(b=Q.projectBuffer(r,c,0,r,f,0,a));z.isSome(f)&&!f.equals(t)?Q.projectBuffer(r,
f,0,w,t,0,a):this._copyVertices(r,0,w,0,a);return{pathVertexDataInfos:g,vertexDataES:r,vertexDataRS:w,projectionSuccess:b,terrainElevation:0}};k._copyVertices=function(b,a,m,g,c){a*=3;g*=3;for(let f=0;f<c;++f)m[g++]=b[a++],m[g++]=b[a++],m[g++]=b[a++]};k._createAs3DShape=function(b,a,m,g){var c=b.geometry,f=[];const t=c.spatialReference,r=C.create(),w=this._context.renderCoordsHelper;Z.spatialReference=t;const p=this._getVertexData(c);if(!p.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),
null;if(0===p.pathVertexDataInfos.length)return 0!==c.paths.length&&c.paths.some(G=>0<G.length)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;for(const G of p.pathVertexDataInfos){c=G.index;var q=G.numVertices;if(2>q)continue;if(z.isSome(this._context.clippingExtent)&&(C.empty(r),C.expandWithBuffer(r,p.vertexDataES,3*c,q),!C.intersectsClippingArea(r,this._context.clippingExtent)))continue;var l=[];for(var u=c;u<c+3*q;){const aa=u++,ba=u++,ca=u++,
H=new n.PathVertex;d.set(H.posES,p.vertexDataES[aa],p.vertexDataES[ba],p.vertexDataES[ca]);const na=D.evaluateElevationAlignmentAtPoint(H.posES,this._context.elevationProvider,m,w);d.set(e,p.vertexDataRS[aa],p.vertexDataRS[ba],p.vertexDataRS[ca]);w.setAltitude(e,na);d.copy(H.pos,e);l.push(H)}c=new n.Path(l);W(c,this._upVectorAlignment,this._context.renderCoordsHelper);c=new n.Builder(c,this._profile,this._extruder,this._startCap,this._endCap);q=null;this._fastUpdates.enabled?(u=this._fastUpdates.visualVariables,
q=u.size?F.getAttributeValue(u.size.field,b):0,l=u.color?F.getAttributeValue(u.color.field,b):0,u=u.opacity?F.getAttributeValue(u.opacity.field,b):0,q=new n.FastUpdatePathGeometry(c,q,l,u)):(q=[this._intrinsicSize[0],this._intrinsicSize[1]],this._drivenProperties.size&&(l=a.size,q[0]*=Y(l[0],"symbol-value"===l[2]?this.symbolLayer.height||0:l[2],this.symbolLayer.width||0),q[1]*=Y(l[2],"symbol-value"===l[0]?this.symbolLayer.width||0:l[0],this.symbolLayer.height||0)),l=void 0,this._drivenProperties.color&&
(l=a.color),this._drivenProperties.opacity&&null!=a.opacity&&(l=l?[l[0],l[1],l[2],a.opacity]:[1,1,1,a.opacity]),c=new n.StaticPathGeometry(c),c.bake(q),l&&c.bakeVertexColors(l),q=c);const {vertexAttributes:oa,indices:pa}=q.createGeometryData();c=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:g,layerUid:this._context.layer.uid});c=new x.PathGeometry(this._material,oa,pa,q,t,this._upVectorAlignment,this._stencilWidth,c);c.transformation=q.xform;f.push(c)}if(0===f.length)return null;
b=new ha.Object3D({geometries:f,metadata:{layerUid:this._context.layer.uid,graphicUid:g}});f=new fa.Graphics3DObject3DGraphicLayer(this,b,f,null,null,ka,m);f.alignedSampledElevation=p.terrainElevation;f.needsElevationUpdates=D.needsElevationUpdates3D(m.mode);return f};return v}(F.Graphics3DSymbolLayer);const la=R.makeDehydratedPoint(0,0,0,null),Z=R.makeDehydratedPoint(0,0,0,null),e=B.create(),y=B.create(),X=B.create(),K=new D.SampleElevationInfo;L.Graphics3DPathSymbolLayer=N;Object.defineProperty(L,
Symbol.toStringTag,{value:"Module"})});