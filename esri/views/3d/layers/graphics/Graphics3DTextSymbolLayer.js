// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../chunks/vec2f64 ../../../../symbols/callouts/calloutUtils ./CreateLabelParameters ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DObjectMetadata ./Graphics3DSymbolLayer ./graphicUtils ./placementUtils ./pointUtils ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureFactory ../../webgl-engine/materials/HUDMaterial".split(" "),
function(B,x,G,d,H,I,u,C,J,K,y,L,M,N,z,O,r,v,P,Q,R,D){function E(h,m,g){h&&h.forEach(a=>{const b=m(a);d.isSome(b)&&g(b,a.graphic)})}function S(h,m){if("baseline"===m.verticalPlacement)return m=r.horizontalPlacementToAnchorX[m.horizontalPlacement],h=d.isSome(h)?h.baselineAnchorY:0,u.fromValues(m,h);h=r.anchorFromPlacements(m.horizontalPlacement,m.verticalPlacement);return r.namedAnchorToHUDMaterialAnchorPos[h]}const T=[0,0,1];z=function(h){function m(a,b,e,c){a=h.call(this,a,b,e,c)||this;a._elevationOptions=
{supportsOffsetAdjustment:!0,supportsOnTheGround:!1};a.ensureDrapedStatus(!1);return a}x._inheritsLoose(m,h);var g=m.prototype;g.doLoad=function(){var a=x._asyncToGenerator(function*(){if(!this._drivenProperties.size){const b=O.validateSymbolLayerSize(this.symbolLayer.size);if(b)throw new G("graphics3dtextsymbollayer:invalid-size",b);}yield this._createTextRenderParameters()});return function(){return a.apply(this,arguments)}}();g._createTextRenderParameters=function(){var a=x._asyncToGenerator(function*(){this._textRenderParameters=
yield Q.TextRenderParameters.fromSymbol(this.symbolLayer,this._context.graphicsCoreOwner.view.state.rasterPixelRatio)});return function(){return a.apply(this,arguments)}}();g.destroy=function(){h.prototype.destroy.call(this)};g.createGraphics3DGraphic=function(a){a=a.graphic;const b=v.placePointOnGeometry(a.geometry);if(d.isNone(b))return this.logger.warn(`unsupported geometry type for text symbol: ${a.geometry.type}`),null;const e=this.symbolLayer.text;if(d.isNone(e)||""===e)return null;var c=C.hasCalloutSupport(this.symbol)&&
this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(d.isSome(c)&&!C.textSymbolLayerSupportsVerticalOffset(this.symbolLayer))return this.logger.errorOncePerTick("Callouts and vertical offset on text symbols are currently only supported with 'center' "+`horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;c=new J.CreateLabelParameters(c,this.symbolLayer.horizontalAlignment,r.verticalPlacementFromAlignment(this.symbolLayer.verticalAlignment));
return this._createAs3DShape(a,b,e,c)};g.createLabel=function(a,b,e,c){a=a.graphic;const k=v.placePointOnGeometry(a.geometry);if(d.isNone(k))return this.logger.warn(`unsupported geometry type for label: ${a.geometry.type}`),null;const l=b.text;return!l||/^\s+$/.test(l)?null:this._createAs3DShape(a,k,l,b,e,c)};g.setGraphicElevationContext=function(a,b,e=0){a=h.prototype.setGraphicElevationContext.call(this,a,b);a.addOffsetRenderUnits(e);return a};g.layerOpacityChanged=function(){this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");
return!1};g.layerElevationInfoChanged=function(a,b){E(a,b,(e,c)=>{this.updateGraphicElevationContext(c,e)});return y.SymbolUpdateType.UPDATE};g.slicePlaneEnabledChanged=function(a,b){E(a,b,e=>{for(const c of e.stageObject.geometries)c.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})});return!0};g.physicalBasedRenderingChanged=function(){return!0};g.pixelRatioChanged=function(){return!1};g.skipHighSymbolLodsChanged=function(){return!0};g.updateGraphicElevationContext=function(a,
b){const e=b.elevationContext;this.setGraphicElevationContext(a,e,d.isSome(b.metadata)?b.metadata.elevationOffset:0);b.needsElevationUpdates=y.needsElevationUpdates2D(e.mode)||"absolute-height"===e.mode};g._defaultElevationInfoNoZ=function(){return U};g._createAs3DShape=function(a,b,e,c,k,l){const w=this.setGraphicElevationContext(a,new L.ElevationContext,c.elevationOffset);var p="polyline"===d.get(a.geometry,"type"),t=a.uid;let q=null;a=null;if(d.isNone(l)){var f=r.textRenderAlignmentFromHorizontalPlacement(c.horizontalPlacement);
q=new R(e,f,this._textRenderParameters);let n=null;if(d.isSome(this._context.sharedResources.textures)){a=this._context.sharedResources.textures.fromData(q.key,()=>d.unwrap(q).create(),()=>{d.isSome(n)&&n.release()});f=this._context.stage.renderView.textureRepository.acquire(a.texture.id);if(d.isNone(f)||H.isPromiseLike(f))return a.release(),null;n=f}}f=S(q,c);f={occlusionTest:!0,screenOffset:c.screenOffset,anchorPosition:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:c.centerOffsetUnits,drawInSecondSlot:!0};
d.isSome(l)?f.textureId=l.id:d.isSome(a)&&(f.textureId=a.texture.id);if(d.isSome(c.verticalOffset)){const {screenLength:n,minWorldLength:A,maxWorldLength:F}=c.verticalOffset;f.verticalOffset={screenLength:I.pt2px(n),minWorldLength:A||0,maxWorldLength:d.isSome(F)?F:Infinity}}if(this._context.screenSizePerspectiveEnabled){const {screenSizePerspectiveSettings:n,screenSizePerspectiveSettingsLabels:A}=this._context.sharedResources;f.screenSizePerspective=A.overridePadding(this._textRenderParameters.haloSize+
this._textRenderParameters.definition.background.padding[0]);f.screenSizePerspectiveAlignment=n}p&&(f.shaderPolygonOffset=1E-4);f.hasSlicePlane=this._context.slicePlaneEnabled;d.isSome(k)?(p=JSON.stringify(f),l=k.get(p),d.isNone(l)&&(l=new D.HUDMaterial(f),k.add(p,l))):l=new D.HUDMaterial(f);p=c.translation;f=d.isSome(q)?u.fromValues(q.displayWidth,q.displayHeight):u.ZEROS;p=P.createPointGeometry(l,T,p,null,f,c.centerOffset,[0,0],null);t=v.createStageObject(this._context,b,p,w,t);if(d.isNone(t))return null;
k=new M.Graphics3DObject3DGraphicLayer(this,t.object,[p],d.isNone(k)?[l]:null,a,K.perObjectElevationAligner,w);k.alignedSampledElevation=t.sampledElevation;k.needsElevationUpdates=y.needsElevationUpdates2D(w.mode)||"absolute-height"===w.mode;const {displayWidth:V,displayHeight:W}=d.isSome(q)?q:c;k.getScreenSize=(n=u.create())=>{n[0]=V;n[1]=W;return n};e=new N.Graphics3DObjectMetadata(c.elevationOffset,e);k.metadata=e;v.extendPointGraphicElevationContext(k,b,this._context.elevationProvider);return k};
return m}(z.Graphics3DSymbolLayer);const U={mode:"relative-to-ground",offset:0};B.Graphics3DTextSymbolLayer=z;Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});