// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/HandleOwner ../../../../core/Logger ../../../../core/maybe ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/projection ../../../../geometry/support/aaBoundingRect ./enums ../../../support/layerViewUtils ../../../support/Scheduler".split(" "),function(t,
f,e,C,m,g,E,F,D,u,v,h,w,x){const y=C.getLogger("esri.views.3d.layers.graphics.Graphics3DScaleVisibility");e=function(z){function q(a){a=z.call(this,a)||this;a._scaleRangeActive=!1;a._layerScaleRangeVisibilityQuery=!1;a._extent=null;a.graphicsCoreOwner=null;a.layer=null;a.queryGraphicUIDsInExtent=null;a.graphicsCore=null;a.basemapTerrain=null;a.layerScaleEnabled=!0;a.suspended=!1;a._dirty=!0;return a}t._inheritsLoose(q,z);var d=q.prototype;d.initialize=function(){this.updateScaleRangeActive();this.handles.add(this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(x.TaskPriority.SCALE_VISIBILITY,
this));this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())};d.destroy=function(){this.updatingHandles.removeAll();this.handles.removeAll();this._dirty=!1;this.basemapTerrain=this.graphicsCore=this.queryGraphicUIDsInExtent=this.layer=this.graphicsCoreOwner=this._extent=null};d._setDirty=function(){this._dirty=!0};d.setExtent=function(a){const b=this.graphicsCoreOwner.view.spatialReference,c=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;
if(b===c)this._extent=a??null;else{const k=v.create();u.projectBoundingRect(a,b,k,c)?this._extent=k:this._extent=null}this._setDirty()};d.scaleRangeActive=function(){return this._scaleRangeActive};d.updateScaleRangeActive=function(){var a=this.layer,b=a.effectiveScaleRange;b=this.layerScaleEnabled&&null!=b&&(0<b.minScale||0<b.maxScale);a.labelingInfo&&!b&&(b=a.labelingInfo.some(c=>c&&(0<(c.minScale??0)||0<(c.maxScale??0))));a=this._scaleRangeActive!==b;(this._scaleRangeActive=b)&&!this.handles.has("terrain-events")&&
this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",c=>this._scaleUpdateHandler(c)),"terrain-events"),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),"terrain-events")):!b&&this.handles.has("terrain-events")&&this.handles.remove("terrain-events");return a};d.runTask=function(a){const b=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&b&&b.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return x.Task.YIELD;
this._layerScaleRangeVisibilityQuery=!0;const {minScale:c,maxScale:k}=this.layer.effectiveScaleRange;b.queryVisibleScaleRange(this._extent,c,k,n=>this._finishUpdate(n))}else this._finishUpdate(!0);a.madeProgress()};d._finishUpdate=function(a){this._layerScaleRangeVisibilityQuery=!1;this._set("suspended",!a);this._dirty=!1};d._visibleAtLayerScale=function(a){const b=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||w.scaleBoundsPredicate(a,b.minScale||0,b.maxScale||0)};d._visibleAtLabelScale=
function(a,b){return w.scaleBoundsPredicate(a,b.minScale||0,b.maxScale||0)};d._graphicScale=function(a){let b;m.isSome(a.centroid)?b=a.centroid:m.isSome(a.graphic.geometry)&&"point"===a.graphic.geometry.type&&(b=a.graphic.geometry);return b?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(b):1:null};d._graphicVisible=function(a){if(!this.layerScaleEnabled)return!0;a=this._graphicScale(a);return this._visibleAtLayerScale(a)};d.updateVisibility=function(a){if(this._scaleRangeActive){const b=
this._graphicVisible(a);return a.setVisibilityFlag(h.VisibilityFlag.SCALE_RANGE,b,h.VisibilityGroup.GRAPHIC)}return!1};d.updateGraphicLabelScaleVisibility=function(a){if(!this._scaleRangeActive||!a.labelLayers||0===a.labelLayers.length)return!1;const b=this._graphicScale(a);if(a=this._updateLabelScaleVisibility(a,b))this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty();return a};d._updateLabelScaleVisibility=function(a,b){if(!a.labelLayers||0===a.labelLayers.length)return!1;
const c=a.labelLayers[0]._labelClass;return c&&null!=c.minScale&&null!=c.maxScale&&(b=this._visibleAtLabelScale(b,c),a.setVisibilityFlag(h.VisibilityFlag.SCALE_RANGE,b,h.VisibilityGroup.LABEL))?!0:!1};d._scaleUpdateHandler=function(a){this._setDirty();if(this.graphicsCore.visible){var b=a.extent,c=a.scale,k=this._visibleAtLayerScale(c),n=!1,r=this.graphicsCoreOwner.view.spatialReference;a=a.spatialReference;if(m.isNone(a))y.error("scaleUpdate: Internal error, no SpatialReference given for tiles");
else{var A=!a.equals(r);A&&!u.projectBoundingRect(b,a,B,r)?y.error("scaleUpdate: Internal error, cannot project AABR from "+a+" to wkid "+r):(this.queryGraphicUIDsInExtent(A?B:b,r,l=>{l=this.graphicsCore.getGraphics3DGraphicById(l);if(!m.isNone(l)){var p=l.centroid;m.isSome(p)&&(b[0]>p.x||b[1]>p.y||b[2]<p.x||b[3]<p.y)||(l.setVisibilityFlag(h.VisibilityFlag.SCALE_RANGE,k,h.VisibilityGroup.GRAPHIC)&&(n=!0),this._updateLabelScaleVisibility(l,c)&&(n=!0))}}),n&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),
this.graphicsCoreOwner.view.labeler.setDirty()))}}};d.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(a=>a.clearVisibilityFlag(h.VisibilityFlag.SCALE_RANGE)):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility();this._setDirty()};t._createClass(q,[{key:"updating",get:function(){return this._dirty||this.updatingHandles.updating}},{key:"running",get:function(){return!(!this.graphicsCoreOwner.view.basemapTerrain||
!this.updating)}}]);return q}(e.HandleOwner);f.__decorate([g.property()],e.prototype,"graphicsCoreOwner",void 0);f.__decorate([g.property()],e.prototype,"layer",void 0);f.__decorate([g.property()],e.prototype,"queryGraphicUIDsInExtent",void 0);f.__decorate([g.property()],e.prototype,"graphicsCore",void 0);f.__decorate([g.property()],e.prototype,"basemapTerrain",void 0);f.__decorate([g.property({constructOnly:!0})],e.prototype,"layerScaleEnabled",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,
"suspended",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"updating",null);f.__decorate([g.property()],e.prototype,"_dirty",void 0);e=f.__decorate([D.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],e);const B=v.create();return e});