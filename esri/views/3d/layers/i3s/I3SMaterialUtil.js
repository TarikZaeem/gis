// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ./enums ../../webgl-engine/core/material/RenderTexture ../../webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl ../../webgl-engine/core/shaderLibrary/util/AlphaCutoff ../../webgl-engine/core/shaderLibrary/util/EllipsoidMode ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Texture ../../../webgl/enums".split(" "),function(q,E,w,p,d,t,y,z,F,g,G,x){function A(a){return a.sort((b,
c)=>b.encoding-c.encoding)}function u(a,b,c){if(p.isNone(a)||c===d.TextureUsage.None)return null;for(let f=0;f<a.length;f++){const e=a[f];if(p.isSome(e)&&0!==(e.usage&c))return a=b[f],p.isSome(a)?a.id:null}return null}function H(a){switch(a){case d.TextureEncoding.KTX2:return g.TextureEncodingMimeType.KTX2_ENCODING;case d.TextureEncoding.Basis:return g.TextureEncodingMimeType.BASIS_ENCODING;case d.TextureEncoding.DDS_S3TC:return g.TextureEncodingMimeType.DDS_ENCODING;case d.TextureEncoding.PNG:return"image/png";
case d.TextureEncoding.JPG:return"image/jpeg";case d.TextureEncoding.KTX_ETC2:return"image/ktx";default:return""}}const I={ktx2:d.TextureEncoding.KTX2,basis:d.TextureEncoding.Basis,dds:d.TextureEncoding.DDS_S3TC,png:d.TextureEncoding.PNG,jpg:d.TextureEncoding.JPG,"ktx-etc2":d.TextureEncoding.KTX_ETC2},B={[g.TextureEncodingMimeType.KTX2_ENCODING]:d.TextureEncoding.Basis,[g.TextureEncodingMimeType.BASIS_ENCODING]:d.TextureEncoding.Basis,[g.TextureEncodingMimeType.DDS_ENCODING]:d.TextureEncoding.DDS_S3TC,
"image/png":d.TextureEncoding.PNG,"image/jpg":d.TextureEncoding.JPG,"image/jpeg":d.TextureEncoding.JPG,"image/ktx":d.TextureEncoding.KTX_ETC2},C=()=>({alphaMode:"opaque",alphaCutoff:z.defaultMaskAlphaCutoff,doubleSided:!0,cullFace:g.CullFaceOptions.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}),
J={s:x.TextureWrapMode.CLAMP_TO_EDGE,t:x.TextureWrapMode.CLAMP_TO_EDGE},K={s:x.TextureWrapMode.REPEAT,t:x.TextureWrapMode.REPEAT};q.configureMaterial=function(a,b,c,f,e,k){const h=k.rendererTextureUsage;var l=b.metallicRoughness.baseColorFactor,m=w.clamp(b.metallicRoughness.baseColorFactor[3],0,1);a.baseColor=[l[0],l[1],l[2],m];a.hasParametersFromSource=!!b.hasParametersFromSource;a.usePBR=k.usePBR;a.mrrFactors=[b.metallicRoughness.metallicFactor,b.metallicRoughness.roughnessFactor,b.hasParametersFromSource?
.2:.5];a.emissiveFactor=b.emissiveFactor;a.isIntegratedMesh=k.isIntegratedMesh;a.textureAlphaCutoff="mask"===b.alphaMode?b.alphaCutoff:z.defaultMaskAlphaCutoff;a.alphaDiscardMode="opaque"===b.alphaMode?g.AlphaDiscardMode.Opaque:"mask"===b.alphaMode?g.AlphaDiscardMode.Mask:g.AlphaDiscardMode.MaskBlend;l=[];m=u(f,c,(d.TextureUsage.Color|d.TextureUsage.AlphaMask)&h);p.isSome(m)&&(a.baseColorTexture=new t.RenderTexture(e,m),l.push(a.baseColorTexture.loadPromise));m=u(f,c,d.TextureUsage.MetallicRoughness&
h);p.isSome(m)&&(a.metallicRoughnessTexture=new t.RenderTexture(e,m),l.push(a.metallicRoughnessTexture.loadPromise));m=u(f,c,d.TextureUsage.Emissive&h);p.isSome(m)&&(a.emissionTexture=new t.RenderTexture(e,m),l.push(a.emissionTexture.loadPromise));m=u(f,c,d.TextureUsage.Occlusion&h);p.isSome(m)&&(a.occlusionTexture=new t.RenderTexture(e,m),l.push(a.occlusionTexture.loadPromise));c=u(f,c,d.TextureUsage.Normal&h);p.isSome(c)&&(a.normalTexture=new t.RenderTexture(e,c),l.push(a.normalTexture.loadPromise));
a.commonMaterialParameters.hasSlicePlane=k.slicePlaneEnabled;a.commonMaterialParameters.doubleSided=b.doubleSided;a.commonMaterialParameters.cullFace=b.cullFace;a.ellipsoidMode=F.getEllipsoidMode(k.viewSpatialReference);return Promise.all(l)};q.createTexture=function(a,b,c,f){if(p.isNone(a)||null==a.data)return null;const e=a.data;var k=!(e instanceof HTMLImageElement)||w.isPowerOfTwo(e.width)&&w.isPowerOfTwo(e.height),h=f.renderingContext.parameters.maxMaxAnisotropy;f=c&&!f.capabilities.shaderTextureLOD?
1:h;k=k&&!a.downsampled&&1<f;c=c||!b.wrapTextures?J:K;h=H(a.encoding);return new G.Texture(e,{mipmap:k,maxAnisotropy:f,encoding:h,wrap:c,components:a.usage&d.TextureUsage.Color?"opaque"===b.alphaMode?3:4:3,noUnpackFlip:!0})};q.defaultMaterial=C;q.getMaterialAndTextures=function(a,b){const c=new Map,f=(v,r)=>{if(p.isNone(v))return-1;var n=c.get(v.id);if(n)return n.usage|=r,n.id;n=c.size;c.set(v.id,{id:n,usage:r});return n};var e=b.pbrMetallicRoughness;const k=e&&e.baseColorFactor,h=b.emissiveFactor,
l=null==b.normalTexture&&null==b.emissiveTexture&&null==b.occlusionTexture&&(e?null==e.metallicRoughnessTexture&&1===e.roughnessFactor&&(1===e.metallicFactor||0===e.metallicFactor):!0),m=l?y.PBRSchematicMRRValues[0]:e?e.metallicFactor:1,L=l?y.PBRSchematicMRRValues[1]:e?e.roughnessFactor:1;e={baseColorFactor:k?[k[0],k[1],k[2],k[3]]:[1,1,1,1],baseColorTextureId:f(e&&e.baseColorTexture,"mask"===b.alphaMode?d.TextureUsage.Color|d.TextureUsage.AlphaMask:d.TextureUsage.Color),metallicRoughnessTextureId:f(e&&
e.metallicRoughnessTexture,d.TextureUsage.MetallicRoughness),metallicFactor:m,roughnessFactor:L};b={alphaMode:b.alphaMode,alphaCutoff:b.alphaCutoff,doubleSided:b.doubleSided,cullFace:"none"===b.cullFace?g.CullFaceOptions.None:"back"===b.cullFace?g.CullFaceOptions.Back:"front"===b.cullFace?g.CullFaceOptions.Front:g.CullFaceOptions.None,normalTextureId:f(b.normalTexture,d.TextureUsage.Normal),emissiveTextureId:f(b.emissiveTexture,d.TextureUsage.Emissive),occlusionTextureId:f(b.occlusionTexture,d.TextureUsage.Occlusion),
emissiveFactor:h?[h[0],h[1],h[2]]:[0,0,0],metallicRoughness:e,wrapTextures:!1,hasParametersFromSource:l};const D=[];c.forEach(({usage:v},r)=>{var n=p.isSome(a)&&a[r]&&a[r].formats;n=n?A(n.map(({name:M,format:N})=>({name:M,encoding:I[N]}))):[];D.push({id:r,usage:v,encodings:n})});return{material:b,textures:D}};q.getMaterialAndTexturesFromShared=function(a){var b=a&&a.materialDefinitions?Object.keys(a.materialDefinitions)[0]:null,c=a&&a.textureDefinitions?Object.keys(a.textureDefinitions)[0]:null;b=
b?a.materialDefinitions?.[b]:null;c=c?a.textureDefinitions?.[c]:null;a=C();if(null!=b){b=b.params;b.diffuse&&(a.metallicRoughness.baseColorFactor=[b.diffuse[0],b.diffuse[1],b.diffuse[2],1]);null!=b.doubleSided&&(a.doubleSided=b.doubleSided,a.cullFace=b.doubleSided?g.CullFaceOptions.None:g.CullFaceOptions.Back);if("none"===b.cullFace||"front"===b.cullFace||"back"===b.cullFace)a.cullFace="none"===b.cullFace?g.CullFaceOptions.None:"back"===b.cullFace?g.CullFaceOptions.Back:g.CullFaceOptions.Front;b.transparency&&
(a.metallicRoughness.baseColorFactor[3]=w.clamp(1-b.transparency,0,1));if(b.useVertexColorAlpha||1>a.metallicRoughness.baseColorFactor[3])a.alphaMode="blend"}b=[];if(null!=c){!c.wrap||"repeat"!==c.wrap[0]&&"repeat"!==c.wrap[1]||(a.wrapTextures=!0);let f=d.TextureUsage.Color;"rgba"===c.channels&&(a.alphaMode="blend",f|=d.TextureUsage.AlphaMask);const e=c.images[c.images.length-1],k=h=>h&&h.split("/").pop();c=Array.isArray(c.encoding)?A(c.encoding.map((h,l)=>({name:k(e.href[l]),encoding:B[h]||0}))):
[{name:k(e.href),encoding:B[c.encoding]||0}];b.push({id:0,usage:f,encodings:c});a.metallicRoughness.baseColorTextureId=0}return{material:a,textures:b}};q.getSupportedEncodings=function(a){const b=!!a.compressedTextureS3TC;a=!!a.compressedTextureETC;const c=E("disable-feature:i3s-basis")?0:d.TextureEncoding.Basis|d.TextureEncoding.KTX2,f=c|d.TextureEncoding.DDS_S3TC;return d.TextureEncoding.JPG|d.TextureEncoding.PNG|(b?f:0)|(a?c:0)};q.selectEncoding=function(a,b){if(null!=b)return a.find(c=>0!==(c.encoding&
b))};Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});