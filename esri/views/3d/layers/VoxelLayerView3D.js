// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/Handles ../../../core/Logger ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/spatialReferenceUtils ./LayerView3D ./support/PopupSceneLayerView ../../layers/LayerView ../../webgl/context-util ../../../geometry/SpatialReference".split(" "),
function(t,q,n,p,B,w,c,k,u,K,L,C,v,x,D,y,E,F,G,H,I,J){var g;(function(l){l[l.API=1]="API";l[l.VerboseAPI=2]="VerboseAPI";l[l.Error=3]="Error"})(g||(g={}));const m=x.create(),z=x.create();n=function(l){function r(){var b=l.apply(this,arguments)||this;b._suspendedHandle=null;b._usedMemory=0;b._futureMemory=0;b.type="voxel-3d";b.slicePlaneEnabled=!1;b._wasmLayerId=-1;b._handles=new B;b._dbgFlags=new Set;return b}t._inheritsLoose(r,l);var f=r.prototype;f.initialize=function(){this._dbgFlags.add(g.Error);
if("local"!==this.view.viewingMode)throw new p("voxel:unsupported-viewingMode","Voxel layers support local viewingMode only.",{});if(this.view._stage.renderView.renderingContext.type!==I.ContextType.WEBGL2)throw new p("voxel:unsupported-context","Voxel layers are supported in WebGL2 rendering contexts only.",{});if(!this.view._stage.renderView.renderingContext.capabilities.colorBufferFloat?.textureFloat)throw new p("voxel:missing-color-buffer-float","Voxel layers require the WebGL2 extension EXT_color_buffer_float",
{});if(!E.equals(this.layer.spatialReference,this.view.spatialReference))throw new p("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});var b=this.layer.currentVariableId,a=this.layer.getVolume(b);b=this.layer.getVariable(b);if(c.isSome(a)&&c.isSome(b)){var d=a.dimensions[0];const h=a.dimensions[1],e=a.zDimension;if(1<e){a=d.size*h.size*a.dimensions[e].size;d=1;switch(b.renderingFormat.type){case "Int16":case "UInt16":d=
2;break;case "Int32":case "UInt32":case "Float32":d=4}this._futureMemory=d*a}}b=this.view.addVoxelLayerViewToWasm(this).then(h=>{this._wasmLayerId=h;this._suspendedHandle=k.watch(()=>this.suspended,e=>{const A=this.view.voxelWasm;c.isSome(A)&&A.setEnabled(this,!e)},k.initial);this._handles.add([k.watch(()=>this.layer.renderMode,e=>this._pushRenderModeToWasm(e)),k.watch(()=>this.layer.currentVariableId,e=>this._pushCurrentVariableIdToWasm(e)),k.watch(()=>this.layer.getSections(),e=>this._pushSectionsToWasm(e)),
k.watch(()=>this.layer.getVariableStyles(),e=>this._pushVariableStylesToWasm(e)),k.watch(()=>this.layer.getVolumeStyles(),e=>this._pushVolumeStylesToWasm(e)),k.watch(()=>this.layer.enableDynamicSections,e=>this._pushEnableDynamicSectionsToWasm(e)),k.watch(()=>this.layer.enableIsosurfaces,e=>this._pushEnableIsosurfacesToWasm(e)),k.watch(()=>this.layer.enableSections,e=>this._pushEnableSectionsToWasm(e)),k.watch(()=>this.layer.enableSlices,e=>this._pushEnableSlicesToWasm(e)),k.watch(()=>this.slicePlaneEnabled,
e=>this._pushAnalysisSliceToWasm(e,this.view.slicePlane)),k.watch(()=>this.view.slicePlane,e=>this._pushAnalysisSliceToWasm(this.slicePlaneEnabled,e))])}).catch(h=>{this.view.removeVoxelLayerViewFromWasm(this);this._wasmLayerId=-1;if(-1===h)throw new p("voxel:addLayer-failure","The voxel layer description was invalid.",{});if(-2===h)throw new p("voxel:addLayer-failure","The voxel layer web assembly module failed to download.",{});});this.addResolvingPromise(b)};f.destroy=function(){this.view.removeVoxelLayerViewFromWasm(this);
this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null);this._handles=c.destroyMaybe(this._handles)};f.isUpdating=function(){const b=this.view.voxelWasm;return 0>this._wasmLayerId||!c.isSome(b)?!1:b.isUpdating(this._wasmLayerId)};f.updatingFlagChanged=function(){this.notifyChange("updating")};f.getUsedMemory=function(){return this._usedMemory};f.getUnloadedMemory=function(){return this._futureMemory};f.ignoresMemoryFactor=function(){return!0};f.whenGraphicBounds=function(b,
a){if(a=b.attributes["Voxel.WorldPosition"])if(b=y.empty(),a=JSON.parse(a),D.projectVectorToVector(a,this.view.renderSpatialReference,z,this.view.spatialReference||J.WGS84))return y.expandWithVec3(b,z),Promise.resolve({boundingBox:b,screenSpaceObjects:[]});return Promise.reject()};f.setUsedMemory=function(b){this._usedMemory=b;this._futureMemory=0};f.captureFrustum=function(){const b=this.view.voxelWasm;c.isSome(b)&&b.captureFrustum()};f.toggleFullVolumeExtentDraw=function(){const b=this.view.voxelWasm;
c.isSome(b)&&b.toggleFullVolumeExtentDraw(this)};f.getLayerTimes=function(){let b=[];const a=this.view.voxelWasm;c.isSome(a)&&(b=a.getLayerTimes(this));return b};f.getCurrentLayerTimeIndex=function(){let b=0;const a=this.view.voxelWasm;c.isSome(a)&&(b=a.getCurrentLayerTimeIndex(this));return b};f._pushRenderModeToWasm=function(b){const a=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushRenderModeToWasm() called, ${c.isSome(a)?"have WASM":"don't have WASM!!!"}`);c.isSome(a)&&a.setRenderMode(this,
b)||this._dbg(g.Error,"VoxelLayerView3D._pushRenderModeToWasm() failed!")};f._pushSectionsToWasm=function(b){const a=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushSectionsToWasm() called, ${c.isSome(a)?"have WASM":"don't have WASM!!!"}`);c.isSome(a)&&a.setStaticSections(this,b)||this._dbg(g.Error,"VoxelLayerView3D._pushSectionsToWasm() failed!")};f._pushCurrentVariableIdToWasm=function(b){const a=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushCurrentVariableIdToWasm() called!, ${c.isSome(a)?
"have WASM":"don't have WASM!!!"}`);c.isSome(a)&&a.setCurrentVariable(this,b)||this._dbg(g.Error,"VoxelLayerView3D._pushCurrentVariableIdToWasm() failed!")};f._pushVariableStylesToWasm=function(b){const a=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushVariableStylesToWasm() called, ${c.isSome(a)?"have WASM":"don't have WASM!!!"}`);let d=!1;c.isSome(a)&&((d=a.setVariableStyles(this,b))||this._dbg(g.Error,"VoxelLayerView3D._pushVariableStylesToWasm() failed!"))};f._accountForEnableSlices=
function(b,a){a=c.isSome(a)?a:this.layer.enableSlices;for(let d=0;d<b.length;++d){const h=b[d];for(const e of h.slices)e.enabled=e.enabled&&a}};f._pushVolumeStylesToWasm=function(b){const a=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushVolumeStylesToWasm() called, ${c.isSome(a)?"have WASM":"don't have WASM!!!"}`);let d=!1;c.isSome(a)&&(this._accountForEnableSlices(b,null),(d=a.setVolumeStyles(this,b))||this._dbg(g.Error,"VoxelLayerView3D._pushVolumeStylesToWasm() failed!"))};f._pushAnalysisSliceToWasm=
function(b,a){const d=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushAnalysisSliceToWasm() called, ${c.isSome(d)?"have WASM":"don't have WASM!!!"}`);var h=!1;c.isSome(d)&&(c.isSome(a)?(h=a.origin,v.cross(m,a.basis1,a.basis2),v.normalize(m,m),h=d.setAnalysisSlice(this,b,h,m)):(v.set(m,0,0,1),h=d.setAnalysisSlice(this,!1,m,m)),h||this._dbg(g.Error,"VoxelLayerView3D._pushAnalysisSliceToWasm() failed!"))};f._pushEnableDynamicSectionsToWasm=function(b){const a=this.view.voxelWasm;this._dbg(g.VerboseAPI,
`VoxelLayerView3D._pushEnableDynamicSectionsToWasm() called, ${c.isSome(a)?"have WASM":"don't have WASM!!!"}`);let d=!1;c.isSome(a)&&((d=a.setEnableDynamicSections(this,b))||this._dbg(g.Error,"VoxelLayerView3D._pushEnableDynamicSectionsToWasm() failed!"))};f._pushEnableSlicesToWasm=function(b){const a=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushEnableSlicesToWasm() called, ${c.isSome(a)?"have WASM":"don't have WASM!!!"}`);var d=!1;c.isSome(a)&&(d=this.layer.getVolumeStyles(),
this._accountForEnableSlices(d,b),(d=a.setVolumeStyles(this,d))||this._dbg(g.Error,"VoxelLayerView3D._pushEnableSlicesToWasm() failed!"))};f._pushEnableIsosurfacesToWasm=function(b){const a=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushEnableIsosurfacesToWasm() called, ${c.isSome(a)?"have WASM":"don't have WASM!!!"}`);let d=!1;c.isSome(a)&&((d=a.setEnableIsosurfaces(this,b))||this._dbg(g.Error,"VoxelLayerView3D._pushEnableIsosurfacesToWasm() failed!"))};f._pushEnableSectionsToWasm=
function(b){const a=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushEnableSectionsToWasm() called, ${c.isSome(a)?"have WASM":"don't have WASM!!!"}`);let d=!1;c.isSome(a)&&((d=a.setEnableSections(this,b))||this._dbg(g.Error,"VoxelLayerView3D._pushEnableSectionsToWasm() failed!"))};f.whenGraphicAttributes=function(){var b=t._asyncToGenerator(function*(a,d){return a});return function(a,d){return b.apply(this,arguments)}}();f._dbg=function(b,a){this._dbgFlags.has(b)&&(b===g.Error?w.getLogger(this.declaredClass).error(a):
w.getLogger(this.declaredClass).warn(a))};t._createClass(r,[{key:"baseUrl",get:function(){return this.layer.parsedUrl?.path??""}},{key:"wasmLayerId",get:function(){return this._wasmLayerId}},{key:"performanceInfo",get:function(){return{nodes:0,displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null}}}]);return r}(G.PopupSceneLayerView(F.LayerView3D(H)));q.__decorate([u.property()],n.prototype,"layer",void 0);q.__decorate([u.property()],n.prototype,"baseUrl",null);q.__decorate([u.property({type:Boolean})],
n.prototype,"slicePlaneEnabled",void 0);return n=q.__decorate([C.subclass("esri.views.3d.layers.VoxelLayerView3D")],n)});