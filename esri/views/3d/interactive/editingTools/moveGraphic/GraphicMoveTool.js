// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Collection ../../../../../core/Evented ../../../../../core/HandleOwner ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/accessorSupport/decorators/subclass ../../../../../layers/graphics/dehydratedFeatures ../../../../../support/elevationInfoUtils ../../manipulatorUtils ../../SnappingVisualizer3D ../isSupportedGraphicUtils ../manipulatorUtils ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYGraphicManipulation ./isSupportedGraphic ../../visualElements/OutlineVisualElement ../../../layers/graphics/GraphicState ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/sketch/SketchTooltipOptions ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TranslateTooltipInfos ../../../../support/automaticLengthMeasurementUtils ../../../../support/euclideanLengthMeasurementUtils".split(" "),
function(m,C,u,M,N,O,P,n,E,y,w,ja,ka,Q,R,z,S,T,U,V,W,X,q,F,Y,Z,G,aa,H,ba,ca,I,da,ea,fa,A,J,ha){let K=function(p){this.allGraphics=p;this.type="graphic-move-start"},L=function(p,v,l){this.dx=p;this.dy=v;this.allGraphics=l;this.type="graphic-move"},D=function(p){this.allGraphics=p;this.type="graphic-move-stop"};m.GraphicMoveTool=function(p){function v(b){b=p.call(this,b)||this;b.graphics=new M;b.enableZ=!0;b.tooltipOptions=new I;b.type="move-3d";b._tooltip=null;return b}C._inheritsLoose(v,p);var l=
v.prototype;l.initialize=function(){const {graphics:b,view:a}=this;this.addHandles([b.on("change",()=>this._refreshManipulators()),y.watch(()=>this.tooltipOptions.enabled,d=>{this._tooltip=d?new fa.Tooltip({view:a}):n.destroyMaybe(this._tooltip)},y.syncAndInitial)]);this._refreshManipulators();this.finishToolCreation()};l.destroy=function(){this._tooltip=n.destroyMaybe(this._tooltip);this._moveManipulation=n.destroyMaybe(this._moveManipulation);this.graphics.removeAll();this._set("view",null)};l.reset=
function(){};l._refreshManipulators=function(){this.handles.removeAll();this._moveManipulation?.destroy();this.manipulators.removeAll();const b=this.graphics.toArray().filter(a=>Z.isSupportedGraphic(a)===U.SupportedGraphicResult.SUPPORTED).map(a=>new ia(a));b.length&&(this._createManipulators(b),this._createVisualElements(b),this.handles.add(b.map(a=>this.view.trackGraphicState(a.state))),this._updateMoveManipulation(b))};l._createManipulators=function(b){for(const a of b){const d=a.state;a.manipulationXY=
new Y.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:d});a.manipulationXY.forEachManipulator(e=>this.handles.add([e.events.on("immediate-click",c=>{this.emit("immediate-click",{...c,graphic:d.graphic});c.stopPropagation()}),e.events.on("grab-changed",({action:c})=>{const {tooltipOptions:f,_tooltip:g}=this;n.isNone(g)||("start"===c?g.info=new A.TranslateGraphicTooltipInfo({tooltipOptions:f}):g.clear())})]));this.handles.add(a.manipulationXY.createDragPipeline((e,c,f,g)=>this._buildDragEventPipeline(b,
q.ManipulationType.XY,e,c,f,g)))}this._createMoveManipulation(b)};l._createMoveManipulation=function(b){const a=new q.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===b.length?q.MoveManipulation.radiusForSymbol(b[0].graphic.symbol):X.DISC_RADIUS});this._moveManipulation=a;a.elevationInfo={mode:"absolute-height",offset:0};a.forEachManipulator(c=>{this.handles.add(c.events.on("immediate-click",f=>{a.zManipulation.hasManipulator(c)||
1!==this.graphics.length||this.emit("immediate-click",{...f,graphic:this.graphics.getItemAt(0)});f.stopPropagation()}))});var d=c=>f=>{this.handles.add(f.events.on("focus-changed",({action:g})=>{const k=this._tooltip;n.isNone(k)||("focus"===g?this._updateMoveTooltip(b,c):k.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(d(q.ManipulationType.XY));this._moveManipulation.xyAxisManipulation.forEachManipulator(d(q.ManipulationType.XY_AXIS));this._moveManipulation.zManipulation.forEachManipulator(d(q.ManipulationType.Z));
d=()=>this._updateMoveManipulation(b);for(const c of b)this.handles.add([c.state.on("changed",d),y.watch(()=>c.state.displaying,d)]);const e=b[b.length-1];this.handles.add(e.state.on("changed",()=>this._updateMoveManipulationAngle(e)));this.handles.add(a.createDragPipeline((c,f,g,k,r)=>this._buildDragEventPipeline(b,c,f,g,k,r),z.getGraphicEffectiveElevationInfo(e.graphic),n.unwrap(e.graphic.geometry).spatialReference,e.graphic));this._updateMoveManipulationAngle(e)};l._createVisualElements=function(b){for(const a of b){const d=
W.createVisualElements({view:this.view,graphic:a.graphic,forEachManipulator:e=>{a.manipulationXY?.forEachManipulator(e);this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>P.makeHandle()});n.isNone(d)||(a.geometryRepresentation=d.visualElement,a.geometryRepresentation instanceof G.OutlineVisualElement&&this.handles.add([a.geometryRepresentation.events.on("attachment-origin-changed",()=>{a.state.isDraped||this._updateMoveManipulation(b)}),y.watch(()=>a.state.isDraped,()=>this._updateMoveManipulation(b))]),
this.handles.add(d))}};l._updateMoveManipulationAngle=function(b){this._moveManipulation.angle=F.shapeOrientation(b.graphic.geometry)};l._updateMoveManipulation=function(b){const a=R.makeDehydratedPoint(0,0,0,this.view.spatialReference);let d=0,e=!1;const c=this._moveManipulation;for(const f of b)if(f.state.displaying&&(b=f.state.graphic,this.enableZ&&V.canMoveZ(b)&&(e=!0),b=f.geometryRepresentation instanceof G.OutlineVisualElement&&!f.state.isDraped?f.geometryRepresentation.attachmentOrigin:S.getGraphicAttachmentOrigin(this.view,
b),n.isSome(b))){const {x:g,y:k,z:r}=b;a.x+=g;a.y+=k;r&&(a.z??(a.z=0),a.z+=r);d++}0<d?(a.x/=d,a.y/=d,a.z??(a.z=0),a.z/=d,c.location=a,c.xyManipulation.available=!0,c.xyAxisManipulation.available=!0,c.zManipulation.available=e):c.available=!1};l._buildDragEventPipeline=function(b,a,d,e,c,f){const g=[],k=[];let r=null,x=null;const B=()=>{for(const h of g)h.dragging=!1;g.length=0;k.length=0;x=r=null;this._moveManipulation.interactive=!0};if(1===b.length&&a===q.ManipulationType.XY){const h=b[0].graphic;
({steps:e,cancel:c}=this._buildSnappingPipelineSteps(h,z.getGraphicEffectiveElevationInfo(h),e,c,f))}c=c.next(h=>x?.(h)).next(()=>{this.emit("graphic-move-stop",new D(k));this.destroyed||B();return null});e=e.next(h=>{if("start"===h.action){g.length=0;k.length=0;for(const t of b)t.dragging||!t.manipulationXY?.hasManipulator(d)&&t.manipulationXY?.grabbing||(g.push(t),k.push(t.graphic),t.dragging=!0);if(0!==k.length&&(this._moveManipulation.interactive=!1,r=H.dragGraphicMany(k,this.view.state.viewingMode),
x=H.resetGraphicMany(k),this.emit("graphic-move-start",new K(k)),this.destroyed))return null}return 0!==k.length?h:null}).next(h=>r?.(h)).next(h=>{this._updateMoveTooltip(b,a,h);return h}).next(h=>{switch(h.action){case "start":case "update":if(h.translationX||h.translationY||h.translationZ){const t=this.view.toScreen(h.mapStart);h=this.view.toScreen(h.mapEnd);this.emit("graphic-move",new L(h.x-t.x,h.y-t.y,k))}break;case "end":this.emit("graphic-move-stop",new D(k)),this.destroyed||B()}return null});
return{steps:e,cancel:c}};l._updateMoveTooltip=function(b,a,d){const {tooltipOptions:e,_tooltip:c}=this;if(!n.isNone(c)){c.clear();var f=0===b.length?"absolute-height":b[0].state.isDraped?"on-the-ground":"absolute-height";switch(a){case q.ManipulationType.XY:c.info=new A.TranslateGraphicTooltipInfo({tooltipOptions:e});this._updateMoveTooltipDistance(c.info,d,(g,k)=>J.autoHorizontalDistanceByElevationModeBetweenPoints(g,k,f));break;case q.ManipulationType.XY_AXIS:c.info=new A.TranslateGraphicXYTooltipInfo({tooltipOptions:e});
this._updateMoveTooltipDistance(c.info,d,(g,k)=>{g=J.autoHorizontalDistanceByElevationModeBetweenPoints(g,k,f);return E.scale(g,F.axisConstrainedDragSign(d))});break;case q.ManipulationType.Z:c.info=new A.TranslateGraphicZTooltipInfo({tooltipOptions:e}),this._updateMoveTooltipDistance(c.info,d,ha.verticalSignedDistanceBetweenPoints)}}};l._updateMoveTooltipDistance=function(b,a,d){if(n.isSome(a)&&"end"!==a.action){const {mapStart:e,mapEnd:c}=a;a=d(e,c);b.distance=n.isSome(a)?a:E.zeroMeters}};l._buildSnappingPipelineSteps=
function(b,a,d,e,c){const f=b.geometry;if(n.isNone(f)||"point"!==f.type&&"mesh"!==f.type)return{steps:d,cancel:e};const g=("point"===f.type?f:f.anchor).clone(),k=new da.SnappingContext({elevationInfo:a,pointer:c,editGeometryOperations:ca.EditGeometryOperations.fromGeometry(g,this.view.state.viewingMode),visualizer:new T.SnappingVisualizer3D,excludeFeature:b}),{snappingStep:r,cancelSnapping:x}=ea.createSnapDragEventPipelineStep({snappingContext:k,snappingManager:this.snappingManager,updatingHandles:this.updatingHandles});
e=e.next(x);d=d.next(B=>{g.z=z.getConvertedElevation(this.view,g,z.getGraphicEffectiveElevationInfo(b),{mode:"absolute-height",offset:0});const h=k.coordinateHelper.pointToVector(g);return{...B,snapOrigin:h}}).next(...r);return{steps:d,cancel:e}};C._createClass(v,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"test",get:function(){return{tooltip:this._tooltip}}}]);return v}(O.HandleOwnerMixin(N.EventedMixin(ba.InteractiveToolBase)));u.__decorate([w.property({constructOnly:!0,
nonNullable:!0})],m.GraphicMoveTool.prototype,"view",void 0);u.__decorate([w.property()],m.GraphicMoveTool.prototype,"graphics",void 0);u.__decorate([w.property({constructOnly:!0,nonNullable:!0})],m.GraphicMoveTool.prototype,"enableZ",void 0);u.__decorate([w.property({constructOnly:!0,type:I})],m.GraphicMoveTool.prototype,"tooltipOptions",void 0);u.__decorate([w.property({constructOnly:!0})],m.GraphicMoveTool.prototype,"snappingManager",void 0);u.__decorate([w.property()],m.GraphicMoveTool.prototype,
"type",void 0);u.__decorate([w.property()],m.GraphicMoveTool.prototype,"updating",null);m.GraphicMoveTool=u.__decorate([Q.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],m.GraphicMoveTool);let ia=function(){function p(v){this.manipulationXY=this.geometryRepresentation=null;this.dragging=!1;this.state=new aa.GraphicState({graphic:v})}C._createClass(p,[{key:"graphic",get:function(){return this.state.graphic}}]);return p}();m.GraphicMoveEvent=L;m.GraphicMoveStartEvent=
K;m.GraphicMoveStopEvent=D;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});