// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Cyclical ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4f64 ../../../../../geometry/support/plane ../../../../../geometry/support/ray ../../../../../geometry/support/vectorStacks ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../../RenderObject ../dragEventPipeline3D ../ManipulatorType ../manipulations/config ../../../webgl-engine/lib/basicInterfaces ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Material ../../../webgl-engine/materials/ColorMaterial ../../../../interactive/dragEventPipeline ../../../../interactive/interfaces ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TransformTooltipInfos".split(" "),
function(U,Z,aa,ba,ca,I,k,H,J,da,ea,F,fa,x,K,ha,L,M,r,ia,ja,ka,y,la,ma,d,na,Q,oa,pa,qa,C,ra,R){function sa(c,e){var a=x.subtract(r.sv3d.get(),e.renderStart,c.origin);c=x.subtract(r.sv3d.get(),e.renderEnd,c.origin);a=x.length(a);c=x.length(c);return 0===a?0:c/a}function ta(c,e,a,b){const {renderStart:h,renderEnd:l}=c;var g=N(h,b,r.sv3d.get());c=N(l,b,r.sv3d.get());if(x.squaredDistance(g,c)<d.DRAG_THRESHOLD_PX*d.DRAG_THRESHOLD_PX)return null;const t=x.subtract(r.sv3d.get(),h,a);e=x.cross(r.sv3d.get(),
t,L.normal(e));e=x.add(r.sv3d.get(),h,e);a=N(a,b,r.sv3d.get());b=N(e,b,r.sv3d.get());e=x.subtract(r.sv3d.get(),b,g);b=x.subtract(r.sv3d.get(),g,a);g=M.wrap(g,e);b=M.wrap(a,b);return M.distance2(g,c)<M.distance2(b,c)?"rotate":"scale"}function N(c,e,a){e.projectToScreen(c,S);return x.set(a,S[0],S[1],0)}function V(c,e){let a=null,b=1;const h=()=>b;return{start:()=>{b=c.getScale();a=c.getScale;c.getScale=h;e()},update:l=>{b+=((b+1)/2-b)*Math.min(l*d.RING_RESET_ANIMATION_SPEED_FACTOR,1);e();return.01>
Math.abs(b-1)?G.STOP:G.CONTINUE},destroy:()=>{a&&(c.getScale=a);e()}}}function ua(c,e,a){let b=0,h=null;const l=()=>!1;return{start:()=>{h=c.getFocused;c.getFocused=l;b=0;e()},update:g=>{b+=g;return!h?.()||b>=a.delayMs?G.STOP:G.CONTINUE},destroy:()=>{h&&(c.getFocused=h);e()}}}function O(c){switch(c){case "integer":case "long":return 0;default:return null}}var f;(function(c){c.ScaleIn=C.ManipulatorStateCustomFlags.Custom2;c.ScaleOut=C.ManipulatorStateCustomFlags.Custom3;c.RotateLeft=C.ManipulatorStateCustomFlags.Custom4;
c.RotateRight=C.ManipulatorStateCustomFlags.Custom5;c.Unlocked=C.ManipulatorStateCustomFlags.Custom7;c.DelayedFocused=C.ManipulatorStateCustomFlags.Custom8;c.TouchInput=C.ManipulatorStateCustomFlags.Custom12})(f||(f={}));let va=function(){function c({adapter:a,tooltipOptions:b,mode:h,tool:l}){this._mode=null;this._handles=new ca;this._activeAnimation=this._scaleRotateDragData=null;this._ringIndicatorDelayMs=d.RING_INDICATOR_DELAY_MS;this.events=new ba;this.getFocused=()=>this._ringManipulator.focused;
this.getScale=()=>k.isSome(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this._adapter.scale:1;this.tool=l;this._mode=h;this._adapter=a;this._tooltipOptions=b;this._tooltip=new ra.Tooltip({view:l.view});this._createManipulator();this._updateDragState();this._updateManipulatorTransform();this._handles.add(J.when(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),J.initial))}var e=c.prototype;e.destroy=function(){k.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),
this._activeAnimation=null);this._handles=k.destroyMaybe(this._handles);this.tool.manipulators.remove(this._ringManipulator);this._ringManipulator=null;this._tooltip=k.destroyMaybe(this._tooltip)};e.startAnimation=function(a){this.cancelActiveAnimation();a.start();const b=da.addFrameTask({update:({deltaTime:h})=>{a.update(h)&&this.cancelActiveAnimation()}});this._activeAnimation={...a,frameTask:b}};e.cancelActiveAnimation=function(){k.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),
this._activeAnimation=k.destroyMaybe(this._activeAnimation))};e.forEachManipulator=function(a){a(this._ringManipulator,ma.ManipulatorType.SCALE_ROTATE)};e._createManipulator=function(){const a=this._createRingManipulator();this._ringManipulator=a;this.tool.manipulators.add(a);const b=this.tool.graphicState.graphic,h=qa.createManipulatorDragEventPipeline(a,(l,g,t)=>{this._scaleRotateDragData=null;const A=this._adapter.startInteraction(),p={mode:"none",origin:K.clone(l.renderLocation),initialAngle:this._adapter.angle,
angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=p;this._updateDragState();const B=r.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(l.renderLocation,B);g.next(la.screenToRenderPlane(this.tool.view,L.fromPositionAndNormal(l.renderLocation,B,L.create()))).next(m=>{var n=L.normal(m.plane);n=ka.calculateInputRotationTransform(m.renderStart,m.renderEnd,p.origin,n);var q=aa.cyclicalPI.shortestSignedDiff(p.angle,n);p.angleDir=I.clamp(p.angleDir+q,-d.ROTATE_INDICATOR_DIRECTION_BUFFER,
d.ROTATE_INDICATOR_DIRECTION_BUFFER);p.angle=n;q=sa(p,m);p.scaleDir=I.clamp(p.scaleDir+(q-this._adapter.scale),-d.SCALE_INDICATOR_DIRECTION_BUFFER,d.SCALE_INDICATOR_DIRECTION_BUFFER);this._onScaleChanged();if("none"===p.mode){const v=this._mode||ta(m,m.plane,p.origin,this.tool.view.state.camera);if(k.isSome(v)){switch(v){case "rotate":this.tool.emit("graphic-rotate-start",{graphic:b,angle:0});this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case "scale":this.tool.emit("graphic-scale-start",
{graphic:b,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}p.mode=v}}switch(p.mode){case "rotate":A.state.angle=p.initialAngle+n;break;case "scale":A.state.scale=q,this._onScaleChanged()}this._updateDragState();this._updateManipulatorTransform();switch(m.action){case "start":case "update":switch(p.mode){case "rotate":this.tool.emit("graphic-rotate",{graphic:b,angle:I.rad2deg(p.angle)});break;case "scale":this.tool.emit("graphic-scale",{graphic:b,xScale:q,
yScale:q})}break;case "end":switch(p.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:b,angle:I.rad2deg(p.angle)});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:b,xScale:q,yScale:q})}}"end"===m.action&&(this.startAnimation(V(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),A.done());return m}).next(this._updateTooltipPipelineStep(p));t.next(()=>{A.cancel();if(k.isSome(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case "rotate":this.tool.emit("graphic-rotate-stop",
{graphic:b,angle:0});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:b,xScale:1,yScale:1})}this.startAnimation(V(this,()=>this._onScaleChanged()));this._scaleRotateDragData=null;this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([h,a.events.on("focus-changed",l=>{"focus"===l.action?this.startAnimation(ua(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),a.events.on("immediate-click",l=>{l.stopPropagation()}),
J.watch(()=>this.tool.graphicState?.displaying,l=>this._ringManipulator.available=l,J.initial)])};e._updateTooltipPipelineStep=function(a){return b=>{const h=this._tooltipOptions;if(!h.enabled)return b;if("end"===b.action)return this._updateFocusTooltip(),b;const l=this._tooltip;var g=this._tooltipOptions.visualVariables,t=k.isSome(g)?g.size:null;g=k.isSome(g)?g.rotation:null;switch(a.mode){case "scale":l.info=new R.TransformScaleTooltipInfo({tooltipOptions:h,scale:{value:this._adapter.scale},size:H.createLength(k.unwrapOr(this._adapter.size,
-1),"meters"),sizeUnit:k.isSome(t)?t.unit:null,sizePrecision:k.isSome(t)?O(t.valueType):null});break;case "rotate":t=k.isSome(g)?O(g.valueType):null,g=k.isSome(g)?g.rotationType:"geographic",l.info=new R.TransformRotateTooltipInfo({tooltipOptions:h,rotation:H.createAngle(k.unwrapOr(-this._adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:t,orientation:H.createAngle(-this._adapter.angle,"radians","geographic"),orientationPrecision:t,rotationType:g})}return b}};e._updateFocusTooltip=
function(){if(this._tooltipOptions.enabled)if(this.getFocused()){var a=this._tooltipOptions.visualVariables;const b=k.isSome(a)?a.rotation:null;a=k.isSome(a)?a.size:null;this._tooltip.info=new R.TransformAbsoluteTooltipInfo({tooltipOptions:this._tooltipOptions,orientation:H.createAngle(-this._adapter.angle,"radians","geographic"),orientationEnabled:null==this._mode||"rotate"===this._mode,orientationPrecision:k.isSome(b)?O(b.valueType):null,rotationType:k.isSome(b)?b.rotationType:"geographic",size:H.createLength(k.unwrapOr(this._adapter.size,
-1),"meters"),sizeUnit:k.isSome(a)?a.unit:null,sizeEnabled:null==this._mode||"scale"===this._mode,sizePrecision:k.isSome(a)?O(a.valueType):null})}else this._tooltip.clear()};e._onScaleChanged=function(){this.events.emit("scale-changed");this._updateManipulatorTransform()};e._updateDelayedFocusedState=function(){this._ringManipulator.updateStateEnabled(f.DelayedFocused,this.getFocused());this._updateFocusTooltip()};e._updateDragState=function(){this._ringManipulator.updateStateEnabled(f.Unlocked,!(k.isSome(this._scaleRotateDragData)&&
"none"!==this._scaleRotateDragData.mode));if(k.isSome(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case "rotate":this._ringManipulator.updateStateEnabled(f.ScaleIn|f.ScaleOut,!1);this._ringManipulator.updateStateEnabled(f.RotateLeft,0>this._scaleRotateDragData.angleDir);this._ringManipulator.updateStateEnabled(f.RotateRight,0<=this._scaleRotateDragData.angleDir);break;case "scale":this._ringManipulator.updateStateEnabled(f.RotateLeft|f.RotateRight,!1),this._ringManipulator.updateStateEnabled(f.ScaleIn,
0>this._scaleRotateDragData.scaleDir),this._ringManipulator.updateStateEnabled(f.ScaleOut,0<=this._scaleRotateDragData.scaleDir)}else this._ringManipulator.updateStateEnabled(f.ScaleIn|f.ScaleOut|f.RotateLeft|f.RotateRight,!1)};e._updateManipulatorTransform=function(){const a=F.fromRotation(r.sm4d.get(),this._adapter.angle,K.fromValues(0,0,1));if(!k.isNone(a)){var b=this.getScale();b=F.fromScaling(r.sm4d.get(),x.set(r.sv3d.get(),b,b,b));this._ringManipulator.modelTransform=F.multiply(r.sm4d.get(),
b,a)}};e._createRingManipulator=function(){var a=(w,D,P)=>{const W=[],X=Math.ceil(d.GEOMETRY_SEGMENTS*(D-w)/(2*Math.PI));for(let T=0;T<X+1;T++){const Y=w+T*(D-w)/X;W.push(K.fromValues(P*Math.cos(Y),P*Math.sin(Y),0))}return W};const b=this._createMaterial(1);var h=(w,D,P=b)=>Q.createPathExtrusionGeometry(P,[[-D/2,0],[D/2,0],[D/2,d.RING_HEIGHT/2],[-D/2,d.RING_HEIGHT/2]],w,[],[],!1),l=a(0,2*Math.PI,d.RING_RADIUS),g=h(l,d.RING_THICKNESS),t=[],A=[];const p=[];for(var B=0;2>B;B++){var m=B*Math.PI-Math.PI/
4,n=Math.PI/2-d.ROTATE_INDICATOR_ARC_LENGTH,q=m+n;m=m+Math.PI/2-n;n=a(q,m,d.INNER_INDICATOR_RADIUS);var v=h(n,d.INDICATOR_THICKNESS);p.push(n);p.push(a(q,m,d.OUTER_INDICATOR_RADIUS-d.RING_THICKNESS/2));t.push(v);A.push(v.instantiate());for(v=0;2>v;v++){var E=0===v,u=fa.create();if(E){F.scale(u,u,[1,-1,1]);F.rotate(u,u,-q,[0,0,1]);var z=Math.round(d.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(n.length-1));u[12]=n[z][0];u[13]=n[z][1];u[14]=n[z][2]}else F.rotate(u,u,m,[0,0,1]),z=Math.round((1-d.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*
(n.length-1)),u[12]=n[z][0],u[13]=n[z][1],u[14]=n[z][2];z=Q.createExtrudedTriangle(b,d.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,d.ROTATE_INDICATOR_ARROW_TIP_RADIUS,d.RING_HEIGHT);Q.transformInPlace(z,u);(E?t:A).push(z)}}B=[];for(q=0;2>q;q++)m=q*Math.PI-Math.PI/4,n=Math.PI/2-d.SCALE_INDICATOR_ARC_LENGTH,m=a(m+n,m+Math.PI/2-n,d.OUTER_INDICATOR_RADIUS),B.push(h(m,d.INDICATOR_THICKNESS));E=this._createMaterial(.66);q=this._createMaterial(.5);n=this._createMaterial(.33);m=a(0,2*Math.PI,d.RING_RADIUS+d.SCALE_INDICATOR_OFFSET1);
v=a(0,2*Math.PI,d.RING_RADIUS+d.SCALE_INDICATOR_OFFSET2);m=h(m,d.INDICATOR_THICKNESS,E);v=h(v,d.INDICATOR_THICKNESS,n);u=a(0,2*Math.PI,d.RING_RADIUS-d.SCALE_INDICATOR_OFFSET1);a=a(0,2*Math.PI,d.RING_RADIUS-d.SCALE_INDICATOR_OFFSET2);E=h(u,d.INDICATOR_THICKNESS,E);h=h(a,d.INDICATOR_THICKNESS,n);g=[new y.RenderObject(g,f.DelayedFocused),new y.RenderObject(g.instantiate({material:q}),C.ManipulatorStateFlags.None)];this._mode&&"scale"!==this._mode||(g=g.concat([...B.map(w=>new y.RenderObject(w,f.DelayedFocused|
f.Unlocked)),new y.RenderObject(m,f.DelayedFocused|f.ScaleIn),new y.RenderObject(v,f.DelayedFocused|f.ScaleIn),new y.RenderObject(E,f.DelayedFocused|f.ScaleOut),new y.RenderObject(h,f.DelayedFocused|f.ScaleOut)]));this._mode&&"rotate"!==this._mode||(g=g.concat([...A.map(w=>new y.RenderObject(w.instantiate(),f.DelayedFocused|f.Unlocked)),...t.map(w=>new y.RenderObject(w,f.DelayedFocused|f.RotateLeft)),...A.map(w=>new y.RenderObject(w,f.DelayedFocused|f.RotateRight))]));l=[l,...p];return new ja.Manipulator3D({view:this.tool.view,
renderObjects:g,autoScaleRenderObjects:!1,worldOriented:!0,radius:d.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:ia.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:l,direction:K.fromValues(0,0,1)}})};e._createMaterial=function(a){const b=ha.fromArray([...d.HANDLE_COLOR,a]);return new pa.ColorMaterial({color:b,transparent:1!==a,cullFace:na.CullFaceOptions.Back,renderOccluded:oa.RenderOccludedFlag.Transparent})};Z._createClass(c,
[{key:"angle",get:function(){return this._adapter.angle}},{key:"scale",get:function(){return this._adapter.scale}},{key:"location",set:function(a){this._ringManipulator.location=a}},{key:"elevationAlignedLocation",set:function(a){this._ringManipulator.elevationAlignedLocation=a}},{key:"grabbing",get:function(){return this._ringManipulator.grabbing}},{key:"interactive",set:function(a){this._ringManipulator.interactive=a}},{key:"test",get:function(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:a=>
this._ringIndicatorDelayMs=a,tooltip:this._tooltip}}}]);return c}();var G;(function(c){c[c.CONTINUE=0]="CONTINUE";c[c.STOP=1]="STOP"})(G||(G={}));const S=ea.createScreenPointArray();U.GraphicScaleRotateTransform=va;Object.defineProperty(U,Symbol.toStringTag,{value:"Module"})});