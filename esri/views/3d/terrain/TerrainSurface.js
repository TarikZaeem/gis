// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../core/Accessor ../../../core/arrayUtils ../../../core/CollectionFlattener ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/ObjectPool ../../../core/PooledArray ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../../../core/support/WatchUpdatingTracking ../../../geometry/ellipsoidUtils ../../../geometry/projection ../../../geometry/SpatialReference ../../../geometry/support/aaBoundingRect ../../../geometry/support/frustum ../../../geometry/support/spatialReferenceUtils ../../../layers/mixins/RefreshableLayer ../../../layers/support/ElevationQueryTileCache ../../../layers/support/ElevationTileData ../../../layers/support/layerUtils ../../../layers/support/LercDecoder ../../2d/engine/vectorTiles/VectorTile ../support/cameraUtils ../support/debugFlags ../support/extentUtils ../support/index ../support/updatingProperties ./ElevationBounds ./ElevationData ./ExtentHelper ./interfaces ./LayerClass ./OverlayManager ./PlanarPatch ./RenderOrder ./ScaleRangeQueries ./SphericalPatch ./SplitLimits ./TerrainConst ./TerrainRenderer ./TerrainSurfacePerformanceInfo ./terrainUtils ./Tile ./TilePerLayerInfo ./TileUpdate ./tileUtils ./TilingSchemeLogic ./UpsampleInfo ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl ../webgl-engine/lib/basicInterfaces ../../support/RenderState ../../support/Scheduler".split(" "),
function(fa,S,l,ha,k,ia,ja,ka,la,B,ma,q,K,T,D,t,m,Sa,na,oa,pa,qa,U,ra,sa,ta,I,V,A,L,ua,va,wa,xa,ya,za,Aa,Ba,W,Ca,X,Da,M,Y,Ea,C,x,Fa,Ga,Ha,Ia,Ja,Ka,E,H,La,p,Ma,Na,u,F,Oa,Pa,Z,aa,ba,Qa,P){function ca(w,y){return w[0]===y[0]&&w[1]===y[1]&&w[2]===y[2]}function da(w){w=w.children;if(!w[0])return!1;for(const y of w)if(y.shouldLoad)return!0;for(const y of w)if(da(y))return!0;return!1}function ea(w,y,g){for(const a of w)if(a.containsPointXY(y,g)){for(w=a;w&&!w.renderData;)w=w.children[(y>w.extentMidX?1:0)+
(g<w.extentMidY?2:0)];return Y.sampleElevation(y,g,w?.renderData?.geometryState.samplerData??null)}return null}k=function(w){function y(a){var b=w.call(this,a)||this;b._scaleRangeQueries=new Ia.ScaleRangeQueries;b._iteratorPool=new K(F.IteratorPreorder,c=>c.remove=()=>b._iteratorPool.release(c));b._postorderIterator=new F.IteratorPostorder;b._hasPendingUpdates=!1;b._pendingUpdates=0;b._asyncWorkItems=0;b._allTilesDirty=!0;b._allTilesSorted=!0;b._visibleCached=!1;b._usedMemory=null;b._performanceInfo=
new La;b._viewChanged=!1;b._inFrameTask=!1;b._viewChangeUpdateDirty=!1;b._eyePosRenderSR=U.create();b._eyePosSurfaceSR=U.create();b._splitLimits=new Ka.SplitLimits;b._frustum=L.create();b._viewProjectionMatrix=pa.create();b._layerViews=[[],[]];b._layerIndexByUid=[new Map,new Map];b._basemapLayerViewHandles=new Map;b._handles=new la;b._watchUpdatingTracking=new sa.WatchUpdatingTracking;b._frameTask=P.ImmediateTask;b._allTiles=new T;b._upsampleInfoPool=new K(Pa.UpsampleInfo);b._rootTilesExtent=A.create();
b.updatingProgress=0;b._maxNumUpdating=1;b.maxTextureScale=1.2;b._spatialReference=V.WebMercator;b.visibleElevationBounds=new M.ElevationBounds(Infinity,-Infinity);b.rootTileElevationBounds=new M.ElevationBounds(Infinity,-Infinity);b._updatingRootTiles=!1;b._pendingTilesForElevationUpdateEvent=new Set;b._pendingTilesToUpdate=new Set;b.totalGeometryUpdates=0;b.totalTileUpdates=0;b.oneBatchPerFrameTask=!0;b._layerViewsDirty=!1;b._shading=!0;b._isWebMercator=!1;b._isWebMercatorOnPlateeCarree=!1;b._isGlobal=
!a.view?.state?.isLocal;return b}S._inheritsLoose(y,w);var g=y.prototype;g.initialize=function(){this._lercDecoder=za.acquireDecoder(this.view.resourceController);this._tilePool=this.view.state.isLocal?new K(Ga.PlanarPatch):new K(Ja.SphericalPatch);var a=this.view.resourceController.memoryController;this._upsampleMapCache=a.newCache("esri.views.3d.terrain.upsample",c=>c.unloadMapData());this._elevationQueryCache=new wa.ElevationQueryTileCache(a.newCache("elevation-query"));this._set("overlayManager",
new Fa.OverlayManager({surface:this}));this._handles.add([t.watch(()=>this.overlayManager.hasHighlights,c=>this._renderer.setNeedsHighlight(c)),t.watch(()=>this.overlayManager.rendersOccluded,c=>this._renderer.setRenderOccludedOverlay(c)),t.watch(()=>this.overlayManager.renderer.isEmpty,()=>this._evaluateTransparency())],"overlayManager");this._renderer=new H.TerrainRenderer({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:ta.getReferenceEllipsoid(this.view.spatialReference).radius,
_stage:this.view._stage,_allTiles:this._allTiles});this._handles.add([t.watch(()=>this.baseOpacity,()=>{this._handleLayerViewChanges();this._updateTileTextures(this._evaluateTransparency()?C.TextureUpdate.UNFADED:C.TextureUpdate.IMMEDIATE)},t.syncAndInitial),t.watch(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?C.TextureUpdate.UNFADED:C.TextureUpdate.IMMEDIATE),t.syncAndInitial),t.watch(()=>this.renderingDisabled,()=>this.view?._stage?.renderer.setParameters({terrainRenderingEnabled:!this.renderingDisabled}),
t.sync),t.watch(()=>this.backgroundColor,c=>{this._handleLayerViewChanges();this._renderer.updateTileBackground(c)},t.syncAndInitial),t.watch(()=>this.snapLevel,()=>this._viewChanged=!0,t.sync),t.watch(()=>this.view.pointsOfInterest,c=>{this._renderer.pointsOfInterest=c;this._watchUpdatingTracking.removeAll();c&&this._watchUpdatingTracking.add(()=>c.focus.renderLocation,()=>this._allTilesSorted=!1)}),t.watch(()=>W.TERRAIN_TILE_TREE_SHOW_TILES,c=>{c&&!this._treeDebugger?(new Promise((f,d)=>fa(["../layers/support/TerrainTileTree3DDebugger"],
f,d))).then(({TerrainTileTree3DDebugger:f})=>{!this._treeDebugger&&W.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new f({view:this.view}))}):c||(this._treeDebugger=q.destroyMaybe(this._treeDebugger))},t.initial)]);({spatialReference:a}=this.view);this._extentHelper=Ea.create(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:a});const b=new ja({getCollections:()=>this.view?.defaultsFromMap?.mapCollections?.map(({layers:c})=>c),getChildrenFunction:c=>
c&&"layers"in c?c.layers:null});a=new Oa.TilingSchemeLogic({layers:b,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:a});this._set("tilingSchemeLogic",a);this._updateTilingScheme();this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(X.ClientType.ELEVATION);this._mapDataRequester=this.view.resourceController.createStreamDataRequester(X.ClientType.BASEMAP);this._frameTask=this.view.resourceController.scheduler.registerTask(P.TaskPriority.TERRAIN_SURFACE,
this);this._handles.add([t.watch(()=>this._extentHelper.stencilEnabledExtents,c=>this._renderer.setStencilEnabledLayerExtents(c),t.initial),t.watch(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),t.sync),t.watch(()=>this.extent,()=>this._updateRootTiles(),t.initial),this.view.on("resize",()=>this._viewChangeUpdate()),t.watch(()=>{const c=this.view,f=c.state;return[this._lodBias,this.lodSnapping,c.resourceController?.memoryController?.memoryFactor,f.camera,f.contentCamera,f.fixedContentCamera]},
()=>this._viewChangeUpdate(),t.syncAndInitial),t.watch(()=>this.view.qualitySettings?.tiledSurface?.textureFadeDuration,c=>this._renderer.textureFadingEnabled=0<c,t.initial),t.watch(()=>this.view.qualitySettings?.physicallyBasedRenderingEnabled,c=>this._renderer.pbrMode=c?aa.PBRMode.Terrain:aa.PBRMode.Disabled,t.initial),t.watch(()=>this._userClippingExtent,()=>this._updateClippingExtent(),t.sync)]);this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0));this._handles.add([t.watch(()=>
this.view?.map.ground.shading,()=>{this._updateShadingIfChanged()})]);this._updateShading();this._layerViewsDirty=!0;this._handleLayerViewChanges()};g.destroy=function(){this._frameTask.remove();this._handles.destroy();this._watchUpdatingTracking.destroy();this._lercDecoder=q.releaseMaybe(this._lercDecoder);this._removeAllTiles();this._upsampleMapCache=q.destroyMaybe(this._upsampleMapCache);this._elevationQueryCache=q.destroyMaybe(this._elevationQueryCache);const a=this.tilingSchemeLogic.layers;this._set("tilingSchemeLogic",
q.destroyMaybe(this.tilingSchemeLogic));a.destroy();this._basemapLayerViewHandles.forEach((b,c)=>this._unregisterTiledLayerView(c));this._mapDataRequester=this._elevationDataRequester=null;this._set("overlayManager",q.destroyMaybe(this.overlayManager));this._tilePool=q.destroyMaybe(this._tilePool);Ma.Tile.prune();this._treeDebugger=q.destroyMaybe(this._treeDebugger);this._renderer=q.destroyMaybe(this._renderer);this._iteratorPool=q.destroyMaybe(this._iteratorPool);this._set("view",null);this._upsampleInfoPool=
q.destroyMaybe(this._upsampleInfoPool);Aa.printAllocations();Na.printAllocations()};g.intersect=function(a,b,c,f){this._renderer.intersect(a,b,c,f)};g.getElevation=function(a,b,c,f){const d=this._rootTiles;if(q.isNone(d)||!d.length||0===d[0].layerInfo[x.LayerClass.ELEVATION].length)return null;const e=z;e[0]=a;e[1]=b;e[2]=c;return I.projectVectorToVector(e,f,e,this._spatialReference)?ea(d,e[0],e[1]):(B.getLogger(this.declaredClass).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),
null)};g.getElevations=function(a,b,c){const f=this._rootTiles;var d=f?f[0].layerInfo[x.LayerClass.ELEVATION].length:0;if(q.isNone(f)||!f.length||0===d)for(a=0;a<b;++a)c(a,null);else for(d=0;d<b;++d){var e=3*d;e=ea(f,a[e+0],a[e+1]);c(d,e)}};g.getScale=function(a){if(!this.tilingScheme)return null;if(!I.projectPointToVector(a,z,this.spatialReference))return B.getLogger(this.declaredClass).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;a=this._rootTiles;
if(q.isSome(a))for(var b of a)if(b?.containsPoint(z)){for(;b.children[0]&&!b.rendered;){a=b.children[0].extent;let c=0;z[0]>a[2]&&(c+=1);z[1]<a[1]&&(c+=2);b=b.children[c]}return this._getLodBiasCorrectedScale(b.level)}return Infinity};g.getSphereElevationBounds=function(a,b,c,f,d){z[0]=a;z[1]=b;z[2]=c;z[3]=f;if(!I.projectVectorToVector(z,d,z,this.tilingScheme?.spatialReference))return B.getLogger(this.declaredClass).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),
null;let e=Infinity,h=-Infinity;const n=r=>{if(r&&A.intersectsSphere(r.extent,z))if(r.isLeaf||r.rendered)e=Math.min(e,r.elevationBounds[0]),h=Math.max(h,r.elevationBounds[1]);else for(const v of r.children)n(v)};a=this._rootTiles;if(q.isSome(a))for(const r of a)n(r);return{min:e,max:h}};g.getSphereScale=function(a,b){if(!this.tilingScheme)return null;if(!I.projectPointToVector(a,z,this.spatialReference))return B.getLogger(this.declaredClass).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),
null;z[3]=b;let c=null;const f=d=>{if(d&&A.intersectsSphere(d.extent,z)){const e=d.children;if(e[0]&&!d.rendered)for(const h of e)f(h);else d=this._getLodBiasCorrectedScale(d.level),c=null==c?d:Math.min(c,d)}};a=this._rootTiles;if(q.isSome(a))for(const d of a)f(d);return c};g.queryVisibleScaleRange=function(a,b,c,f){b=b?this.tilingScheme.levelAtScale(b):0;c=c?this.tilingScheme.levelAtScale(c):Infinity;const d=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(a,b+d,c+d,f)};g._evaluateTransparency=
function(){var a=this.baseOpacity;const b=this.overlayManager.renderer.isEmpty;var c=this._renderer.transparency;a=this._allSurfaceLayersTransparent()?b?H.TransparencyMode.Empty:H.TransparencyMode.TransparentWithDraped:1<=a&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?H.TransparencyMode.Opaque:H.TransparencyMode.Semitransparent;if(c=c!==a)this._renderer.transparency=a,this.view?._stage?.renderer.setParameters({terrainTransparency:this._renderer.transparency});return c};g._updateTilingScheme=
function(){const a=this.tilingSchemeLogic.tilingScheme;if(a!==this.tilingScheme){p.weakAssert(!!a,"tiling scheme cannot be reset to undefined");this._isGlobal=!this.view?.state?.isLocal;this.tilingScheme&&this._removeAllTiles();var b=a?.spatialReference??V.WebMercator;this._spatialReference=b;this._isWebMercatorOnPlateeCarree=(this._isWebMercator=!!b?.isWebMercator)&&ua.isPlateCarree(this.view?.renderSpatialReference);this._set("tilingScheme",a);this._updateClippingExtent();a&&(this._updateTiledLayers(),
this._renderer.setTileSize(a.pixelSize),this.overlayManager.setSpatialReference(a.spatialReference),this._updateRootTiles())}};g._acquireTile=function(a,b,c,f){const d=this._tilePool.acquire();N[0]=a;N[1]=b;N[2]=c;d.init(N,f,this);return d};g._updateRootTiles=function(){const {extent:a,tilingScheme:b}=this;if(b){var c=Ra,f=b.rootTilesInExtent(a,c,5*E.MAX_ROOT_TILES);if(q.isSome(this._rootTiles)){if(f.length>E.MAX_ROOT_TILES){B.getLogger(this.declaredClass).warn(E.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);
return}const d=this._rootTiles.map(h=>h.lij),e=ia.difference(d,f,ca);this._updatingRootTiles=!0;if(0<e.removed.length||0<e.added.length){const h=this._rootTiles.filter(n=>-1<e.removed.findIndex(r=>ca(r,n.lij))?(this._purgeTile(n),!1):!0);e.added.forEach(n=>h.push(this._newRootTile(n)));this._setRootTiles(h)}}else this._updatingRootTiles=!0,f.length>E.MAX_ROOT_TILES&&(B.getLogger(this.declaredClass).warn(E.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),f=b.rootTilesInExtent(a,c,E.MAX_ROOT_TILES)),this._setRootTiles(f.map(d=>
this._newRootTile(d)));A.equals(c,this._rootTilesExtent)||(this._rootTilesExtent=A.create(c));this._visible=!0;this._viewChangeUpdate();this.overlayManager.setPlacementDirty();this.notifyChange("ready");this._updateAllTileGeometries();this._updatingRootTiles=!1;this.checkAllTilesWaterproofness()}};g._updateAllTileGeometries=function(){const a=this._allTiles.filter(b=>b.isLoaded&&b.intersectsClippingArea);a.forEach(b=>this._renderer.updateTileGeometryState(b));a.forEach(b=>b.renderData.updateNeighborData());
this._updateTilesGeometries(a);this._pendingTilesToUpdate.clear()};g._updateTilesGeometries=function(a){if(0!==a.length){a.sort(F.compareTilesByLij);var b=this.renderer;a.forEach(c=>b.updateGeometryIfNeeded(c));a.forEach(c=>this._pendingTilesForElevationUpdateEvent.add(c))}};g._shouldSplit=function(a){return a.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===u.TileUpdate.SPLIT};g._newRootTile=function(a){a=this._acquireTile(0,a[1],a[2],null);this._shouldSplit(a)&&a.setPendingUpdate(u.TileUpdate.SPLIT);
this._loadTile(a);this._markTileToUpdate(a);this._updateRootTileElevationBounds();return a};g._setRootTiles=function(a){this._rootTiles=a;this._allTiles.clear();if(q.isSome(a)){const b=this._iteratorPool.acquire();for(b.reset(a);!b.done;)this._allTiles.push(b.next());b.remove()}this._renderer.setRootTiles(this._rootTiles);this._updateTilesVisibility(a)};g._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())};g._viewChangeUpdate=
function(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))};g._updateClippingStatus=function(a){a.updateClippingStatus(this.extent)&&a.resetPendingUpdate(u.TileUpdate.GEOMETRY)&&this._updateTileGeometryState(a)};g._updateTilesVisibility=function(a){if(!q.isNone(a)){var b=F.hasLoadableSiblings(a),c=this.visibleElevationBounds,
f=b?c.min:Infinity;b=b?c.max:-Infinity;var d=this.extent,e=this._viewProjectionMatrix;this.setTileTreeDirty();var h=this._iteratorPool.acquire();for(h.reset(a);!h.done;)a=h.next(),a.updateClippingStatus(d)&&a.resetPendingUpdate(u.TileUpdate.GEOMETRY)&&this._updateTileGeometryState(a),a.setPendingUpdate(u.TileUpdate.RENDERDATA),a.computeVisibility(),a.updateScreenDepth(e),a.renderData&&(f=Math.min(a.elevationBounds[0],f),b=Math.max(a.elevationBounds[1],b));h.remove();this._allTilesDirty=this._viewChanged=
!0;this._batchUpdatePendingTileGeometries();isFinite(f)&&isFinite(b)&&(c.min!==f||c.max!==b)&&(this.visibleElevationBounds=new M.ElevationBounds(f,b))}};g._updateRootTileElevationBounds=function(){let a=Infinity,b=-Infinity;var c=this._rootTiles;q.isSome(c)&&c.forEach(({elevationBounds:f})=>{a=Math.min(a,f[0]);b=Math.max(b,f[1])});c=this.rootTileElevationBounds;if(c.min!==a||c.max!==b)this.rootTileElevationBounds=new M.ElevationBounds(a,b)};g._updateViewDependentParameters=function(){const {camera:a,
contentCamera:b}=this.view.state,c=Math.tan(.5*b.fovX),f=Math.tan(.5*b.fovY),d=this.tilingScheme.pixelSize,e=2**-this._lodBias*a.pixelRatio;this._splitLimits.aboveGround=a.aboveGround;this._splitLimits.fovX=c;this._splitLimits.fovY=f;this._splitLimits.relativeWidthLimit=d/a.width*this.maxTextureScale*e;this._splitLimits.relativeHeightLimit=d/a.height*this.maxTextureScale*e;this._splitLimits.maxLod=this.tilingScheme.getMaxLod();this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias;
this.view.state.fixedContentCamera?(q.isNone(this._splitLimits.frustum)&&(this._splitLimits.frustum=L.create()),L.copy(this._splitLimits.frustum,b.frustum)):this._splitLimits.frustum=null;L.copy(this._frustum,a.frustum);oa.multiply(this._viewProjectionMatrix,b.projectionMatrix,b.viewMatrix);qa.copy(this._eyePosRenderSR,b.eye);I.projectVectorToVector(a.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)};g._updateRenderData=function(a){a.rendered&&!a.shouldLoad&&(da(a)?
this._loadChildren(a):a.isLeaf&&(a.parent?.shouldLoad??!1)&&this._loadParent(a))};g._updateTileGeometryState=function(a){a.updateVisibility();this._renderer.updateTileGeometryState(a)&&this._markTileToUpdate(a);this._usedMemory=null};g._markAllTileNeighborsForGeometryUpdate=function(a){const b=this._pendingTilesToUpdate;a.forEachLoadedNeighbor(c=>{b.add(c)})};g._updateTileTexture=function(a,b){const c=a.resetPendingUpdate(u.TileUpdate.TEXTURE_FADING)?u.TileUpdate.TEXTURE_FADING:a.resetPendingUpdate(u.TileUpdate.TEXTURE_NOFADING)?
u.TileUpdate.TEXTURE_NOFADING:!1;c&&(this._renderer.updateTileTexture(a,c),this._usedMemory=null,b.madeProgress())};g._emitElevationUpdateEventForTiles=function(){const a=Q.extent;A.empty(a);this._pendingTilesForElevationUpdateEvent.forEach(b=>A.expand(a,b.extent,a));this._pendingTilesForElevationUpdateEvent.clear();Q.spatialReference=this.spatialReference;this.emit("elevation-change",Q)};g.runTask=function(a){this._handleLayerViewChanges(a);this._frameTask.processQueue(a);this.renderer.processScaleRangeQueries(this._scaleRangeQueries,
a);this._inFrameTask=!0;this._pendingUpdates=0;this._hasPendingUpdates=!1;this._updateAllTilesStatus(a);this._sortTiles(a);const b=!this.view.state.fixedContentCamera;this._mergeAndSplit(a,b);this._updateElevation(a);this._updateTextures(a);b||this._mergeAndSplit(a,!0);this._inFrameTask=!1;this._runViewChangeUpdateIfDirty();this._batchUpdatePendingTileGeometries();this._emitElevationUpdateEventForTiles();a.done&&a.hasProgressed?this.requestUpdate():this.getUsedMemory();this.notifyChange("updatingProgressValue")};
g._updateAllTilesStatus=function(a){if(this._viewChanged&&this._rootTiles&&!a.done){this._viewChanged=!1;var b=this._iteratorPool.acquire();b.reset(this._rootTiles);for(var c=this.snapLevel,f=this._splitLimits,d=this._eyePosRenderSR;!b.done;){var e=b.next(),h=e.shouldSplit(f,d,c);if(h===u.TileUpdate.SPLIT)e.resetPendingUpdate(u.TileUpdate.MERGE),e.isLeaf&&(e.setPendingUpdate(u.TileUpdate.SPLIT),b.skipSubtree()),e.rendered&&e.setPendingUpdate(u.TileUpdate.RENDERDATA);else if(e.resetPendingUpdate(u.TileUpdate.SPLIT)&&
e.updateAgentSuspension(),h===u.TileUpdate.VSPLITMERGE&&e.updateAgents(x.LayerClass.ELEVATION),b.skipSubtree(),!e.isLeaf){e.setPendingUpdate(u.TileUpdate.MERGE);e.resetPendingUpdate(u.TileUpdate.SPLIT);h=this._iteratorPool.acquire();h.resetOne(e);e=this._viewProjectionMatrix;for(let n=h.next();!h.done;n=h.next())this._updateClippingStatus(n),n.updateVisibility(),n.updateScreenDepth(e);h.remove()}}b.remove();this.requestUpdate();!this.shortBatches&&this.oneBatchPerFrameTask||this._batchUpdatePendingTileGeometries();
a.madeProgress()}};g._sortTiles=function(a){a.done||this._allTilesSorted||(F.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),a.madeProgress())};g._markTileToUpdate=function(a){p.internalAssert(a.isLoaded);a.intersectsClippingArea&&(this._pendingTilesToUpdate.add(a),this._markAllTileNeighborsForGeometryUpdate(a))};g._batchUpdatePendingTileGeometries=function(){const a=this._pendingTilesToUpdate;if(0!==
a.size){var b=Array.from(this._pendingTilesToUpdate.keys()).filter(d=>d.isLoaded&&d.intersectsClippingArea),c=(d,e)=>{!e?.isLoaded||!e.intersectsClippingArea||e.level<d.level||a.has(e)||(a.add(e),b.push(e),e.renderData.updateNeighborData())};b.sort(F.compareTilesByLij);var f=b.length;for(let d=0;d<f;++d){const e=b[d];p.internalAssert(e.isLoaded);p.internalAssert(e.intersectsClippingArea);const h=e.renderData;h.updateNeighborData();const n=h._dirtyEdgeResolutions,r=h.geometryState.neighborData;for(let v=
0;4>v;++v)if(n&1<<v){const G=h.geometryState.neighborData.edgePeerNeighbors[v];G&&G?.level>=e.level&&G.forAllSubtreeOnSide(p.oppositeEdge(p.neighborEdgeIndices[v]),J=>J.isLoaded&&J.intersectsClippingArea?(p.internalAssert(a.has(J)||0>F.compareTilesByLij(e,J)),c(e,J),!0):!1);c(e,r.cornerPeerNeighbors[v]);c(e,r.cornerPeerNeighbors[(v+1)%4])}}a.clear();this._updateTilesGeometries(b);p.ENABLE_TERRAIN_INTERNAL_CHECKS&&p.ENABLE_WATERPROOFNESS_TESTS&&this.checkAllTilesWaterproofness()}};g._mergeAndSplit=
function(a,b){if(!this.suspended&&!a.done&&this._allTilesDirty){this._allTilesDirty=!1;this.requestUpdate();for(var c=!1,f=this.view.state.fixedContentCamera,d=!1;!a.done;){d=!0;let e=!1;const h=!this._allTiles.some(n=>{if(!c&&!f&&!n.visible)return a.done;let r=n;if(n.resetPendingUpdate(u.TileUpdate.MERGE)){if(!b)return n.setPendingUpdate(u.TileUpdate.MERGE),a.done;for(;r.parent?.resetPendingUpdate(u.TileUpdate.MERGE);)r=r.parent;this._mergeTile(r);e=!0;a.madeProgress()}else n.resetPendingUpdate(u.TileUpdate.SPLIT)&&
(this._splitTile(n),e=!0,a.madeProgress());!a.done&&r===n&&n.resetPendingUpdate(u.TileUpdate.RENDERDATA)&&(this._updateRenderData(n),a.madeProgress());return a.done});e&&(this._allTilesSorted=!1,this._allTilesDirty=!0);if(h)if(!c)c=!0;else{if(!e)break}else this._allTilesDirty=!0}d?a.madeProgress():this._allTilesDirty=!0;!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries();this._sortTiles(a)}};g._updateElevation=function(a){a.done||(this._allTiles.some(b=>{b.resetPendingUpdate(u.TileUpdate.GEOMETRY)&&
(this._updateTileGeometryState(b),this._updateTileTexture(b,a),this.shortBatches&&this._batchUpdatePendingTileGeometries(),a.madeProgress());return a.done}),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())};g._updateTextures=function(a){a.done||this._allTiles.some(b=>{this._updateTileTexture(b,a);return a.done})};g._updateClippingExtent=function(){this.spatialReference&&(this.updateTileOverlayParams(ba.RenderRequestType.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())};
g._getLodBiasCorrectedScale=function(a){const b=this.tilingScheme.levels;a=ma.clamp(a-this._lodBias,0,b.length-1);const c=a-Math.floor(a);return b[Math.floor(a)].scale*(1-c)+b[Math.ceil(a)].scale*c};g._removeAllTiles=function(){q.isSome(this._rootTiles)&&(this._rootTiles.forEach(a=>this._purgeTile(a)),this._setRootTiles(null),this.notifyChange("ready"));this._allTiles.clear();this._visible=!1};g._purgeDescendantTiles=function(a){if(!a.children[0])return!1;let b=!1;for(let c=0;4>c;++c)b=this._purgeTile(a.children[c])||
b;a.unsetChildren();return b};g._purgeTile=function(a){const b=this._purgeDescendantTiles(a)||a.rendered;this._allTiles.removeUnordered(a);this._unloadTile(a);this._tilePool.release(a);return b};g._unloadTile=function(a){this._pendingTilesToUpdate.delete(a);this._pendingTilesForElevationUpdateEvent.delete(a);a.unload(this._renderer)};g._splitTile=function(a){p.weakAssert(a.isLeaf,"tile that is already split should not be split again!");const b=a.level+1,c=2*a.lij[1],f=2*a.lij[2];a.setChildren(this._createTile(b,
c,f,a),this._createTile(b,c,f+1,a),this._createTile(b,c+1,f,a),this._createTile(b,c+1,f+1,a));a.setPendingUpdate(u.TileUpdate.RENDERDATA);a.updateAgentSuspension();this._allTiles.pushArray(a.children);this._allTilesDirty=!0;++this._performanceInfo.numSplit};g._emitTileScaleChange=function(a,b=a.level){O.spatialReference=this.spatialReference;O.extent=a.extent;O.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",O)};g._createTile=function(a,b,c,f){p.weakAssert(!!f,"_createTile sanity check");
a=this._acquireTile(a,b,c,f);a.updateClippingStatus(this.extent);a.updateScreenDepth(this._viewProjectionMatrix);this._shouldSplit(a)&&a.setPendingUpdate(u.TileUpdate.SPLIT);return a};g._mergeTile=function(a){p.weakAssert(!a.hasPendingUpdate(u.TileUpdate.SPLIT),"_mergeTile sanity check");this._purgeDescendantTiles(a)&&(p.weakAssert(!a.renderData,"_mergeTile sanity check"),this._loadTile(a),this._markTileToUpdate(a),this._emitTileScaleChange(a),this.shortBatches&&this._batchUpdatePendingTileGeometries());
this._allTilesDirty=!0;++this._performanceInfo.numMerged};g._loadChildren=function(a){p.weakAssert(a.rendered,"parent should be rendered");this._unloadTile(a);const b=a.children;b.forEach(c=>this._loadTile(c));b.forEach(c=>this._pendingTilesToUpdate.add(c));this._markAllTileNeighborsForGeometryUpdate(a);this._emitTileScaleChange(a,a.level+1);this.shortBatches&&this._batchUpdatePendingTileGeometries()};g._loadParent=function(a){a=a.parent;this._unloadChildren(a);this._loadTile(a);this._markTileToUpdate(a);
this._emitTileScaleChange(a,a.level);this.shortBatches&&this._batchUpdatePendingTileGeometries()};g._unloadChildren=function(a){a=a.children;if(a[0])for(let b=0;4>b;++b){const c=a[b];this._unloadChildren(c);this._unloadTile(c)}};g._loadTile=function(a){a.load();a.setPendingUpdate(u.TileUpdate.RENDERDATA);this.requestUpdate();this._allTilesDirty=!0;this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(a)};g._elevationDataArrived=function(a,b,c){c=new Y.ElevationData(a.lij,
a.extent,c);a.dataArrived(b,x.LayerClass.ELEVATION,c);c=[a];a=a.level;const f=this._iteratorPool.acquire();for(f.reset(c);!f.done;){const d=f.next();d.findElevationBoundsForLayer(b,a);d.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds();f.remove();this._updateTilesVisibility(c)};g._handleLayerViewChanges=function(a=P.noBudget){if(this._layerViewsDirty){var b=this._layerViewsDirty=!1,c=new Set,f=-1;for(const e of this.view.allLayerViews.items)if(c.add(e.uid),p.isSurfaceLayerView(e)||
p.isGroupLayerView(e))if(this._basemapLayerViewHandles.has(e.uid)&&!p.isGroupLayerView(e)){var d=this._layerClassFromLayerView(e);d=this._getLayerIdxByUID(d,e.uid);if(q.isSome(d)){if(d<f||q.isNone(f))b=!0;f=d}}else this._registerTiledLayerView(e),e.layer.loaded&&(b=!0);this._basemapLayerViewHandles.forEach((e,h)=>{c.has(h)||(this._unregisterTiledLayerView(h),b=!0)});b&&this._updateTiledLayers();this.hasCompositeBlendMode=this._hasCompositeBlendMode();this._evaluateTransparency();a.madeProgress()}};
g._allSurfaceLayersTransparent=function(){let a=0===this.view.map?.ground?.opacity;for(const b of this.view.allLayerViews.items)if(p.isMapTileLayerView(b)&&!ya.isBaseLayer(b.layer)&&0!==b.fullOpacity){a=!1;break}return a};g._hasCompositeBlendMode=function(){for(const a of this.view.allLayerViews.items)if((p.isBlendableLayerView(a)||p.isGroupLayerView(a))&&Z.isCompositeBlendMode(Z.blendModeFromString[a.layer.blendMode]))return!0;return!1};g._layerClassFromLayerView=function(a){return p.isElevationLayerView(a)?
x.LayerClass.ELEVATION:x.LayerClass.MAP};g._registerTiledLayerView=function(a){const b=[];(p.isBlendableLayerView(a)||p.isGroupLayerView(a))&&b.push(t.watch(()=>a.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode();this._updateTileTextures(C.TextureUpdate.UNFADED)}));if(!p.isGroupLayerView(a)){var c=this._layerClassFromLayerView(a);b.push(t.watch(()=>a.suspended,()=>this._updateTiledLayers()));b.push(t.watch(()=>a.fullOpacity,()=>this._updateTileTextures(C.TextureUpdate.UNFADED)));
b.push(t.watch(()=>"effectiveScaleRange"in a.layer?a.layer.effectiveScaleRange:null,()=>this._restartAllAgents(c)));a.on("data-changed",()=>{const f=this._getLayerIdxByUID(c,a.uid);q.isSome(f)&&this._invalidateLayerData(f,c)});this._basemapLayerViewHandles.set(a.uid,b)}};g._unregisterTiledLayerView=function(a){const b=this._basemapLayerViewHandles.get(a);if(b){for(let c=0;c<b.length;c++)b[c].remove();this._basemapLayerViewHandles.delete(a)}};g._updateTiledLayers=function(){if(this.tilingScheme&&!this.view.suspended){var a=
[[],[]],b=null;this.view.allLayerViews.forEach(f=>{if(f.layer&&!f.suspended&&p.isSurfaceLayerView(f)&&f.fullExtent){var d=this._layerClassFromLayerView(f);if(d===x.LayerClass.MAP){const e=f.displayLevelRange.maxLevel;Infinity!==e&&(null===b||e>b)&&(b=e)}a[d].push(f)}});for(const f of x.LayerClasses){var c=this._layerViews[f];const d=a[f];d.reverse();const e=d.length;let h=c.length!==e;const n=Array(e),r=Array(c.length);this._layerIndexByUid[f].clear();for(let v=0;v<e;v++){this._layerIndexByUid[f].set(d[v].uid,
v);const G=c.indexOf(d[v]);n[v]=G;v!==G&&(h=!0);-1<G&&(r[G]=v)}if(h){c=this._postorderIterator;for(c.reset(this._rootTiles);!c.done;)c.next().modifyLayers(r,n,f);this._layerViews[f]=d;this._restartAllAgents(f);this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(b)&&this._viewChangeUpdate()}};g._restartAllAgents=function(a){const b=this._postorderIterator;for(b.reset(this._rootTiles);!b.done;){const c=b.next();c.restartAgents(a);a===x.LayerClass.ELEVATION&&c.computeElevationBounds()}this._updateRootTileElevationBounds()};
g.layerViewByIndex=function(a,b){return this._layerViews[b][a]};g.numLayers=function(a){return this._layerViews[a].length};g._updateTileTextures=function(a){this._allTiles.forAll(b=>{b.updateAgents(x.LayerClass.MAP);a===C.TextureUpdate.IMMEDIATE?this.renderer.updateTileTexture(b,u.TileUpdate.TEXTURE_NOFADING):b.updateRenderData(x.LayerClass.MAP,a)});this._evaluateTransparency()};g._invalidateLayerData=function(a,b){this._allTiles.forAll(c=>c.removeLayerAgent(a,b));this._allTiles.forAll(c=>c.invalidateLayerData(a,
b))};g.setTileTreeDirty=function(){this._allTilesDirty=!0};g.requestRender=function(a=ba.RenderRequestType.UPDATE){this.renderer.setNeedsRender(a)};g.requestUpdate=function(){1===++this._pendingUpdates&&(this._hasPendingUpdates=!0)};g.requestTileData=function(a,b,c,f){const d=this.layerViewByIndex(b,c);b=d.layer;if(!b.tilemapCache||p.isVectorTileLayerView(d))return this._requestTileData(a,c,d,f);++this._asyncWorkItems;return b.tilemapCache.fetchAvailability(a.lij[0],a.lij[1],a.lij[2],{...f,timeout:6E3}).then(()=>
--this._asyncWorkItems).catch(e=>{--this._asyncWorkItems;D.throwIfAborted(f);D.isAbortError(e)||this._dataMissing(a,c,d,{notInTilemap:!0});throw e;}).then(()=>this._frameTask.schedule(()=>this._requestTileData(a,c,d,f),f.signal))};g._requestTileData=function(a,b,c,f){return b===x.LayerClass.ELEVATION?p.isElevationLayerView(c)?this._requestElevationTileData(a,c,f):Promise.reject():p.isMapTileLayerView(c)?this._requestMapTileData(a,c,f):Promise.reject()};g._requestElevationTileData=function(a,b,c){++this._asyncWorkItems;
const f=h=>{if(!D.isAborted(c)){var n=this._layerIndexByUid[x.LayerClass.ELEVATION].get(b.uid);null==n?B.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer %d %s",x.LayerClass.ELEVATION,a.lij.toString()):(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(a,n,h))}},d=h=>{D.isAbortError(h)||(this._dataMissing(a,x.LayerClass.ELEVATION,b,h),this.requestUpdate())};if(p.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],
{noDataValue:E.ELEVATION_NODATA_VALUE,signal:c.signal}).then(h=>{if(D.isAborted(c))B.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.");else return this._frameTask.schedule(()=>f(h),c.signal,d)},d).finally(()=>{--this._asyncWorkItems});const e=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);return this._elevationDataRequester.request(e,"binary",c).then(h=>this._lercDecoder.decode(h,{noDataValue:E.ELEVATION_NODATA_VALUE},
c.signal)).then(h=>{h?f(new xa.ElevationTileData(h)):d(Error("LERC decoding failed"))},d).finally(()=>{--this._asyncWorkItems})};g._requestMapTileData=function(a,b,c){++this._asyncWorkItems;const f=(r,v)=>{--this._asyncWorkItems;p.releaseTileData(v);D.isAborted(c)||(this._dataMissing(a,x.LayerClass.MAP,b,r),this.requestUpdate())},d=r=>v=>f(v,r),e=r=>this._frameTask.schedule(()=>{--this._asyncWorkItems;this.requestUpdate();D.isAborted(c)?p.releaseTileData(r):this._mapTileDataArrived(a,b,r)},c.signal,
d(r)).catch(d(r)),h=(r,v=null)=>this._frameTask.schedule(()=>f(r,v));if(p.isVectorTileLayerView(b)){var n=b.schemaHelper.getLevelRowColumn(a.lij);return b.fetchTile(n[0],n[1],n[2],c).then(e,h)}if(p.isImageryTileLayerView(b))return b.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(e,h);if(p.isTileLayerView(b)&&p.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(r=>{D.isAborted(c)?(B.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),
h(D.createAbortError())):e(r)},h);n=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);va.isRefreshableLayer(b.layer)&&b.layer.refreshTimestamp&&(n+=`${n.includes("?")?"\x26":"?"}_ts=${b.layer.refreshTimestamp}`);return this._mapDataRequester.request(n,b.hasMixedImageFormats?"image+type":"image",c).then(e,h)};g._mapTileDataArrived=function(a,b,c){b=this._getLayerIdxByUID(x.LayerClass.MAP,b.uid);q.isSome(b)?a.dataArrived(b,x.LayerClass.MAP,c):(p.releaseTileData(c),B.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer"))};
g._getLayerIdxByUID=function(a,b){return this._layerIndexByUid[a].get(b)};g._dataMissing=function(a,b,c,f){c=this._getLayerIdxByUID(b,c.uid);q.isSome(c)?a.dataMissing(c,b,f):B.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer")};g.updateTileOverlayParams=function(a){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll(b=>{b.renderData&&this.overlayManager.setTileParameters(b)}),this._renderer.setNeedsRender(a))};g.getUsedMemory=function(){if(!this.tilingScheme)return 0;
q.isNone(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory());return q.isSome(this._usedMemory)?this._usedMemory:0};g._recalculateUsedMemory=function(){return this.tilingScheme?this._allTiles.reduce((a,b)=>a+b.usedMemory,0):null};g.getUsedMemoryForLayerView=function(a){let b=0;const c=this._layerClassFromLayerView(a),f=this._getLayerIdxByUID(c,a.uid);q.isSome(f)&&this._allTiles.forAll(d=>b+=d.getUsedMemoryForLayer(c,f));return b};g.getTile=function(a){if(q.isNone(a)||q.isNone(this._rootTiles))return null;
const b=a.split("/").map(e=>+e);if(0===b[0])return this._rootTiles.find(e=>e.lij[1]===b[1]&&e.lij[2]===b[2]);a=2**b[0];const c=Math.floor(b[1]/a),f=Math.floor(b[2]/a);let d;this._rootTiles.some(e=>e.lij[1]===c&&e.lij[2]===f?(d=e,!0):!1);if(d){for(a=1<<b[0]-1;d.lij[0]<b[0];){let e=b[1]&a?2:0;0<(b[2]&a)&&e++;if(!d.children[e])return null;d=d.children[e];a>>=1}p.weakAssert(d.lij[0]===b[0]&&d.lij[1]===b[1]&&d.lij[2]===b[2],"not the right tile?");return d}return null};g.checkAllTilesWaterproofness=function(){if(p.ENABLE_WATERPROOFNESS_TESTS){var a=
this._rootTiles;if(!q.isNone(a)){var b=d=>0<d?.renderData?.geometryInfo?.indices?.length,c=d=>{if(d.intersectsClippingArea)if(d.renderData&&!d.renderData.geometryState&&console.error("Tile[",d.lij,"] has renderData but not geometryState"),d.renderData&&!d.renderData.geometryInfo&&console.error("Tile[",d.lij,"] has renderData but not geometryInfo"),!d.renderData?.geometryInfo||0<(d.renderData.geometryInfo.indices?.length??0)||console.error("Tile[",d.lij,"] has renderData but no indices - geometryInfo: ",
d.renderData.geometryInfo),b(d)){d.checkGeometryWaterproofness();for(const n of d.children){var e=n,h=d;b(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",h.lij,"] has geom")}}else if(d.isLeaf)console.error("Tile[",d.lij,"] has no geometry and no children, from root to leaf");else for(e of d.children)c(e)},f=d=>{const e=d.parent?.visible??!0,h=d.visible;d.computeVisibility();const n=d.visible;h!==n&&e&&console.error(" Tile[",d.lij,"] has out of date visibility: ",h," instead of ",
n);if(!d.isLeaf)for(const r of d.children)f(r)};for(const d of a)c(d),f(d)}}};g._updateShadingIfChanged=function(){this.view?.map?.ground?.shading!==this._shading&&this._updateShading()};g._updateShading=function(){const a=this.view?.map?.ground?.shading;this._shading=a;this.renderer&&(this.renderer.shading=a,this.renderer.setNeedsRender());this._updateAllTileGeometries()};g.isEastEndWrap=function(a){return this.isGlobal&&a[2]===this.lijEastEnd(a[0])-1};g.isWestEndWrap=function(a){return this.isGlobal&&
0===a[2]};g.lijEastEnd=function(a){const b=q.isSome(this.spatialReference)&&this.spatialReference.isGeographic;return 2**(a+(b?1:0))};g.wrapEastWest=function(a){const b=this.lijEastEnd(a[0]),c=a[2];return 0<=c&&c<b?a:this.isGlobal?[a[0],a[1],(c+(0>c?b:0))%b]:null};g.enableInternalChecks=function(a){p.enableTerrainInternalChecks(a)};g.enableWaterproofnessChecks=function(a){p.enableTerrainWaterproofnessChecks(a)};S._createClass(y,[{key:"renderer",get:function(){return this._renderer}},{key:"frustum",
get:function(){return this._frustum}},{key:"snapLevel",get:function(){if(this.lodSnapping===C.LODSnapping.ON){var a=this.view,b=this.tilingScheme;const c=a.pointsOfInterest?.cameraOnSurface?.scale;if(c&&b){const f=a.state.contentCamera;a=Ba.directionToHeadingTilt(a,f.eye,f.viewForward,f.up).tilt;90<a&&(a=180-a);a=2*(a/90)**2;b=b.levelAtScale(c);return Math.round(b-a)}}return null}},{key:"lodSnapping",get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?C.LODSnapping.ON:
C.LODSnapping.OFF}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},{key:"elevationQueryCache",get:function(){return this._elevationQueryCache}},{key:"mapTileRequester",get:function(){return this._mapDataRequester}},{key:"_userClippingExtent",get:function(){var {spatialReference:a}=this,{clippingArea:b}=this.view;if(q.isNone(b)||q.isNone(a))return null;const c=A.create();a=Ca.toBoundingRect(b,c,a)?c:null;
b=this._get("extent");return A.equals(a,b)?b:a}},{key:"rootTilesExtent",get:function(){return this._rootTilesExtent}},{key:"extent",get:function(){const a=A.intersection(this.groundExtent,this._userClippingExtent,A.create()),b=this._get("extent");return A.equals(a,b)?b:a}},{key:"groundExtent",get:function(){return q.isSome(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}},{key:"_tilingSchemeExtent",get:function(){return this.tilingSchemeLogic?.extent}},{key:"updating",get:function(){this._hasPendingUpdates||
(this._maxNumUpdating=1);return!!((this.running||this._watchUpdatingTracking.updating||0<this._asyncWorkItems)&&this.ready&&!this.suspended||this.overlayManager.updating)}},{key:"running",get:function(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}},{key:"updatingProgressValue",get:function(){this._maxNumUpdating=Math.max(this._pendingUpdates,
this._maxNumUpdating);return 1-this._pendingUpdates/this._maxNumUpdating}},{key:"baseOpacity",get:function(){return this.view.map.ground.opacity},set:function(a){this.view.map.ground.opacity=a}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"ready",get:function(){return q.isSome(this._rootTiles)}},{key:"renderOrder",set:function(a){this._renderer.renderOrder=a;this._set("renderOrder",a)}},{key:"rootTiles",get:function(){return this._rootTiles}},{key:"spatialReference",
get:function(){return this.tilingScheme?.spatialReference??null}},{key:"backgroundColor",get:function(){return this.view.map.ground.surfaceColor},set:function(a){this.view.map.ground.surfaceColor=a}},{key:"slicePlaneEnabled",set:function(a){this._renderer.slicePlaneEnabled=a;this._set("slicePlaneEnabled",a);this._evaluateTransparency()}},{key:"tilingSchemeLocked",get:function(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}},{key:"velvetOverground",set:function(a){this._renderer.velvetOverground=
a;this._set("velvetOverground",a)}},{key:"wireframe",get:function(){return this._renderer.wireframe},set:function(a){a!==this._renderer.wireframe&&(this._renderer.wireframe=a,this._updateAllTileGeometries())}},{key:"_visible",set:function(a){a!==this._visibleCached&&(this._visibleCached=a,this._renderer.setVisibility(a),this.suspended=!a)}},{key:"opaque",get:function(){return this._renderer.transparency===H.TransparencyMode.Opaque}},{key:"suspended",set:function(a){this._set("suspended",a);this._viewChangeUpdate()}},
{key:"textureFadeDuration",get:function(){return this.view.qualitySettings.tiledSurface.textureFadeDuration??0}},{key:"updatingRootTiles",get:function(){return this._updatingRootTiles}},{key:"_lodBias",get:function(){return this.view.qualitySettings.tiledSurface.lodBias-(1-this.view.resourceController.memoryController.memoryFactor)*E.MAX_MEMORY_LOD_BIAS}},{key:"shortBatches",get:function(){return this.view.state.mode!==Qa.RenderState.IDLE}},{key:"performanceInfo",get:function(){const a=this._performanceInfo;
a.numNodes=this._allTiles.length;a.numLeaves=a.numVisible=a.numRendered=a.numLoadedPerLevel.length=a.numRenderedPerLevel.length=0;this._allTiles.forAll(b=>{b.isLeaf&&a.numLeaves++;const c=b.level;b.renderData&&(a.numLoadedPerLevel[c]=(a.numLoadedPerLevel[c]||0)+1);b.visible&&(a.numVisible++,b.rendered&&(a.numRenderedPerLevel[c]=(a.numRenderedPerLevel[c]||0)+1,a.numRendered++))});return a}},{key:"renderPatchBorders",get:function(){return this._renderer.renderPatchBorders},set:function(a){this._renderer.renderPatchBorders=
a}},{key:"visualizeNormals",get:function(){return this._renderer.visualizeNormals},set:function(a){this._renderer.visualizeNormals=a}},{key:"renderingDisabled",get:function(){return this._renderer.renderingDisabled},set:function(a){this._renderer.renderingDisabled=a}},{key:"test",get:function(){const a=this;return{renderer:a._renderer,lercDecoder:a._lercDecoder,forceReload:()=>{q.isSome(a._rootTiles)&&0<a._rootTiles.length&&(a._mergeTile(a._rootTiles[0]),a._viewChangeUpdate())},getTiles:()=>a._allTiles.toArray(),
getRenderedTiles(){R.clear();a._allTiles.forAll(c=>{c.visible&&c.rendered&&R.push(c)});const b=R.toArray();F.sortTiles(a.renderOrder,b);return b},lockTilingScheme(b,c){a._extentHelper.defaultTiledLayersExtent=c;a.tilingSchemeLogic.test.lockTilingScheme(b)}}}},{key:"isGlobal",get:function(){return this._isGlobal}},{key:"shading",get:function(){return this._shading}},{key:"isWebMercator",get:function(){return this._isWebMercator}},{key:"isWebMercatorOnPlateeCarree",get:function(){return this._isWebMercatorOnPlateeCarree}}]);
return y}(ka.EventedMixin(k));l.__decorate([m.property()],k.prototype,"_renderer",void 0);l.__decorate([m.property({constructOnly:!0})],k.prototype,"_scaleRangeQueries",void 0);l.__decorate([m.property()],k.prototype,"_hasPendingUpdates",void 0);l.__decorate([m.property()],k.prototype,"_asyncWorkItems",void 0);l.__decorate([m.property()],k.prototype,"_allTilesDirty",void 0);l.__decorate([m.property()],k.prototype,"_allTilesSorted",void 0);l.__decorate([m.property()],k.prototype,"_viewChanged",void 0);
l.__decorate([m.property({readOnly:!0})],k.prototype,"_watchUpdatingTracking",void 0);l.__decorate([m.property()],k.prototype,"_frameTask",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"snapLevel",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"lodSnapping",null);l.__decorate([m.property({constructOnly:!0})],k.prototype,"view",void 0);l.__decorate([m.property()],k.prototype,"_userClippingExtent",null);l.__decorate([m.property()],k.prototype,"_rootTilesExtent",void 0);l.__decorate([m.property({readOnly:!0})],
k.prototype,"extent",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"groundExtent",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"_tilingSchemeExtent",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"updating",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"running",null);l.__decorate([m.property(Da.updatingProgress)],k.prototype,"updatingProgress",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"updatingProgressValue",null);l.__decorate([m.property()],
k.prototype,"_maxNumUpdating",void 0);l.__decorate([m.property()],k.prototype,"baseOpacity",null);l.__decorate([m.property()],k.prototype,"hasCompositeBlendMode",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"overlayManager",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"viewingMode",null);l.__decorate([m.property()],k.prototype,"maxTextureScale",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"ready",null);l.__decorate([m.property({value:Ha.RenderOrder.FRONT_TO_BACK})],
k.prototype,"renderOrder",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"rootTiles",null);l.__decorate([m.property()],k.prototype,"_rootTiles",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"spatialReference",null);l.__decorate([m.property({type:ha})],k.prototype,"backgroundColor",null);l.__decorate([m.property({value:!1})],k.prototype,"slicePlaneEnabled",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"tilingScheme",void 0);l.__decorate([m.property({readOnly:!0})],
k.prototype,"tilingSchemeLocked",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"tilingSchemeLogic",void 0);l.__decorate([m.property({value:!0})],k.prototype,"velvetOverground",null);l.__decorate([m.property()],k.prototype,"wireframe",null);l.__decorate([m.property({value:!1})],k.prototype,"suspended",null);l.__decorate([m.property()],k.prototype,"textureFadeDuration",null);l.__decorate([m.property()],k.prototype,"visibleElevationBounds",void 0);l.__decorate([m.property()],k.prototype,
"rootTileElevationBounds",void 0);l.__decorate([m.property()],k.prototype,"_layerViewsDirty",void 0);l.__decorate([m.property()],k.prototype,"renderPatchBorders",null);l.__decorate([m.property()],k.prototype,"visualizeNormals",null);l.__decorate([m.property()],k.prototype,"renderingDisabled",null);l=k=l.__decorate([na.subclass("esri.views.3d.terrain.TerrainSurface")],k);const z=ra.create(),Ra=A.create(),N=[0,0,0],R=new T,Q={spatialReference:null,extent:A.create(),context:"ground"},O={spatialReference:null,
extent:null,scale:0};return l});