// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Evented ../../../core/Handles ../../../core/MapUtils ../../../core/maybe ../../../core/PooledArray ../../../core/reactiveUtils ../../../core/SetUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../ViewingMode ../layers/interfaces ../support/debugFlags ./interfaces ./Overlay ./OverlayFramebufferObject ./OverlayRenderTarget ../webgl-engine/core/shaderLibrary/ShaderOutput ../../../chunks/TextureOnly.glsl ../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository ../webgl-engine/lib/Camera ../webgl-engine/lib/GLMaterialRepository ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/Material ../webgl-engine/lib/RenderContext ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/ShadowMap ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/SSAOHelper ../webgl-engine/lib/TextureTechnique ../webgl-engine/lib/TextureTechniqueConfiguration ../webgl-engine/lib/TransparencyPassType ../webgl-engine/lib/UpdatePolicy ../webgl-engine/lighting/Lightsources ../webgl-engine/materials/StippleTextureRepository ../../support/Scheduler ../../webgl/enums ../../webgl/Texture ../../webgl/Util".split(" "),
function(h,B,l,M,N,O,y,f,P,r,C,m,sa,ta,Q,G,R,S,T,t,H,u,I,U,V,z,W,X,Y,Z,J,aa,ba,ca,D,da,ea,fa,ha,ia,ja,ka,la,ma,K,n,na,oa){h.OverlayRenderer=function(A){function v(a){a=A.call(this,a)||this;a._overlays=null;a._overlayRenderTarget=null;a._hasHighlights=!1;a._rendersOccluded=!1;a._hasWater=!1;a._handles=new O;a._renderers=new Map;a._sortedDrapeSourceRenderersDirty=!1;a._sortedRenderers=new P;a._passParameters=new W.TextureOnlyPassParameters;a._rctx=null;a._materialRepository=null;a._screenToWorldRatio=
1;a._localOriginFactory=null;a._camera=new Y.Camera;a.worldToPCSRatio=1;a.events=new N;a.longitudeCyclical=null;return a}B._inheritsLoose(v,A);var d=v.prototype;d.initialize=function(){const a=this.view._stage.renderView;this._rctx=a.renderingContext;const c=a.waterTextureRepository;this._stippleTextureRepository=new ma.StippleTextureRepository(a.renderingContext);this._shaderTechniqueRepository=new X.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:T.ViewingMode.Local,stippleTextureRepository:this._stippleTextureRepository,
waterTextureRepository:c});this._renderContext=new ca.OverlayRenderContext(this._rctx,new da.ShadowMap(this._rctx,this.view.state.viewingMode),new fa.SSAOHelper(this.view,this._shaderTechniqueRepository,this._rctx,()=>{}));this._handles.add([r.watch(()=>c.updating,()=>this.events.emit("content-changed"),r.syncAndInitial),r.watch(()=>this.spatialReference,b=>this._localOriginFactory=new aa.GridLocalOriginFactory(b),r.syncAndInitial),r.on(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=
!0)]);this._materialRepository=new Z.GLMaterialRepository(a.textureRepository,this._shaderTechniqueRepository,b=>{0<(b.renderOccluded&E)!==this._rendersOccluded&&this._updateRendersOccluded();this.events.emit("content-changed");this.notifyChange("updating");this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._bindParameters.slot=D.RenderSlot.DRAPED_MATERIAL;this._bindParameters.highlightDepthTexture=J.createEmptyDepthTexture(this._rctx);this._camera.near=1;this._camera.far=
1E4;this._camera.relativeElevation=null;this._bindParameters.camera=this._camera;this._bindParameters.transparencyPassType=ja.TransparencyPassType.NONE;this._bindParameters.newLighting.noonFactor=0;this._bindParameters.newLighting.globalFactor=0;this._bindParameters.newLighting.set([new la.AmbientLight(S.fromValues(1,1,1))]);this._handles.add(this.view.resourceController.scheduler.registerTask(K.TaskPriority.STAGE,this))};d.destroy=function(){this._handles.destroy();this._renderers.forEach(a=>a.destroy());
this._renderers.clear();this._debugTextureTechnique=f.releaseMaybe(this._debugTextureTechnique);this._passParameters.texture=f.disposeMaybe(this._passParameters.texture);this._bindParameters.highlightDepthTexture=f.disposeMaybe(this._bindParameters.highlightDepthTexture);this._shaderTechniqueRepository=f.destroyMaybe(this._shaderTechniqueRepository);this._temporaryFBO=f.disposeMaybe(this._temporaryFBO);this._quadVAO=f.disposeMaybe(this._quadVAO);this.disposeOverlays()};d.createGeometryDrapeSourceRenderer=
function(a){return this.createDrapeSourceRenderer(a,ea.SortedRenderGeometryRenderer)};d.createDrapeSourceRenderer=function(a,c,b){const e=this._renderers.get(a);f.isSome(e)&&e.destroy();c=new c({...b,rendererContext:this,drapeSource:a});this._renderers.set(a,c);this._sortedDrapeSourceRenderersDirty=!0;"fullOpacity"in a&&this._handles.add(r.watch(()=>a.fullOpacity,()=>this.events.emit("content-changed")),a);return c};d.removeDrapeSourceRenderer=function(a){if(!f.isNone(a)){var c=this._renderers.get(a);
f.isNone(c)||(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(a),this._handles.remove(a),c.destroy())}};d.collectUnusedRenderTargetMemory=function(a){let c=!1;if(f.isSome(this._overlayRenderTarget))for(const b of this._overlayRenderTarget.renderTargets){const [e,g]=this.overlays;c=this._overlayRenderTarget.validateUsageForTarget(e.validTargets[b.type]||!g.validTargets[b.type],b,a)||c}return c};d.ensureDrapeTargets=function(a){f.isSome(this._overlays)&&this._overlays.forEach(c=>c.hasTargetWithoutRasterImage=
C.someSet(a,b=>b.drapeTargetType===t.DrapeTargetType.WithoutRasterImage))};d.ensureDrapeSources=function(a){f.isSome(this._overlays)&&this._overlays.forEach(c=>{c.hasDrapedFeatureSource=C.someSet(a,b=>b.drapeSourceType===t.DrapeSourceType.Features);c.hasDrapedRasterSource=C.someSet(a,b=>b.drapeSourceType===t.DrapeSourceType.RasterImage)})};d.ensureOverlays=function(a,c){f.isNone(this._overlays)&&(this._overlayRenderTarget=new V.OverlayRenderTarget(this._rctx),this._overlays=[new I.Overlay(u.OverlayIndex.INNER,
this._overlayRenderTarget),new I.Overlay(u.OverlayIndex.OUTER,this._overlayRenderTarget)]);this.ensureDrapeTargets(a);this.ensureDrapeSources(c)};d.disposeOverlays=function(){this._overlays=null;this._overlayRenderTarget=f.disposeMaybe(this._overlayRenderTarget);this.events.emit("textures-disposed")};d.runTask=function(a){this._processDrapeSources(a,()=>!0)};d._processDrapeSources=function(a,c){let b=!1;for(const [e,g]of this._renderers){if(a.done)break;(e.destroyed||c(e))&&g.commitChanges()&&(b=
!0,a.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,b=!0,this._updateSortedDrapeSourceRenderers());b&&(f.isSome(this._overlays)&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())};d.processSyncDrapeSources=function(){this._processDrapeSources(K.noBudget,a=>a.updatePolicy===ka.UpdatePolicy.SYNC)};
d.updateAnimation=function(a){let c=!1;this._renderers.forEach(b=>c=b.updateAnimation(a)||c);return c};d.updateDrapeSourceOrder=function(){this._sortedDrapeSourceRenderersDirty=!0};d.drawTarget=function(a,c,b){const e=a.canvasGeometries;if(0===e.numViews)return!1;this._screenToWorldRatio=b*a.mapUnitsPerPixel;const g=c.output;if(this.isEmpty||g===z.ShaderOutput.Highlight&&!this.hasHighlights||g===z.ShaderOutput.Normal&&!this.hasWater||!a.hasSomeSizedView())return!1;const k=c.fbo;if(!k.isValid())return!1;
const p=2*a.resolution,q=a.resolution;k.resize(p,q);const w=this._rctx;this._camera.pixelRatio=a.pixelRatio*b;this._renderContext.output=g;this._bindParameters.screenToWorldRatio=this._screenToWorldRatio;this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio;this._bindParameters.slot=g===z.ShaderOutput.Normal?D.RenderSlot.DRAPED_WATER:D.RenderSlot.DRAPED_MATERIAL;a.applyViewport(this._rctx);k.bind(w);a.index===u.OverlayIndex.INNER&&(w.setClearColor(0,0,0,0),w.clearSafe(n.ClearBufferBit.COLOR_BUFFER_BIT));
c.type===u.RenderTargetType.Occluded&&(this._renderContext.renderOccludedMask=E);if(H.OVERLAY_DRAW_DEBUG_TEXTURE&&c.type!==u.RenderTargetType.Occluded)for(b=0;b<e.numViews;b++)this._setViewParameters(e.extents[b],a),this._drawDebugTexture(a.resolution,pa[a.index]);0<this._renderers.size&&this._sortedRenderers.forAll(({drapeSource:x,renderer:qa})=>{if(c.type!==u.RenderTargetType.ColorNoRasterImage||x.drapeSourceType!==t.DrapeSourceType.RasterImage){({fullOpacity:x}=x);var L=f.isSome(x)&&1>x&&g===z.ShaderOutput.Color;
L&&(this.bindTemporaryFramebuffer(this._rctx,p,q),w.clearSafe(n.ClearBufferBit.COLOR_BUFFER_BIT));for(let F=0;F<e.numViews;F++)this._setViewParameters(e.extents[F],a),qa.render(this._renderContext);L&&f.isSome(this._temporaryFBO)&&(k.bind(w),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),x,a.index))}});w.bindFramebuffer(null);k.generateMipMap();this._renderContext.resetRenderOccludedMask();return!0};d.bindTemporaryFramebuffer=
function(a,c,b){f.isNone(this._temporaryFBO)&&(this._temporaryFBO=new U.OverlayFramebufferObject(a,!1));this._temporaryFBO.resize(c,b);this._temporaryFBO.bind(a)};d.reloadShaders=function(){var a=B._asyncToGenerator(function*(){yield this._shaderTechniqueRepository.reloadAll()});return function(){return a.apply(this,arguments)}}();d.notifyContentChanged=function(){this.events.emit("content-changed")};d.intersect=function(a,c,b,e){let g=0;for(const k of this._renderers.values())g=k.intersect?.(a,c,
b,e,g)??g};d._updateSortedDrapeSourceRenderers=function(){this._sortedRenderers.clear();if(0!==this._renderers.size){var a=this.view.map.allLayers;this._renderers.forEach((c,b)=>{const e=a.indexOf(b.layer),g=0<=e;this._sortedRenderers.push(new ra(b,c,this._renderers.size*(b.renderGroup??(g?t.DrapedRenderGroup.MapLayer:t.DrapedRenderGroup.ViewLayer))+(g?e:0)))});this._sortedRenderers.sort((c,b)=>c.index-b.index)}};d._setViewParameters=function(a,c){const b=this._camera;b.viewport=[0,0,c.resolution,
c.resolution];G.ortho(b.projectionMatrix,0,a[2]-a[0],0,a[3]-a[1],b.near,b.far);G.fromTranslation(b.viewMatrix,[-a[0],-a[1],0])};d._updateHasWater=function(){const a=y.someMap(this._renderers,c=>c.hasWater);a!==this._hasWater&&(this._hasWater=a,this.events.emit("has-water",a))};d._updateHasHighlights=function(){const a=y.someMap(this._renderers,c=>c.hasHighlights);a!==this._hasHighlights&&(this._hasHighlights=a,this.events.emit("has-highlights",a))};d._updateRendersOccluded=function(){const a=y.someMap(this._renderers,
c=>c.rendersOccluded);a!==this._rendersOccluded&&(this._rendersOccluded=a,this.events.emit("renders-occluded",a))};d._drawDebugTexture=function(a,c){this._ensureDebugPatternResources(a,a,c);a=this._rctx;a.bindTechnique(this._debugTextureTechnique,this._passParameters,null);a.bindVAO(this._quadVAO);a.drawArrays(n.PrimitiveType.TRIANGLE_STRIP,0,oa.vertexCount(this._quadVAO,"geometry"))};d._ensureDebugPatternResources=function(a,c,b){R.set(this._passParameters.color,b[0],b[1],b[2]);if(!this._passParameters.texture){b=
new Uint8Array(a*c*4);var e=0;for(let g=0;g<c;g++)for(let k=0;k<a;k++){const p=Math.floor(k/10),q=Math.floor(g/10);2>p||2>q||10*p>a-20||10*q>c-20?(b[e++]=255,b[e++]=255,b[e++]=255,b[e++]=255):(b[e++]=255,b[e++]=255,b[e++]=255,p&1&&q&1?b[e++]=k&1^g&1?0:255:b[e++]=p&1^q&1?0:128)}this._passParameters.texture=new na.Texture(this._rctx,{target:n.TextureType.TEXTURE_2D,pixelFormat:n.PixelFormat.RGBA,dataType:n.PixelType.UNSIGNED_BYTE,samplingMode:n.TextureSamplingMode.NEAREST,width:a,height:c},b);a=new ia.TextureTechniqueConfiguration;
a.hasAlpha=!0;this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(ha.TextureTechnique,a);this._quadVAO=J.createQuadVAO(this._rctx)}};B._createClass(v,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"rctx",get:function(){return this._rctx}},{key:"materialRepository",get:function(){return this._materialRepository}},{key:"screenToWorldRatio",get:function(){return this._screenToWorldRatio}},{key:"localOriginFactory",get:function(){return this._localOriginFactory}},
{key:"updating",get:function(){return this._sortedDrapeSourceRenderersDirty||y.someMap(this._renderers,a=>a.updating)}},{key:"hasOverlays",get:function(){return f.isSome(this._overlays)&&f.isSome(this._overlayRenderTarget)}},{key:"gpuMemoryUsage",get:function(){return f.isSome(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"overlays",get:function(){return f.unwrapOr(this._overlays,[])}},{key:"running",get:function(){return this.updating}},{key:"isEmpty",get:function(){return H.OVERLAY_DRAW_DEBUG_TEXTURE?
!1:!y.someMap(this._renderers,a=>!a.isEmpty)}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:a=>this._renderers.get(a)}}}]);return v}(M);l.__decorate([m.property()],h.OverlayRenderer.prototype,"_sortedDrapeSourceRenderersDirty",void 0);l.__decorate([m.property({autoDestroy:!0})],
h.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0);l.__decorate([m.property({autoDestroy:!0})],h.OverlayRenderer.prototype,"_stippleTextureRepository",void 0);l.__decorate([m.property({constructOnly:!0})],h.OverlayRenderer.prototype,"view",void 0);l.__decorate([m.property()],h.OverlayRenderer.prototype,"worldToPCSRatio",void 0);l.__decorate([m.property()],h.OverlayRenderer.prototype,"spatialReference",void 0);l.__decorate([m.property({type:Boolean,readOnly:!0})],h.OverlayRenderer.prototype,
"updating",null);l.__decorate([m.property()],h.OverlayRenderer.prototype,"isEmpty",null);h.OverlayRenderer=l.__decorate([Q.subclass("esri.views.3d.terrain.OverlayRenderer")],h.OverlayRenderer);let ra=function(A,v,d){this.drapeSource=A;this.renderer=v;this.index=d};const pa=[[1,.5,.5],[.5,.5,1]],E=ba.RenderOccludedFlag.OccludeAndTransparent;h.DRAPED_Z=-2;h.overlayRenderOccludedFlag=E;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});