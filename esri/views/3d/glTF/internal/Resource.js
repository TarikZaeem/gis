// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/Logger ../../../../core/MapUtils ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../core/Version ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/quat ../../../../chunks/quatf64 ../../../../geometry/support/buffer/BufferView ../../../../chunks/scalar ./BinaryStreamReader ./enums ./fillDefaults ./pathUtils ./resourceUtils ../../../webgl/enums".split(" "),function(A,
m,g,I,J,E,u,F,t,v,K,L,l,B,G,C,D,M,w,h){function N(f){switch(f.componentType){case h.DataType.BYTE:return new l.BufferViewVec2i8(f.raw,f.byteOffset,f.byteStride,f.byteOffset+f.byteStride*f.entryCount);case h.DataType.UNSIGNED_BYTE:return new l.BufferViewVec2u8(f.raw,f.byteOffset,f.byteStride,f.byteOffset+f.byteStride*f.entryCount);case h.DataType.SHORT:return new l.BufferViewVec2i16(f.raw,f.byteOffset,f.byteStride,f.byteOffset+f.byteStride*f.entryCount);case h.DataType.UNSIGNED_SHORT:return new l.BufferViewVec2u16(f.raw,
f.byteOffset,f.byteStride,f.byteOffset+f.byteStride*f.entryCount);case h.DataType.UNSIGNED_INT:return new l.BufferViewVec2u32(f.raw,f.byteOffset,f.byteStride,f.byteOffset+f.byteStride*f.entryCount);case h.DataType.FLOAT:return new l.BufferViewVec2f(f.raw,f.byteOffset,f.byteStride,f.byteOffset+f.byteStride*f.entryCount)}}let R=function(){function f(c,a,b,e){this._context=c;this.uri=a;this.json=b;this._glbBuffer=e;this._bufferLoaders=new Map;this._textureLoaders=new Map;this._textureCache=new Map;this._materialCache=
new Map;this._nodeParentMap=new Map;this._nodeTransformCache=new Map;this._supportedExtensions=["KHR_texture_basisu"];this._baseUri=M.splitURI(this.uri).dirPart;this._checkVersionSupported();this._checkRequiredExtensionsSupported();if(null==b.scenes)throw new g("gltf-loader-unsupported-feature","Scenes must be defined.");if(null==b.meshes)throw new g("gltf-loader-unsupported-feature","Meshes must be defined");if(null==b.nodes)throw new g("gltf-loader-unsupported-feature","Nodes must be defined.");
this._computeNodeParents()}f.load=function(){var c=m._asyncToGenerator(function*(a,b,e){if(u.isDataProtocol(b)){var d=u.dataComponents(b);if(d&&"model/gltf-binary"!==d.mediaType)try{const n=JSON.parse(d.isBase64?atob(d.data):d.data);return new f(a,b,n)}catch{}d=u.dataToArrayBuffer(b);if(f._isGLBData(d))return this._fromGLBData(a,b,d)}if(b.endsWith(".gltf"))return e=yield a.loadJSON(b,e),new f(a,b,e);d=yield a.loadBinary(b,e);if(f._isGLBData(d))return this._fromGLBData(a,b,d);e=yield a.loadJSON(b,
e);return new f(a,b,e)});return function(a,b,e){return c.apply(this,arguments)}}();f._isGLBData=function(c){if(null==c)return!1;c=new G.BinaryStreamReader(c);return 4<=c.remainingBytes()&&1179937895===c.readUint32()};f._fromGLBData=function(){var c=m._asyncToGenerator(function*(a,b,e){e=yield f._parseGLBData(e);return new f(a,b,e.json,e.binaryData)});return function(a,b,e){return c.apply(this,arguments)}}();f._parseGLBData=function(){var c=m._asyncToGenerator(function*(a){const b=new G.BinaryStreamReader(a);
if(12>b.remainingBytes())throw new g("gltf-loader-error","GLB binary data is insufficiently large.");var e=b.readUint32(),d=b.readUint32();const n=b.readUint32();if(1179937895!==e)throw new g("gltf-loader-error","Magic first 4 bytes do not fit to expected GLB value.");if(a.byteLength<n)throw new g("gltf-loader-error","GLB binary data is smaller than header specifies.");if(2!==d)throw new g("gltf-loader-unsupported-feature","An unsupported GLB container version was detected. Only version 2 is supported.");
a=0;let p,q;for(;8<=b.remainingBytes();){e=b.readUint32();d=b.readUint32();if(0===a){if(1313821514!==d)throw new g("gltf-loader-error","First GLB chunk must be JSON.");if(0>e)throw new g("gltf-loader-error","No JSON data found.");p=yield w.jsonFromBinaryData(b.readUint8Array(e))}else if(1===a){if(5130562!==d)throw new g("gltf-loader-unsupported-feature","Second GLB chunk expected to be BIN.");q=b.readUint8Array(e)}else I.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] More than 2 GLB chunks detected. Skipping.");
a+=1}if(!p)throw new g("gltf-loader-error","No GLB JSON chunk detected.");return{json:p,binaryData:q}});return function(a){return c.apply(this,arguments)}}();var k=f.prototype;k.getBuffer=function(){var c=m._asyncToGenerator(function*(a,b){const e=this.json.buffers[a];if(null==e.uri){if(null==this._glbBuffer)throw new g("gltf-loader-error","GLB buffer not present");return this._glbBuffer}a=yield this._getBufferLoader(a,b);if(a.byteLength!==e.byteLength)throw new g("gltf-loader-error","Buffer byte lengths should match.");
return a});return function(a,b){return c.apply(this,arguments)}}();k._getBufferLoader=function(){var c=m._asyncToGenerator(function*(a,b){const e=this._bufferLoaders.get(a);if(e)return e;b=this._context.loadBinary(this._resolveUri(this.json.buffers[a].uri),b).then(d=>new Uint8Array(d));this._bufferLoaders.set(a,b);return b});return function(a,b){return c.apply(this,arguments)}}();k.getAccessor=function(){var c=m._asyncToGenerator(function*(a,b){if(!this.json.accessors)throw new g("gltf-loader-unsupported-feature",
"Accessors missing.");a=this.json.accessors[a];if(null==a?.bufferView)throw new g("gltf-loader-unsupported-feature","Some accessor does not specify a bufferView.");if(a.type in[C.AttributeType.MAT2,C.AttributeType.MAT3,C.AttributeType.MAT4])throw new g("gltf-loader-unsupported-feature",`AttributeType ${a.type} is not supported`);const e=this.json.bufferViews[a.bufferView];b=yield this.getBuffer(e.buffer,b);const d=O[a.type],n=P[a.componentType],p=d*n,q=e.byteStride||p;return{raw:b.buffer,byteStride:q,
byteOffset:b.byteOffset+(e.byteOffset||0)+(a.byteOffset||0),entryCount:a.count,isDenselyPacked:q===p,componentCount:d,componentByteSize:n,componentType:a.componentType,min:a.min,max:a.max,normalized:!!a.normalized}});return function(a,b){return c.apply(this,arguments)}}();k.getIndexData=function(){var c=m._asyncToGenerator(function*(a,b){if(null!=a.indices)if(a=yield this.getAccessor(a.indices,b),a.isDenselyPacked)switch(a.componentType){case h.DataType.UNSIGNED_BYTE:return new Uint8Array(a.raw,a.byteOffset,
a.entryCount);case h.DataType.UNSIGNED_SHORT:return new Uint16Array(a.raw,a.byteOffset,a.entryCount);case h.DataType.UNSIGNED_INT:return new Uint32Array(a.raw,a.byteOffset,a.entryCount)}else switch(a.componentType){case h.DataType.UNSIGNED_BYTE:return B.makeDense(this._wrapAccessor(l.BufferViewUint8,a));case h.DataType.UNSIGNED_SHORT:return B.makeDense(this._wrapAccessor(l.BufferViewUint16,a));case h.DataType.UNSIGNED_INT:return B.makeDense(this._wrapAccessor(l.BufferViewUint32,a))}});return function(a,
b){return c.apply(this,arguments)}}();k.getPositionData=function(){var c=m._asyncToGenerator(function*(a,b){if(null==a.attributes.POSITION)throw new g("gltf-loader-unsupported-feature","No POSITION vertex data found.");a=yield this.getAccessor(a.attributes.POSITION,b);if(a.componentType!==h.DataType.FLOAT)throw new g("gltf-loader-unsupported-feature","Expected type FLOAT for POSITION vertex attribute, but found "+h.DataType[a.componentType]);if(3!==a.componentCount)throw new g("gltf-loader-unsupported-feature",
"POSITION vertex attribute must have 3 components, but found "+a.componentCount.toFixed());return this._wrapAccessor(l.BufferViewVec3f,a)});return function(a,b){return c.apply(this,arguments)}}();k.getNormalData=function(){var c=m._asyncToGenerator(function*(a,b){if(null==a.attributes.NORMAL)throw new g("gltf-loader-error","No NORMAL vertex data found.");a=yield this.getAccessor(a.attributes.NORMAL,b);if(a.componentType!==h.DataType.FLOAT)throw new g("gltf-loader-unsupported-feature","Expected type FLOAT for NORMAL vertex attribute, but found "+
h.DataType[a.componentType]);if(3!==a.componentCount)throw new g("gltf-loader-unsupported-feature","NORMAL vertex attribute must have 3 components, but found "+a.componentCount.toFixed());return this._wrapAccessor(l.BufferViewVec3f,a)});return function(a,b){return c.apply(this,arguments)}}();k.getTangentData=function(){var c=m._asyncToGenerator(function*(a,b){if(null==a.attributes.TANGENT)throw new g("gltf-loader-error","No TANGENT vertex data found.");a=yield this.getAccessor(a.attributes.TANGENT,
b);if(a.componentType!==h.DataType.FLOAT)throw new g("gltf-loader-unsupported-feature","Expected type FLOAT for TANGENT vertex attribute, but found "+h.DataType[a.componentType]);if(4!==a.componentCount)throw new g("gltf-loader-unsupported-feature","TANGENT vertex attribute must have 4 components, but found "+a.componentCount.toFixed());return new l.BufferViewVec4f(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount)});return function(a,b){return c.apply(this,arguments)}}();k.getTextureCoordinates=
function(){var c=m._asyncToGenerator(function*(a,b){if(null==a.attributes.TEXCOORD_0)throw new g("gltf-loader-error","No TEXCOORD_0 vertex data found.");a=yield this.getAccessor(a.attributes.TEXCOORD_0,b);if(2!==a.componentCount)throw new g("gltf-loader-unsupported-feature","TEXCOORD_0 vertex attribute must have 2 components, but found "+a.componentCount.toFixed());if(a.componentType===h.DataType.FLOAT)return this._wrapAccessor(l.BufferViewVec2f,a);if(!a.normalized)throw new g("gltf-loader-unsupported-feature",
"Integer component types are only supported for a normalized accessor for TEXCOORD_0.");return N(a)});return function(a,b){return c.apply(this,arguments)}}();k.getVertexColors=function(){var c=m._asyncToGenerator(function*(a,b){if(null==a.attributes.COLOR_0)throw new g("gltf-loader-error","No COLOR_0 vertex data found.");a=yield this.getAccessor(a.attributes.COLOR_0,b);if(4!==a.componentCount&&3!==a.componentCount)throw new g("gltf-loader-unsupported-feature","COLOR_0 attribute must have 3 or 4 components, but found "+
a.componentCount.toFixed());if(4===a.componentCount){if(a.componentType===h.DataType.FLOAT)return this._wrapAccessor(l.BufferViewVec4f,a);if(a.componentType===h.DataType.UNSIGNED_BYTE)return this._wrapAccessor(l.BufferViewVec4u8,a);if(a.componentType===h.DataType.UNSIGNED_SHORT)return this._wrapAccessor(l.BufferViewVec4u16,a)}else if(3===a.componentCount){if(a.componentType===h.DataType.FLOAT)return this._wrapAccessor(l.BufferViewVec3f,a);if(a.componentType===h.DataType.UNSIGNED_BYTE)return this._wrapAccessor(l.BufferViewVec3u8,
a);if(a.componentType===h.DataType.UNSIGNED_SHORT)return this._wrapAccessor(l.BufferViewVec3u16,a)}throw new g("gltf-loader-unsupported-feature","Unsupported component type for COLOR_0 attribute: "+h.DataType[a.componentType]);});return function(a,b){return c.apply(this,arguments)}}();k.hasPositions=function(c){return void 0!==c.attributes.POSITION};k.hasNormals=function(c){return void 0!==c.attributes.NORMAL};k.hasVertexColors=function(c){return void 0!==c.attributes.COLOR_0};k.hasTextureCoordinates=
function(c){return void 0!==c.attributes.TEXCOORD_0};k.hasTangents=function(c){return void 0!==c.attributes.TANGENT};k.getMaterial=function(){var c=m._asyncToGenerator(function*(a,b,e){var d=a.material?this._materialCache.get(a.material):void 0;if(!d){d=null!=a.material?D.material(this.json.materials[a.material]):D.material();const n=d.pbrMetallicRoughness,p=this.hasVertexColors(a),q=this.getTexture(n.baseColorTexture,b),x=this.getTexture(d.normalTexture,b),y=e?this.getTexture(d.occlusionTexture,
b):void 0,r=e?this.getTexture(d.emissiveTexture,b):void 0;b=e?this.getTexture(n.metallicRoughnessTexture,b):void 0;a=null!=a.material?a.material:-1;d={alphaMode:d.alphaMode,alphaCutoff:d.alphaCutoff,color:n.baseColorFactor,doubleSided:!!d.doubleSided,colorTexture:yield q,normalTexture:yield x,name:d.name,id:a,occlusionTexture:yield y,emissiveTexture:yield r,emissiveFactor:d.emissiveFactor,metallicFactor:n.metallicFactor,roughnessFactor:n.roughnessFactor,metallicRoughnessTexture:yield b,hasVertexColors:p,
ESRI_externalColorMixMode:d.extras.ESRI_externalColorMixMode,colorTextureTransform:n?.baseColorTexture?.extensions?.KHR_texture_transform,normalTextureTransform:d.normalTexture?.extensions?.KHR_texture_transform,occlusionTextureTransform:d.occlusionTexture?.extensions?.KHR_texture_transform,emissiveTextureTransform:d.emissiveTexture?.extensions?.KHR_texture_transform,metallicRoughnessTextureTransform:n?.metallicRoughnessTexture?.extensions?.KHR_texture_transform}}return d});return function(a,b,e){return c.apply(this,
arguments)}}();k.getTexture=function(){var c=m._asyncToGenerator(function*(a,b){if(a){if(0!==(a.texCoord||0))throw new g("gltf-loader-unsupported-feature","Only TEXCOORD with index 0 is supported.");var e=a.index;a=this.json.textures[e];var d=D.textureSampler(null!=a.sampler?this.json.samplers[a.sampler]:{}),n=this._getTextureSourceId(a),p=this.json.images[n],q=yield this._loadTextureImageData(e,a,b);return J.getOrCreateMapValue(this._textureCache,e,()=>{const x=r=>33071===r||33648===r||10497===r,
y=r=>{throw new g("gltf-loader-error",`Unexpected TextureSampler WrapMode: ${r}`);};return{data:q,wrapS:x(d.wrapS)?d.wrapS:y(d.wrapS),wrapT:x(d.wrapT)?d.wrapT:y(d.wrapT),minFilter:d.minFilter,name:p.name,id:e}})}});return function(a,b){return c.apply(this,arguments)}}();k.getNodeTransform=function(c){if(void 0===c)return H;var a=this._nodeTransformCache.get(c);if(!a){a=this.getNodeTransform(this._getNodeParent(c));const b=this.json.nodes[c];b.matrix?a=t.multiply(v.create(),a,b.matrix):b.translation||
b.rotation||b.scale?(a=v.clone(a),b.translation&&t.translate(a,a,b.translation),b.rotation&&(z[3]=K.getAxisAngle(z,b.rotation),t.rotate(a,a,z[3],z)),b.scale&&t.scale(a,a,b.scale)):a=v.clone(a);this._nodeTransformCache.set(c,a)}return a};k._wrapAccessor=function(c,a){return new c(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*(a.entryCount-1)+a.componentByteSize*a.componentCount)};k._resolveUri=function(c){return u.makeAbsolute(c,this._baseUri)};k._getNodeParent=function(c){return this._nodeParentMap.get(c)};
k._checkVersionSupported=function(){const c=F.Version.parse(this.json.asset.version,"glTF");Q.validate(c)};k._checkRequiredExtensionsSupported=function(){const c=this.json;if(c.extensionsRequired&&!c.extensionsRequired.every(a=>this._supportedExtensions.includes(a)))throw new g("gltf-loader-unsupported-feature","gltf loader was not able to load unsupported feature. Required extensions: "+c.extensionsRequired.join(", "));};k._computeNodeParents=function(){this.json.nodes.forEach((c,a)=>{c.children&&
c.children.forEach(b=>{this._nodeParentMap.set(b,a)})})};k._loadTextureImageData=function(){var c=m._asyncToGenerator(function*(a,b,e){const d=this._textureLoaders.get(a);if(d)return d;b=this._createTextureLoader(b,e);this._textureLoaders.set(a,b);return b});return function(a,b,e){return c.apply(this,arguments)}}();k._getTextureSourceId=function(c){if(void 0!==c.extensions&&null!==c.extensions.KHR_texture_basisu)return c.extensions.KHR_texture_basisu.source;if(null!==c.source)return c.source;throw new g("gltf-loader-unsupported-feature",
"Source is expected to be defined for a texture. It can also be omitted in favour of an KHR_texture_basisu extension tag.");};k._createTextureLoader=function(){var c=m._asyncToGenerator(function*(a,b){a=this._getTextureSourceId(a);a=this.json.images[a];if(a.uri)return a.uri.endsWith(".ktx2")?(b=yield this._context.loadBinary(this._resolveUri(a.uri),b),new w.EncodedMeshTexture(new Uint8Array(b))):this._context.loadImage(this._resolveUri(a.uri),b);if(null==a.bufferView)throw new g("gltf-loader-unsupported-feature",
"Image bufferView must be defined.");if(null==a.mimeType)throw new g("gltf-loader-unsupported-feature","Image mimeType must be defined.");const e=this.json.bufferViews[a.bufferView];b=yield this.getBuffer(e.buffer,b);if(null!=e.byteStride)throw new g("gltf-loader-unsupported-feature","byteStride not supported for image buffer");return w.imageFromBinaryData(new Uint8Array(b.buffer,b.byteOffset+(e.byteOffset||0),e.byteLength),a.mimeType)});return function(a,b){return c.apply(this,arguments)}}();k.getLoadedBuffersSize=
function(){var c=m._asyncToGenerator(function*(){if(this._glbBuffer)return this._glbBuffer.byteLength;const a=yield E.eachAlwaysValues(Array.from(this._bufferLoaders.values())),b=yield E.eachAlwaysValues(Array.from(this._textureLoaders.values()));return a.reduce((e,d)=>e+(d?.byteLength??0),0)+b.reduce((e,d)=>e+(d?w.isEncodedMeshTexture(d)?d.data.byteLength:d.width*d.height*4:0),0)});return function(){return c.apply(this,arguments)}}();return f}();const H=t.fromXRotation(v.create(),Math.PI/2),Q=new F.Version(2,
0,"glTF"),z=L.create(),O={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},P={[h.DataType.BYTE]:1,[h.DataType.UNSIGNED_BYTE]:1,[h.DataType.SHORT]:2,[h.DataType.UNSIGNED_SHORT]:2,[h.DataType.FLOAT]:4,[h.DataType.UNSIGNED_INT]:4};A.GLTFResource=R;A.TRANSFORM_GLTF_TO_ENGINE=H;Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});