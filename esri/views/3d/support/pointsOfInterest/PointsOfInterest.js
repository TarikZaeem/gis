// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/ray ../debugFlags ../debugUtils ../PropertiesPool ../geometryUtils/ray ./CameraOnSurface ./CenterOnSurface ./ContentGeometryUpdates ./Focus ./StableSurfaceCenter ./SurfaceGeometryUpdates ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/verticalOffsetUtils ../../../support/Scheduler".split(" "),
function(b,v,d,E,F,q,e,f,V,W,G,r,y,z,H,n,I,J,K,w,L,M,N,O,A,P,Q,t){b.PointsOfInterest=function(B){function u(a){a=B.call(this,a)||this;a._handles=new F;a._tmpRay=z.create();a._centerRayDirty=!0;a._surfaceAltitudeAtCenter=0;a._surfaceAltitudeAtCenterDirty=!0;a._contentAltitudeAtCenter=0;a._contentAltitudeAtCenterDirty=!0;a._propertiesPool=new I.PropertiesPool({renderPointOfView:R},v._assertThisInitialized(a));a.renderPointOfView=y.create();a._pois=[];a._debugCenters=new Map;return a}v._inheritsLoose(u,
B);var k=u.prototype;k.initialize=function(){const {state:a,basemapTerrain:c,renderCoordsHelper:g,map:x}=this.view;this._surfaceIntersector=A.newIntersector(a.viewingMode);this._surfaceIntersector.options.backfacesTerrain=a.isGlobal?!1:!0;this._surfaceIntersector.options.invisibleTerrain=!1;this._surfaceIntersector.options.store=P.StoreResults.MIN;this._contentIntersector=A.newIntersector(a.viewingMode);var h=()=>this._estimateSurfaceAltitudeAtCenter();const C=this.view.resourceController.scheduler,
D=q.unwrap(this.view.basemapTerrain?.elevationQueryCache),p={state:a,scheduler:C,surface:c,renderCoordsHelper:g};this._set("centerOnSurfaceInfrequent",new w.CenterOnSurface({...p,task:t.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("centerOnSurfaceFrequent",new w.CenterOnSurface({...p,task:t.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("centerOnContent",new w.CenterOnSurface({...p,task:t.TaskPriority.POINT_OF_INTEREST_FREQUENT,
estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}));this._set("cameraOnSurface",new K.CameraOnSurface({...p,cache:D,task:t.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:x}));this._set("surfaceGeometryUpdates",new O.SurfaceGeometryUpdates({...p,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}));this._set("contentGeometryUpdates",new L.ContentGeometryUpdates({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:g}));
this._set("surfaceOrigin",new N.StableSurfaceCenter({cache:D,view:this.view}));this._set("focus",new M.Focus({state:a,scheduler:C,surface:c,renderCoordsHelper:g,centerOnSurface:this.centerOnSurfaceInfrequent,estimateSurfaceIntersectionAtRenderPoint:(l,S)=>this._estimateSurfaceIntersectionAtRenderPoint(l,this.view.state.contentCamera,S)}));this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);h=this.view.graphics;this._debugCenters.set(this.centerOnContent,
new n.PointGraphics(h,"red","CenterOnContent"));this._debugCenters.set(this.centerOnSurfaceFrequent,new n.PointGraphics(h,"red","CenterOnSurface"));this._debugCenters.set(this.centerOnSurfaceInfrequent,new n.PointGraphics(h,"red","CenterOnSurface"));this._debugCenters.set(this.cameraOnSurface,new n.PointGraphics(h,"blue","CameraOnSurface"));this._debugCenters.set(this.focus,new n.PointGraphics(h,"green","Focus"));this._handles.add([e.watch(()=>a.contentCamera,l=>this._cameraChanged(l),e.sync),e.watch(()=>
c.extent,()=>this._updateCenterPointsOfInterest()),e.when(()=>!c.updating,()=>this._updateCenterPointsOfInterest(),e.sync),e.on(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),e.on(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),e.when(()=>H.SHOW_POI,l=>this._setDebug(l),e.initial)]);this._cameraChanged(this.view.state.contentCamera);for(const l of this._pois)l.runTask()};k.destroy=function(){this._setDebug(!1);
this._handles.destroy();this._propertiesPool.destroy();for(const a of this._pois)a.destroy();this.surfaceOrigin.destroy()};k._estimateContentAltitudeAtCenter=function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const a=this._centerRay;if(q.isNone(a))return this._contentAltitudeAtCenter;this.view.sceneIntersectionHelper.intersectRay(a,this._contentIntersector,m,T)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(m):
this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter();return this._contentAltitudeAtCenter};k._estimateSurfaceAltitudeAtCenter=function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const a=this._centerRay;if(q.isNone(a))return this._surfaceAltitudeAtCenter;const c=a.origin,g=r.add(m,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a,this.view.state.contentCamera);
this.view.basemapTerrain.intersect(this._surfaceIntersector,null,c,g);this._surfaceIntersector.results.min.getIntersectionPoint(m)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(m));return this._surfaceAltitudeAtCenter};k._estimateSurfaceIntersectionAtRenderPoint=function(a,c,g){a=J.fromRenderAtEye(c,a,U);if(q.isNone(a))return null;const x=a.origin,h=r.add(m,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a,c);this.view.basemapTerrain.intersect(this._surfaceIntersector,
null,x,h);return this._surfaceIntersector.results.min.getIntersectionPoint(g)?g:null};k._cameraChanged=function(a){this._updateCenterPointsOfInterest();a=a.eye;r.exactEquals(this.renderPointOfView,a)||this._set("renderPointOfView",r.copy(this._propertiesPool.get("renderPointOfView"),a))};k._updateCenterPointsOfInterest=function(){this._contentAltitudeAtCenterDirty=this._surfaceAltitudeAtCenterDirty=this._centerRayDirty=!0;for(const a of this._pois)a.updateRenderLocation()};k._updateCenterOnContent=
function(){this._contentAltitudeAtCenterDirty=!0;this.centerOnContent.updateRenderLocation()};k._setDebug=function(a){if(a)for(const c of this._pois)this._handles.add(e.watch(()=>c.renderLocation,g=>this._debugCenters.get(c)?.show(g,c.renderCoordsHelper.spatialReference),e.initial),"debug");else this._debugCenters.forEach(c=>c.hide()),this._handles.remove("debug")};v._createClass(u,[{key:"updating",get:function(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(a=>a.updating))}},{key:"_centerRay",
get:function(){this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1);return this._centerRayCached}},{key:"test",get:function(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const a of this._pois)a.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}}]);return u}(E);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnContent",
void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnSurfaceInfrequent",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"cameraOnSurface",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"focus",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"renderPointOfView",void 0);d.__decorate([f.property({readOnly:!0})],
b.PointsOfInterest.prototype,"surfaceOrigin",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"contentGeometryUpdates",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"surfaceGeometryUpdates",void 0);d.__decorate([f.property({constructOnly:!0})],b.PointsOfInterest.prototype,"view",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"updating",null);b.PointsOfInterest=d.__decorate([G.subclass("esri.views.3d.support.PointsOfInterest")],
b.PointsOfInterest);const R=Array,m=y.create(),U=z.create(),T={exclude:new Set([Q.TERRAIN_ID])};Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});