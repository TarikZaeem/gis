// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../support/buffer/InterleavedLayout ../core/shaderLibrary/ShaderOutput ../lib/GLMaterial ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./VisualVariablePassParameters ../shaders/LineMarkerTechniqueConfiguration ../../../../chunks/RibbonLine.glsl ../shaders/RibbonLineTechnique ../shaders/RibbonLineTechniqueConfiguration".split(" "),
function(ca,da,Z,ua,ea,U,V,va,g,A,wa,aa,O,x,xa,F,ya,fa,L,za,l,Aa,Ba,Ca,ma,na){function M(h,t,b,a,c){for(let d=0;d<c;d++)b[a++]=h[t++];return a}function oa(h,t,b){t=t.get(l.VertexAttribute.POSITION).data;b=b?b.get(l.VertexAttribute.POSITION):null;return h.isClosed?b?2<b.length:6<t.length:!1}var B;(function(h){h[h.LEFT_JOIN_START=-2]="LEFT_JOIN_START";h[h.LEFT_JOIN_END=-1]="LEFT_JOIN_END";h[h.LEFT_CAP_START=-4]="LEFT_CAP_START";h[h.LEFT_CAP_END=-5]="LEFT_CAP_END";h[h.RIGHT_JOIN_START=2]="RIGHT_JOIN_START";
h[h.RIGHT_JOIN_END=1]="RIGHT_JOIN_END";h[h.RIGHT_CAP_START=4]="RIGHT_CAP_START";h[h.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(B||(B={}));let Ha=function(h){function t(a){a=h.call(this,a,new pa)||this;a._configuration=new na.RibbonLineTechniqueConfiguration;a._vertexAttributeLocations=ma.vertexAttributeLocations;a._layout=a.createLayout();return a}da._inheritsLoose(t,h);var b=t.prototype;b.isClosed=function(a,c){return this.parameters.isClosed?c?2<c.length:6<a.length:!1};b.getConfiguration=function(a,c){this._configuration.output=
a;this._configuration.draped=c.slot===L.RenderSlot.DRAPED_MATERIAL;a=U.isSome(this.parameters.stipplePattern)&&a!==F.ShaderOutput.Highlight;this._configuration.stippleEnabled=a;this._configuration.stippleOffColorEnabled=a&&U.isSome(this.parameters.stippleOffColor);this._configuration.stippleScaleWithLineWidth=a&&this.parameters.stippleScaleWithLineWidth;this._configuration.stipplePreferContinuous=a&&this.parameters.stipplePreferContinuous;this._configuration.hasSlicePlane=this.parameters.hasSlicePlane;
this._configuration.hasOccludees=this.parameters.hasOccludees;this._configuration.roundJoins="round"===this.parameters.join;this._configuration.capType=this.parameters.cap;a=this._configuration;if(U.isSome(this.parameters.markerParameters)){var d=this.parameters.markerParameters;d=d.anchor===Ba.LineMarkerAnchor.Tip&&d.hideOnShortSegments&&"begin-end"===d.placement&&d.worldSpace}else d=!1;a.applyMarkerOffset=d;this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset;this._configuration.writeDepth=
this.parameters.writeDepth;this._configuration.vvColor=this.parameters.vvColorEnabled;this._configuration.vvOpacity=this.parameters.vvOpacityEnabled;this._configuration.vvSize=this.parameters.vvSizeEnabled;this._configuration.innerColorEnabled=0<this.parameters.innerWidth&&U.isSome(this.parameters.innerColor);this._configuration.falloffEnabled=0<this.parameters.falloff;this._configuration.occluder=this.parameters.renderOccluded===fa.RenderOccludedFlag.OccludeAndTransparentStencil;this._configuration.transparencyPassType=
c.transparencyPassType;this._configuration.hasMultipassTerrain=c.multipassTerrain.enabled;this._configuration.cullAboveGround=c.multipassTerrain.cullAboveGround;this._configuration.wireframe=this.parameters.wireframe;return this._configuration};b.intersectDraped=function(a,c,d,n,e,p){if(d.options.selectionMode){c=a.vertexAttributes.get(l.VertexAttribute.POSITION).data;d=a.vertexAttributes.get(l.VertexAttribute.SIZE);var f=this.parameters.width;this.parameters.vvSizeEnabled?(d=a.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0],
f*=ea.clamp(this.parameters.vvSizeOffset[0]+d*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])):d&&(f*=d.data[0]);d=n[0];n=n[1];a=(f/2+4)*a.screenToWorldRatio;f=Number.MAX_VALUE;var u=0;for(let G=0;G<c.length-5;G+=3){var q=c[G],w=c[G+1],D=d-q,k=n-w;q=c[G+3]-q;w=c[G+4]-w;const N=ea.clamp((q*D+w*k)/(q*q+w*w),0,1);D=q*N-D;k=w*N-k;k=D*D+k*k;k<f&&(f=k,u=G/3)}f<a*a&&e(p.dist,p.normal,u,!1)}};b.intersect=function(a,c,d,n,e,p){if(d.options.selectionMode&&
a.visible)if(za.isTranslationMatrix(c)){var f=a.vertexAttributes;e=f.get(l.VertexAttribute.POSITION).data;n=this.parameters.width;if(this.parameters.vvSizeEnabled){var u=f.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];n*=ea.clamp(this.parameters.vvSizeOffset[0]+u*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else f.has(l.VertexAttribute.SIZE)&&(n*=f.get(l.VertexAttribute.SIZE).data[0]);var q=d.camera,w=Da;va.copy(w,d.point);u=n*q.pixelRatio/
2+4*q.pixelRatio;g.set(X[0],w[0]-u,w[1]+u,0);g.set(X[1],w[0]+u,w[1]+u,0);g.set(X[2],w[0]+u,w[1]-u,0);g.set(X[3],w[0]-u,w[1]-u,0);for(n=0;4>n;n++)if(!q.unprojectFromRenderScreen(X[n],J[n]))return;x.fromPoints(q.eye,J[0],J[1],ha);x.fromPoints(q.eye,J[1],J[2],ia);x.fromPoints(q.eye,J[2],J[3],ja);x.fromPoints(q.eye,J[3],J[0],ka);var D=Number.MAX_VALUE;n=0;a=oa(this.parameters,f,a.indices)?e.length-2:e.length-5;for(f=0;f<a;f+=3){y[0]=e[f]+c[12];y[1]=e[f+1]+c[13];y[2]=e[f+2]+c[14];var k=(f+3)%e.length;
z[0]=e[k]+c[12];z[1]=e[k+1]+c[13];z[2]=e[k+2]+c[14];if(!(0>x.signedDistance(ha,y)&&0>x.signedDistance(ha,z)||0>x.signedDistance(ia,y)&&0>x.signedDistance(ia,z)||0>x.signedDistance(ja,y)&&0>x.signedDistance(ja,z)||0>x.signedDistance(ka,y)&&0>x.signedDistance(ka,z))){q.projectToRenderScreen(y,P);q.projectToRenderScreen(z,Q);if(0>P[2]&&0<Q[2])g.subtract(H,y,z),k=q.frustum,k=-x.signedDistance(k[aa.PlaneIndex.NEAR],y)/g.dot(H,x.normal(k[aa.PlaneIndex.NEAR])),g.scale(H,H,k),g.add(y,y,H),q.projectToRenderScreen(y,
P);else if(0<P[2]&&0>Q[2])g.subtract(H,z,y),k=q.frustum,k=-x.signedDistance(k[aa.PlaneIndex.NEAR],z)/g.dot(H,x.normal(k[aa.PlaneIndex.NEAR])),g.scale(H,H,k),g.add(z,z,H),q.projectToRenderScreen(z,Q);else if(0>P[2]&&0>Q[2])continue;P[2]=0;Q[2]=0;k=O.distance2(O.fromPoints(P,Q,qa),w);k<D&&(D=k,g.copy(ra,y),g.copy(sa,z),n=f/3)}}c=d.rayBegin;d=d.rayEnd;D<u*u&&(e=Number.MAX_VALUE,O.closestLineSegmentPoint(O.fromPoints(ra,sa,qa),O.fromPoints(c,d,Ea),R)&&(g.subtract(R,R,c),e=g.length(R),g.scale(R,R,1/e),
e/=g.distance(c,d)),p(e,R,n,!1))}else ua.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix")};b.createLayout=function(){const a=xa.newLayout().vec3f(l.VertexAttribute.POSITION).f32(l.VertexAttribute.SUBDIVISIONFACTOR).vec2f(l.VertexAttribute.UV0).vec3f(l.VertexAttribute.AUXPOS1).vec3f(l.VertexAttribute.AUXPOS2);this.parameters.vvSizeEnabled?a.f32(l.VertexAttribute.SIZEFEATUREATTRIBUTE):a.f32(l.VertexAttribute.SIZE);this.parameters.vvColorEnabled?
a.f32(l.VertexAttribute.COLORFEATUREATTRIBUTE):a.vec4f(l.VertexAttribute.COLOR);this.parameters.vvOpacityEnabled&&a.f32(l.VertexAttribute.OPACITYFEATUREATTRIBUTE);Z("enable-feature:objectAndLayerId-rendering")&&a.vec4u8(l.VertexAttribute.OBJECTANDLAYERIDCOLOR);return a};b.createBufferWriter=function(){return new Fa(this._layout,this.parameters)};b.requiresSlot=function(a,c){return c===F.ShaderOutput.Color||c===F.ShaderOutput.Alpha||c===F.ShaderOutput.Highlight||c===F.ShaderOutput.Depth||c===F.ShaderOutput.ObjectAndLayerIdColor?
a===L.RenderSlot.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===fa.RenderOccludedFlag.OccludeAndTransparentStencil?a===L.RenderSlot.OPAQUE_MATERIAL||a===L.RenderSlot.OCCLUDER_MATERIAL||a===L.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL:c===F.ShaderOutput.Color||c===F.ShaderOutput.Alpha?a===(this.parameters.writeDepth?L.RenderSlot.TRANSPARENT_MATERIAL:L.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):a===L.RenderSlot.OPAQUE_MATERIAL:!1};b.createGLMaterial=function(a){return new Ga(a)};b.validateParameters=
function(a){"miter"!==a.join&&(a.miterLimit=0);U.isSome(a.markerParameters)&&(a.markerScale=a.markerParameters.width/a.width)};return t}(fa.Material),Ga=function(h){function t(){var a=h.apply(this,arguments)||this;a._stipplePattern=null;return a}da._inheritsLoose(t,h);var b=t.prototype;b.dispose=function(){h.prototype.dispose.call(this);this._stippleTextureRepository.release(this._stipplePattern);this._stipplePattern=null};b._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.hasOccludees&&
this._material.setParameters({hasOccludees:a.hasOccludees})};b.beginSlot=function(a){this._output!==F.ShaderOutput.Color&&this._output!==F.ShaderOutput.Alpha||this._updateOccludeeState(a);const c=this._material.parameters.stipplePattern;this._stipplePattern!==c&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,c)),this._stipplePattern=c);return this.ensureTechnique(ma.RibbonLineTechnique,a)};return t}(ya),pa=function(h){function t(){var b=h.apply(this,arguments)||
this;b.width=0;b.color=wa.ONES;b.join="miter";b.cap=na.CapType.BUTT;b.miterLimit=5;b.writeDepth=!0;b.hasPolygonOffset=!1;b.stippleTexture=null;b.stippleScaleWithLineWidth=!1;b.stipplePreferContinuous=!0;b.markerParameters=null;b.markerScale=1;b.hasSlicePlane=!1;b.vvFastUpdate=!1;b.isClosed=!1;b.falloff=0;b.innerWidth=0;b.hasOccludees=!1;b.wireframe=!1;return b}da._inheritsLoose(t,h);return t}(Aa.VisualVariablePassParameters),Fa=function(){function h(b,a){this._parameters=a;this.numJoinSubdivisions=
0;this.vertexBufferLayout=b;b=a.stipplePattern?1:0;switch(this._parameters.join){case "miter":case "bevel":this.numJoinSubdivisions=b;break;case "round":this.numJoinSubdivisions=Ca.RIBBONLINE_NUM_ROUND_JOIN_SUBDIVISIONS+b}}var t=h.prototype;t._isClosed=function(b){return oa(this._parameters,b.vertexAttributes,b.indices)};t.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};t.elementCount=function(b){var a=b.indices.get(l.VertexAttribute.POSITION).length/2+1;b=this._isClosed(b);a=
(b?2:4)+((b?a:a-1)-(b?0:1))*(2*this.numJoinSubdivisions+4);a+=2;this._parameters.wireframe&&(a=2+4*(a-2));return a};t.write=function(b,a,c,d,n){a=Ia;const e=Ja,p=Ka,f=c.vertexAttributes.get(l.VertexAttribute.POSITION).data;var u=c.indices&&c.indices.get(l.VertexAttribute.POSITION);const q=c.vertexAttributes.get(l.VertexAttribute.DISTANCETOSTART)?.data;u&&u.length!==2*(f.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let w=1,D=0;this._parameters.vvSizeEnabled?D=c.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:
c.vertexAttributes.has(l.VertexAttribute.SIZE)&&(w=c.vertexAttributes.get(l.VertexAttribute.SIZE).data[0]);let k=[1,1,1,1],G=0;this._parameters.vvColorEnabled?G=c.vertexAttributes.get(l.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:c.vertexAttributes.has(l.VertexAttribute.COLOR)&&(k=c.vertexAttributes.get(l.VertexAttribute.COLOR).data);const N=Z("enable-feature:objectAndLayerId-rendering")?c.objectAndLayerIdColor:null;let ta=0;this._parameters.vvOpacityEnabled&&(ta=c.vertexAttributes.get(l.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);
u=f.length/3;const r=new Float32Array(d.buffer),ba=Z("enable-feature:objectAndLayerId-rendering")?new Uint8Array(d.buffer):null,S=this.vertexBufferLayout.stride/4;let m=n*S;n=m;let C=0;const la=q?(v,I,K)=>C=q[K]:(v,I,K)=>C+=g.distance(v,I),La=Z("enable-feature:objectAndLayerId-rendering"),E=(v,I,K,Ma,Na,Oa,Pa)=>{r[m++]=I[0];r[m++]=I[1];r[m++]=I[2];r[m++]=Ma;r[m++]=Pa;r[m++]=Na;r[m++]=v[0];r[m++]=v[1];r[m++]=v[2];r[m++]=K[0];r[m++]=K[1];r[m++]=K[2];this._parameters.vvSizeEnabled?r[m++]=D:r[m++]=w;
this._parameters.vvColorEnabled?r[m++]=G:(v=Math.min(4*Oa,k.length-4),r[m++]=k[v],r[m++]=k[v+1],r[m++]=k[v+2],r[m++]=k[v+3]);this._parameters.vvOpacityEnabled&&(r[m++]=ta);La&&(U.isSome(N)&&(ba[4*m]=N[0],ba[4*m+1]=N[1],ba[4*m+2]=N[2],ba[4*m+3]=N[3]),m++)};m+=S;g.set(e,f[0],f[1],f[2]);b&&g.transformMat4(e,e,b);if(c=this._isClosed(c)){var T=f.length-3;g.set(a,f[T],f[T+1],f[T+2]);b&&g.transformMat4(a,a,b)}else g.set(p,f[3],f[4],f[5]),b&&g.transformMat4(p,p,b),E(e,e,p,1,B.LEFT_CAP_START,0,0),E(e,e,p,
1,B.RIGHT_CAP_START,0,0),g.copy(a,e),g.copy(e,p);T=c?0:1;const Y=c?u:u-1;for(let v=T;v<Y;v++){var W=(v+1)%u*3;g.set(p,f[W],f[W+1],f[W+2]);b&&g.transformMat4(p,p,b);la(a,e,v);E(a,e,p,0,B.LEFT_JOIN_END,v,C);E(a,e,p,0,B.RIGHT_JOIN_END,v,C);W=this.numJoinSubdivisions;for(let I=0;I<W;++I){const K=(I+1)/(W+1);E(a,e,p,K,B.LEFT_JOIN_END,v,C);E(a,e,p,K,B.RIGHT_JOIN_END,v,C)}E(a,e,p,1,B.LEFT_JOIN_START,v,C);E(a,e,p,1,B.RIGHT_JOIN_START,v,C);g.copy(a,e);g.copy(e,p)}c?(g.set(p,f[3],f[4],f[5]),b&&g.transformMat4(p,
p,b),C=la(a,e,Y),E(a,e,p,0,B.LEFT_JOIN_END,T,C),E(a,e,p,0,B.RIGHT_JOIN_END,T,C)):(C=la(a,e,Y),E(a,e,e,0,B.LEFT_CAP_END,Y,C),E(a,e,e,0,B.RIGHT_CAP_END,Y,C));M(r,n+S,r,n,S);m=M(r,m-S,r,m,S);this._parameters.wireframe&&this._addWireframeVertices(d,n,m,S)};t._addWireframeVertices=function(b,a,c,d){const n=new Float32Array(b.buffer,c*Float32Array.BYTES_PER_ELEMENT);b=new Float32Array(b.buffer,a*Float32Array.BYTES_PER_ELEMENT,c-a);a=0;for(c=0;c<b.length-1;c+=2*d)a=M(b,c,n,a,d),a=M(b,c+2*d,n,a,d),a=M(b,
c+1*d,n,a,d),a=M(b,c+2*d,n,a,d),a=M(b,c+1*d,n,a,d),a=M(b,c+3*d,n,a,d)};return h}();const y=A.create(),z=A.create(),H=A.create(),R=A.create(),Da=A.create(),P=V.createRenderScreenPointArray3(),Q=V.createRenderScreenPointArray3(),ra=A.create(),sa=A.create(),qa=O.create(),Ea=O.create(),Ia=A.create(),Ja=A.create(),Ka=A.create(),X=[V.createRenderScreenPointArray3(),V.createRenderScreenPointArray3(),V.createRenderScreenPointArray3(),V.createRenderScreenPointArray3()],J=[A.create(),A.create(),A.create(),
A.create()],ha=x.create(),ia=x.create(),ja=x.create(),ka=x.create();ca.Parameters=pa;ca.RibbonLineMaterial=Ha;Object.defineProperty(ca,Symbol.toStringTag,{value:"Module"})});