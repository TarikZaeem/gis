// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../../../geometry/support/buffer/BufferView ../core/shaderLibrary/ShaderOutput ../lib/GLMaterial ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./DefaultBufferWriter ./DefaultLayouts ./internal/bufferWriterUtils ../shaders/NativeLineTechnique ../shaders/NativeLineTechniqueConfiguration".split(" "),
function(M,N,da,ea,O,H,fa,h,y,ha,J,D,n,U,K,ia,V,P,ja,w,ka,W,la,ma,na){var L;(function(p){p[p.START=0]="START";p[p.END=1]="END"})(L||(L={}));let sa=function(p){function q(a){a=p.call(this,a,new X)||this;a._configuration=new na.NativeLineTechniqueConfiguration;return a}N._inheritsLoose(q,p);var b=q.prototype;b.getConfiguration=function(a,c){this._configuration.output=a;this._configuration.hasSlicePlane=this.parameters.hasSlicePlane;this._configuration.hasVertexColors=this.parameters.hasVertexColors;
this._configuration.transparent=1>this.parameters.color[3]||1>this.parameters.width;this._configuration.draped=c.slot===P.RenderSlot.DRAPED_MATERIAL;a=O.isSome(this.parameters.stipplePattern);this._configuration.stippleEnabled=a;this._configuration.stippleOffColorEnabled=a&&O.isSome(this.parameters.stippleOffColor);this._configuration.hasOccludees=this.parameters.hasOccludees;this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous;return this._configuration};b.intersect=
function(a,c,f,d,m,u){if(f.options.selectionMode&&a.visible)if(ja.isTranslationMatrix(c)){m=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;var g=f.camera,k=oa;fa.copy(k,f.point);h.set(I[0],k[0]-2,k[1]+2,0);h.set(I[1],k[0]+2,k[1]+2,0);h.set(I[2],k[0]+2,k[1]-2,0);h.set(I[3],k[0]-2,k[1]-2,0);for(a=0;4>a;a++)if(!g.unprojectFromRenderScreen(I[a],B[a]))return;n.fromPoints(g.eye,B[0],B[1],Q);n.fromPoints(g.eye,B[1],B[2],R);n.fromPoints(g.eye,B[2],B[3],S);n.fromPoints(g.eye,B[3],B[0],T);d=Number.MAX_VALUE;
a=0;for(let l=0;l<m.length-5;l+=3)if(r[0]=m[l]+c[12],r[1]=m[l+1]+c[13],r[2]=m[l+2]+c[14],t[0]=m[l+3]+c[12],t[1]=m[l+4]+c[13],t[2]=m[l+5]+c[14],!(0>n.signedDistance(Q,r)&&0>n.signedDistance(Q,t)||0>n.signedDistance(R,r)&&0>n.signedDistance(R,t)||0>n.signedDistance(S,r)&&0>n.signedDistance(S,t)||0>n.signedDistance(T,r)&&0>n.signedDistance(T,t))){g.projectToRenderScreen(r,E);g.projectToRenderScreen(t,F);if(0>E[2]&&0<F[2]){h.subtract(z,r,t);var e=g.frustum;e=-n.signedDistance(e[J.PlaneIndex.NEAR],r)/
h.dot(z,n.normal(e[J.PlaneIndex.NEAR]));h.scale(z,z,e);h.add(r,r,z);g.projectToRenderScreen(r,E)}else if(0<E[2]&&0>F[2])h.subtract(z,t,r),e=g.frustum,e=-n.signedDistance(e[J.PlaneIndex.NEAR],t)/h.dot(z,n.normal(e[J.PlaneIndex.NEAR])),h.scale(z,z,e),h.add(t,t,z),g.projectToRenderScreen(t,F);else if(0>E[2]&&0>F[2])continue;E[2]=0;F[2]=0;e=D.distance2(D.fromPoints(E,F,Y),k);e<d&&(d=e,h.copy(Z,r),h.copy(aa,t),a=l/3)}c=f.rayBegin;f=f.rayEnd;4>d&&(d=Number.MAX_VALUE,D.closestLineSegmentPoint(D.fromPoints(Z,
aa,Y),D.fromPoints(c,f,pa),G)&&(h.subtract(G,G,c),d=h.length(G),h.scale(G,G,1/d),d/=h.distance(c,f)),u(d,G,a,!1))}else da.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix")};b.intersectDraped=function(a,c,f,d,m,u){if(f.options.selectionMode){c=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;var g=a.vertexAttributes.get(w.VertexAttribute.SIZE);f=d[0];d=d[1];a=(((g?g.data[0]:0)+1)/2+4)*a.screenToWorldRatio;g=Number.MAX_VALUE;
var k=0;for(let v=0;v<c.length-5;v+=3){var e=c[v],l=c[v+1],A=f-e,x=d-l;e=c[v+3]-e;l=c[v+4]-l;const C=ea.clamp((e*A+l*x)/(e*e+l*l),0,1);A=e*C-A;x=l*C-x;x=A*A+x*x;x<g&&(g=x,k=v/3)}g<a*a&&m(u.dist,u.normal,k,!1)}};b.requiresSlot=function(a,c){return(c===K.ShaderOutput.Color||c===K.ShaderOutput.Highlight||c===K.ShaderOutput.ObjectAndLayerIdColor)&&(a===P.RenderSlot.OPAQUE_MATERIAL||a===P.RenderSlot.DRAPED_MATERIAL)};b.createGLMaterial=function(a){return new qa(a)};b.createBufferWriter=function(){const a=
this.parameters.hasVertexColors?W.PositionColorLayout:W.PositionLayout;return O.isNone(this.parameters.stipplePattern)?new ka.DefaultBufferWriter(a):new ra(a.clone().vec3f(w.VertexAttribute.AUXPOS1).vec2f(w.VertexAttribute.UV0))};return q}(V.Material),qa=function(p){function q(){var a=p.apply(this,arguments)||this;a._stipplePattern=null;return a}N._inheritsLoose(q,p);var b=q.prototype;b.dispose=function(){p.prototype.dispose.call(this);this._stippleTextureRepository.release(this._stipplePattern);
this._stipplePattern=null};b._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})};b.beginSlot=function(a){this._output===K.ShaderOutput.Color&&this._updateOccludeeState(a);const c=this._material.parameters.stipplePattern;this._stipplePattern!==c&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,c)),this._stipplePattern=c);return this.ensureTechnique(ma.NativeLineTechnique,
a)};return q}(ia),ra=function(){function p(b){this.vertexBufferLayout=b}var q=p.prototype;q.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};q.elementCount=function(b){return b.indices.get(w.VertexAttribute.POSITION).length};q.write=function(b,a,c,f,d){la.writeDefaultAttributes(c,this.vertexBufferLayout,b,a,f,d);this._writeAuxpos1(b,c,f,d);this._writeUV0(b,c,f,d)};q._writeAuxpos1=function(b,a,c,f){var d=c.getField(w.VertexAttribute.AUXPOS1,U.BufferViewVec3f);c=a.indices.get(w.VertexAttribute.POSITION);
a=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;const m=d.typedBufferStride;d=d.typedBuffer;f*=m;for(let g=0;g<c.length-1;g+=2)for(const k of[1,0]){var u=3*c[g+k];const e=a[u],l=a[u+1];u=a[u+2];const A=b[1]*e+b[5]*l+b[9]*u+b[13],x=b[2]*e+b[6]*l+b[10]*u+b[14];d[f]=b[0]*e+b[4]*l+b[8]*u+b[12];d[f+1]=A;d[f+2]=x;f+=m}};q._writeUV0=function(b,a,c,f){var d=c.getField(w.VertexAttribute.UV0,U.BufferViewVec2f),m=a.indices.get(w.VertexAttribute.POSITION);c=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;
const u=a.vertexAttributes.get(w.VertexAttribute.DISTANCETOSTART)?.data;a=d.typedBufferStride;d=d.typedBuffer;f*=a;let g=0;d[f]=L.START;d[f+1]=g;f+=a;var k=3*m[0];k=h.set(r,c[k],c[k+1],c[k+2]);b&&h.transformMat4(k,k,b);const e=t,l=m.length-1;let A=1;const x=u?(C,ba,ca)=>g=u[ca]:(C,ba,ca)=>g+=h.distance(C,ba);for(let C=1;C<l;C+=2){var v=3*m[C];h.set(e,c[v],c[v+1],c[v+2]);b&&h.transformMat4(e,e,b);x(k,e,A++);for(v=0;2>v;++v)d[f]=1-v,d[f+1]=g,f+=a;h.copy(k,e)}m=3*m[l];h.set(e,c[m],c[m+1],c[m+2]);b&&
h.transformMat4(e,e,b);x(k,e,A);d[f]=L.END;d[f+1]=g};return p}(),X=function(p){function q(){var b=p.apply(this,arguments)||this;b.color=ha.ONES;b.hasVertexColors=!1;b.hasSlicePlane=!1;b.width=1;b.stipplePreferContinuous=!0;b.hasOccludees=!1;b.stippleTexture=null;return b}N._inheritsLoose(q,p);return q}(V.MaterialParameters);const r=y.create(),t=y.create(),z=y.create(),G=y.create(),E=H.createRenderScreenPointArray3(),F=H.createRenderScreenPointArray3(),Z=y.create(),aa=y.create(),Y=D.create(),pa=D.create(),
oa=y.create(),I=[H.createRenderScreenPointArray3(),H.createRenderScreenPointArray3(),H.createRenderScreenPointArray3(),H.createRenderScreenPointArray3()],B=[y.create(),y.create(),y.create(),y.create()],Q=n.create(),R=n.create(),S=n.create(),T=n.create();M.NativeLineMaterial=sa;M.Parameters=X;Object.defineProperty(M,Symbol.toStringTag,{value:"Module"})});