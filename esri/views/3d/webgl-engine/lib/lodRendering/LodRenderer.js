// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4f64 ../../../support/debugFlags ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ../../core/shaderLibrary/ShaderOutput ../Camera ../DefaultVertexAttributeLocations ../IntersectorInterfaces ../Octree ../RenderSlot ../Util ../VertexAttribute ./InstanceData ./InstanceOctree ./LevelSelector ./LodLevel ./RenderInstanceData ../../materials/internal/MaterialUtil ../../materials/renderers/utils ../../shaders/DefaultMaterialTechnique ../../../../support/Scheduler ../../../../webgl/Util".split(" "),
function(u,F,x,V,w,I,z,na,oa,W,X,A,G,C,J,Y,Z,D,aa,K,ba,L,H,E,B,r,ca,da,ea,M,fa,ha,ia,N,O){function P(g,n,l){const a=g.allocateHead();g=g.view;ha.encodeDoubleVec3(n.modelOrigin,l,g.modelOriginHi,g.modelOriginLo,a);g.model.copyFrom(a,n.model,l);g.modelNormal.copyFrom(a,n.modelNormal,l);n.color&&g.color&&g.color.copyFrom(a,n.color,l);n.objectAndLayerIdColor&&g.objectAndLayerIdColor&&g.objectAndLayerIdColor.copyFrom(a,n.objectAndLayerIdColor,l);n.featureAttribute&&g.featureAttribute&&g.featureAttribute.copyFrom(a,
n.featureAttribute,l)}function ja(g){let n=Z.newLayout().vec3f(B.VertexAttribute.MODELORIGINHI).vec3f(B.VertexAttribute.MODELORIGINLO).mat3f(B.VertexAttribute.MODEL).mat3f(B.VertexAttribute.MODELNORMAL);w.isSome(g)&&g.includes("color")&&(n=n.vec4f(B.VertexAttribute.INSTANCECOLOR));w.isSome(g)&&g.includes("featureAttribute")&&(n=n.vec4f(B.VertexAttribute.INSTANCEFEATUREATTRIBUTE));w.isSome(g)&&g.includes("objectAndLayerIdColor")&&(n=n.vec4u8(B.VertexAttribute.OBJECTANDLAYERIDCOLOR_INSTANCED));return n}
const ka=g=>{const n=g.baseBoundingSphere.radius;g=g.levels.map(l=>l.minScreenSpaceRadius);return new da.LevelSelector(n,g)};u.LodRenderer=function(g){function n(a,c){var b=g.call(this,a)||this;b.type=ba.IntersectorType.LOD;b.isGround=!1;b._levels=[];b._defaultRenderInstanceData=[];b._highlightRenderInstanceData=[];b._instanceIndex=0;b._cycleStartIndex=0;b._slicePlane=!1;b._camera=new aa.Camera;b._updateCyclesWithStaticCamera=-1;b._needFullCycle=!1;b.slots=[H.RenderSlot.OPAQUE_MATERIAL,H.RenderSlot.TRANSPARENT_MATERIAL];
b.canRender=!0;b._instanceData=new r.InstanceData({shaderTransformation:a.shaderTransformation},a.optionalFields);b._frameTask=c.registerTask(N.TaskPriority.LOD_RENDERER,F._assertThisInitialized(b));return b}F._inheritsLoose(n,g);var l=n.prototype;l.initialize=function(){this._instanceBufferLayout=ja(this.optionalFields);this._glInstanceBufferLayout=Y.glLayout(this._instanceBufferLayout,1);this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle());this._instanceData.events.on("instance-transform-changed",
({index:a})=>{this._requestUpdateCycle();this.metadata.notifyGraphicGeometryChanged(a)});this._instanceData.events.on("instance-visibility-changed",({index:a})=>{this._requestUpdateCycle(!0);this.metadata.notifyGraphicVisibilityChanged(a)});this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))};l.destroy=function(){this._frameTask.remove()};l.initializeRenderContext=function(){var a=F._asyncToGenerator(function*(c,b){this._context=c;const d=c.renderContext.rctx,
e=yield Promise.allSettled(this.symbol.levels.map(m=>{this._defaultRenderInstanceData.push(new M.RenderInstanceData(d,this._instanceBufferLayout));this._highlightRenderInstanceData.push(new M.RenderInstanceData(d,this._instanceBufferLayout));return ea.LodLevel.create(c,m,b)})),k=e.map(m=>"fulfilled"===m.status?m.value:null).filter(w.isSome);if(I.isAborted(b)||k.length!==e.length){k.forEach(m=>m.destroy());I.throwIfAborted(b);for(const m of e)if("rejected"===m.status)throw m.reason;}this._levels=k;
this._levelSelector=ka(this)});return function(c,b){return a.apply(this,arguments)}}();l.uninitializeRenderContext=function(){this._invalidateOctree();this._levels.forEach(a=>a.destroy());this._defaultRenderInstanceData.forEach(a=>a.destroy());this._highlightRenderInstanceData.forEach(a=>a.destroy())};l.prepareRender=function(a){if(!J.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const c=a.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(a.bindParameters.contentCamera);
c||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(N.noBudget),this._needFullCycle=!1)}};l.render=function(a){this.baseMaterial.isVisible()&&this.baseMaterial.isVisibleForOutput(a.output)&&(a.rctx.bindVAO(),a.output!==D.ShaderOutput.Highlight&&a.output!==D.ShaderOutput.ShadowHighlight&&this._renderComponents(a,this._defaultRenderInstanceData),a.output!==D.ShaderOutput.ShadowExcludeHighlight&&this._renderComponents(a,this._highlightRenderInstanceData))};l.intersect=function(a,c,b,d){if(this.baseMaterial.isVisible()&&
!w.isNone(this._octree)){var e=G.create();A.subtract(e,d,b);var k=m=>{this._instanceData.getCombinedModelTransform(m,Q);a.transform.set(Q);A.transformMat4(R,b,a.transform.inverse);A.transformMat4(S,d,a.transform.inverse);const q=this._instanceData.getState(m),h=this._instanceData.getLodLevel(m),f=this._levels.length;E.assert(0!==(q&r.StateFlags.ACTIVE),"invalid instance state");E.assert(0<=h&&h<f,"invaid lod level");this._levels[h].intersect(a,c,R,S,m,this.metadata,f)};this.baseMaterial.parameters.verticalOffset?
this._octree.forEach(k):this._octree.forEachAlongRay(b,e,k)}};l.queryDepthRange=function(a){return this._queryDepthRangeOctree(a)};l.notifyShaderTransformationChanged=function(){this._invalidateOctree();this._requestUpdateCycle()};l._invalidateOctree=function(){this._octreeCached=w.destroyMaybe(this._octreeCached)};l._queryDepthRangeOctree=function(a){if(w.isNone(this._octree))return{near:Infinity,far:-Infinity};var c=a.viewForward,b=this._octree.findClosest(c,L.DepthOrder.FRONT_TO_BACK,a.frustum);
const d=this._octree.findClosest(c,L.DepthOrder.BACK_TO_FRONT,a.frustum);if(null==b||null==d)return{near:Infinity,far:-Infinity};const e=a.eye,k=this._instanceData.view;k.boundingSphere.getVec(b,y);A.subtract(y,y,e);b=A.dot(y,c)-y[3];k.boundingSphere.getVec(d,y);A.subtract(y,y,e);c=A.dot(y,c)+y[3];return{near:Math.max(a.near,b),far:Math.min(a.far,c)}};l._requestUpdateCycle=function(a=!1){this._updateCyclesWithStaticCamera=-1;this._cycleStartIndex=this._instanceIndex;a&&(this._needFullCycle=!0,this._context.requestRender())};
l._startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._defaultRenderInstanceData.forEach(a=>a.startUpdateCycle());this._highlightRenderInstanceData.forEach(a=>a.startUpdateCycle())};l.runTask=function(a){const {_enableLevelSelection:c,_camera:b,_levelSelector:d}=this;this._defaultRenderInstanceData.forEach(p=>p.beginUpdate());this._highlightRenderInstanceData.forEach(p=>p.beginUpdate());const e=this._instanceData,k=e.view;let m=e.size;const q=e.capacity;let h=this._instanceIndex;
for(let p=0;p<m&&!a.done;++p){h===this._cycleStartIndex&&this._startUpdateCycle();const v=k.state.get(h);var f=0;if(v&r.StateFlags.ALLOCATED){var t=k.lodLevel.get(h);v&r.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[t].freeTail();v&r.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[t].freeTail();v&r.StateFlags.REMOVE?e.freeInstance(h):v&r.StateFlags.VISIBLE?(t=0,c&&(k.modelOrigin.getVec(h,T),t=d.selectLevel(T,e.getCombinedMedianScaleFactor(h),b)),f=v&~(r.StateFlags.ACTIVE|
r.StateFlags.TRANSFORM_CHANGED),0<=t&&(v&r.StateFlags.HIGHLIGHT?(P(this._highlightRenderInstanceData[t],k,h),f|=r.StateFlags.HIGHLIGHT_ACTIVE):(P(this._defaultRenderInstanceData[t],k,h),f|=r.StateFlags.DEFAULT_ACTIVE)),k.state.set(h,f),k.lodLevel.set(h,t)):(f=v&~(r.StateFlags.ACTIVE|r.StateFlags.TRANSFORM_CHANGED),k.state.set(h,f));w.isSome(this._octreeCached)&&(t=!!(v&r.StateFlags.ACTIVE),f=!!(f&r.StateFlags.ACTIVE),!t&&f?this._octreeCached.addInstance(h):t&&!f?this._octreeCached.removeInstance(h):
t&&f&&v&r.StateFlags.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(h),this._octreeCached.addInstance(h)));h=h+1===q?0:h+1;a.madeProgress()}else h=h+1===q?0:h+1,m++}this._instanceIndex=h;this._defaultRenderInstanceData.forEach(p=>p.endUpdate());this._highlightRenderInstanceData.forEach(p=>p.endUpdate());this._context.requestRender()};l._renderComponents=function(a,c){this.levels.forEach((b,d)=>{const e=b.components.map(k=>this._beginComponent(a,c[d],k));b.components.forEach((k,m)=>this._renderComponent(a,
e[m],c[d],k,d))})};l._beginComponent=function(a,c,b){const {bindParameters:d,rctx:e,output:k}=a;if(0===c.size||!b.material.requiresSlot(d.slot,a.output))return null;a=b.glMaterials.load(e,d.slot,k);return w.isSome(a)?a.beginSlot(d):null};l._renderComponent=function(a,c,b,d,e){if(!w.isNone(c)){var {bindParameters:k,rctx:m}=a,q=m.bindTechnique(c,d.material.parameters,k);m.bindVAO(d.vao);c.ensureAttributeLocations(d.vao);q.bindDraw(la,k,d.material.parameters);J.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&
a.output===D.ShaderOutput.Color&&(q.setUniform4fv("externalColor",U[Math.min(e,U.length-1)]),q.setUniform1i("colorMixMode",fa.colorMixModes.replace));var h=m.capabilities.instancing;a=b.capacity;e=b.headIndex;q=b.tailIndex;var f=b.firstIndex,t=this._glInstanceBufferLayout,p=(v,ma)=>{O.bindVertexBufferLayout(m,K.Default3D,b.buffer,t,v);h.drawArraysInstanced(c.primitiveType,0,d.vertexCount,ma-v);O.unbindVertexBufferLayout(m,K.Default3D,b.buffer,t)};d.material.parameters.transparent&&null!=f?e>q?(E.assert(f>=
q&&f<=e,"invalid firstIndex"),p(f,e),p(q,f)):e<q&&(f<=e?(E.assert(0<=f&&f<=e,"invalid firstIndex"),p(f,e),p(q,a),p(0,f)):(E.assert(f>=q&&f<=a,"invalid firstIndex"),p(f,a),p(0,e),p(q,f))):e>q?p(q,e):e<q&&(p(0,e),p(q,a));m.bindVAO(null)}};F._createClass(n,[{key:"_enableLevelSelection",get:function(){return 1<this.symbol.levels.length}},{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",
get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlaneEnabled",get:function(){return this._slicePlane},set:function(a){this._slicePlane=a}},{key:"layerUid",get:function(){return this.metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const a={cpu:0,gpu:0};this._defaultRenderInstanceData.forEach(c=>
{c=c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});this._highlightRenderInstanceData.forEach(c=>{c=c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});return a}},{key:"renderStats",get:function(){const a=this._instanceData.size,c=[];this._levels.forEach((b,d)=>{d=this._defaultRenderInstanceData[d].size+this._highlightRenderInstanceData[d].size;b=b.triangleCount;c.push({renderedInstances:d,renderedTriangles:d*b,trianglesPerInstance:b})});return{totalInstances:a,renderedInstances:c.reduce((b,d)=>b+d.renderedInstances,
0),renderedTriangles:c.reduce((b,d)=>b+d.renderedTriangles,0),levels:c}}},{key:"needsTransparentPass",get:function(){return this._levels.some(a=>a.components.some(c=>c.material.requiresSlot(H.RenderSlot.TRANSPARENT_MATERIAL,D.ShaderOutput.Color)))}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData.some(a=>0<a.size)}},{key:"_octree",get:function(){if(w.isNone(this._octreeCached)){const a=this._instanceData,c=a.view?.state;if(!c)return null;this._octreeCached=new ca.InstanceOctree(a,
this.baseBoundingSphere);for(let b=0;b<a.capacity;++b)c.get(b)&r.StateFlags.ACTIVE&&this._octreeCached.addInstance(b)}return this._octreeCached}},{key:"running",get:function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera}}]);return n}(V);x.__decorate([z.property({constructOnly:!0})],u.LodRenderer.prototype,"symbol",void 0);x.__decorate([z.property({constructOnly:!0})],u.LodRenderer.prototype,"optionalFields",void 0);x.__decorate([z.property({constructOnly:!0})],u.LodRenderer.prototype,
"metadata",void 0);x.__decorate([z.property({constructOnly:!0})],u.LodRenderer.prototype,"shaderTransformation",void 0);x.__decorate([z.property()],u.LodRenderer.prototype,"_instanceData",void 0);x.__decorate([z.property()],u.LodRenderer.prototype,"_cycleStartIndex",void 0);x.__decorate([z.property({readOnly:!0})],u.LodRenderer.prototype,"_enableLevelSelection",null);x.__decorate([z.property()],u.LodRenderer.prototype,"_updateCyclesWithStaticCamera",void 0);x.__decorate([z.property({readOnly:!0})],
u.LodRenderer.prototype,"running",null);u.LodRenderer=x.__decorate([W.subclass("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],u.LodRenderer);const T=G.create(),y=C.create(),Q=X.create(),R=G.create(),S=G.create(),U=[C.fromValues(1,0,1,1),C.fromValues(0,0,1,1),C.fromValues(0,1,0,1),C.fromValues(1,1,0,1),C.fromValues(1,0,0,1)],la=new ia.DefaultMaterialDrawParameters;Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});