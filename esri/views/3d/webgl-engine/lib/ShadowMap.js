// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../ViewingMode ./CascadeCamera ./Util ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),
function(P,na,oa,X,I,pa,J,K,d,p,Q,da,Y,Z,qa,ra,r,t,sa,U,ta){function w(x,l){d.set(ea,x[l],x[l+3]);return ea}P.SnapshotSlot=void 0;(function(x){x[x.Highlight=0]="Highlight";x[x.Default=1]="Default"})(P.SnapshotSlot||(P.SnapshotSlot={}));let V=function(){this.camera=new ra.CascadeCamera;this.lightMat=K.create()},wa=function(){function x(b,c){this._rctx=b;this._viewingMode=c;this._enabled=!1;this._snapshots=[];this._textureSize=0;this._numCascades=1;this._maxNumCascades=4;this._projectionView=K.create();
this._projectionViewInverse=K.create();this._modelViewLight=K.create();this._splitSchemeLambda=0;this._cascadeDistances=[0,0,0,0,0];this._usedCascadeDistances=Z.create();this._cascades=[new V,new V,new V,new V];this._lastOrigin=null;this._maxTextureSize=Math.min(oa("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}var l=x.prototype;l.dispose=function(){this.enabled=!1;this.disposeOffscreenBuffers()};l.disposeOffscreenBuffers=function(){this._discardDepthTexture();this._discardAllSnapshots()};
l.getSnapshot=function(b){return this.enabled?this._snapshots[b]:null};l.start=function(b,c,e){r.assert(this.enabled);this._textureSize=this._computeTextureSize(b.fullWidth,b.fullHeight);this._ensureDepthTexture();const {near:g,far:u}=this._clampNearFar(e);this._computeCascadeDistances(u,g);this._setupMatrices(b,c);const {viewMatrix:h,projectionMatrix:m}=b;for(b=0;b<this._numCascades;++b)this._constructCascade(b,m,h,c);this._lastOrigin=null;this.clear()};l.finish=function(b){r.assert(this.enabled);
this._rctx.bindFramebuffer(b)};l.getShadowMapMatrices=function(b){if(!this._lastOrigin||!Q.exactEquals(b,this._lastOrigin)){this._lastOrigin=this._lastOrigin||da.create();Q.copy(this._lastOrigin,b);for(let c=0;c<this._numCascades;++c){J.translate(fa,this._cascades[c].lightMat,b);for(let e=0;16>e;++e)ha[16*c+e]=fa[e]}}return ha};l.takeCascadeSnapshotTo=function(b,c){r.assert(this.enabled);var e=this._ensureSnapshot(c);this._bindFbo();c=this._rctx;e=c.bindTexture(e,U.Texture.TEXTURE_UNIT_FOR_UPDATES);
c.gl.copyTexSubImage2D(t.TextureType.TEXTURE_2D,0,b.camera.viewport[0],b.camera.viewport[1],b.camera.viewport[0],b.camera.viewport[1],b.camera.viewport[2],b.camera.viewport[3]);c.bindTexture(e,U.Texture.TEXTURE_UNIT_FOR_UPDATES)};l.clear=function(){const b=this._rctx;this._bindFbo();b.setClearColor(1,1,1,1);b.clearSafe(t.ClearBufferBit.COLOR_BUFFER_BIT|t.ClearBufferBit.DEPTH_BUFFER_BIT)};l._computeTextureSize=function(b,c){return Math.min(this._maxTextureSize,2*2**Math.round(.5*Math.log(b*b+c*c)*
Math.LOG2E+.35))};l._ensureDepthTexture=function(){I.isSome(this._depthTexture)&&this._depthTexture.descriptor.width===this._textureSize||(this._discardDepthTexture(),this._depthTexture=new U.Texture(this._rctx,{target:t.TextureType.TEXTURE_2D,pixelFormat:t.PixelFormat.RGBA,dataType:t.PixelType.UNSIGNED_BYTE,wrapMode:t.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:t.TextureSamplingMode.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize}),this._fbo=new sa.FramebufferObject(this._rctx,
{colorTarget:t.TargetType.TEXTURE,depthStencilTarget:t.DepthStencilTargetType.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture))};l._ensureSnapshot=function(b){let c=this._snapshots[b];if(I.isSome(c)&&c.descriptor.width===this._textureSize)return c;this._discardSnapshot(b);c=new U.Texture(this._rctx,{target:t.TextureType.TEXTURE_2D,pixelFormat:t.PixelFormat.RGBA,dataType:t.PixelType.UNSIGNED_BYTE,wrapMode:t.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:t.TextureSamplingMode.NEAREST,
flipped:!0,width:this._textureSize,height:this._textureSize});return this._snapshots[b]=c};l._discardDepthTexture=function(){this._fbo=I.disposeMaybe(this._fbo);this._depthTexture=I.disposeMaybe(this._depthTexture)};l._discardSnapshot=function(b){this._snapshots[b]=I.disposeMaybe(this._snapshots[b])};l._discardAllSnapshots=function(){for(let b=0;b<this._snapshots.length;++b)this._discardSnapshot(b);this._snapshots.length=0};l._bindFbo=function(){const b=this._rctx;b.unbindTexture(this._depthTexture);
b.bindFramebuffer(this._fbo)};l._constructCascade=function(b,c,e,g){const u=this._cascades[b];var h=-this._cascadeDistances[b],m=-this._cascadeDistances[b+1];h=(c[10]*h+c[14])/Math.abs(c[11]*h+c[15]);c=(c[10]*m+c[14])/Math.abs(c[11]*m+c[15]);r.assert(h<c);for(m=0;8>m;++m){Y.set(ia,0===m%4||3===m%4?-1:1,0===m%4||1===m%4?-1:1,4>m?h:c,1);var f=D[m];Y.transformMat4(f,ia,this._projectionViewInverse);f[0]/=f[3];f[1]/=f[3];f[2]/=f[3]}Q.negate(aa,D[0]);u.camera.viewMatrix=J.translate(ua,this._modelViewLight,
aa);for(h=0;8>h;++h)Q.transformMat4(D[h],D[h],u.camera.viewMatrix);h=D[0][2];c=D[0][2];for(m=1;8>m;++m)h=Math.min(h,D[m][2]),c=Math.max(c,D[m][2]);h-=200;c+=200;u.camera.near=-c;u.camera.far=-h;m=u.camera;f=1/D[0][3];var y=1/D[4][3];r.assert(f<y);f+=Math.sqrt(f*y);var G=Math.sin(X.acosClamped(e[2]*g[0]+e[6]*g[1]+e[10]*g[2]));e=D;var z=f/G;g=ja;var A=ka,k=va;y=la;f=ma;d.set(B,0,0);for(var q=0;4>q;++q)d.add(B,B,e[q]);d.scale(B,B,.25);d.set(L,0,0);for(q=4;8>q;++q)d.add(L,L,e[q]);d.scale(L,L,.25);d.lerp(H[0],
e[4],e[5],.5);d.lerp(H[1],e[5],e[6],.5);d.lerp(H[2],e[6],e[7],.5);d.lerp(H[3],e[7],e[4],.5);q=0;var E=d.squaredDistance(H[0],B);for(var C=1;4>C;++C){var M=d.squaredDistance(H[C],B);M<E&&(E=M,q=C)}d.subtract(n,H[q],e[q+4]);q=n[0];n[0]=-n[1];n[1]=q;d.subtract(ba,L,B);0>d.dot(ba,n)&&d.negate(n,n);d.lerp(n,n,ba,G);d.normalize(n,n);G=q=d.dot(d.subtract(F,e[0],B),n);for(E=1;8>E;++E)C=d.dot(d.subtract(F,e[E],B),n),C<G?G=C:C>q&&(q=C);d.copy(g,B);d.scale(F,n,G-z);d.add(g,g,F);C=-1;M=1;z=E=0;for(let R=0;8>
R;++R){d.subtract(S,e[R],g);d.normalize(S,S);const T=n[0]*S[1]-n[1]*S[0];0<T?T>C&&(C=T,E=R):T<M&&(M=T,z=R)}r.verify(0<C,"leftArea");r.verify(0>M,"rightArea");d.scale(N,n,G);d.add(N,N,B);d.scale(O,n,q);d.add(O,O,B);W[0]=-n[1];W[1]=n[0];A=r.rayRay2D(g,e[z],O,d.add(F,O,W),1,A);k=r.rayRay2D(g,e[E],O,F,1,k);y=r.rayRay2D(g,e[E],N,d.add(F,N,W),1,y);e=r.rayRay2D(g,e[z],N,F,1,f);r.verify(A,"rayRay");r.verify(k,"rayRay");r.verify(y,"rayRay");r.verify(e,"rayRay");k=ja;e=ka;g=la;y=ma;f=m.projectionMatrix;d.subtract(v,
g,y);d.scale(v,v,.5);a[0]=v[0];a[1]=v[1];a[2]=0;a[3]=v[1];a[4]=-v[0];a[5]=0;a[6]=v[0]*v[0]+v[1]*v[1];a[7]=v[0]*v[1]-v[1]*v[0];a[8]=1;a[6]=-d.dot(w(a,0),k);a[7]=-d.dot(w(a,1),k);k=d.dot(w(a,0),g)+a[6];A=d.dot(w(a,1),g)+a[7];z=d.dot(w(a,0),y)+a[6];y=d.dot(w(a,1),y)+a[7];k=-(k+z)/(A+y);a[0]+=a[1]*k;a[3]+=a[4]*k;a[6]+=a[7]*k;k=1/(d.dot(w(a,0),g)+a[6]);A=1/(d.dot(w(a,1),g)+a[7]);a[0]*=k;a[3]*=k;a[6]*=k;a[1]*=A;a[4]*=A;a[7]*=A;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;k=d.dot(w(a,1),e)+a[7];A=d.dot(w(a,2),
e)+a[8];z=d.dot(w(a,1),g)+a[7];y=d.dot(w(a,2),g)+a[8];k=-.5*(k/A+z/y);a[1]+=a[2]*k;a[4]+=a[5]*k;a[7]+=a[8]*k;k=d.dot(w(a,1),e)+a[7];A=d.dot(w(a,2),e)+a[8];z=-A/k;a[1]*=z;a[4]*=z;a[7]*=z;f[0]=a[0];f[1]=a[1];f[2]=0;f[3]=a[2];f[4]=a[3];f[5]=a[4];f[6]=0;f[7]=a[5];f[8]=0;f[9]=0;f[10]=1;f[11]=0;f[12]=a[6];f[13]=a[7];f[14]=0;f[15]=a[8];m.projectionMatrix[10]=2/(h-c);m.projectionMatrix[14]=-(h+c)/(h-c);J.multiply(u.lightMat,u.camera.projectionMatrix,u.camera.viewMatrix);h=this._textureSize/2;u.camera.viewport=
[0===b%2?0:h,0===Math.floor(b/2)?0:h,h,h]};l._setupMatrices=function(b,c){J.multiply(this._projectionView,b.projectionMatrix,b.viewMatrix);J.invert(this._projectionViewInverse,this._projectionView);b=this._viewingMode===qa.ViewingMode.Global?b.eye:Q.set(aa,0,0,1);J.lookAt(this._modelViewLight,[0,0,0],[-c[0],-c[1],-c[2]],b)};l._clampNearFar=function(b){let {near:c,far:e}=b;2>c&&(c=2);2>e&&(e=2);c>=e&&(c=2,e=4);return{near:c,far:e}};l._computeCascadeDistances=function(b,c){this._numCascades=Math.min(1+
Math.floor(r.logWithBase(b/c,4)),this._maxNumCascades);const e=(b-c)/this._numCascades;b=(b/c)**(1/this._numCascades);let g=c;for(let u=0;u<this._numCascades+1;++u)this._cascadeDistances[u]=X.lerp(g,c,this._splitSchemeLambda),g*=b,c+=e};na._createClass(x,[{key:"depthTexture",get:function(){return this._depthTexture}},{key:"textureSize",get:function(){return this._textureSize}},{key:"numCascades",get:function(){return this._numCascades}},{key:"cascadeDistances",get:function(){return Y.set(this._usedCascadeDistances,
this._cascadeDistances[0],1<this._numCascades?this._cascadeDistances[1]:Infinity,2<this._numCascades?this._cascadeDistances[2]:Infinity,3<this._numCascades?this._cascadeDistances[3]:Infinity)}},{key:"maxCascades",get:function(){return this._maxNumCascades},set:function(b){this._maxNumCascades=X.clamp(Math.floor(b),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(b){this._enabled=b;b||(this._discardDepthTexture(),this._discardAllSnapshots())}},{key:"ready",get:function(){return this._enabled&&
I.isSome(this._depthTexture)}},{key:"cascades",get:function(){for(let b=0;b<this._numCascades;++b)ca[b]=this._cascades[b];ca.length=this._numCascades;return ca}},{key:"gpuMemoryUsage",get:function(){return this._snapshots.reduce((b,c)=>b+ta.getGpuMemoryUsage(c),this._fbo?.gpuMemoryUsage??0)}},{key:"test",get:function(){const b=this;return{maxNumCascades:this._maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(c){b._splitSchemeLambda=c},get splitSchemeLambda(){return b._splitSchemeLambda}}}}]);
return x}();const ua=K.create(),ia=Z.create(),D=[];for(let x=0;8>x;++x)D.push(Z.create());const ja=p.create(),ka=p.create(),va=p.create(),la=p.create(),ma=p.create(),aa=da.create(),ca=[],fa=K.create(),ha=new Float32Array(64),B=p.create(),L=p.create(),H=[p.create(),p.create(),p.create(),p.create()],n=p.create(),ba=p.create(),F=p.create(),S=p.create(),N=p.create(),O=p.create(),W=p.create(),ea=p.create(),v=p.create(),a=pa.create();P.ShadowMap=wa;Object.defineProperty(P,Symbol.toStringTag,{value:"Module"})});