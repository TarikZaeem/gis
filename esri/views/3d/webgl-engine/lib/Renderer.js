// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/has ../../../../core/maybe ../../../../core/PooledArray ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/boundedPlane ../../support/debugFlags ../../terrain/TerrainRenderer ../core/renderPasses/RenderPassManager ../core/shaderLibrary/ShaderOutput ../core/shaderLibrary/hud/HUDUniforms ./AnimationTimeStep ./basicInterfaces ./BoundingInfo ./depthRange ./depthRangeUtils ./glUtil3D ./Highlight ./Material ./OffscreenRendering ./RenderContext ./rendererUtils ./RenderFeature ./RenderPluginManager ./RenderSlot ./ShadowAccumulator ./ShadowHighlight ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./TransparencyPassType ./edgeRendering/EdgeView ./edgeRendering/interfaces ../materials/renderers/MergedRenderer ../shaders/CompositingTechniqueConfiguration ../statistics/RendererPerformanceInfo ../../../support/RenderState ../../../webgl/enums".split(" "),
function(p,P,w,U,V,W,X,r,Q,A,y,ua,Y,D,H,Z,aa,M,ba,q,z,ca,E,da,R,ea,fa,ha,v,ia,ja,ka,C,la,k,ma,na,N,oa,pa,qa,I,ra,J,sa,K,m,ta,B){p.Renderer=function(t){function L(a,c,d,f,l,h,n,u){var b=t.call(this,{})||this;b._stage=a;b._materialRepository=c;b._shaderTechniqueRepository=f;b._rctx=l;b._compositingHelper=h;b._magnifierHelper=n;b._requestRender=u;b._materialRenderers=new Q;b._needsTransparentPass=!1;b._hasHUDElements=!1;b._hasHighlights=!1;b._hasWater=!1;b._hasOverlayWater=!1;b._renderOverlay=g=>{};
b._isRendering=!1;b._fallbackDepthStencilTexture=null;b._sliceHelper=new oa;b._state=ta.RenderState.IDLE;b._renderStateFeatures=C.setupFeatureDefaults();b._antialiasingEnabled=!0;b._highQualityTransparencyEnabled=!0;b._terrainRenderingEnabled=!0;b._terrainTransparency=M.TransparencyMode.Opaque;b._waterReflectionEnabled=!1;b._ssaoEnabled=!1;b._hasAnimations=!1;b._animationTimestep=new ca.AnimationTimeStep;b._handles=new W;b._renderHiddenTransparentEdges=()=>{};b._oitUsed=!1;b._smaaPass=new pa.SmaaRenderPass(b._rctx,
f);u();b._offscreen=new ia.OffscreenRendering(b._rctx,b._compositingHelper);b.performanceInfo=new m.RendererPerformanceInfo(b._rctx);b._shadowMap=new N.ShadowMap(b._rctx,a.viewingMode);b._ssaoHelper=new qa.SSAOHelper(a.view,f,b._rctx,u);b._highlight=new ha.Highlight(f,b._rctx);b._shadowHighlight=new na.ShadowHighlight(b._rctx,a.viewingMode);b._shadowAccumulator=new ma.ShadowAccumulator(b._rctx,f,a,g=>{const F=b.shadowsEnabled;b._shadowMap.enabled=!0;b._prepare(g.camera,g.contentCamera);b._renderPlugins.prepareRender();
b._shadowMap.enabled=F},(g,F,O)=>{g.shadowMap.start(g.camera,F,O);b._renderShadowCascades(q.ShaderOutput.Shadow,g.shadowMap);g.camera.setGLViewport(b._rctx);b._prepare(g.camera,g.contentCamera)},u);b._renderContext=new ja.RenderContext(b._rctx,b._offscreen,b._shadowMap,b._ssaoHelper,b._sliceHelper);b._renderPlugins=new la.RenderPluginManager({renderContext:b._renderContext,techniqueRepository:f,textureRepository:d,materialRepository:b._materialRepository,requestRender:u,controller:a});b.renderPassManager=
new ba.RenderPassManager(b._rctx,b._shaderTechniqueRepository);b._renderPlugins.add(b.renderPassManager.slots(),b.renderPassManager);b._handles.add([A.watch(()=>b._stage.view.state.camera,()=>u(),A.syncAndInitial),A.watch(()=>aa.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,g=>{b._renderHiddenTransparentEdges=g?()=>b._renderEdges(J.Transparency.TRANSPARENT):()=>{};u()},A.initial),A.watch(()=>b._ssaoEnabled||b.isFeatureEnabled(C.RenderFeature.SSAO),g=>b._ssaoHelper.enabled=g,A.syncAndInitial)]);return b}P._inheritsLoose(L,
t);var e=L.prototype;e.isFeatureEnabled=function(a,c=this._state){return r.unwrapOr(this._renderStateFeatures.get(c,a),!1)};e.setFeatureEnabled=function(a,c,d){this._renderStateFeatures.set(c,a,d);this.notifyChange("_renderStateFeatures");this._requestRender()};e.normalizeCtorArgs=function(){return{}};e.destroy=function(){this._handles.destroy();this._smaaPass.dispose();this._gpuTimerHandle=r.removeMaybe(this._gpuTimerHandle);this._materialRenderers.forAll(a=>a.dispose());this._materialRenderers.clear();
this._offscreen.dispose();this._fallbackDepthStencilTexture=r.disposeMaybe(this._fallbackDepthStencilTexture);this._shadowMap.dispose();this._ssaoHelper.dispose();this._highlight.dispose();this._shadowHighlight.dispose();this._shadowAccumulator.dispose();da.BoundingInfo.prune()};e.disposeOffscreenBuffers=function(){this._offscreen.dispose();this._shadowMap.disposeOffscreenBuffers();this._smaaPass.disable();this._ssaoHelper.disposeOffscreenBuffers()};e.ensureEdgeView=function(){r.isNone(this._edgeView)&&
(this._edgeView=new ra.EdgeView({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:a=>this._stage.view.resourceController.immediate.schedule(a)}),this._handles.add(A.watch(()=>r.applySome(this._edgeView,a=>a.updating),()=>this._requestRender(),A.sync)),this._requestRender());return this._edgeView};e.setParameters=function(a){const {_shadowMap:c,_bindParameters:d}=
this;void 0!==a.screenSpaceReflectionsEnabled&&d.ssr.enabled!==a.screenSpaceReflectionsEnabled&&(d.ssr.enabled=a.screenSpaceReflectionsEnabled,this._requestRender());void 0!==a.shadowMap&&this._shadowMap.enabled!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap,this._requestRender());void 0!==a.shadowMapMaxCascades&&c.maxCascades!==a.shadowMapMaxCascades&&(c.maxCascades=a.shadowMapMaxCascades,this._requestRender());if(r.isSome(a.environment)){r.isSome(a.environment.weather)&&(this._bindParameters.weather=
a.environment.weather,this._bindParameters.weatherVisible=!!a.weatherVisible);void 0!==a.environment.lighting.ambientOcclusionEnabled&&this._ssaoEnabled!==a.environment.lighting.ambientOcclusionEnabled&&(this._ssaoEnabled=a.environment.lighting.ambientOcclusionEnabled,this._requestRender());void 0!==a.environment.lighting.waterReflectionEnabled&&this._waterReflectionEnabled!==a.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=a.environment.lighting.waterReflectionEnabled,
this._requestRender());const f="virtual"!==a.environment.lighting.type;d.enableFillLights!==f&&(d.enableFillLights=f,this._requestRender())}a.background&&this._offscreen.background!==a.background&&(this._offscreen.background=a.background,this._requestRender());void 0!==a.antialiasingEnabled&&this._antialiasingEnabled!==a.antialiasingEnabled&&(this._antialiasingEnabled=a.antialiasingEnabled,this._requestRender());void 0!==a.highQualityTransparency&&this._highQualityTransparencyEnabled!==a.highQualityTransparency&&
(this._highQualityTransparencyEnabled=a.highQualityTransparency,this._requestRender());void 0!==a.defaultHighlightOptions&&(this._highlight.setDefaultOptions(a.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(a.defaultHighlightOptions),this._requestRender());void 0!==a.overlays&&this._bindParameters.overlays!==a.overlays&&(this._bindParameters.overlays=a.overlays,this._requestRender());void 0!==a.hasOverlayWater&&this._hasOverlayWater!==a.hasOverlayWater&&(this._hasOverlayWater=a.hasOverlayWater,
this._requestRender());void 0!==a.renderOverlay&&this._renderOverlay!==a.renderOverlay&&(this._renderOverlay=a.renderOverlay,this._requestRender());void 0!==a.slicePlane&&this._sliceHelper.plane!==a.slicePlane&&(this._sliceHelper.plane=r.unwrap(a.slicePlane),this._requestRender());void 0!==a.terrainRenderingEnabled&&this._terrainRenderingEnabled!==a.terrainRenderingEnabled&&(this._terrainRenderingEnabled=a.terrainRenderingEnabled,this._requestRender());void 0!==a.terrainTransparency&&this._terrainTransparency!==
a.terrainTransparency&&(this._terrainTransparency=a.terrainTransparency,this._requestRender());void 0!==a.shadowCastOptions&&this._shadowAccumulator.setOptions(a.shadowCastOptions)};e.modify=function(a,c){this._isRendering&&console.warn("Renderer.modify called while rendering");const {adds:d,removes:f,updates:l}=a;if(0!==d.length||0!==f.length||0!==l.length){var h=!1;ka.splitRenderGeometryChangeSetByMaterial(a).forEach((n,u)=>{if(!c.done){var b=this._materialRenderers.find(g=>g.material===u);r.isNone(b)&&
0<n.adds.length&&(b=new sa.MergedRenderer(this._rctx,this._materialRepository,u),this._materialRenderers.push(b));b&&(b.modify(n),b.isEmpty&&(h=!0));n.removes.forEach(g=>a.removes.removeUnordered(g));n.adds.forEach(g=>a.adds.removeUnordered(g));n.updates.forEach(g=>a.updates.removeUnordered(g));c.madeProgress()}});h&&this._materialRenderers.filterInPlace(n=>n.isEmpty?(n.dispose(),!1):!0);this._hasHighlights=this._materialRenderers.some(n=>n.hasHighlights);this._bindParameters.hasOccludees=this._materialRenderers.some(n=>
n.hasOccludees);this._hasWater=this._materialRenderers.some(n=>n.hasWater);this._hasHUDElements=this._materialRenderers.some(n=>n.requiresSlot(k.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,q.ShaderOutput.Color)||n.requiresSlot(k.RenderSlot.HUD_MATERIAL,q.ShaderOutput.Color)||n.requiresSlot(k.RenderSlot.LABEL_MATERIAL,q.ShaderOutput.Color));this._requestRender()}};e.updateAnimation=function(a){const c=this._hasAnimations;this._hasAnimations=!1;this._materialRenderers.forAll(d=>this._hasAnimations=d.updateAnimation(a)||
this._hasAnimations);this._hasAnimations=this._renderPlugins.updateAnimation(a)||this._hasAnimations;this._hasAnimations!==c&&(this._gpuTimerHandle=c?r.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo());return this._hasAnimations};e.resetAnimation=function(){this._animationTimestep.clear()};e.render=function(a,c,d,f,l){this._isRendering=!0;this.performanceInfo.startFrame();const {camera:h,contentCamera:n,mode:u}=d;this._state=u;this._renderOverlay(l);this.performanceInfo.advance(m.PerformanceCategory.OVERLAY);
this._renderContext.time=l;this._bindParameters.transparencyPassType=I.TransparencyPassType.NONE;var b=this._offscreen;b.setupRenderTarget(this.hasWaterReflection);d=Z.create(this._sliceHelper.plane);f===E.Decorations.OFF&&(this._sliceHelper.plane=null);this._rctx.bindFramebuffer(a);h.setGLViewport(this._rctx);this._prepare(h,n);this._renderPlugins.prepareRender();this.performanceInfo.advance(m.PerformanceCategory.PREPARE);var g=this._computeDepthRange(h);this._renderShadowMap(a,h,this._bindParameters.lighting.mainLight.direction,
g);this.performanceInfo.advance(m.PerformanceCategory.SHADOW_MAP);b.initializeFrame(h);this._ensureBindParameters(h,n);this._renderLinearDepth();this.performanceInfo.advance(m.PerformanceCategory.LINEAR_DEPTH);this._accumulateShadows(g,h,n);this.performanceInfo.advance(m.PerformanceCategory.ACCUMULATED_SHADOWS);this._renderNormal();this.performanceInfo.advance(m.PerformanceCategory.NORMALS);this._ensureBindParametersSSR(l);this._renderSSAO(l);this.performanceInfo.advance(m.PerformanceCategory.SSAO);
this._renderContext.output=q.ShaderOutput.Color;b.bindFramebuffer();this._renderOpaqueGeometry();this.performanceInfo.advance(m.PerformanceCategory.OPAQUE);l=this._terrainRenderingEnabled&&(this._terrainTransparency===M.TransparencyMode.Semitransparent||this._terrainTransparency===M.TransparencyMode.TransparentWithDraped);g=this._highQualityTransparency&&l;this._renderTerrainLinearDepth(g);this._setMultipassEnabled(g);this._setTerrainCulling(g);this._renderEdges(J.Transparency.OPAQUE);this.performanceInfo.advance(m.PerformanceCategory.OPAQUE_EDGES);
this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth);this._renderSlot(k.RenderSlot.VOXEL);this.performanceInfo.advance(m.PerformanceCategory.VOXEL);this._renderHiddenTransparentEdges();const F=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;F&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry());this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT);
this._renderGeometryLinearDepth(g);const O=this._renderHUDVisibility(g);g||this._renderInternalSlot(k.RenderSlot.LINE_CALLOUTS);this.performanceInfo.advance(m.PerformanceCategory.HUD_VISIBILITY);this._renderObjectAndLayerIdColor(c);this.performanceInfo.advance(m.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR);this._renderEdges(J.Transparency.TRANSPARENT,g);this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_EDGES);this._renderTransparentTerrain();l&&O&&(g?this._renderLineCallouts(z.HUDTransparentRenderStyle.Occluded):
b.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(z.HUDTransparentRenderStyle.Occluded,b.framebuffer),this.performanceInfo.advance(m.PerformanceCategory.HUD_OCCLUDED));this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_TERRAIN);this._setTerrainCulling(!1);l&&(b.compositeTransparentTerrainOntoMain(this._bindParameters),g&&(this._renderEdges(J.Transparency.OPAQUE),this.performanceInfo.advance(m.PerformanceCategory.OPAQUE_EDGES),F&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>
this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT),this._renderEdges(J.Transparency.TRANSPARENT),this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_EDGES)));g&&this._renderLineCallouts(z.HUDTransparentRenderStyle.NotOccluded);this._setMultipassEnabled(!1);this._shadowAccumulator.render(this._bindParameters);b.renderToTargets(()=>{this._renderInternalSlot(k.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);
this._renderSlot(k.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT);this._renderSlot(k.RenderSlot.LASERLINES)},b.currentColorTarget,b.mainDepth);this.performanceInfo.advance(m.PerformanceCategory.ENVIRONMENT);this._renderPlugins.needsLaserlineWithContrastControl&&b.renderTmpAndCompositeToMain(()=>this._renderSlot(k.RenderSlot.LASERLINES_CONTRAST_CONTROL),this._bindParameters,K.AlphaMode.PremultipliedAlpha);this.performanceInfo.advance(m.PerformanceCategory.LASER_LINE);this._renderOccluded();this.performanceInfo.advance(m.PerformanceCategory.OCCLUDED);
f=(c=f===E.Decorations.ON&&this._magnifierHelper.enabled)&&r.isNone(a)?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):a;this._rctx.bindFramebuffer(f);b=this._offscreen.colorTexture;!this._renderAntiAliasing(b)&&r.isSome(b)&&this._compositingHelper.composite(this._bindParameters,b,K.AlphaMode.None);this.performanceInfo.advance(m.PerformanceCategory.ANTIALIASING);this._renderHUD(z.HUDTransparentRenderStyle.NotOccluded,f);this.performanceInfo.advance(m.PerformanceCategory.HUD);
this._renderHighlights(f,this._bindParameters);this.performanceInfo.advance(m.PerformanceCategory.HIGHLIGHTS);c&&this._magnifierHelper.render(this._rctx,this._bindParameters);f!==a&&(this._rctx.bindFramebuffer(a),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,K.AlphaMode.None));this._disposeOITBuffers();this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera);this._sliceHelper.plane=d;this._isRendering=!1;if(this.onPostRender)this.onPostRender();
this.performanceInfo.finishFrame()};e._renderObjectAndLayerIdColor=function(a){if(r.isSome(a)&&X("enable-feature:objectAndLayerId-rendering")){const c=this._renderContext.output;this._rctx.bindFramebuffer(a);this._offscreen.renderToFBO(()=>this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.ObjectAndLayerIdColor),[0,0,0,0],!0,!0);this._rctx.bindFramebuffer(a);this._offscreen.renderToFBO(()=>{this._bindParameters.renderTransparentlyOccludedHUD=z.HUDTransparentRenderStyle.NotOccluded;this._renderInternalSlot(k.RenderSlot.HUD_MATERIAL)},
void 0,!0,!0);this._renderContext.output=c}};e.finish=function(a){this._hasAnimations||this._animationTimestep.clear();var c=this.performanceInfo.gpuSamplingEnabled;if((a=a===E.RenderRequestType.BACKGROUND)||c){const d=a?this.performanceInfo.elapsedTime:0;c=c?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError();this._animationTimestep.frame(Math.max(d,c),a)}};e.readDepthPixels=function(a,c,d){const f=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);
this._needsLinearDepth||(this._ensureBindParameters(a,a),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(B.ClearBufferBit.COLOR_BUFFER_BIT|B.ClearBufferBit.DEPTH_BUFFER_BIT|B.ClearBufferBit.STENCIL_BUFFER_BIT),this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.Depth));f.readPixels(c[0],c[1],c[2],c[3],B.PixelFormat.RGBA,B.PixelType.UNSIGNED_BYTE,d)};e.readHUDVisibility=function(a,c,d,f,l){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(a,
c,d,f,B.PixelFormat.RGBA,B.PixelType.UNSIGNED_BYTE,l)};e.readAccumulatedShadow=function(a){return this._shadowAccumulator.readAccumulatedShadow(a[0],a[1])};e._setMultipassEnabled=function(a){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=a};e._setTerrainCulling=function(a){this._bindParameters.multipassTerrain.cullAboveGround=a};e._renderSlot=function(a){this._bindParameters.slot=a;this._renderPlugins.render()};e._renderEdges=function(a,c=!1){const d=
this._edgeView;r.isSome(d)&&d.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain(()=>d.render(this._bindParameters,a),this._bindParameters,K.AlphaMode.Alpha,c)};e._renderShadowMap=function(a,c,d,f){const l=this._shadowMap;l.enabled&&this.isFeatureEnabled(C.RenderFeature.ShadowMapUpdate)&&(l.start(c,d,f),this._shadowHighlight.updateParameters(c,d),this._needsShadowHighlight?(this._renderShadowCascades(q.ShaderOutput.ShadowHighlight,this._shadowMap,h=>l.takeCascadeSnapshotTo(h,N.SnapshotSlot.Highlight)),
l.clear(),this._renderShadowCascades(q.ShaderOutput.ShadowExcludeHighlight,this._shadowMap,h=>{l.takeCascadeSnapshotTo(h,N.SnapshotSlot.Default);this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.ShadowHighlight)})):this._renderShadowCascades(q.ShaderOutput.Shadow),l.finish(a),c.setGLViewport(this._rctx))};e._renderShadowCascades=function(a,c=this._shadowMap,d=f=>{}){for(const f of c.cascades)f.camera.setGLViewport(this._rctx),this._prepare(f.camera,f.camera),this._renderGeometryAndTransparentTerrainPass(a),
d(f)};e._renderLinearDepth=function(){this._needsLinearDepth?this._offscreen.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.Depth),this._offscreen.linearDepth,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth);this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture};e._renderTerrainLinearDepth=function(a){a?(a=this._renderContext.output,this._renderContext.output=q.ShaderOutput.Depth,this._offscreen.renderToTargets(()=>
this._renderTransparentTerrain(),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1E10,-1E10,-1E10,1],!0,!0),this._renderContext.output=a):this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture};e._renderGeometryLinearDepth=function(a){a?(a=this._renderContext.output,this._offscreen.renderToTargets(()=>this._renderGeometryPass(q.ShaderOutput.Depth),this._offscreen.geometryLinearDepth,
this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=a):this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture};e._renderNormal=function(){this._needsNormal?this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.Normal)},this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)};
e._computeDepthRange=function(a){if(!this._needsDepthRange)return R.ZERO;const c=ea.depthRangeFromScene(a,this._materialRenderers,this._stage.layers);R.union(c,this.renderPlugins.queryDepthRange(a));c.near=Math.max(a.near,c.near);c.far=Math.min(a.far,c.far);return c};e._renderGeometryAndTransparentTerrainPass=function(a){this._renderContext.output=a;this._renderGeometryPass(a);this._renderTransparentTerrain()};e._renderGeometryPass=function(a){this._renderContext.output=a;this._renderOpaqueGeometry();
this._renderTransparentGeometry()};e._renderSSAO=function(a){this._ssaoHelper.render(this._bindParameters,a,this._offscreen.linearDepthTexture,this._offscreen.normalTexture)};e._renderOpaqueGeometry=function(){this._renderSlot(k.RenderSlot.INTEGRATED_MESH);this._renderSlot(k.RenderSlot.OPAQUE_TERRAIN);this._renderInternalSlot(k.RenderSlot.OPAQUE_MATERIAL);this._renderSlot(k.RenderSlot.OPAQUE_MATERIAL);this._renderSlot(k.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE)};e._renderTransparentGeometry=function(){this._renderInternalSlot(k.RenderSlot.TRANSPARENT_MATERIAL);
this._renderSlot(k.RenderSlot.TRANSPARENT_MATERIAL)};e._renderTransparentTerrain=function(){this._renderSlot(k.RenderSlot.TRANSPARENT_TERRAIN)};e._renderHUDVisibility=function(a){let c=!1;this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture;c=this._renderInternalSlot(k.RenderSlot.OCCLUSION_PIXELS)},a);return c};e._renderLineCallouts=
function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;a===z.HUDTransparentRenderStyle.Occluded?this._offscreen.renderToTargets(()=>this._renderInternalSlot(k.RenderSlot.LINE_CALLOUTS),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(k.RenderSlot.LINE_CALLOUTS)};e._renderHUD=function(a,c){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(()=>this._renderHUDElements(a),!0),this._rctx.bindFramebuffer(c),this._compositingHelper.composite(this._bindParameters,
this._offscreen.hudColorTexture,K.AlphaMode.PremultipliedAlpha)):a===z.HUDTransparentRenderStyle.Occluded?this._offscreen.renderToTargets(()=>this._renderHUDElements(z.HUDTransparentRenderStyle.Occluded),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(a))};e._renderHUDElements=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this._renderInternalSlot(k.RenderSlot.LINE_CALLOUTS_HUD_DEPTH);this._renderInternalSlot(k.RenderSlot.HUD_MATERIAL);
this._renderInternalSlot(k.RenderSlot.LABEL_MATERIAL)};e._renderHighlights=function(a,c){if(this._needsHighlight){var d=this._highlight,f=this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.Highlight);this._rctx.clearSafe(B.ClearBufferBit.DEPTH_BUFFER_BIT);this._renderHUDElements(z.HUDTransparentRenderStyle.Both)},this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=f.colorTexture;this._needsShadowHighlight&&
this._shadowHighlight.render(c,a);d.render(this._bindParameters,f,a)}else this._offscreen.disposeTarget(this._offscreen.highlight)};e._accumulateShadows=function(a,c,d){this._needsShadowCast&&r.isSome(this._offscreen.linearDepthTexture)&&this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,a,c,d)};e._renderOrderIndependentTransparency=function(a,c){const d=l=>{this._bindParameters.transparencyPassType=l;this._offscreen.renderOITPass(()=>a(),l,c)},f=this._renderContext.output;
this._renderContext.output=q.ShaderOutput.Alpha;d(I.TransparencyPassType.Alpha);this._renderContext.output=q.ShaderOutput.Color;d(I.TransparencyPassType.Color);d(I.TransparencyPassType.FrontFace);this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,c);this._bindParameters.transparencyPassType=I.TransparencyPassType.NONE;this._renderContext.output=f;this._oitUsed=!0};e._disposeOITBuffers=function(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),
this._offscreen.disposeTarget(this._offscreen.frontFaceTarget));this._oitUsed=!1};e._renderOccluded=function(){let a=0;x.clear();this._materialRenderers.forAll(h=>{h.material&&h.material.isVisible()&&h.material.renderOccluded===v.RenderOccludedFlag.OccludeAndTransparentStencil&&(a|=h.material.renderOccluded,x.push(h))});const c=this._offscreen,d=(h,n,u,b,g)=>{0!==(a&n)&&(c.renderToTargets(u,c.tmpColor,c.mainDepth,[0,0,0,0],b,g),c.compositeOccludedOntoMain(this._bindParameters,h))};0!==x.length&&(this._renderInternalSlot(k.RenderSlot.OCCLUDER_MATERIAL,
x),d(.5,v.RenderOccludedFlag.OccludeAndTransparentStencil,()=>this._renderInternalSlot(k.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,x),!1,!1));x.clear();this._materialRenderers.forAll(h=>{h.material&&h.material.isVisible()&&(h.material.renderOccluded===v.RenderOccludedFlag.OccludeAndTransparent||h.material.renderOccluded===v.RenderOccludedFlag.Transparent||h.material.renderOccluded===v.RenderOccludedFlag.Opaque)&&(a|=h.material.renderOccluded,x.push(h))});const f=this._renderPlugins.renderOccludedFlags;
if(a|=f){var l=h=>{this._renderContext.renderOccludedMask=h;f>v.RenderOccludedFlag.Occlude&&this._renderSlot(k.RenderSlot.OCCLUDED_TERRAIN);this._renderInternalSlot(k.RenderSlot.OPAQUE_MATERIAL,x);this._renderInternalSlot(k.RenderSlot.TRANSPARENT_MATERIAL,x);this._renderInternalSlot(k.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,x);this._renderContext.resetRenderOccludedMask()};this._renderContext.output=q.ShaderOutput.Color;d(.5,v.RenderOccludedFlag.OccludeAndTransparent,()=>l(v.RenderOccludedFlag.OccludeAndTransparent),
!0,E.StencilBits.OutlineVisualElementMask);d(.5,v.RenderOccludedFlag.Transparent,()=>l(v.RenderOccludedFlag.Transparent),!0,E.StencilBits.OutlineVisualElementMask);d(1,v.RenderOccludedFlag.Opaque,()=>l(v.RenderOccludedFlag.Opaque),!0,E.StencilBits.OutlineVisualElementMask);x.clear()}};e._renderAntiAliasing=function(a){if(this._antialiasing){if(this._smaaPass.enable(()=>this._requestRender())&&r.isSome(a))return this._smaaPass.render(a),!0}else this._smaaPass.disable();return!1};e._prepare=function(a,
c){this._needsTransparentPass=this._materialRenderers.some(d=>d.requiresSlot(k.RenderSlot.TRANSPARENT_MATERIAL,q.ShaderOutput.Color));this._bindParameters.camera=a;this._bindParameters.contentCamera=c};e._ensureBindParameters=function(a,c){this._bindParameters.camera=a;this._bindParameters.contentCamera=c;a=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=a.hudVisibilityTexture;this._bindParameters.mainColorTexture=a.mainColorTexture;this._bindParameters.highlightDepthTexture=
a.depthTexture??this._getFallbackDepthTexture()};e._ensureBindParametersSSR=function(a){this._bindParameters.ssr.enabled=this.hasWaterReflection;if(this._bindParameters.ssr.enabled){r.isNone(this._waterReflectionEnableTime)&&(this._waterReflectionEnableTime=a);this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=H.IDENTITY:(D.invert(S,this._bindParameters.camera.viewMatrix),D.invert(T,this._bindParameters.camera.projectionMatrix),D.multiply(G,S,T),D.multiply(G,
this._renderContext.lastFrameCamera.viewMatrix,G),D.multiply(G,this._renderContext.lastFrameCamera.projectionMatrix,G),this._reprojectionMatrix=G);this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;const c=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=0<c?Math.min(c,a-this._waterReflectionEnableTime)/c:1;1>this._bindParameters.ssr.fadeFactor&&this._requestRender()}else this._waterReflectionEnableTime=this._bindParameters.ssr.lastFrameColorTexture=
null};e._renderInternalSlot=function(a,c=this._materialRenderers){let d=!1;this._bindParameters.slot=a;c.forAll(f=>{f.material.shouldRender(this._renderContext)&&f.render(this._renderContext.output,this._bindParameters)&&(d=!0)});return d};e._getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=fa.createEmptyDepthTexture(this._rctx));return this._fallbackDepthStencilTexture};P._createClass(L,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},
{key:"_antialiasing",get:function(){return this._antialiasingEnabled||this.isFeatureEnabled(C.RenderFeature.Antialiasing)}},{key:"_highQualityTransparency",get:function(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(C.RenderFeature.HighQualityTransparency)}},{key:"hasWaterReflection",get:function(){return this.hasWater&&(this._waterReflectionEnabled||this.isFeatureEnabled(C.RenderFeature.WaterReflection))}},{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},
{key:"updating",get:function(){return this._antialiasing&&this._smaaPass.updating||r.isSome(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return D.equals(this._bindParameters.ssr.reprojectionMatrix,H.IDENTITY)}},{key:"_reprojectionMatrix",set:function(a){V.update(this._bindParameters.ssr.reprojectionMatrix,a)&&this.notifyChange("isCameraFinal")}},{key:"shadowsEnabled",
get:function(){return!!this._shadowMap?.enabled}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlend.result}},{key:"_oitEnabled",get:function(){return this._highQualityTransparency&&this._hasOITSupport}},{key:"animationTimestep",get:function(){return this._animationTimestep.value}},{key:"animationTimeDilation",get:function(){return this._animationTimestep.timeDilation}},
{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasWaterReflection||this._needsShadowHighlight||this._needsShadowCast}},{key:"_needsNormal",get:function(){return this._ssaoHelper.active}},{key:"_needsDepthRange",get:function(){return this._shadowMap.enabled||this._needsShadowCast}},{key:"_needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"_needsShadowHighlight",get:function(){return this._shadowMap.enabled&&
this._shadowHighlight.isVisible&&this._needsHighlight}},{key:"_needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"gpuMemoryUsage",get:function(){return{offscreen:this._offscreen?.gpuMemoryUsage??0,highlights:(this._highlight?.gpuMemoryUsage??0)+(this._shadowHighlight?.gpuMemoryUsage??0),shadows:this._shadowMap?.gpuMemoryUsage??0,ssao:this._ssaoHelper?.gpuMemoryUsage??0}}},{key:"test",get:function(){const a=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,
ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{a._renderStateFeatures=C.setupFeatureDefaults()},getFramebufferTexture:c=>{switch(c){case p.FramebufferId.Color:return a._offscreen.colorTexture;case p.FramebufferId.LinearDepth:return a._offscreen.linearDepthTexture;case p.FramebufferId.Normals:return a._offscreen.normalTexture;
case p.FramebufferId.ShadowMap:return a._shadowMap.depthTexture;case p.FramebufferId.HudVisibility:return a._offscreen.hudVisibilityTexture;case p.FramebufferId.Highlight:return a._offscreen.highlightTexture}}}}}]);return L}(U);w.__decorate([y.property()],p.Renderer.prototype,"_shadowAccumulator",void 0);w.__decorate([y.property()],p.Renderer.prototype,"_state",void 0);w.__decorate([y.property()],p.Renderer.prototype,"_renderStateFeatures",void 0);w.__decorate([y.property()],p.Renderer.prototype,
"_antialiasingEnabled",void 0);w.__decorate([y.property({readOnly:!0})],p.Renderer.prototype,"_antialiasing",null);w.__decorate([y.property()],p.Renderer.prototype,"_ssaoEnabled",void 0);w.__decorate([y.property()],p.Renderer.prototype,"_smaaPass",void 0);w.__decorate([y.property({autoDestroy:!0})],p.Renderer.prototype,"_edgeView",void 0);w.__decorate([y.property()],p.Renderer.prototype,"updating",null);w.__decorate([y.property()],p.Renderer.prototype,"isCameraFinal",null);p.Renderer=w.__decorate([Y.subclass("esri.views.3d.webgl-engine.lib.Renderer")],
p.Renderer);p.FramebufferId=void 0;(function(t){t[t.Color=0]="Color";t[t.LinearDepth=1]="LinearDepth";t[t.Normals=2]="Normals";t[t.ShadowMap=3]="ShadowMap";t[t.HudVisibility=4]="HudVisibility";t[t.Highlight=5]="Highlight"})(p.FramebufferId||(p.FramebufferId={}));const x=new Q,T=H.create(),S=H.create(),G=H.create();Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});