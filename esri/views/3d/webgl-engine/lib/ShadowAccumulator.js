// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ./BindParameters ./depthRange ./glUtil3D ./ShadowCastRenderer ./ShadowMap ../../../../chunks/ShadowCastAccumulate.glsl ../shaders/ShadowCastAccumulateTechnique ../../../support/Scheduler ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Util".split(" "),
function(c,n,f,A,B,C,D,m,p,g,O,E,t,F,G,u,H,q,I,v,J,K,h,L,M){c.ShadowAccumulator=function(w){function r(a,d,l,k,N,x){var b=w.call(this,{})||this;b._rctx=a;b._stage=l;b._prepareForShadowMapPass=k;b._renderToShadowMap=N;b._requestRender=x;b._progress=0;b._sampleCount=0;b._passParameters=new v.ShadowCastAccumulatePassParameters;b._enabledInternal=!1;b._cachedLightDirections=[];b._depthRange=u.ZERO;b._previewing=!1;b._handles=new C;b._cameraForcedForScreenshot=!1;b._bindParameters=new G.BindParameters(new I.ShadowMap(a,
l.viewingMode),null,null);b._bindParameters.shadowMap.enabled=!0;b._vao=H.createQuadVAO(a);b._fbo=new L.FramebufferObject(a,{colorTarget:h.TargetType.TEXTURE,depthStencilTarget:h.DepthStencilTargetType.NONE,width:0,height:0},{target:h.TextureType.TEXTURE_2D,pixelFormat:h.PixelFormat.RGBA,dataType:h.PixelType.UNSIGNED_BYTE,samplingMode:h.TextureSamplingMode.LINEAR,wrapMode:h.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0});b._accumulationRenderer=new q.ShadowCastRenderer(d,a,n._assertThisInitialized(b),
x);b._handles.add([b._stage.view.resourceController.scheduler.registerTask(K.TaskPriority.SHADOW_ACCUMULATOR,n._assertThisInitialized(b)),p.watch(()=>l.renderView,y=>{b._handles.remove("renderView");m.isSome(y)&&b._handles.add(y.events.on("force-camera-for-screenshot",()=>b._cameraForcedForScreenshot=!0),"renderView")},p.syncAndInitial),p.watch(()=>b._previewing,()=>b._requestRenderIfEnabled(),p.sync)]);return b}n._inheritsLoose(r,w);var e=r.prototype;e.normalizeCtorArgs=function(){return{}};e.runTask=
function(a){for(this._prepareForShadowMapPass(this._bindParameters);!a.done&&!this._isDoneAccumulating;)this._accumulateShadow(),a.madeProgress();this._requestRender()};e.renderAccumulation=function(a,d,l,k){this._depthRange=d;this._updateCamera(l);this._bindParameters.contentCamera=k;this._passParameters.linearDepthTexture=a;this._passParameters.origin=this._bindParameters.camera.center;this.notifyChange("canAccumulate");if(this.isAccumulating&&this.canAccumulate){(this._previewing||0===this._progress||
this._cameraForcedForScreenshot)&&this._clear();a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(6,this._sampleCount-this._progress);for(d=0;d<a;++d)this._accumulateShadow();this._cameraForcedForScreenshot=!1;this._requestRender()}};e.render=function(a){this._accumulationRenderer.render(a)};e.dispose=function(){this._stop();this._handles.destroy();this._accumulationRenderer=m.disposeMaybe(this._accumulationRenderer);this._bindParameters.shadowMap.dispose();this._fbo=m.disposeMaybe(this._fbo);
this._vao=m.disposeMaybe(this._vao);this._accumulationTechniqueCached=m.releaseMaybe(this._accumulationTechniqueCached);this._sampleCount=this._cachedLightDirections.length=0};e.setOptions=function(a){void 0!==a.enabled&&(this._enabled=a.enabled);void 0!==a.previewing&&(this._previewing=a.previewing);void 0!==a.lightDirections&&(this._lightDirections=a.lightDirections);this._accumulationRenderer.setOptions(a)};e.readAccumulatedShadow=function(a,d){if(!this._isActive||1>this._progress||0>a||a>this._fbo.width||
0>d||d>this._fbo.height)return 0;this._fbo.readPixels(a,d,1,1,h.PixelFormat.RGBA,h.PixelType.UNSIGNED_BYTE,z);return z[0]/this._progress};e._start=function(){this._progress=0;this._enabledInternal=!0};e._stop=function(){this._enabledInternal=!1};e._invalidate=function(){this._progress=0;this._requestRenderIfEnabled()};e._clear=function(){this._rctx.bindFramebuffer(this._fbo);this._rctx.setClearColor(0,0,0,0);this._rctx.clearSafe(h.ClearBufferBit.COLOR_BUFFER_BIT);this._progress=0};e._accumulateShadow=
function(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const a=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo);this._rctx.bindTechnique(a,this._passParameters,this._bindParameters);this._rctx.bindVAO(this._vao);this._rctx.drawArrays(a.primitiveType,0,M.vertexCount(this._vao,"geometry"))};e._sampleLightDirection=function(){this._progress++;return this._lightDirections[104729*this._progress%this._lightDirections.length]};e._updateCamera=
function(a){a.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(a),this._fbo.resize(a.fullWidth,a.fullHeight),this._opacityFromElevation=1-D.smoothstep(q.shadowCastDisableElevationMin,q.shadowCastDisableElevationMax,a.relativeElevation))};e._requestRenderIfEnabled=function(){this._enabledInternal&&this._requestRender()};n._createClass(r,[{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"isAccumulating",
get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){m.isNone(this._accumulationTechniqueCached)&&(this._accumulationTechniqueCached=new J.ShadowCastAccumulateTechnique({rctx:this._rctx,viewingMode:this._stage.viewingMode}));return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},
{key:"_isActive",get:function(){return this._enabledInternal&&0<this._sampleCount}},{key:"canAccumulate",get:function(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==u.ZERO&&this._opacityFromElevation>q.shadowCastDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(a){const d=this._cachedLightDirections;if(!B.equals(d,a,t.equals)){var l=
Math.min(v.ShadowCastMaxSamples,a.length);this._sampleCount=d.length=l;for(let k=0;k<l;++k)d[k]=t.copy(d[k]??F.create(),a[k]);this._invalidate()}}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(a){this._accumulationRenderer.opacityFromElevation=a}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&0<this._progress}},{key:"_enabled",set:function(a){a!==this._enabledInternal&&(a?this._start():this._stop())}},
{key:"test",get:function(){const a=this;return{lightDirections:this._lightDirections,get isDone(){return a._isDoneAccumulating},get isActive(){return a._isActive}}}}]);return r}(A);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_progress",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_sampleCount",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_enabledInternal",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_depthRange",void 0);
f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_previewing",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_accumulationRenderer",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_isRefining",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_isActive",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"canAccumulate",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_isDoneAccumulating",null);f.__decorate([g.property()],
c.ShadowAccumulator.prototype,"_opacityFromElevation",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"running",null);c.ShadowAccumulator=f.__decorate([E.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],c.ShadowAccumulator);const z=new Uint8Array(4);Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});