// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../brushes ../vectorTiles/shaders/VTLMaterialManager ./BitBlitRenderer ./enums ./MaterialManager ./TextureManager ./TextureUploadManager ./WorldExtentClipRenderer ./effects/AnimationEffect ./effects/BlendEffect ./effects/FeatureEffect ./effects/HighlightEffect ./effects/HittestEffect ./effects/HittestEffectVTL ./effects/post-processing/EffectManager ./painter/RenderPass ../../../webgl/context-util ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Renderbuffer".split(" "),
function(w,m,l,x,y,k,z,A,B,C,D,E,u,F,G,H,I,J,K,e,t,L){function M(q,f){switch(q){case k.WGLGeometryType.LINE:return l.brushes.line;case k.WGLGeometryType.TEXT:return l.brushes.text;case k.WGLGeometryType.LABEL:return l.brushes.label;case k.WGLGeometryType.FILL:switch(f){case k.WGLSymbologyType.DOT_DENSITY:return l.brushes.dotDensity;default:return l.brushes.fill}case k.WGLGeometryType.MARKER:switch(f){case k.WGLSymbologyType.HEATMAP:return l.brushes.heatmap;case k.WGLSymbologyType.PIE_CHART:return l.brushes.pieChart;
default:return l.brushes.marker}}}function v(q,f,a,d){return q!==k.WGLDrawPhase.HIGHLIGHT&&(1!==d||m.isSome(f)&&"normal"!==f||m.isSome(a)&&0<a.length)}return function(){function q(a,d,c){this.context=a;this._blitRenderer=new y.BitBlitRenderer;this._worldExtentClipRenderer=new C.WorldExtentClipRenderer;this._isClippedToWorldExtent=!1;this._brushCache=new Map;this._prevFBO=this._lastHeight=this._lastWidth=null;this._vtlMaterialManager=new x;this._blendEffect=new E.BlendEffect;this._fbos=this._stencilBuf=
null;this._fboPool=[];this._renderTarget=null;this.effects={highlight:new F,hittest:new G.HittestEffect,hittestVTL:new H.HittestEffectVTL,integrate:new D.AnimationEffect,insideEffect:new u.FeatureEffect("inside"),outsideEffect:new u.FeatureEffect("outside")};this.materialManager=new z(a);this.textureManager=new A(d,c,a.type===K.ContextType.WEBGL2);this.textureUploadManager=new B.TextureUploadManager(a,d);this._effectsManager=new I.EffectManager}var f=q.prototype;f.getRenderTarget=function(){return this._renderTarget};
f.setRenderTarget=function(a){this._renderTarget=a};f.getFbos=function(a,d){if(a!==this._lastWidth||d!==this._lastHeight){this._lastWidth=a;this._lastHeight=d;if(this._fbos){for(var c in this._fbos)this._fbos[c].resize(a,d);return this._fbos}c={target:e.TextureType.TEXTURE_2D,pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.UNSIGNED_BYTE,samplingMode:e.TextureSamplingMode.NEAREST,wrapMode:e.TextureWrapMode.CLAMP_TO_EDGE,width:a,height:d};const b={colorTarget:e.TargetType.TEXTURE,depthStencilTarget:e.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER};
this._stencilBuf=a=new L.Renderbuffer(this.context,{width:a,height:d,internalFormat:e.RenderbufferFormat.DEPTH_STENCIL});this._fbos={output:new t.FramebufferObject(this.context,b,c,a),blend:new t.FramebufferObject(this.context,b,c,a),effect0:new t.FramebufferObject(this.context,b,c,a)}}return this._fbos};f.acquireFbo=function(a,d){let c;c=0<this._fboPool.length?this._fboPool.pop():new t.FramebufferObject(this.context,{colorTarget:e.TargetType.TEXTURE,depthStencilTarget:e.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER},
{target:e.TextureType.TEXTURE_2D,pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.UNSIGNED_BYTE,samplingMode:e.TextureSamplingMode.NEAREST,wrapMode:e.TextureWrapMode.CLAMP_TO_EDGE,width:a,height:d},this._stencilBuf);const b=c.descriptor;b.width===a&&b.height===d||c.resize(a,d);return c};f.releaseFbo=function(a){this._fboPool.push(a)};f.getSharedStencilBuffer=function(){return this._stencilBuf};f.beforeRenderLayers=function(a,d=null){const {width:c,height:b}=a.getViewport();this._prevFBO=a.getBoundFramebufferObject();
const g=this.getFbos(c,b);a.bindFramebuffer(g?.output);a.setColorMask(!0,!0,!0,!0);if(m.isSome(d)){const {r:n,g:p,b:h,a:r}=d.color;a.setClearColor(r*n/255,r*p/255,r*h/255,r)}else a.setClearColor(0,0,0,0);a.setDepthWriteEnabled(!0);a.setClearDepth(1);a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT);a.setDepthWriteEnabled(!1)};f.beforeRenderLayer=function(a,d,c){const {context:b,blendMode:g,effects:n,requireFBO:p,drawPhase:h}=a;p||v(h,g,n,c)?(b.bindFramebuffer(this._fbos?.blend),b.setColorMask(!0,
!0,!0,!0),b.setClearColor(0,0,0,0),b.setDepthWriteEnabled(!0),b.setClearDepth(1),b.clear(b.gl.COLOR_BUFFER_BIT|b.gl.DEPTH_BUFFER_BIT),b.setDepthWriteEnabled(!1)):(a=this._getOutputFBO(),b.bindFramebuffer(a));b.setDepthWriteEnabled(!1);b.setDepthTestEnabled(!1);b.setStencilTestEnabled(!0);b.setClearStencil(d);b.setStencilWriteMask(255);b.clear(b.gl.STENCIL_BUFFER_BIT)};f.compositeLayer=function(a,d){const {context:c,blendMode:b,effects:g,requireFBO:n,drawPhase:p}=a;if(n||v(p,b,g,d)){m.isSome(g)&&0<
g.length&&p===k.WGLDrawPhase.MAP&&this._applyEffects(a,g);var h=this._getOutputFBO();c.bindFramebuffer(h);c.setStencilTestEnabled(!1);c.setStencilWriteMask(0);c.setBlendingEnabled(!0);c.setBlendFunctionSeparate(e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA,e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA);c.setColorMask(!0,!0,!0,!0);h=m.isNone(b)||p===k.WGLDrawPhase.HIGHLIGHT?"normal":b;const r=this._fbos;r?.blend.colorTexture&&this._blendEffect.draw(a,r.blend.colorTexture,e.TextureSamplingMode.NEAREST,
h,d)}};f.renderLayers=function(a){a.bindFramebuffer(this._prevFBO);const d=this._getOutputFBO();d&&(a.setDepthTestEnabled(!1),a.setStencilWriteMask(0),this._isClippedToWorldExtent?(a.setStencilTestEnabled(!0),a.setStencilFunction(e.CompareFunction.EQUAL,1,255)):a.setStencilTestEnabled(!1),this.blitTexture(a,d.colorTexture,e.TextureSamplingMode.NEAREST))};f.prepareDisplay=function(a,d,c){const {context:b}=a;b.bindFramebuffer(this._prevFBO);b.setColorMask(!0,!0,!0,!0);if(m.isSome(d)){const {r:g,g:n,
b:p,a:h}=d.color;b.setClearColor(h*g/255,h*n/255,h*p/255,h)}else b.setClearColor(0,0,0,0);b.setStencilWriteMask(255);b.setClearStencil(0);b.clear(b.gl.COLOR_BUFFER_BIT|b.gl.STENCIL_BUFFER_BIT);this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(a,c)};f.dispose=function(){this.materialManager.dispose();this.textureManager.dispose();this.textureUploadManager.destroy();this._blitRenderer=m.disposeMaybe(this._blitRenderer);this._worldExtentClipRenderer=m.disposeMaybe(this._worldExtentClipRenderer);
this._brushCache&&(this._brushCache.forEach(a=>a.dispose()),this._brushCache.clear(),this._brushCache=null);if(this._fbos)for(const a in this._fbos)this._fbos[a]&&this._fbos[a].dispose();for(const a of this._fboPool)a.dispose();this._fboPool.length=0;if(this.effects)for(const a in this.effects)this.effects[a]&&this.effects[a].dispose();this._effectsManager.dispose();this._vtlMaterialManager=m.disposeMaybe(this._vtlMaterialManager);this._prevFBO=null};f.getBrush=function(a,d){a=M(a,d);d=this._brushCache.get(a);
void 0===d&&(d=new a,this._brushCache.set(a,d));return d};f.renderObject=function(a,d,c,b){if(c=l.brushes[c]){var g=this._brushCache.get(c);void 0===g&&(g=new c,this._brushCache.set(c,g));g.prepareState(a,b);g.draw(a,d,b)}};f.renderObjects=function(a,d,c,b){if(c=l.brushes[c]){var g=this._brushCache.get(c);void 0===g&&(g=new c,this._brushCache.set(c,g));g.drawMany(a,d,b)}};f.registerRenderPass=function(a){const d=a.brushes.map(c=>{this._brushCache.has(c)||this._brushCache.set(c,new c);return this._brushCache.get(c)});
return new J(d,a)};f.blitTexture=function(a,d,c,b=1){a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA,e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA);a.setColorMask(!0,!0,!0,!0);this._blitRenderer.render(a,d,c,b)};f.getPostProcessingEffects=function(a){return this._effectsManager.getPostProcessingEffects(a)};f._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos?.output??null};f._applyEffects=function(a,
d){const c=this._fbos?.blend;if(c){var {context:b}=a;d=this._effectsManager.getPostProcessingEffects(d);for(const {postProcessingEffect:g,effect:n}of d)b.bindFramebuffer(c),g.draw(a,c,n)}};w._createClass(q,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}}]);return q}()});