// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../TimeExtent ../../../../../core/Accessor ../../../../../core/Evented ../../../../../core/has ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/diffUtils ../../../../../rest/support/Query ./DataTileSubscription ../support/UpdateToken".split(" "),function(t,g,v,r,w,u,x,p,q,y,z,A){function B(l,k){const d=new Set;l&&l.forEach(b=>d.add(b));k&&k.forEach(b=>d.add(b));return d.has("*")?
["*"]:Array.from(d)}r=function(l){function k(b){var a=l.call(this)||this;a.events=new w;a._resolver=p.createResolver();a._didEdit=!1;a._subscriptions=new Map;a._outSR=b.outSR;a._serviceInfo=b.serviceInfo;a._onTileUpdateMessage=b.onMessage;return a}g._inheritsLoose(k,l);var d=k.prototype;d._onMessage=function(){var b=g._asyncToGenerator(function*(a){const c=this._subscriptions.get(a.id);if(c)return a={...a,remove:a.remove??[],status:a.status??A.UpdateToken.empty()},p.ignoreAbortErrors(this._onTileUpdateMessage(a,
c.options))});return function(a){return b.apply(this,arguments)}}();d.update=function(b,a){var c=a.fields.length;a.outFields=B(this._schema?.outFields,a.outFields);a.outFields=a.outFields.length>=.75*c?["*"]:a.outFields;a.outFields.sort();if(c=q.diff(this._schema,a)){u("esri-2d-update-debug")&&console.debug("Applying Update - Source:",c);var m={returnCentroid:"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,
outFields:a.outFields,outSpatialReference:this._outSR,orderByFields:["orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC"],where:a.definitionExpression||"1\x3d1",gdbVersion:a.gdbVersion,historicMoment:a.historicMoment,timeExtent:a.timeExtent?v.fromJSON(a.timeExtent):null},h=this._schema&&q.hasDiff(c,"outFields");this._schema&&q.hasDiffAny(c,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&
(b.why.mesh.push("Layer filter and/or custom parameters changed"),b.why.source.push("Layer filter and/or custom parameters changed"),b.mesh=!0,b.source=!0,b.queryFilter=!0);h&&(b.why.source.push("Layer required fields changed"),b.source=!0);q.diff(m,this._queryInfo)&&(this._queryInfo=m);this._schema=a;this._resolver.resolve()}};d.whenInitialized=function(){return this._resolver.promise};d.applyUpdate=function(){var b=g._asyncToGenerator(function*(a){a.queryFilter||a.source&&this._didEdit?(this.refresh(a.version),
this._didEdit=!1):(this._subscriptions.forEach(c=>c.applyUpdate(a)),yield this.resend())});return function(a){return b.apply(this,arguments)}}();d.refresh=function(b,a){for(const c of this._tiles())this.unsubscribe(c),this.subscribe(c,b)};d.subscribe=function(b,a){a=new z.DataTileSubscription(b,a);this._subscriptions.set(b.id,a)};d.unsubscribe=function(b){const a=this.getSubscription(b.id);x.isSome(a)&&a.abort();this._subscriptions.delete(b.id)};d.createQuery=function(b={}){return new y({...this._queryInfo,
historicMoment:this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null,...b})};d.getSubscription=function(b){return this._subscriptions.has(b)?this._subscriptions.get(b):null};d.queryLastEditDate=function(){var b=g._asyncToGenerator(function*(){throw Error("Service does not support query type");});return function(){return b.apply(this,arguments)}}();d.query=function(){var b=g._asyncToGenerator(function*(a,c){throw Error("Service does not support query");});return function(a,c){return b.apply(this,
arguments)}}();d._tiles=function*(){const b=Array.from(this._subscriptions.values());for(const a of b)yield a.tile};d.edit=function(){var b=g._asyncToGenerator(function*(a,c){var m=this,h=Array.from(this._subscriptions.values());const C=h.map(({tile:f})=>f);for(const f of h)f.removeIds(c);a.length&&(h=C.map(f=>{const e=this.createTileQuery(f);e.objectIds=a;return{tile:f,query:e}}).map(function(){var f=g._asyncToGenerator(function*({tile:e,query:n}){return{tile:e,result:yield m.query(n,{query:{tile:u("esri-tiles-debug")?
e.id.replace(/\//g,"."):void 0}}),query:n}});return function(e){return f.apply(this,arguments)}}()),h=(yield p.eachAlwaysValues(h)).map(function(){var f=g._asyncToGenerator(function*({tile:e,result:n}){(n.hasFeatures||c.length||a.length)&&(e=m._subscriptions.get(e.key.id))&&e.edit(n,a)});return function(e){return f.apply(this,arguments)}}()),yield p.eachAlways(h));this._didEdit=!0});return function(a,c){return b.apply(this,arguments)}}();return k}(r);t.DataTileSource=r;Object.defineProperty(t,Symbol.toStringTag,
{value:"Module"})});