// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("require ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ./WebSocketConnection ../../../../rest/query/operations/query ../../../../rest/support/Query ../../../../geometry/support/jsonUtils ../../../../geometry/SpatialReference".split(" "),
function(w,m,x,r,y,p,n,k,z,A,K,L,M,B,C,u,D,E,F){const G={maxQueryDepth:5,maxRecordCountFactor:3};r=function(v){function t(a){a=v.call(this,{...G,...a})||this;a._buddyServicesQuery=null;a._relatedFeatures=null;return a}m._inheritsLoose(t,v);var f=t.prototype;f._open=function(){var a=m._asyncToGenerator(function*(){var b=yield this._fetchServiceDefinition(this._config.source);b.timeInfo.trackIdField||n.getLogger(this.declaredClass).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");
b=this._fetchWebSocketUrl(b.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices());yield this._buddyServicesQuery;yield this._tryCreateWebSocket(b);const {filter:c,outFields:d}=this._config;this.destroyed||this._setFilter(c,d)});return function(){return a.apply(this,arguments)}}();f._onMessage=function(a){if("attributes"in a){let b;try{b=this._enrich(a),k.isSome(this._featureZScaler)&&this._featureZScaler(b.geometry)}catch(c){n.getLogger(this.declaredClass).error(new p("geoevent-connection",
"Failed to parse message",c));return}this.onFeature(b)}else this.onMessage(a)};f._fetchServiceDefinition=function(){var a=m._asyncToGenerator(function*(b){return this._serviceDefinition=b=(yield y(b.path,{query:{f:"json",...this._config.customParameters},responseType:"json"})).data});return function(b){return a.apply(this,arguments)}}();f._fetchWebSocketUrl=function(a,b){const {urls:c,token:d}=a[0];a=this._inferWebSocketBaseUrl(c);return A.addQueryParameters(`${a}/subscribe`,{outSR:""+b.wkid,token:d})};
f._inferWebSocketBaseUrl=function(a){if(1===a.length)return a[0];for(const b of a)if(b.includes("wss"))return b;n.getLogger(this.declaredClass).error(new p("geoevent-connection","Unable to infer WebSocket url",a));return null};f._setFilter=function(){var a=m._asyncToGenerator(function*(b,c){const d=this._websocket;if(!(k.isNone(d)||k.isNone(b)&&k.isNone(c))){b=JSON.stringify({filter:this._serializeFilter(b,c)});var g=!1,h=z.createResolver();d.onmessage=e=>{e=JSON.parse(e.data);e.filter&&(e.error&&
(n.getLogger(this.declaredClass).error(new p("geoevent-connection","Failed to set service filter",e.error)),this._set("errorString",`Could not set service filter - ${e.error}`),h.reject(e.error)),this._setWebSocketJSONParseHandler(d),g=!0,h.resolve())};d.send(b);setTimeout(()=>{g||(this.destroyed||this._websocket!==d||n.getLogger(this.declaredClass).error(new p("geoevent-connection","Server timed out when setting filter")),h.reject())},1E4);return h.promise}});return function(b,c){return a.apply(this,
arguments)}}();f._serializeFilter=function(a,b){const c={};if(k.isNone(a)&&k.isNone(b))return c;if(k.isSome(a)&&a.geometry)try{const d=E.fromJSON(a.geometry);if("extent"!==d.type)throw new p(`Expected extent but found type ${d.type}`);c.geometry=JSON.stringify(d.shiftCentralMeridian())}catch(d){n.getLogger(this.declaredClass).error(new p("geoevent-connection","Encountered an error when setting connection geometryDefinition",d))}k.isSome(a)&&a.where&&"1 \x3d 1"!==a.where&&"1\x3d1"!==a.where&&(c.where=
a.where);k.isSome(b)&&(c.outFields=b.join(","));return c};f._enrich=function(a){if(!this._relatedFeatures)return a;const b=this._relatedFeatures.get(a.attributes[this._serviceDefinition.relatedFeatures.joinField]);if(!b)return n.getLogger(this.declaredClass).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",a),a;const {attributes:c,geometry:d}=b;for(const g in c)a.attributes[g]=c[g];d&&(a.geometry=d);a.geometry||a.centroid||n.getLogger(this.declaredClass).error(new p("geoevent-connection",
"Found malformed feature - no geometry found",a));return a};f._queryBuddyServices=function(){var a=m._asyncToGenerator(function*(){try{const {relatedFeatures:b,keepLatestArchive:c}=this._serviceDefinition,d=this._queryRelatedFeatures(b),g=this._queryArchive(c);yield d;const h=yield g;if(h)for(const e of h.features)this.onFeature(this._enrich(e))}catch(b){n.getLogger(this.declaredClass).error(new p("geoevent-connection","Encountered an error when querying buddy services",{error:b}))}});return function(){return a.apply(this,
arguments)}}();f._queryRelatedFeatures=function(){var a=m._asyncToGenerator(function*(b){b&&(b=yield this._queryBuddy(b.featuresUrl),this._addRelatedFeatures(b))});return function(b){return a.apply(this,arguments)}}();f._queryArchive=function(){var a=m._asyncToGenerator(function*(b){if(b)return this._queryBuddy(b.featuresUrl)});return function(b){return a.apply(this,arguments)}}();f._queryBuddy=function(){var a=m._asyncToGenerator(function*(b){const c=new (yield new Promise((H,I)=>w(["../../../FeatureLayer"],
J=>H(Object.freeze(Object.defineProperty({__proto__:null,default:J},Symbol.toStringTag,{value:"Module"}))),I))).default({url:b});var {capabilities:d}=yield c.load();const g=d.query.supportsMaxRecordCountFactor,h=d.query.supportsPagination;d=d.query.supportsCentroid;const e=this._config.maxRecordCountFactor;var q=c.capabilities.query.maxRecordCount;q=g?q*e:q;const l=new D;l.outFields=k.unwrapOr(this._config.outFields,["*"]);l.where=k.unwrapOr(k.get(this._config.filter,"where"),"1\x3d1");l.returnGeometry=
!0;l.returnExceededLimitFeatures=!0;l.outSpatialReference=F.fromJSON(this._config.spatialReference);d&&(l.returnCentroid=!0);g&&(l.maxRecordCountFactor=e);if(h)return l.num=q,c.destroy(),this._queryPages(b,l);b=yield u.executeQuery(b,l,this._config.sourceSpatialReference);c.destroy();return b.data});return function(b){return a.apply(this,arguments)}}();f._queryPages=function(){var a=m._asyncToGenerator(function*(b,c,d=[],g=0){c.start=k.isSome(c.num)?g*c.num:null;const {data:h}=yield u.executeQuery(b,
c,this._config.sourceSpatialReference);if(h.exceededTransferLimit&&g<(this._config.maxQueryDepth??0))return h.features.forEach(e=>d.push(e)),this._queryPages(b,c,d,g+1);d.forEach(e=>h.features.push(e));return h});return function(b,c){return a.apply(this,arguments)}}();f._addRelatedFeatures=function(a){const b=new Map;a=a.features;const c=this._serviceDefinition.relatedFeatures.joinField;for(const d of a)b.set(d.attributes[c],d);this._relatedFeatures=b};return t}(C.WebSocketConnection);return r=x.__decorate([B.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],
r)});