// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../Graphic ../../../kernel ../../../request ../../../TimeExtent ../../../core/Error ../../../core/has ../../../core/jsonMap ../../../core/Loadable ../../../core/maybe ../../../core/object ../../../core/promiseUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/jsonUtils ../assetEditingSupport ./support/clientSideDefaults ./support/QueryTask ../../support/arcgisLayerUrl ../../../rest/query/operations/editsZScale ../../../geometry/SpatialReference".split(" "),
function(l,A,z,H,I,t,J,x,E,F,K,n,L,M,B,C,Z,aa,N,O,P,Q,R,S,T,U,V){function G(w){return D.apply(this,arguments)}function D(){D=l._asyncToGenerator(function*(w){if("string"===typeof w){const v=B.dataComponents(w);return v?v:{data:w}}return new Promise((v,g)=>{const b=new FileReader;b.readAsDataURL(w);b.onload=()=>v(B.dataComponents(b.result));b.onerror=a=>g(a)})});return D.apply(this,arguments)}const W=new F.JSONMap({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),X=new Set(["Feature Layer",
"Table"]),Y=new F.JSONMap({Started:"published",Publishing:"publishing",Stopped:"unavailable"});z=function(w){function v(){var b=w.apply(this,arguments)||this;b.type="feature-layer";b.refresh=M.debounce(l._asyncToGenerator(function*(){yield b.load();var a=b.sourceJSON.editingInfo?.lastEditDate;if(null==a)return{dataChanged:!0,updates:{}};try{yield b._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}a=a!==b.sourceJSON.editingInfo?.lastEditDate;return{dataChanged:a,updates:a?{editingInfo:b.sourceJSON.editingInfo,
extent:b.sourceJSON.extent}:null}}));return b}l._inheritsLoose(v,w);var g=v.prototype;g.load=function(b){b=n.isSome(b)?b.signal:null;this.addResolvingPromise(this._fetchService(this.layer.sourceJSON,b));return Promise.resolve(this)};g.addAttachment=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();a=a.attributes[this.layer.objectIdField];const e=this.layer.parsedUrl.path+"/"+a+"/addAttachment",d=this._getLayerRequestOptions();c=this._getFormDataForAttachment(c,d.query);try{const f=
yield t(e,{body:c});return this._createFeatureEditResult(f.data.addAttachmentResult)}catch(f){throw this._createAttachmentErrorResult(a,f);}});return function(a,c){return b.apply(this,arguments)}}();g.updateAttachment=function(){var b=l._asyncToGenerator(function*(a,c,e){yield this.load();a=a.attributes[this.layer.objectIdField];const d=this.layer.parsedUrl.path+"/"+a+"/updateAttachment";c=this._getLayerRequestOptions({query:{attachmentId:c}});e=this._getFormDataForAttachment(e,c.query);try{const f=
yield t(d,{body:e});return this._createFeatureEditResult(f.data.updateAttachmentResult)}catch(f){throw this._createAttachmentErrorResult(a,f);}});return function(a,c,e){return b.apply(this,arguments)}}();g.applyEdits=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();const e=this.layer.infoFor3D;var d=n.isSome(e),f=d||(c?.globalIdUsed??!1),h=a.addFeatures?.map(m=>this._serializeFeature(m,e)).filter(n.isSome)??[],k=a.updateFeatures?.map(m=>this._serializeFeature(m,e)).filter(n.isSome)??
[];const r=this._getFeatureIds(a.deleteFeatures,f);U.unapplyEditsZUnitScaling(h,k,this.layer.spatialReference);var q=[],y=[],u=[...(a.deleteAttachments??[])];for(const m of a.addAttachments??[])q.push(yield this._serializeAttachment(m));for(const m of a.updateAttachments??[])y.push(yield this._serializeAttachment(m));y=q.length||y.length||u.length?{adds:q,updates:y,deletes:u}:null;u=void 0;q=null;if(d){q=new Map;u=[];for(const m of a.addAssets??[])u.push(this._serializeAssetMapEditAndUploadAssets(m,
q));a=yield Promise.all(u);u=a.length?{adds:a,updates:[],deletes:[]}:void 0}a={gdbVersion:c?.gdbVersion||this.layer.gdbVersion,rollbackOnFailure:c?.rollbackOnFailureEnabled,useGlobalIds:f,returnEditMoment:c?.returnEditMoment,usePreviousEditMoment:c?.usePreviousEditMoment,sessionId:c?.sessionId};c?.returnServiceEditsOption?(a.edits=JSON.stringify([{id:this.layer.layerId,adds:h,updates:k,deletes:r,attachments:y,assetMaps:n.unwrap(u)}]),a.returnServiceEditsOption=W.toJSON(c?.returnServiceEditsOption),
a.returnServiceEditsInSourceSR=c?.returnServiceEditsInSourceSR):(a.adds=h.length?JSON.stringify(h):null,a.updates=k.length?JSON.stringify(k):null,a.deletes=r.length?f?JSON.stringify(r):r.join(","):null,a.attachments=y&&JSON.stringify(y),a.assetMaps=n.isSome(u)?JSON.stringify(u):void 0);h=this._getLayerRequestOptions({method:"post",query:a});f=c?.returnServiceEditsOption?this.layer.url:this.layer.parsedUrl.path;c=yield t(f+"/applyEdits",h);!this.layer.capabilities.operations?.supportsEditing&&this.layer.effectiveCapabilities?.operations?.supportsEditing&&
(yield I.id?.findCredential(this.layer.url)?.refreshToken());if(d&&null!=c.data&&null!=c.data.assetMaps){k=c.data;d=this.layer.objectIdField;h=[];for(var p of k.addResults)p.success&&h.push(p.objectId);for(const m of k.updateResults)m.success&&h.push(m.objectId);p=this._createRequestQueryOptions();if((p=yield t(f+"/query",{...p,query:{f:"json",formatOf3DObjects:"3D_glb",where:`OBJECTID IN (${h.join(",")})`,outFields:`${d}`}}))&&p.data&&p.data.assetMaps&&n.isSome(q)){p=p.data.assetMaps;for(const m of p)p=
q.get(m.parentGlobalId).geometry,n.isSome(p)&&"mesh"===p.type&&p.updateExternalSource({source:[{name:m.assetName,source:m.assetName}],extent:p.extent})}}return this._createEditsResult(c)});return function(a,c){return b.apply(this,arguments)}}();g.deleteAttachments=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();a=a.attributes[this.layer.objectIdField];const e=this.layer.parsedUrl.path+"/"+a+"/deleteAttachments";try{return(yield t(e,this._getLayerRequestOptions({query:{attachmentIds:c.join(",")},
method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(d){throw this._createAttachmentErrorResult(a,d);}});return function(a,c){return b.apply(this,arguments)}}();g.fetchRecomputedExtents=function(b={}){var a=this;return this.load({signal:b.signal}).then(l._asyncToGenerator(function*(){var c=a._getLayerRequestOptions({...b,query:{returnUpdates:!0}});const {layerId:e,url:d}=a.layer;({data:c}=yield t(`${d}/${e}`,c));const {id:f,extent:h,fullExtent:k,timeExtent:r}=c;
c=h||k;return{id:f,fullExtent:c&&O.fromJSON(c),timeExtent:r&&J.fromJSON({start:r[0],end:r[1]})}}))};g.queryAttachments=function(){var b=l._asyncToGenerator(function*(a,c={}){yield this.load();c=this._getLayerRequestOptions(c);return this.queryTask.executeAttachmentQuery(a,c)});return function(a){return b.apply(this,arguments)}}();g.queryFeatures=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.execute(a,{...c,query:this._createRequestQueryOptions(c)})});
return function(a,c){return b.apply(this,arguments)}}();g.queryFeaturesJSON=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeJSON(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryObjectIds=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForIds(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,
arguments)}}();g.queryFeatureCount=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForCount(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryExtent=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForExtent(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryRelatedFeatures=
function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeRelationshipQuery(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryRelatedFeaturesCount=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeRelationshipQueryForCount(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryTopFeatures=
function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeTopFeaturesQuery(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryTopObjectIds=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForTopIds(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryTopExtents=function(){var b=l._asyncToGenerator(function*(a,
c){yield this.load();return this.queryTask.executeForTopExtents(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryTopCount=function(){var b=l._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForTopCount(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.fetchPublishingStatus=function(){var b=l._asyncToGenerator(function*(){if(!T.isHostedAgolService(this.layer.url))return"unavailable";
var a=B.join(this.layer.url,"status");a=yield t(a,{query:{f:"json"}});return Y.fromJSON(a.data.status)});return function(){return b.apply(this,arguments)}}();g._createRequestQueryOptions=function(b){b={...this.layer.customParameters,token:this.layer.apiKey,...b?.query};this.layer.datesInUnknownTimezone&&(b.timeReferenceUnknownClient=!0);return b};g._fetchService=function(){var b=l._asyncToGenerator(function*(a,c){a||({data:a}=yield t(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:E("featurelayer-advanced-symbols")?
{returnAdvancedSymbols:!0}:{},signal:c})));this.sourceJSON=this._patchServiceJSON(a);a=a.type;if(!X.has(a))throw new x("feature-layer-source:unsupported-type",`Source type "${a}" is not supported`);});return function(a,c){return b.apply(this,arguments)}}();g._patchServiceJSON=function(b){if("Table"!==b.type&&b.geometryType&&!b?.drawingInfo?.renderer&&!b.defaultSymbol){const a=R.createDrawingInfo(b.geometryType).renderer;L.setDeepValue("drawingInfo.renderer",a,b)}"esriGeometryMultiPatch"===b.geometryType&&
b.infoFor3D&&(b.geometryType="mesh");return b};g._serializeFeature=function(b,a){const {geometry:c,attributes:e}=b;if(n.isSome(a)&&n.isSome(b.geometry)&&"mesh"===b.geometry.type){const f={...e};b=b.geometry;var d=b.origin;b=b.transform;f[a.transformFieldRoles.originX]=d.x;f[a.transformFieldRoles.originY]=d.y;f[a.transformFieldRoles.originZ]=d.z;if(n.isSome(b)){d=b.translation;const h=b.scale;b=b.rotation;f[a.transformFieldRoles.translationX]=d[0];f[a.transformFieldRoles.translationY]=-d[2];f[a.transformFieldRoles.translationZ]=
d[1];f[a.transformFieldRoles.scaleX]=h[0];f[a.transformFieldRoles.scaleY]=h[1];f[a.transformFieldRoles.scaleZ]=h[2];f[a.transformFieldRoles.rotationX]=b[0];f[a.transformFieldRoles.rotationY]=b[2];f[a.transformFieldRoles.rotationZ]=b[1];f[a.transformFieldRoles.rotationDeg]=b[3]}return{geometry:null,attributes:f}}return n.isNone(c)?{attributes:e}:"mesh"===c.type||"extent"===c.type?null:{geometry:c.toJSON(),attributes:e}};g._serializeAttachment=function(){var b=l._asyncToGenerator(function*(a){const {feature:c,
attachment:e}=a,{globalId:d,name:f,contentType:h,data:k,uploadId:r}=e;a={globalId:d,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};c&&(a.parentGlobalId="attributes"in c?c.attributes&&c.attributes[this.layer.globalIdField]:c.globalId);if(r)a.uploadId=r;else if(k){const q=yield G(k);q&&(a.contentType=q.mediaType,a.data=q.data);k instanceof File&&(a.name=k.name)}f&&(a.name=f);h&&(a.contentType=h);return a});return function(a){return b.apply(this,arguments)}}();g._serializeAssetMapEditAndUploadAssets=
function(){var b=l._asyncToGenerator(function*(a,c){var e=this.layer.url,d=null;try{const f=new Blob([a.data],{type:a.mimeType}),h=new FormData;h.append("f","json");h.append("file",f,`${a.assetName}`);const {data:k}=yield t(`${e}/uploads/upload`,{body:h,method:"post",responseType:"json"});if(!k.success)throw new x("feature-layer-source:upload-failure","Expected upload to be successfull.");d={assetType:a.assetType,assetUploadId:k.item.itemID}}catch(f){d=null}if(n.isNone(d)){e=yield G(new Blob([a.data]));
if(!e.isBase64)throw new x("feature-layer-source:uploadAssets-failure","Expected gltf data in base64 format after conversion.");d={assetType:a.assetType,assetData:e.data}}if(n.isNone(d))throw new x("feature-layer-source:uploadAssets-failure","Unable to prepare uploadAsset request options.");e={method:"post",query:{f:"json",assets:JSON.stringify([d])},responseType:"json"};e=yield t(B.join(this.layer.parsedUrl.path,"uploadAssets"),e);if(1!==e.data.uploadResults.length||!e.data.uploadResults[0].success)throw new x("feature-layer-source:uploadAssets-failure",
"Bad response.");e=e.data.uploadResults[0].assetHash;d=[];a.flags&Q.AssetMapEditFlags.PROJECT_VERTICES&&d.push("PROJECT_VERTICES");e={globalId:a.assetMapGlobalId,parentGlobalId:a.featureGlobalId,assetName:a.assetName,assetHash:e,flags:d};c.set(a.featureGlobalId,a.feature);return e});return function(a,c){return b.apply(this,arguments)}}();g._getFeatureIds=function(b,a){const c=b?.[0];return c?this._canUseGlobalIds(a,b)?this._getGlobalIdsFromFeatureIdentifier(b):"objectId"in c?this._getObjectIdsFromFeatureIdentifier(b):
this._getIdsFromFeatures(b):[]};g._getIdsFromFeatures=function(b){const a=this.layer.objectIdField;return b.map(c=>c.attributes&&c.attributes[a])};g._canUseGlobalIds=function(b,a){return b&&"globalId"in a[0]};g._getObjectIdsFromFeatureIdentifier=function(b){return b.map(a=>a.objectId)};g._getGlobalIdsFromFeatureIdentifier=function(b){return b.map(a=>a.globalId)};g._createEditsResult=function(b){const a=b.data,{layerId:c}=this.layer;b=[];let e=null;if(Array.isArray(a))for(var d of a)b.push({id:d.id,
editedFeatures:d.editedFeatures}),d.id===c&&(e={addResults:d.addResults??[],updateResults:d.updateResults??[],deleteResults:d.deleteResults??[],attachments:d.attachments,editMoment:d.editMoment});else e=a;d=e?.attachments;d={addFeatureResults:e?.addResults?.map(this._createFeatureEditResult,this)??[],updateFeatureResults:e?.updateResults?.map(this._createFeatureEditResult,this)??[],deleteFeatureResults:e?.deleteResults?.map(this._createFeatureEditResult,this)??[],addAttachmentResults:d&&d.addResults?
d.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:d&&d.updateResults?d.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:d&&d.deleteResults?d.deleteResults.map(this._createFeatureEditResult,this):[]};e?.editMoment&&(d.editMoment=e.editMoment);if(0<b.length){d.editedFeatureResults=[];for(const f of b){({editedFeatures:b}=f);const h=b?.spatialReference?new V(b.spatialReference):null;d.editedFeatureResults.push({layerId:f.id,editedFeatures:{adds:b?.adds?.map(k=>
this._createEditedFeature(k,h))||[],updates:b?.updates?.map(k=>({original:this._createEditedFeature(k[0],h),current:this._createEditedFeature(k[1],h)}))||[],deletes:b?.deletes?.map(k=>this._createEditedFeature(k,h))||[],spatialReference:h}})}}return d};g._createEditedFeature=function(b,a){return new H({attributes:b.attributes,geometry:P.fromJSON({...b.geometry,spatialReference:a})})};g._createFeatureEditResult=function(b){const a=!0===b.success?null:b.error||{code:void 0,description:void 0};return{objectId:b.objectId,
globalId:b.globalId,error:a?new x("feature-layer-source:edit-failure",a.description,{code:a.code}):null}};g._createAttachmentErrorResult=function(b,a){return{objectId:b,globalId:null,error:new x("feature-layer-source:attachment-failure",a.details.messages&&a.details.messages[0]||a.message,{code:a.details.httpStatus||a.details.messageCode})}};g._getFormDataForAttachment=function(b,a){if(b=b instanceof FormData?b:b&&b.elements?new FormData(b):null)for(const c in a){const e=a[c];null!=e&&(b.set?b.set(c,
e):b.append(c,e))}return b};g._getLayerRequestOptions=function(b={}){const {parsedUrl:a,gdbVersion:c,dynamicDataSource:e}=this.layer;return{...b,query:{gdbVersion:c,layer:e?JSON.stringify({source:e}):void 0,...a.query,f:"json",...this._createRequestQueryOptions(b)},responseType:"json"}};l._createClass(v,[{key:"queryTask",get:function(){const {capabilities:b,parsedUrl:a,dynamicDataSource:c,infoFor3D:e,gdbVersion:d,spatialReference:f,fieldsIndex:h}=this.layer,k=E("featurelayer-pbf")&&b?.query.supportsFormatPBF&&
n.isNone(e);return new S({url:a.path,pbfSupported:k,fieldsIndex:h,infoFor3D:e,dynamicDataSource:c,gdbVersion:d,sourceSpatialReference:f,queryAttachmentsSupported:b?.operations?.supportsQueryAttachments??!1})}}]);return v}(K);A.__decorate([C.property()],z.prototype,"type",void 0);A.__decorate([C.property({constructOnly:!0})],z.prototype,"layer",void 0);A.__decorate([C.property({readOnly:!0})],z.prototype,"queryTask",null);return z=A.__decorate([N.subclass("esri.layers.graphics.sources.FeatureLayerSource")],
z)});