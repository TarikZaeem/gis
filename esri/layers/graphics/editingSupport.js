// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../Graphic ../../core/Collection ../../core/Error ../../core/lang ../../core/maybe ../../core/urlUtils ../../core/uuid ../../geometry/support/normalizeUtils ./assetEditingSupport ../mixins/EditBusLayer ../support/infoFor3D ../support/layerUtils".split(" "),function(A,p,G,q,g,H,n,I,J,K,L,B,C,r){function t(){t=p._asyncToGenerator(function*(a,b,d,e={}){let c,m;const f={edits:d,result:new Promise((h,k)=>{c=h;m=k})};a.emit("apply-edits",f);try{const {results:h,
edits:k}=yield M(a,b,d,e);b=N=>N.filter(O=>!O.error).map(H.clone);const l={edits:k,addedFeatures:b(h.addFeatureResults),updatedFeatures:b(h.updateFeatureResults),deletedFeatures:b(h.deleteFeatureResults),addedAttachments:b(h.addAttachmentResults),updatedAttachments:b(h.updateAttachmentResults),deletedAttachments:b(h.deleteAttachmentResults),exceededTransferLimit:!1};h.editedFeatureResults?.length&&(l.editedFeatures=h.editedFeatureResults);if(l.addedFeatures.length||l.updatedFeatures.length||l.deletedFeatures.length||
l.addedAttachments.length||l.updatedAttachments.length||l.deletedAttachments.length)a.emit("edits",l),B.isEditBusLayer(a)&&B.editEventBus.emit("edits",{layer:a,event:l});c(l);return h}catch(h){throw m(h),h;}});return t.apply(this,arguments)}function M(a,b,d,e){return u.apply(this,arguments)}function u(){u=p._asyncToGenerator(function*(a,b,d,e){yield a.load();if(!b||null==b.applyEdits)throw new g(`${a.type}-layer:no-editing-support`,"Layer source does not support applyEdits capability",{layer:a});
if(!r.getEffectiveEditingEnabled(a))throw new g(`${a.type}-layer:editing-disabled`,"Editing is disabled for layer",{layer:a});const {edits:c,options:m}=yield P(a,d,e);return c.addFeatures?.length||c.updateFeatures?.length||c.deleteFeatures?.length||c.addAttachments?.length||c.updateAttachments?.length||c.deleteAttachments?.length?{edits:c,results:yield b.applyEdits(c,m)}:{edits:c,results:{addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],
deleteAttachmentResults:[]}}});return u.apply(this,arguments)}function P(a,b,d){return v.apply(this,arguments)}function v(){v=p._asyncToGenerator(function*(a,b,d){var e=b&&(b.addFeatures||b.updateFeatures||b.deleteFeatures),c=b&&(b.addAttachments||b.updateAttachments||b.deleteAttachments);const m=n.isSome(a.infoFor3D);if(!b||!e&&!c)throw new g(`${a.type}-layer:missing-parameters`,"'addFeatures', 'updateFeatures', 'deleteFeatures', 'addAttachments', 'updateAttachments' or 'deleteAttachments' parameter is required");
e=r.getEffectiveLayerCapabilities(a);if(!e.data.isVersioned&&d?.gdbVersion)throw new g(`${a.type}-layer:invalid-parameter`,"'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'");if(!e.editing.supportsRollbackOnFailure&&d?.rollbackOnFailureEnabled)throw new g(`${a.type}-layer:invalid-parameter`,"This layer does not support 'rollbackOnFailureEnabled' parameter. See: 'capabilities.editing.supportsRollbackOnFailure'");if(!e.editing.supportsGlobalId&&
d?.globalIdUsed)throw new g(`${a.type}-layer:invalid-parameter`,"This layer does not support 'globalIdUsed' parameter. See: 'capabilities.editing.supportsGlobalId'");if(!e.editing.supportsGlobalId&&c)throw new g(`${a.type}-layer:invalid-parameter`,"'addAttachments', 'updateAttachments' and 'deleteAttachments' are applicable only if the layer supports global ids. See: 'capabilities.editing.supportsGlobalId'");if(!d?.globalIdUsed&&c)throw new g(`${a.type}-layer:invalid-parameter`,"When 'addAttachments', 'updateAttachments' or 'deleteAttachments' is specified, globalIdUsed should be set to true");
c={...d};null!=c.rollbackOnFailureEnabled||e.editing.supportsRollbackOnFailure||(c.rollbackOnFailureEnabled=!0);if(!1===c.rollbackOnFailureEnabled&&"original-and-current-features"===c.returnServiceEditsOption)throw new g(`${a.type}-layer:invalid-parameter`,"'original-and-current-features' is valid for 'returnServiceEditsOption' only when 'rollBackOnFailure' is true.");if(!e.editing.supportsReturnServiceEditsInSourceSpatialReference&&c.returnServiceEditsInSourceSR)throw new g(`${a.type}-layer:invalid-parameter`,
"This layer does not support 'returnServiceEditsInSourceSR' parameter. See: 'capabilities.editing.supportsReturnServiceEditsInSourceSpatialReference'");if(c.returnServiceEditsInSourceSR&&"original-and-current-features"!==c.returnServiceEditsOption)throw new g(`${a.type}-layer:invalid-parameter`,"'returnServiceEditsInSourceSR' is valid only when 'returnServiceEditsOption' is set to 'original-and-current-features'");const f={...b};f.addFeatures=b&&q.isCollection(b.addFeatures)?b.addFeatures.toArray():
f.addFeatures||[];f.updateFeatures=b&&q.isCollection(b.updateFeatures)?b.updateFeatures.toArray():f.updateFeatures||[];f.deleteFeatures=b&&q.isCollection(b.deleteFeatures)?b.deleteFeatures.toArray():f.deleteFeatures||[];if(f.addFeatures.length&&!e.operations.supportsAdd)throw new g(`${a.type}-layer:unsupported-operation`,"Layer does not support adding features.");if(f.updateFeatures.length&&!e.operations.supportsUpdate)throw new g(`${a.type}-layer:unsupported-operation`,"Layer does not support updating features.");
if(f.deleteFeatures.length&&!e.operations.supportsDelete)throw new g(`${a.type}-layer:unsupported-operation`,"Layer does not support deleting features.");f.addAttachments=f.addAttachments||[];f.updateAttachments=f.updateAttachments||[];f.deleteAttachments=f.deleteAttachments||[];f.addFeatures=f.addFeatures.map(D);f.updateFeatures=f.updateFeatures.map(D);f.addAssets=[];const h=d?.globalIdUsed||m;f.addFeatures.forEach(k=>{w(k,a,h)});f.updateFeatures.forEach(k=>{w(k,a,h);const l=r.getEffectiveLayerCapabilities(a);
if("geometry"in k&&n.isSome(k.geometry)&&!l?.editing.supportsGeometryUpdate)throw new g(`${a.type}-layer:unsupported-operation`,"Layer does not support geometry updates.");});f.deleteFeatures.forEach(k=>{w(k,a,h)});f.addAttachments.forEach(k=>E(k,a));f.updateAttachments.forEach(k=>E(k,a));m&&(yield Q(f,a));return{edits:yield R(f),options:c}});return v.apply(this,arguments)}function w(a,b,d){if(d){if("attributes"in a&&!a.attributes[b.globalIdField])throw new g(`${b.type}-layer:invalid-parameter`,"Feature should have 'globalId' when 'globalIdUsed' is true");
if(!("attributes"in a||a.globalId))throw new g(`${b.type}-layer:invalid-parameter`,"'globalId' of the feature should be passed when 'globalIdUsed' is true");}if("geometry"in a&&n.isSome(a.geometry)){if(a.geometry.hasZ&&!1===b.capabilities?.data.supportsZ)throw new g(`${b.type}-layer:z-unsupported`,"Layer does not support z values while feature has z values.");if(a.geometry.hasM&&!1===b.capabilities?.data.supportsM)throw new g(`${b.type}-layer:m-unsupported`,"Layer does not support m values while feature has m values.");
}}function E(a,b){const {feature:d,attachment:e}=a;if(!d||"attributes"in d&&!d.attributes[b.globalIdField])throw new g(`${b.type}-layer:invalid-parameter`,"Attachment should have reference to a feature with 'globalId'");if(!("attributes"in d||d.globalId))throw new g(`${b.type}-layer:invalid-parameter`,"Attachment should have reference to 'globalId' of the parent feature");if(!e.globalId)throw new g(`${b.type}-layer:invalid-parameter`,"Attachment should have 'globalId'");if(!e.data&&!e.uploadId)throw new g(`${b.type}-layer:invalid-parameter`,
"Attachment should have 'data' or 'uploadId'");if(!(e.data instanceof File&&e.data.name||e.name))throw new g(`${b.type}-layer:invalid-parameter`,"'name' is required when attachment is specified as Base64 encoded string using 'data'");if(!b.capabilities?.editing.supportsUploadWithItemId&&e.uploadId)throw new g(`${b.type}-layer:invalid-parameter`,"This layer does not support 'uploadId' parameter. See: 'capabilities.editing.supportsUploadWithItemId'");if("string"===typeof e.data&&(a=I.dataComponents(e.data))&&
!a.isBase64)throw new g(`${b.type}-layer:invalid-parameter`,"Attachment 'data' should be a Blob, File or Base64 encoded string");}function R(a){return x.apply(this,arguments)}function x(){x=p._asyncToGenerator(function*(a){const b=a.addFeatures??[],d=a.updateFeatures??[];var e=b.concat(d).map(f=>f.geometry);e=yield K.normalizeCentralMeridian(e);const c=b.length,m=d.length;e.slice(0,c).forEach((f,h)=>b[h].geometry=f);e.slice(c,c+m).forEach((f,h)=>d[h].geometry=f);return a});return x.apply(this,arguments)}
function D(a){const b=new G;a.attributes||(a.attributes={});b.geometry=a.geometry;b.attributes=a.attributes;return b}function Q(a,b){return y.apply(this,arguments)}function y(){y=p._asyncToGenerator(function*(a,b){if(!n.isNone(b.infoFor3D)){var {infoFor3D:d}=b,e=!1;for(const c of d.editFormats)if(c===C.AssetType.GLTF_BINARY){e=!0;break}d=[];for(const c of a.addFeatures??[])d.push(F(c,a,b,e));for(const c of a.updateFeatures??[])d.push(F(c,a,b,e));a=yield Promise.allSettled(d);for(const c of a)if("rejected"===
c.status)throw c.reason;}});return y.apply(this,arguments)}function F(a,b,d,e){return z.apply(this,arguments)}function z(){z=p._asyncToGenerator(function*(a,b,d,e){if(!n.isNone(a.geometry)&&"mesh"===a.geometry.type){var c=a.geometry,m=d.globalIdField;if(!(n.isSome(d.parsedUrl)&&n.isSome(c.external)&&Array.isArray(c.external.source)&&1===c.external.source.length&&"source"in c.external.source[0]&&"string"==typeof c.external.source[0].source&&c.external.source[0].source.startsWith(d.parsedUrl.path))){if(!e)throw new g(`${d.type}-layer:binary-gltf-asset-not-supported`,
"3DObjectFeatureLayer requires binary glTF (.glb) support for updating mesh geometry.");d=yield(yield c.toBinaryGLTF({ignoreLocalTransform:!0})).buffer();e=`{${J.generateUUID()}}`;var f=`${e}.glb`;b.addAssets?.push({featureGlobalId:a.getAttribute(m),assetMapGlobalId:e,assetName:f,flags:n.isSome(c.transform)&&c.transform.geographic?L.AssetMapEditFlags.PROJECT_VERTICES:0,data:d.data,mimeType:d.type,assetType:C.AssetType.GLTF_BINARY,feature:a})}}});return z.apply(this,arguments)}A.applyEdits=function(a,
b,d){return t.apply(this,arguments)};Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});