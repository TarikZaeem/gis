// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../geometry/support/centroid ../../../geometry/support/extentUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ./AttributesBuilder ./projectionSupport ./SnappingCandidate ./utils ../../support/fieldUtils ../../../statistics/utils ../../../support/arcadeOnDemand".split(" "),function(ba,G,C,O,S,P,T,Q,N,U,V,F,W,B,ca){function da(w,m,c,a){const b=a.x-c.x;a=a.y-c.y;
m=Math.min(1,Math.max(0,((m.x-c.x)*b+(m.y-c.y)*a)/(b*b+a*a)));w.x=c.x+b*m;w.y=c.y+a*m}function X(w,m){return w?m?4:3:m?3:2}let ia=function(){function w(c,a,b){this.items=c;this.query=a;this.geometryType=b.geometryType;this.hasM=b.hasM;this.hasZ=b.hasZ;this.fieldsIndex=b.fieldsIndex;this.objectIdField=b.objectIdField;this.spatialReference=b.spatialReference;this.featureAdapter=b.featureAdapter}var m=w.prototype;m.createQueryResponseForCount=function(){const c=new N(this.query,this.featureAdapter,this.fieldsIndex);
if(!this.query.outStatistics)return c.countDistinctValues(this.items);const {groupByFieldsForStatistics:a,having:b,outStatistics:e}=this.query;if(!a?.length)return 1;const d=new Map,f=new Map,h=new Set;for(const l of e){var {statisticType:g}=l;g="exceedslimit"!==g?l.onStatisticField:void 0;if(!f.has(g)){var k=[];for(const n of a){const q=this._getAttributeValues(c,n,d);k.push(q)}f.set(g,this._calculateUniqueValues(k,c.returnDistinctValues))}g=f.get(g);for(const n in g){const {data:q,items:t}=g[n];
k=q.join(",");b&&!c.validateItems(t,b)||h.add(k)}}return h.size};m.createQueryResponse=function(){var c=C._asyncToGenerator(function*(){let a;a=this.query.outStatistics?this.query.outStatistics.some(b=>"exceedslimit"===b.statisticType)?this._createExceedsLimitQueryResponse(this.query):yield this._createStatisticsQueryResponse(this.query):this._createFeatureQueryResponse(this.query);if(this.query.returnQueryGeometry){const b=this.query.geometry;Q.isValid(this.query.outSR)&&!Q.equals(b.spatialReference,
this.query.outSR)?a.queryGeometry=F.cleanFromGeometryEngine({spatialReference:this.query.outSR,...U.project(b,b.spatialReference,this.query.outSR)}):a.queryGeometry=F.cleanFromGeometryEngine({spatialReference:this.query.outSR,...b})}return a});return function(){return c.apply(this,arguments)}}();m.createSnappingResponse=function(c,a){const b=this.featureAdapter,e=X(this.hasZ,this.hasM),{point:d,mode:f}=c,h="number"===typeof c.distance?c.distance:c.distance.x,g="number"===typeof c.distance?c.distance:
c.distance.y,k={candidates:[]},l="esriGeometryPolygon"===this.geometryType;a=this._getPointCreator(f,this.spatialReference,a);const n=new Y(null,0),q=new Y(null,0),t={x:0,y:0,z:0};for(const u of this.items){var r=b.getGeometry(u);if(O.isNone(r))continue;const {coords:z,lengths:D}=r;n.coords=z;q.coords=z;if(c.types&G.SnappingTypes.EDGE){r=0;for(var x=0;x<D.length;x++){var A=D[x];for(var p=0;p<A;p++,r+=e){var v=n;v.coordsIndex=r;if(p!==A-1){const E=q;E.coordsIndex=r+e;const H=t;da(t,d,v,E);var y=(d.x-
H.x)/h;const I=(d.y-H.y)/g;y=y*y+I*I;1>=y&&k.candidates.push(V.makeEdgeCandidate(b.getObjectId(u),a(H),Math.sqrt(y),a(v),a(E)))}}}}if(c.types&G.SnappingTypes.VERTEX)for(r=l?z.length-e:z.length,x=0;x<r;x+=e)A=n,A.coordsIndex=x,p=(d.x-A.x)/h,v=(d.y-A.y)/g,p=p*p+v*v,1>=p&&k.candidates.push(V.makeVertexCandidate(b.getObjectId(u),a(A),Math.sqrt(p)))}k.candidates.sort((u,z)=>u.distance-z.distance);return k};m._getPointCreator=function(c,a,b){const e=O.isSome(b)&&!Q.equals(a,b)?f=>U.project(f,a,b):f=>f,
{hasZ:d}=this;return"3d"===c?d?({x:f,y:h,z:g})=>e({x:f,y:h,z:g}):({x:f,y:h})=>e({x:f,y:h,z:0}):({x:f,y:h})=>e({x:f,y:h})};m.createSummaryStatisticsResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:h,minValue:g,maxValue:k,scale:l}=a;a=this.fieldsIndex.isDateField(b);var n=yield this._getDataValues({field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:h,scale:l});const q=
B.isNullCountSupported({normalizationType:f,normalizationField:d,minValue:g,maxValue:k}),t=this.fieldsIndex.get(b),r={value:.5,fieldType:t?.type};n=W.isStringField(t)?B.calculateStringStatistics({values:n,supportsNullCount:q,percentileParams:r}):B.calculateStatistics({values:n,minValue:g,maxValue:k,useSampleStdDev:!f,supportsNullCount:q,percentileParams:r});return B.processSummaryStatisticsResult(n,a)});return function(a){return c.apply(this,arguments)}}();m.createUniqueValuesResponse=function(){var c=
C._asyncToGenerator(function*(a){const {field:b,valueExpression:e,domains:d,returnAllCodedValues:f,scale:h}=a;var g=yield this._getDataValues({field:b,field2:a.field2,field3:a.field3,fieldDelimiter:a.fieldDelimiter,valueExpression:e,scale:h});g=B.calculateUniqueValuesCount(g);return B.createUVResult(g,d,f,a.fieldDelimiter)});return function(a){return c.apply(this,arguments)}}();m.createClassBreaksResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,valueExpression:e,normalizationField:d,
normalizationType:f,normalizationTotal:h,classificationMethod:g,standardDeviationInterval:k,minValue:l,maxValue:n,numClasses:q,scale:t}=a;a=yield this._getDataValues({field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:h,scale:t});a=B.calculateClassBreaks(a,{field:b,normalizationField:d,normalizationType:f,normalizationTotal:h,classificationMethod:g,standardDeviationInterval:k,minValue:l,maxValue:n,numClasses:q});return B.resolveCBResult(a,g)});return function(a){return c.apply(this,
arguments)}}();m.createHistogramResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:h,classificationMethod:g,standardDeviationInterval:k,minValue:l,maxValue:n,numBins:q,scale:t}=a;a=yield this._getDataValues({field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:h,scale:t});return B.calculateHistogram(a,{field:b,normalizationField:d,normalizationType:f,normalizationTotal:h,
classificationMethod:g,standardDeviationInterval:k,minValue:l,maxValue:n,numBins:q})});return function(a){return c.apply(this,arguments)}}();m._sortFeatures=function(c,a,b){if(1<c.length&&a&&a.length)for(const e of a.reverse()){a=e.split(" ");const d=a[0],f=this.fieldsIndex.get(d);a=a[1]?"desc"===a[1].toLowerCase():!1;const h=B.getAttributeComparator(f?.type,a);c.sort((g,k)=>{g=b(g,d,f);k=b(k,d,f);return h(g,k)})}};m._createFeatureQueryResponse=function(c){const a=this.items,{geometryType:b,hasM:e,
hasZ:d,objectIdField:f,spatialReference:h}=this,{outFields:g,outSR:k,quantizationParameters:l,resultRecordCount:n,resultOffset:q,returnZ:t,returnM:r}=c,x=null!=n?a.length>(q||0)+n:!1,A=g&&(g.includes("*")?[...this.fieldsIndex.fields]:g.map(p=>this.fieldsIndex.get(p)));return{exceededTransferLimit:x,features:this._createFeatures(c,a),fields:A,geometryType:b,hasM:e&&r,hasZ:d&&t,objectIdFieldName:f,spatialReference:F.cleanFromGeometryEngine(k?k:h),transform:l&&T.toQuantizationTransform(l)||null}};m._createFeatures=
function(c,a){const b=new N(c,this.featureAdapter,this.fieldsIndex),{hasM:e,hasZ:d}=this,{orderByFields:f,quantizationParameters:h,returnGeometry:g,returnCentroid:k,maxAllowableOffset:l,resultOffset:n,resultRecordCount:q,returnZ:t=!1,returnM:r=!1}=c,x=d&&t,A=e&&r;c=[];var p=0;a=[...a];this._sortFeatures(a,f,(u,z,D)=>b.getFieldValue(u,z,D));if(g||k){var v=T.toQuantizationTransform(h)??void 0;if(g&&!k)for(var y of a)c[p++]={attributes:b.getAttributes(y),geometry:F.getGeometry(this.geometryType,this.hasZ,
this.hasM,this.featureAdapter.getGeometry(y),l,v,x,A)};else if(!g&&k)for(const u of a)c[p++]={attributes:b.getAttributes(u),centroid:F.transformCentroid(this,this.featureAdapter.getCentroid(u,this),v)};else for(const u of a)c[p++]={attributes:b.getAttributes(u),centroid:F.transformCentroid(this,this.featureAdapter.getCentroid(u,this),v),geometry:F.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(u),l,v,x,A)}}else for(v of a)(y=b.getAttributes(v))&&(c[p++]={attributes:y});
p=n||0;null!=q&&(c=c.slice(p,Math.min(c.length,p+q)));return c};m._createExceedsLimitQueryResponse=function(c){var a=!1;let b=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY;a=Number.POSITIVE_INFINITY;for(const d of c.outStatistics??[])if("exceedslimit"===d.statisticType){b=null!=d.maxPointCount?d.maxPointCount:Number.POSITIVE_INFINITY;e=null!=d.maxRecordCount?d.maxRecordCount:Number.POSITIVE_INFINITY;a=null!=d.maxVertexCount?d.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===
this.geometryType)a=this.items.length>b;else if(this.items.length>e)a=!0;else{c=X(this.hasZ,this.hasM);const d=this.featureAdapter;a=this.items.reduce((f,h)=>{h=d.getGeometry(h);return f+(O.isSome(h)&&h.coords.length||0)},0)/c>a}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(a)}}]}};m._createStatisticsQueryResponse=function(){var c=C._asyncToGenerator(function*(a){var b=
{attributes:{}};const e=[],d=new Map,f=new Map,h=new Map,g=new Map,k=new N(a,this.featureAdapter,this.fieldsIndex);var l=a.outStatistics;const {groupByFieldsForStatistics:n,having:q,orderByFields:t}=a;a=n&&n.length;const r=!!a,x=r?n[0]:null,A=r&&!this.fieldsIndex.get(x);for(const z of l??[]){const {outStatisticFieldName:D,statisticType:E}=z;l=z;var p="exceedslimit"!==E?z.onStatisticField:void 0;const H="percentile_disc"===E||"percentile_cont"===E,I="EnvelopeAggregate"===E||"CentroidAggregate"===E||
"ConvexHullAggregate"===E,ea=r&&1===a&&(p===x||A)&&"count"===E;if(r){if(!h.has(p)){var v=[];for(const L of n){var y=this._getAttributeValues(k,L,d);v.push(y)}h.set(p,this._calculateUniqueValues(v,I?!1:k.returnDistinctValues))}v=h.get(p);for(const L in v){const {count:R,data:Z,items:aa,itemPositions:fa}=v[L];y=Z.join(",");if(!q||k.validateItems(aa,q)){const J=g.get(y)||{attributes:{}};if(I){J.aggregateGeometries||(J.aggregateGeometries={});const {aggregateGeometries:K,outStatisticFieldName:M}=yield this._getAggregateGeometry(l,
aa);J.aggregateGeometries[M]=K}else{var u=null;if(ea)u=R;else{const K=this._getAttributeValues(k,p,d);u=fa.map(M=>K[M]);u=H&&"statisticParameters"in l?this._getPercentileValue(l,u):this._getStatisticValue(l,u,null,k.returnDistinctValues)}J.attributes[D]=u}let ha=0;n.forEach((K,M)=>J.attributes[this.fieldsIndex.get(K)?K:`EXPR_${++ha}`]=Z[M]);g.set(y,J)}}}else if(I){b.aggregateGeometries||(b.aggregateGeometries={});const {aggregateGeometries:L,outStatisticFieldName:R}=yield this._getAggregateGeometry(l,
this.items);b.aggregateGeometries[R]=L}else p=this._getAttributeValues(k,p,d),b.attributes[D]=H&&"statisticParameters"in l?this._getPercentileValue(l,p):this._getStatisticValue(l,p,f,k.returnDistinctValues);e.push({name:D,alias:D,type:"esriFieldTypeDouble"})}b=r?Array.from(g.values()):[b];this._sortFeatures(b,t,(z,D)=>z.attributes[D]);return{fields:e,features:b}});return function(a){return c.apply(this,arguments)}}();m._getAggregateGeometry=function(){var c=C._asyncToGenerator(function*(a,b){var e=
yield new Promise((t,r)=>ba(["../../../geometry/geometryEngineJSON"],t,r));const {statisticType:d,outStatisticFieldName:f}=a,{featureAdapter:h,spatialReference:g,geometryType:k,hasZ:l,hasM:n}=this;b=b.map(t=>F.getGeometry(k,l,n,h.getGeometry(t)));const q=e.convexHull(g,b,!0)[0];a={aggregateGeometries:null,outStatisticFieldName:null};"EnvelopeAggregate"===d?(e=q?P.getPolygonExtent(q):P.getGeometryExtent(e.union(g,b)),a.aggregateGeometries={...e,spatialReference:g},a.outStatisticFieldName=f||"extent"):
"CentroidAggregate"===d?(e=q?S.polygonCentroid(q):S.extentCentroid(P.getGeometryExtent(e.union(g,b))),a.aggregateGeometries={x:e[0],y:e[1],spatialReference:g},a.outStatisticFieldName=f||"centroid"):"ConvexHullAggregate"===d&&(a.aggregateGeometries=q,a.outStatisticFieldName=f||"convexHull");return a});return function(a,b){return c.apply(this,arguments)}}();m._getStatisticValue=function(c,a,b,e){const {onStatisticField:d,statisticType:f}=c;c=null;c=b?.has(d)?b.get(d):W.isStringField(this.fieldsIndex.get(d))?
B.calculateStringStatistics({values:a,returnDistinct:e}):B.calculateStatistics({values:e?[...(new Set(a))]:a,minValue:null,maxValue:null,useSampleStdDev:!0});b&&b.set(d,c);return c["var"===f?"variance":f]};m._getPercentileValue=function(c,a){const {onStatisticField:b,statisticParameters:e,statisticType:d}=c,{value:f,orderBy:h}=e;c=this.fieldsIndex.get(b);return B.calculatePercentile(a,{value:f,orderBy:h,fieldType:c?.type,isDiscrete:"percentile_disc"===d})};m._getAttributeValues=function(c,a,b){if(b.has(a))return b.get(a);
const e=this.fieldsIndex.get(a),d=this.items.map(f=>c.getFieldValue(f,a,e));b.set(a,d);return d};m._getAttributeDataValues=function(c,a){return this.items.map(b=>c.getDataValue(b,{field:a.field,field2:a.field2,field3:a.field3,fieldDelimiter:a.fieldDelimiter,normalizationField:a.normalizationField,normalizationType:a.normalizationType,normalizationTotal:a.normalizationTotal}))};m._getAttributeExpressionValues=function(){var c=C._asyncToGenerator(function*(a,b,e){const {arcadeUtils:d}=yield ca.loadArcade();
b=d.createFunction(b);e=e&&d.getViewInfo(e);return a.getExpressionValues(this.items,b,e,d)});return function(a,b,e){return c.apply(this,arguments)}}();m._calculateUniqueValues=function(c,a){const b={},e=this.items,d=e.length;for(let f=0;f<d;f++){const h=e[f],g=[];for(const l of c)g.push(l[f]);const k=g.join(",");null==b[k]?b[k]={count:1,data:g,items:[h],itemPositions:[f]}:(a||b[k].count++,b[k].items.push(h),b[k].itemPositions.push(f))}return b};m._getDataValues=function(){var c=C._asyncToGenerator(function*(a){const b=
new N(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:e,field:d,normalizationField:f,normalizationType:h,normalizationTotal:g,scale:k}=a,l=e?{viewingMode:"map",scale:k,spatialReference:this.query.outSR||this.spatialReference}:null;return e?this._getAttributeExpressionValues(b,e,l):this._getAttributeDataValues(b,{field:d,field2:a.field2,field3:a.field3,fieldDelimiter:a.fieldDelimiter,normalizationField:f,normalizationType:h,normalizationTotal:g})});return function(a){return c.apply(this,
arguments)}}();C._createClass(w,[{key:"size",get:function(){return this.items.length}}]);return w}();G.SnappingTypes=void 0;(function(w){w[w.NONE=0]="NONE";w[w.EDGE=1]="EDGE";w[w.VERTEX=2]="VERTEX"})(G.SnappingTypes||(G.SnappingTypes={}));let Y=function(){function w(m,c){this.coords=m;this.coordsIndex=c}C._createClass(w,[{key:"x",get:function(){return this.coords[this.coordsIndex]}},{key:"y",get:function(){return this.coords[this.coordsIndex+1]}},{key:"z",get:function(){return this.coords[this.coordsIndex+
2]}}]);return w}();G.QueryEngineResult=ia;Object.defineProperty(G,Symbol.toStringTag,{value:"Module"})});