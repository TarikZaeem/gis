// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/maybe","../DimensionalDefinition"],function(n,m,p){function r(b,a,c){const f=a.shift();0===c.length&&c.push({sliceId:-1,multidimensionalDefinition:[]});const d=c.length;for(let e=0;e<d;e++){const k=c.shift().multidimensionalDefinition;f.values?.forEach(g=>{c.push({sliceId:-1,multidimensionalDefinition:[...k,{variableName:b,dimensionName:f.name,values:[g]}]})})}a.length&&r(b,a,c)}function t(b,a){return Array.isArray(b)?a[0]===a[1]?b[0]===a[0]||b[1]===a[0]:b[0]>=a[0]&&
b[0]<=a[1]&&b[1]>=a[0]&&b[1]<=a[1]:b>=a[0]&&b<=a[1]}function y(b,a){return b[0]<=a[0]&&b[1]>=a[0]||b[0]<=a[1]&&b[1]>=a[1]||b[0]>=a[0]&&b[1]<=a[1]}function u(b){return 1===b.length?[b[0],b[0]]:[b[0],b[b.length-1]]}function v(b,a,c){if(!a?.subsetDefinitions?.length)return b;if(c){const {variables:d}=a;if(d.length&&!d.includes(c))return null;a=a.subsetDefinitions.find(e=>e.dimensionName===b.name&&e.variableName===c);if(!a?.values?.length)return b;a=u(a.values)}else a=a.dimensions.find(({name:d})=>d===
b.name)?.extent;const f=a;if(!f||!f?.length)return b;a=b.values.filter(d=>t(d,f));return{...b,extent:[...f],values:a}}function q(b,a,c){if(!a?.subsetDefinitions?.length)return!1;const {variables:f}=a;if(f.length&&b.some(({variableName:d})=>d&&!f.includes(d)))return!0;for(let d=0;d<b.length;d++){const e=b[d],k=a.subsetDefinitions.find(g=>(""===e.variableName||g.variableName===e.variableName)&&g.dimensionName===e.dimensionName);if(k?.values.length){const g=u(k.values);if(!e.isSlice&&2===e.values.length&&
!Array.isArray(e.values[0])&&e.values[0]!==e.values[1]&&c){if(!y(e.values,g))return!0}else if(e.values.some(h=>!t(h,g)))return!0}}return!1}function z(b,a){var c=b.dimensions.find(({name:k})=>"StdTime"===k);if(null==c||m.isNone(a.start)&&m.isNone(a.end))return a;a=a.clone();const {start:f,end:d}=a.toJSON(),e=f===d?[f]:null!=f&&null!=d?[f,d]:[f??d];if(2===e.length&&c?.extent.length&&(e[0]=Math.max(e[0],c.extent[0]),e[1]=Math.min(e[1],c.extent[1]??c.extent[0]),e[1]<e[0]))return null;c=new p({variableName:"",
dimensionName:"StdTime",isSlice:1===e.length,values:e});if(q([c],b,!0))return null;a.start=new Date(e[0]);a.end=new Date(e[1]??e[0]);return a}function w(b,a={}){const {multidimensionalInfo:c,keyProperties:f}=b;if(m.isNone(c))return null;const {variableName:d,multidimensionalSubset:e,multidimensionalDefinition:k}=a;b=m.isSome(k)?k[0]?.variableName:null;const g=d||b||f?.DefaultVariable;({variables:b}=c);e?.variables?.length&&(b=b.filter(({name:h})=>e.variables.includes(h)));return g?b.find(({name:h})=>
h===g)??b[0]:b[0]}function A(b,a){var {values:c}=a;if(c?.length)return Array.isArray(c[0])!==Array.isArray(b)?-1:Array.isArray(c[0])?c.findIndex(e=>e[0]===b[0]&&e[1]===b[1]):c.indexOf(b);var {extent:f}=a;if(Array.isArray(b)||b<f[0]||b>f[1])return-1;c=a.interval||1;if("ISO8601"!==a.unit)return Math.round((b-f[0])/c);f=f[0];let d=-1;switch(a.intervalUnit?.toLowerCase()||"seconds"){case "seconds":d=Math.round((b-f)/1E3/c);break;case "minutes":d=Math.round((b-f)/6E4/c);break;case "hours":d=Math.round((b-
f)/36E5/c);break;case "days":d=Math.round((b-f)/864E5/c);break;case "months":a=(new Date(b)).getUTCFullYear()-(new Date(f)).getUTCFullYear();c=(new Date(f)).getUTCMonth();f=(new Date(b)).getUTCMonth();d=0===a?f-c:f+11-c+12*(a-1);break;case "years":d=Math.round(((new Date(b)).getUTCFullYear()-(new Date(f)).getUTCFullYear())/c);break;case "decades":d=Math.round(((new Date(b)).getUTCFullYear()-(new Date(f)).getUTCFullYear())/10/c)}return d}function x(b){var a=b.values?.length;if(a)return a;const {extent:c,
unit:f}=b;a=b.interval||1;var d=c?c[1]-c[0]:0;if("ISO8601"!==f)return Math.round(d/a);switch(b.intervalUnit?.toLowerCase()??"seconds"){case "seconds":a=Math.round(d/1E3/a);break;case "minutes":a=Math.round(d/6E4/a);break;case "hours":a=Math.round(d/36E5/a);break;case "days":a=Math.round(d/864E5/a);break;case "months":b=(new Date(c[1])).getUTCFullYear()-(new Date(c[0])).getUTCFullYear();a=(new Date(c[1][0])).getUTCMonth();d=(new Date(c[1][1])).getUTCMonth();a=0===b?d-a+1:d+11-a+12*(b-1)+1;break;case "years":a=
Math.round(((new Date(c[1])).getUTCFullYear()-(new Date(c[0])).getUTCFullYear())/a);break;case "decades":a=Math.round(((new Date(c[1])).getUTCFullYear()-(new Date(c[0])).getUTCFullYear())/10/a);break;default:a=0}return a}n.createSlices=function(b,a){const c=[];let f=0;(a?b.variables.filter(d=>d.name.toLowerCase()===a.toLowerCase()):[...b.variables].sort((d,e)=>d.name>e.name?1:-1)).forEach(d=>{const e=[],k=[...d.dimensions].sort((g,h)=>g.name>h.name?-1:1);r(d.name,k,e);e.forEach(g=>{c.push({...g,sliceId:f++})})});
return c};n.getDefaultMultidimensionalDefinition=function(b,a={}){var c=w(b,a);if(!c)return null;b=[];const {dimensions:f,name:d}=c;if(0===f.length)return[new p({variableName:d,dimensionName:"",values:[],isSlice:!0})];for(c=0;c<f.length;c++){const e=v(f[c],a.multidimensionalSubset,d);if(!e)return null;const {values:k,extent:g}=e;let h=k?.[0]??g[0];"stdz"===e.name.toLowerCase()&&!e.hasRanges&&Math.abs(g[1])<=Math.abs(g[0])&&(h=k?.length?k[k.length-1]:g[1]);b.push(new p({variableName:d,dimensionName:e.name,
values:[h],isSlice:a.useRangeForRangedDimensionInfo?!!e.hasRanges:!0}))}return b};n.getDefaultVariablInfo=w;n.getSliceIds=function(b,a,c){let f=b;a&&(a=[...a].sort((d,e)=>d.dimensionName<e.dimensionName?-1:1),a.forEach(({dimensionName:d,values:e,isSlice:k})=>{e.length&&(f=f.filter(g=>{g=g.multidimensionalDefinition.find(l=>l.dimensionName===d);if(null==g)return!1;const h=g.values[0];return"number"===typeof h?"number"===typeof e[0]?e.includes(h):e.some(l=>l[0]<=h&&l[1]>=h):"number"===typeof e[0]?e.some(l=>
h[0]<=l&&h[1]>=l):k?e.some(l=>l[0]===h[0]&&l[0]===h[1]):e.some(l=>l[0]>=h[0]&&l[0]<=h[1]||l[1]>=h[0]&&l[1]<=h[1]||l[0]<h[0]&&l[1]>h[1])}))}));if(f.length&&c&&m.isSome(c.start)&&m.isSome(c.end)){const d=c.start.getTime(),e=c.end.getTime(),k=f[0].multidimensionalDefinition.findIndex(g=>"StdTime"===g.dimensionName);-1<k&&(f=f.filter(g=>{g=g.multidimensionalDefinition[k].values[0];return d<=g&&e>=g}))}return f.map(d=>d.sliceId)};n.getSliceIndex=function(b,a){let c=0;var f=b[0].variableName;a=[...a.variables].sort((e,
k)=>e.name>k.name?1:-1);for(var d=0;d<a.length;d++){const e=a[d],k=[...e.dimensions].sort((g,h)=>g.name>h.name?-1:1);if(e.name!==f)c+=k.map(g=>x(g)).reduce((g,h)=>g*h);else{f=k.map(g=>x(g));a=k.length;for(let g=0;g<a;g++){d=b.find(h=>h.dimensionName===k[g].name);if(null==d)return null;d=A(d.values[0],k[g]);if(-1===d)return null;f.shift();c=g===a-1?c+d:c+d*f.reduce((h,l)=>h*l)}break}}return c};n.getSubsetVariablesFromMdInfo=function(b,a){if(m.isNone(a)||m.isNone(b))return null;a=a.variables.map(c=>
({...c}));b?.variables?.length&&(a=a.filter(({name:c})=>b.variables.includes(c)),a.forEach(c=>{c.dimensions=c.dimensions.map(f=>v(f,b,c.name)).filter(m.isSome)}));return a};n.hasExcludedVariableOrDimension=q;n.intersectMultimensionalSubset=function(b,a){if(m.isNone(b))return{isOutside:!1};const {geometry:c,timeExtent:f,multidimensionalDefinition:d}=a;a=null;if(m.isSome(f)&&(a=z(b,f),m.isNone(a)))return{isOutside:!0};const {areaOfInterest:e}=b;if(e&&c){const k="point"===c.type?c:"extent"===c.type?
c.center:"polygon"===c.type?c.centroid:null;if(k&&!e.contains(k))return{isOutside:!0}}return m.isSome(d)&&d.length&&q(d,b,!0)?{isOutside:!0}:{isOutside:!1,intersection:{geometry:c,timeExtent:a,multidimensionalDefinition:d}}};n.isMultiSliceOrRangeDefinition=function(b){return m.isNone(b)||!b.length?!1:b.some(a=>{if(null==a.values)return!0;const c=a.values.length;return 0===c||1<c||!a.isSlice&&Array.isArray(a.values[0])})};Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});