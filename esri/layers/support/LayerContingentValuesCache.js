// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/JSONSupport ../../core/Loadable ../../core/maybe ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/accessorSupport/decorators/subclass ./arcgisLayerUrl ./Contingency ./ContingencyConstraintViolation ./ContingentValue ./ContingentValuesResult ./FieldGroup ./Subtype".split(" "),function(u,B,C,v,M,D,E,P,Q,N,F,H,I,t,O,G,J){var y;v=y=function(K){function A(c){c=
K.call(this,c)||this;c.request=C;c.fieldGroups=null;c.fieldGroupDefinitions=null;return c}u._inheritsLoose(A,K);var l=A.prototype;l.initialize=function(){};A.createLoadedLayerContingentValuesCache=function(){var c=u._asyncToGenerator(function*(a){yield a.load();if(void 0===a.layerId)return null;var b=a.sourceJSON.hasContingentValuesDefinition;if(b)return(new y({layer:a})).load();if(void 0===b){b=F.parse(a.url);if(D.isNone(b))return null;b=b.url.path;if((yield y._staticFetchEnterpriseFeatureRoot(b)).supportsQueryDataElements&&
(b=yield y._staticFetchEnterpriseFieldGroup(b,a.layerId.toString())))return b=b.map(d=>({name:d.name,isEditingRestrictive:d.isEditingRestrictive,fields:d.fieldNames.names})),(new y({layer:a,fieldGroupDefinitions:b})).load()}return null});return function(a){return c.apply(this,arguments)}}();l.load=function(){var c=u._asyncToGenerator(function*(a){const b=this.layer.load(a).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,a));this.addResolvingPromise(b);return this});return function(a){return c.apply(this,
arguments)}}();l.validateContingencyConstraints=function(c,a){const b=Object.keys(c),d=[],e=[];for(const k of this.fieldGroups){const h=k.isEditingRestrictive?"error":"warning";if(a&&!k.fields.some(g=>a.includes(g)))continue;if(!k.fields.every(g=>b.includes(g))){e.push(new I({fieldGroup:k,type:h}));continue}let n=!1;const q=c[this.subtypeFieldName];var f=k.contingencies.filter(g=>!g.isRetired&&g.subtype?g.subtype.code===q:!0);for(const g of f){f=!0;for(const r in g.values){const p=g.values[r];if("any"!==
p.objectType)if("null"===p.objectType){if(null!=c[r]){f=!1;break}}else if("code"===p.objectType){if(c[r]!==p.codedValue.code){f=!1;break}}else if("range"===p.objectType){const m=c[r];if(m<p.minValue||m>p.maxValue){f=!1;break}}}if(f){n=!0;break}}n||d.push(new I({fieldGroup:k,type:h}))}return{invalid:d,incomplete:e}};l.getContingentValues=function(c,a,b=!1){const d=c[this.subtypeFieldName],e=void 0!==d&&null!==d,f={};let k=[];const h=this.fieldGroups.filter(q=>q.fields.includes(a));k.push(new t({objectType:"any"}));
for(const q of h){let g=[];var n=q.contingencies.filter(m=>!m.isRetired&&(m.subtype&&e?m.subtype.code===d:!0));let r=!1;const p={};for(const m of n){let w;n=!0;for(const z in m.values){const x=m.values[z];if(a===z)w=x,r=r||"range"===x.objectType;else if(void 0!==c[z]&&"any"!==x.objectType)if("null"===x.objectType)null!==c[z]&&(n=!1);else if("code"===x.objectType)c[z]!==x.codedValue.code&&(n=!1);else if("range"===x.objectType){const L=c[z];if(L<x.minValue||L>x.maxValue)n=!1}}if(w&&n){if("any"===w.objectType){g.length=
0;g.push(w);break}n=this._generateKey(w);p[n]||g.push(w);p[n]=!0}}r&&(g=this._joinRange(g));f[q.name]=g;k=b?this._filterIntersection(k,g):[]}1===h.length&&b&&(k=[]);return new O({contingentValuesAllGroups:k,contingentValuesByFieldGroup:f})};l._generateKey=function(c){switch(c.objectType){case "any":return"@any@";case "null":return"@null@";case "code":return c.codedValue.name+c.codedValue.code.toString();case "range":return c.minValue.toString()+"-"+c.maxValue.toString()}};l._joinRange=function(c){c.sort((e,
f)=>"null"===e.objectType?-1:"null"===f.objectType?1:e.minValue-f.minValue);let a,b;const d=[];for(const e of c)"null"===e.objectType?d.push(e):null==a||null==b?(a=e.minValue,b=e.maxValue):b<e.minValue?(d.push(new t({objectType:"range",minValue:a,maxValue:b})),a=e.minValue,b=e.maxValue):b<e.maxValue&&(b=e.maxValue);d.push(new t({objectType:"range",minValue:a,maxValue:b}));return d};l._filterIntersection=function(c,a){if(0===c.length||0===a.length)return[];if("any"===c[0].objectType)return a;if("any"===
a[0].objectType)return c;const b="range"===a[0].objectType||"range"===a[1]?.objectType;return"range"===c[0].objectType||"range"===c[1]?.objectType||b?this._intersectRanges(c,a):this._intersectValues(c,a)};l._intersectRanges=function(c,a){const b=[];let d=0;for(const e of c)for(;d<a.length;d++){const f=a[d];if("null"===e.objectType&&"null"===f.objectType)b.push(new t({objectType:"null"}));else if("null"===e.objectType)break;else if("null"===f.objectType)continue;if(e.maxValue<f.minValue)break;if(e.maxValue===
f.minValue){b.push(new t({objectType:"range",minValue:e.maxValue,maxValue:f.minValue}));break}if(!(e.minValue>f.maxValue))if(e.minValue===f.maxValue)b.push(new t({objectType:"range",minValue:e.minValue,maxValue:f.maxValue}));else{c=e.minValue>f.minValue?e.minValue:f.minValue;if(e.maxValue<f.maxValue){b.push(new t({objectType:"range",minValue:c,maxValue:e.maxValue}));break}b.push(new t({objectType:"range",minValue:c,maxValue:f.maxValue}))}}return b};l._intersectValues=function(c,a){const b=[];for(const d of c)a.some(e=>
{if(d.objectType===e.objectType)switch(d.objectType){case "any":case "null":return!0;case "code":return d.codedValue.code===e.codedValue.code&&d.codedValue.name===e.codedValue.name}return!1})&&b.push(d);return b};A._staticFetchEnterpriseFeatureRoot=function(){var c=u._asyncToGenerator(function*(a,b){return C(a,{responseType:"json",query:{f:"json"},...b}).then(d=>d.data)});return function(a,b){return c.apply(this,arguments)}}();A._staticFetchEnterpriseFieldGroup=function(){var c=u._asyncToGenerator(function*(a,
b,d){return C(`${a}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([b]),f:"json"},...d}).then(e=>e.data.layerDataElements?.[0].dataElement.fieldGroups)});return function(a,b,d){return c.apply(this,arguments)}}();l._initializeContingentValues=function(){var c=u._asyncToGenerator(function*(a,b){a=a?a:yield this._fetchFieldGroupDefs(b);this.fieldGroups=0===a.length?[]:yield this._fetchContingentValues(a,b)});return function(a,b){return c.apply(this,arguments)}}();l._fetchFieldGroupDefs=
function(){var c=u._asyncToGenerator(function*(a){var b=this;if(void 0===this.layer.layerId)return[];const d=this.layer.sourceJSON,e=this.layer.layerId.toString(),f=D.unwrap(F.parse(this.layer.url)).url.path;return d.hasContingentValuesDefinition?(yield this._fetchAGOLFieldGroup(f,e,a)).map(k=>({name:k.name,isEditingRestrictive:k.restrictive,fields:k.fields.map(h=>this.layer.fieldsIndex.normalizeFieldName(h))})):void 0!==d.hasContingentValuesDefinition?[]:this._fetchEnterpriseFeatureRoot(f,a).then(function(){var k=
u._asyncToGenerator(function*(h){return h.supportsQueryDataElements?(yield b._fetchEnterpriseFieldGroup(f,e,a)).map(n=>({name:n.name,isEditingRestrictive:n.isEditingRestrictive,fields:n.fieldNames.names.map(q=>b.layer.fieldsIndex.normalizeFieldName(q))})):[]});return function(h){return k.apply(this,arguments)}}())});return function(a){return c.apply(this,arguments)}}();l._fetchAGOLFieldGroup=function(){var c=u._asyncToGenerator(function*(a,b,d){return C(`${a}/${b}/fieldgroups`,{responseType:"json",
query:{f:"json"},...d}).then(e=>e.data.fieldGroups)});return function(a,b,d){return c.apply(this,arguments)}}();l._fetchEnterpriseFieldGroup=function(){var c=u._asyncToGenerator(function*(a,b,d){return y._staticFetchEnterpriseFieldGroup(a,b,d)});return function(a,b,d){return c.apply(this,arguments)}}();l._fetchEnterpriseFeatureRoot=function(){var c=u._asyncToGenerator(function*(a,b){return y._staticFetchEnterpriseFeatureRoot(a,b)});return function(a,b){return c.apply(this,arguments)}}();l._fetchContingentValues=
function(){var c=u._asyncToGenerator(function*(a,b){if(void 0===this.layer.layerId)return[];const d=this.layer.sourceJSON,e=this.layer.layerId.toString(),f=D.unwrap(F.parse(this.layer.url)).url.path;if(d.hasContingentValuesDefinition)return b=yield this._fetchAGOLContingentValues(f,e,b),this._constructFieldGroupsAGOL(a,b);b=yield this._fetchEnterpriseContingentValues(f,e,b);return this._constructFieldGroupsEnterprise(a,b)});return function(a,b){return c.apply(this,arguments)}}();l._constructFieldGroupsAGOL=
function(c,a){return c.map(b=>{const d=a.contingentValuesDefinition.fieldGroups.find(e=>e.name===b.name);if(d){let e=[];e=a.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(b,a,d.subTypes):this._parseAGOLFieldGroup(b,a,d.contingentValues);return new G({name:b.name,isEditingRestrictive:b.isEditingRestrictive,fields:b.fields,contingencies:e})}return null}).filter(D.isSome)};l._parseAGOLFieldGroupSubtype=function(c,a,b){let d=[];b?.forEach(e=>{const f=this._getSubtypeAGOL(e.name);
d=d.concat(this._parseAGOLFieldGroup(c,a,e.contingentValues,f))});return d};l._parseAGOLFieldGroup=function(c,a,b,d=null){const e=[];for(const f of b??[])b=this._parseAGOLContingency(f,c,a,d),e.push(b);return e};l._parseAGOLContingency=function(c,a,b,d){const e=c.id,f=c.retired?1===c.retired:!1,k={};for(let n=0,q=0;n<a.fields.length;n++){const g=a.fields[n];var h=b.typeCodes[c.types[n]];if("Code"===h){let r=c.values[q];q++;const p=this._getDomain(d,g);"string"===this.layer.getField(g)?.type&&(h=b.stringDicts.find(m=>
m.domain===p.name))&&(r=h.entries[r]);h=p.codedValues.find(m=>m.code===r);h=new t({codedValue:h,objectType:"code"});k[g]=h}else"Range"===h?(h=c.values[q],q++,h=new t({minValue:h.range[0],maxValue:h.range[1],objectType:"range"}),k[g]=h):"Any"===h?(h=new t({objectType:"any"}),k[g]=h):(h=new t({objectType:"null"}),k[g]=h)}return new H({id:e,isRetired:f,subtype:d,values:k})};l._constructFieldGroupsEnterprise=function(c,a){const b=a.fieldGroups;return c.map(d=>{var e=b.find(f=>f.name===d.name);return e?
(e=e.contingencies.map(f=>{const k=f.id,h=f.isRetired||!1,n=this._getSubtypeEnterprise(f.subtypeCode),q={};for(let r=0;r<d.fields.length;r++){const p=d.fields[r];let m=f.values[r];if("number"===typeof m||"string"===typeof m){var g=this._getDomain(n,p);const w=this.layer.getField(p);"string"===w?.type?m=a.stringDictionary[m]:"date"===w?.type&&(m=(new Date(`${m}+00:00`)).getTime());g=g.codedValues.find(z=>z.code===m);g=new t({codedValue:g,objectType:"code"});q[p]=g}else"object"===typeof m?(g=new t({minValue:m.minValue,
maxValue:m.maxValue,objectType:"range"}),q[p]=g):m?(g=new t({objectType:"any"}),q[p]=g):(g=new t({objectType:"null"}),q[p]=g)}return new H({id:k,isRetired:h,subtype:n,values:q})}),new G({name:d.name,isEditingRestrictive:d.isEditingRestrictive,fields:d.fields,contingencies:e})):null}).filter(D.isSome)};l._fetchEnterpriseContingentValues=function(){var c=u._asyncToGenerator(function*(a,b,d){return C(`${a}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([b]),f:"json"},...d}).then(e=>
e.data.contingentValueSets?.[0])});return function(a,b,d){return c.apply(this,arguments)}}();l._fetchAGOLContingentValues=function(){var c=u._asyncToGenerator(function*(a,b,d){return C(`${a}/${b}/contingentValues`,{responseType:"json",query:{f:"json"},...d}).then(e=>e.data)});return function(a,b,d){return c.apply(this,arguments)}}();l._getSubtypeEnterprise=function(c){var a=this.layer.sourceJSON;let b;a.subtypes&&(a=a.subtypes.find(d=>d.code===c),b=J.fromJSON(a));return b?b:null};l._getSubtypeAGOL=
function(c){var a=this.layer.sourceJSON;let b;a.subtypes&&(a=a.subtypes.find(d=>d.name===c),b=J.fromJSON(a));return b?b:null};l._getDomain=function(c,a){c=c?c.domains?.[a]:this.layer.getFieldDomain(a);return"inherited"===c?.type?this.layer.getFieldDomain(a):c};u._createClass(A,[{key:"subtypeFieldName",get:function(){const {layer:c}=this;return"subtype-group"===c.type?c.subtypeField:c.typeIdField}}]);return A}(v.JSONSupportMixin(M));B.__decorate([E.property({constructOnly:!0})],v.prototype,"layer",
void 0);B.__decorate([E.property({constructOnly:!0})],v.prototype,"request",void 0);B.__decorate([E.property({type:[G]})],v.prototype,"fieldGroups",void 0);B.__decorate([E.property({constructOnly:!0})],v.prototype,"fieldGroupDefinitions",void 0);B.__decorate([E.property()],v.prototype,"subtypeFieldName",null);return v=y=B.__decorate([N.subclass("esri.layers.support.LayerContingentValuesCache")],v)});