// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Collection ../core/Error ../core/Logger ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../chunks/vec3 ../chunks/vec3f64 ../geometry/Extent ./Layer ./mixins/APIKeyMixin ./mixins/ArcGISService ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/ScaleRangeLayer ./mixins/SceneService ./support/arcgisLayerUrl ./support/commonProperties ./support/Field ./voxel/VoxelSection ./voxel/VoxelSimpleShading ./voxel/VoxelVariable ./voxel/VoxelVariableStyle ./voxel/VoxelVolume ./voxel/VoxelVolumeIndex ./voxel/VoxelVolumeStyle ../support/popupUtils".split(" "),
function(x,f,l,t,d,m,E,F,g,G,V,y,H,I,J,z,K,L,M,N,O,P,Q,R,u,p,v,A,S,B,C,T,D,U){const n=d.getLogger("esri.layers.VoxelLayer");d=function(q){function r(b){var a=q.call(this,b)||this;a.serviceRoot="";a.operationalLayerType="Voxel";a.legendEnabled=!0;a.title=null;a.sections=null;a.currentVariableId=0;a.volumeStyles=null;a.renderMode="volume";a.variableStyles=null;a.enableSlices=!0;a.enableSections=!0;a.enableDynamicSections=!0;a.enableIsosurfaces=!0;a.shading=new A;a.opacity=1;a.variables=new l;a.volumes=
new l;a.index=null;a.minScale=0;a.maxScale=0;a.type="voxel";a.version={major:Number.NaN,minor:Number.NaN,versionString:""};a.fullExtent=null;a.popupEnabled=!0;a.popupTemplate=null;a.test=null;a.volumeStyles=new (l.ofType(D));a.variableStyles=new (l.ofType(B));a.sections=new (l.ofType(v));b?.constantUpscaling&&(a.test={constantUpscaling:!0});return a}x._inheritsLoose(r,q);var k=r.prototype;k.load=function(b){const a=m.isSome(b)?b.signal:null;b=this.loadFromPortal({supportedTypes:["Scene Service"]},
b).catch(F.throwIfAbortError).then(()=>this._fetchService(a)).then(()=>this.serviceRoot=this.url);this.addResolvingPromise(b);return Promise.resolve(this)};k.read=function(b,a){q.prototype.read.call(this,b,a);for(const c of this.volumes)c.spatialReference=this.spatialReference};k.readVersion=function(b,a){return q.prototype.parseVersionString.call(this,b)};k.validateLayer=function(b){if(b.layerType&&b.layerType!==this.operationalLayerType)throw new t("voxel-layer:layer-type-not-supported","VoxelLayer does not support this layer type",
{layerType:b.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor)||3>this.version.major)throw new t("layer:service-version-not-supported","Service version is not supported.",{serviceVersion:this.version.versionString,supportedVersions:"3.x"});if(3<this.version.major)throw new t("layer:service-version-too-new","Service version is too new.",{serviceVersion:this.version.versionString,supportedVersions:"3.x"});};k.readFullExtent=function(b,a,c){if(null!=b&&"object"===typeof b){b=z.fromJSON(b,
c);if(0===b.zmin&&0===b.zmax&&Array.isArray(a.volumes)&&(a=C.fromJSON(a.volumes[0]),a.isValid&&"xyt"!==a.volumeType&&(c=a.dimensions[2],c.isRegular))){a=c.regularSpacing.offset;c=c.regularSpacing.offset+c.regularSpacing.scale*(c.size-1);if(a>c){const e=a;a=c;c=e}b.zmin=a;b.zmax=c}return b}return null};k.createPopupTemplate=function(b){return U.createPopupTemplate({fields:this.voxelFields,title:this.title},b)};k.getConfiguration=function(){const b={layerType:this.operationalLayerType,version:this.version.versionString,
name:this.title,spatialReference:this.spatialReference,fullExtent:this.fullExtent,volumes:this.volumes.toJSON(),variables:this.variables.toJSON(),index:this.index?.toJSON(),sections:this.getSections(),style:{volumeStyles:this.getVolumeStyles(),currentVariableId:this.currentVariableId,renderMode:this.renderMode,variableStyles:this.getVariableStyles(),enableSections:this.enableSections,enableDynamicSections:this.enableDynamicSections,enableIsosurfaces:this.enableIsosurfaces,enableSlices:this.enableSlices,
shading:this.shading}};return b.index&&this.index?.isValid()?JSON.stringify(b):""};k.getVariableStyle=function(b){let a=-1;a=m.isSome(b)?b:this.currentVariableId;if(!this.variableStyles||-1===a)return null;b=this.variableStyles.findIndex(c=>c.variableId===a);return 0>b?null:this.variableStyles.getItemAt(b)};k.getVariable=function(b){let a=-1;a=m.isSome(b)?b:this.currentVariableId;if(!this.variables||-1===a)return null;b=this.variables.findIndex(c=>c.id===a);return 0>b?null:this.variables.getItemAt(b)};
k.getVolume=function(b){const a=this.getVariable(b);return m.isSome(a)?this.volumes.find(({id:c})=>c===a.volumeId):null};k.getVolumeStyle=function(b){const a=this.getVariable(b);return m.isSome(a)?this.volumeStyles.find(({volumeId:c})=>c===a.volumeId):null};k.getColorForContinuousDataValue=function(b,a,c){var e=this.getVariable(b);if(m.isNone(e)||"continuous"!==e.renderingFormat?.continuity||!this.variableStyles)return null;e=this.variableStyles.findIndex(h=>h.variableId===b);if(0>e)return null;e=
this.variableStyles.getItemAt(e);return e.transferFunction?e.transferFunction.getColorForContinuousDataValue(a,c):null};k.getSections=function(){const b=[];for(const a of this.sections)b.push(new v({enabled:a.enabled,href:a.href,id:a.id,label:a.label,normal:a.normal,point:a.point,sizeInPixel:a.sizeInPixel,slices:a.slices,timeId:a.timeId,variableId:a.variableId}));return b};k.getVariableStyles=function(){const b=[];for(const a of this.variableStyles){const c=this._getVariable(a);if(m.isSome(c)){const e=
a.clone();4<e.isosurfaces.length&&(e.isosurfaces=e.isosurfaces.slice(0,3),n.error("A maximum of 4 isosurfaces are supported for Voxel Layers."));for(const h of e.isosurfaces)if(!h.colorLocked){const w=this.getColorForContinuousDataValue(e.variableId,h.value,!1);null===w||w.equals(h.color)||(h.color=w)}if("continuous"===c.renderingFormat.continuity)(null===e.transferFunction||2>e.transferFunction.colorStops.length)&&n.error(`VoxelVariableStyle for variable ${c.id} is invalid. At least 2 color stops are required in the transferFunction for continuous Voxel Layer variables.`),
null===e.transferFunction||Array.isArray(e.transferFunction.stretchRange)&&2===e.transferFunction.stretchRange.length||(n.error(`VoxelVariableStyle for variable ${c.id} is invalid. The stretchRange of the transferFunction for continuous Voxel Layer variables must be of the form [minimumDataValue, maximumDataValue].`),e.transferFunction.stretchRange=[0,1],e.transferFunction.colorStops.removeAll());else if("discrete"===c.renderingFormat.continuity)if(0===a.uniqueValues.length)n.error(`VoxelVariableStyle for variable ${c.id} is invalid. Unique values are required for discrete Voxel Layer variables.`);
else for(const h of a.uniqueValues)null!==h.label&&void 0!==h.label||null===h.value||void 0===h.value||(h.label=h.value.toString());b.push(e)}else n.error(`VoxelVariable ID=${a.variableId} doesn't exist, VoxelVariableStyle for this VoxelVariable will be ignored.`)}return b};k.getVolumeStyles=function(){const b=[];for(const a of this.volumeStyles){const c=this._getVolumeFromVolumeId(a.volumeId);if(m.isSome(c)){const e=a.clone();for(const h of e.slices)this._isPlaneValid(h,[0,1,c.zDimension],c.dimensions)||
(h.enabled=!1,h.label="invalid");for(const h of e.dynamicSections)this._isPlaneValid(h,[0,1,c.zDimension],c.dimensions)||(h.enabled=!1,h.label="invalid");b.push(e)}else n.error(`VoxelVolume ID=${a.volumeId} doesn't exist, VoxelVolumeStyle for this VoxelVolume will be ignored.`)}return b};k._getVariable=function(b){b=b.variableId;for(const a of this.variables)if(a.id===b)return a;return null};k._getVolumeFromVolumeId=function(b){for(const a of this.volumes)if(a.id===b)return a;return null};k._isPlaneValid=
function(b,a,c){if(!(b.point&&Array.isArray(b.point)&&3===b.point.length&&b.normal&&Array.isArray(b.normal)&&3===b.normal.length))return!1;for(let e=0;3>e;++e){const h=b.point[e];if(0>h||h>=c[a[e]].size)return!1}a=J.fromValues(b.normal[0],b.normal[1],b.normal[2]);I.normalize(a,a);if(1E-6>Math.abs(a[0])+Math.abs(a[1])+Math.abs(a[2]))return!1;b.normal[0]=a[0];b.normal[1]=a[1];b.normal[2]=a[2];return!0};x._createClass(r,[{key:"url",set:function(b){this._set("url",R.sanitizeUrl(b,n))}},{key:"voxelFields",
get:function(){var b=new p({name:"Voxel.ServiceValue",alias:"Value",domain:null,editable:!1,length:128,type:"string"}),a=new p({name:"Voxel.ServiceVariableLabel",alias:"Variable",domain:null,editable:!1,length:128,type:"string"}),c=new p({name:"Voxel.Position",alias:"Voxel Position",domain:null,editable:!1,length:128,type:"string"});b=[b,a,c];a=this.getVolume(null);if(m.isSome(a)){if("xyzt"===a.volumeType||"xyt"===a.volumeType)c=new p({name:"Voxel.ServiceLocalTime",alias:"Local Time",domain:null,
editable:!1,length:128,type:"string"}),b.push(c),c=new p({name:"Voxel.ServiceNativeTime",alias:"Native Time",domain:null,editable:!1,length:128,type:"string"}),b.push(c);"xyt"!==a.volumeType&&(a=new p({name:"Voxel.ServiceDepth",alias:"Depth",domain:null,editable:!1,length:128,type:"string"}),b.push(a))}return b}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}}]);return r}(Q.SceneService(M.ArcGISService(N.OperationalLayer(O.PortalLayer(P.ScaleRangeLayer(E.MultiOriginJSONMixin(L.APIKeyMixin(K))))))));
f.__decorate([g.property({type:["Voxel"]})],d.prototype,"operationalLayerType",void 0);f.__decorate([g.property(u.legendEnabled)],d.prototype,"legendEnabled",void 0);f.__decorate([g.property({json:{write:!0}})],d.prototype,"title",void 0);f.__decorate([g.property(u.url)],d.prototype,"url",null);f.__decorate([g.property({type:l.ofType(v),json:{origins:{"web-scene":{name:"layerDefinition.sections",write:!0}}}})],d.prototype,"sections",void 0);f.__decorate([g.property({type:G.Integer,json:{origins:{"web-scene":{name:"layerDefinition.style.currentVariableId",
write:{enabled:!0,isRequired:!0,ignoreOrigin:!0}},service:{name:"style.currentVariableId"}}}})],d.prototype,"currentVariableId",void 0);f.__decorate([g.property({type:l.ofType(D),json:{origins:{"web-scene":{name:"layerDefinition.style.volumeStyles",write:!0},service:{name:"style.volumeStyles"}}}})],d.prototype,"volumeStyles",void 0);f.__decorate([g.property({type:["volume","surfaces"],json:{origins:{"web-scene":{name:"layerDefinition.style.renderMode",write:!0},service:{name:"style.renderMode"}}}})],
d.prototype,"renderMode",void 0);f.__decorate([g.property({type:l.ofType(B),json:{origins:{"web-scene":{name:"layerDefinition.style.variableStyles",write:!0},service:{name:"style.variableStyles"}}}})],d.prototype,"variableStyles",void 0);f.__decorate([g.property({type:Boolean,json:{origins:{"web-scene":{name:"layerDefinition.style.enableSlices",write:!0},service:{name:"style.enableSlices"}}}})],d.prototype,"enableSlices",void 0);f.__decorate([g.property({type:Boolean,json:{origins:{"web-scene":{name:"layerDefinition.style.enableSections",
write:!0},service:{name:"style.enableSections"}}}})],d.prototype,"enableSections",void 0);f.__decorate([g.property({type:Boolean,json:{origins:{"web-scene":{name:"layerDefinition.style.enableDynamicSections",write:!0},service:{name:"style.enableDynamicSections"}}}})],d.prototype,"enableDynamicSections",void 0);f.__decorate([g.property({type:Boolean,json:{origins:{"web-scene":{name:"layerDefinition.style.enableIsosurfaces",write:!0},service:{name:"style.enableIsosurfaces"}}}})],d.prototype,"enableIsosurfaces",
void 0);f.__decorate([g.property({type:A,json:{origins:{"web-scene":{name:"layerDefinition.style.shading",write:!0},service:{name:"style.shading"}}}})],d.prototype,"shading",void 0);f.__decorate([g.property({type:["show","hide"]})],d.prototype,"listMode",void 0);f.__decorate([g.property({type:Number,range:{min:0,max:1},nonNullable:!0,json:{read:!1,write:!1,origins:{"web-scene":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],d.prototype,"opacity",void 0);f.__decorate([g.property({type:l.ofType(S)})],
d.prototype,"variables",void 0);f.__decorate([g.property({type:l.ofType(C)})],d.prototype,"volumes",void 0);f.__decorate([g.property({type:T})],d.prototype,"index",void 0);f.__decorate([g.property({type:Number,json:{name:"layerDefinition.minScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],d.prototype,"minScale",void 0);f.__decorate([g.property({type:Number,json:{name:"layerDefinition.maxScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],d.prototype,"maxScale",void 0);
f.__decorate([g.property({json:{read:!1},readOnly:!0})],d.prototype,"type",void 0);f.__decorate([g.property({readOnly:!0,json:{name:"serviceVersion"}})],d.prototype,"version",void 0);f.__decorate([y.reader("service","version")],d.prototype,"readVersion",null);f.__decorate([g.property({type:z})],d.prototype,"fullExtent",void 0);f.__decorate([y.reader("service","fullExtent",["fullExtent"])],d.prototype,"readFullExtent",null);f.__decorate([g.property({readOnly:!0,clonable:!1,json:{read:!1}})],d.prototype,
"voxelFields",null);f.__decorate([g.property(u.popupEnabled)],d.prototype,"popupEnabled",void 0);f.__decorate([g.property({readOnly:!0})],d.prototype,"defaultPopupTemplate",null);return d=f.__decorate([H.subclass("esri.layers.VoxelLayer")],d)});