// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.26/esri/copyright.txt for details.
//>>built
define("require ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Collection ../core/Error ../core/HandleOwner ../core/Handles ../core/loadAll ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/reactiveUtils ../core/sql ../core/urlUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/PropertyOrigin ./Layer ./mixins/APIKeyMixin ./mixins/ArcGISService ./mixins/BlendLayer ./mixins/CustomParametersMixin ./mixins/EditBusLayer ./mixins/FeatureLayerBase ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/featureLayerUtils ./support/fieldProperties ./support/fieldUtils ./support/Subtype ./support/SubtypeSublayer ./support/TimeInfo ./support/versionUtils ../rest/support/Query".split(" "),
function(C,f,g,v,q,e,D,E,w,F,y,z,G,A,k,t,da,H,I,x,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,l,X,Y,Z,u,aa,ba,ca){function B(h,n){return new q("layer:unsupported",`Layer (${h.title}, ${h.id}) of type '${h.declaredClass}' ${n}`,{layer:h})}t=X.defineFieldProperties();e=function(h){function n(...b){var a=h.call(this,...b)||this;a._handles=new D;a._sublayersCollectionChanged=!1;a._sublayerLookup=new Map;a.fields=null;a.fieldsIndex=null;a.outFields=null;a.subtypes=null;a.sublayers=new (v.ofType(u));a.timeInfo=null;a.title=
"Layer";a.type="subtype-group";a.addHandles(z.watch(()=>a.sublayers,(c,m)=>a._handleSublayersChange(c,m),z.sync));return a}f._inheritsLoose(n,h);var d=n.prototype;d.destroy=function(){this.source?.destroy();this._handles=w.destroyMaybe(this._handles)};d.normalizeCtorArgs=function(b,a){return"string"===typeof b?{url:b,...a}:b};d.load=function(b){var a=this;const c=w.isSome(b)?b.signal:null,m=this.loadFromPortal({supportedTypes:["Feature Service"]},b).catch(y.throwIfAbortError).then(f._asyncToGenerator(function*(){if(!a.url)throw new q("subtype-grouplayer:missing-url-or-source",
"SubtypeGroupLayer must be created with either a url or a portal item");if(null==a.layerId)throw new q("subtype-grouplayer:missing-layerid","layerId is required for a SubtypeGroupLayer created with url");return a._initLayerProperties(yield a.createGraphicsSource(c))})).then(()=>this._setUserPrivileges(this.serviceItemId,b)).then(()=>l.ensureLayerCredential(this,b));this.addResolvingPromise(m);return Promise.resolve(this)};d.readTitleFromService=function(b,{name:a}){return this.url?V.titleFromUrlAndName(this.url,
a):a};d.addAttachment=function(){var b=f._asyncToGenerator(function*(a,c){return l.addAttachment(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.updateAttachment=function(){var b=f._asyncToGenerator(function*(a,c,m){return l.updateAttachment(this,a,c,m,"SubtypeGroupLayer")});return function(a,c,m){return b.apply(this,arguments)}}();d.applyEdits=function(){var b=f._asyncToGenerator(function*(a,c){return l.applyEdits(this,a,c)});return function(a,c){return b.apply(this,
arguments)}}();d.on=function(b,a){return h.prototype.on.call(this,b,a)};d.createGraphicsSource=function(){var b=f._asyncToGenerator(function*(a){const {default:c}=yield y.whenOrAbort(new Promise((m,p)=>C(["./graphics/sources/FeatureLayerSource"],r=>m(Object.freeze(Object.defineProperty({__proto__:null,default:r},Symbol.toStringTag,{value:"Module"}))),p)),a);return(new c({layer:this})).load({signal:a})});return function(a){return b.apply(this,arguments)}}();d.createQuery=function(){const b=l.createQuery(this),
a=this.sublayers.map(c=>c.subtypeCode);b.where=G.sqlAnd(`${this.subtypeField} IN (${a.join(",")})`,this.definitionExpression);return b};d.deleteAttachments=function(){var b=f._asyncToGenerator(function*(a,c){return l.deleteAttachments(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.fetchRecomputedExtents=function(){var b=f._asyncToGenerator(function*(a){return l.fetchRecomputedExtents(this,a,"SubtypeGroupLayer")});return function(a){return b.apply(this,arguments)}}();
d.getFieldDomain=function(b,a){return this._getLayerDomain(b)};d.getField=function(b){return this.fieldsIndex.get(b)};d.findSublayerForFeature=function(b){const a=this.fieldsIndex.get(this.subtypeField);return this._sublayerLookup.get(b.attributes[a.name])};d.loadAll=function(){return E.loadAll(this,b=>{b(this.sublayers)})};d.queryAttachments=function(){var b=f._asyncToGenerator(function*(a,c){return l.queryAttachments(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();
d.queryFeatures=function(){var b=f._asyncToGenerator(function*(a,c){const m=yield this.load();a=ca.from(a)??m.createQuery();const p=w.unwrapOr(a.outFields,[]);p.includes(this.subtypeField)||(p.push(this.subtypeField),a.outFields=p);c=yield m.source.queryFeatures(a,c);if(c?.features)for(const r of c.features)r.layer=r.sourceLayer=this.findSublayerForFeature(r);return c});return function(a,c){return b.apply(this,arguments)}}();d.queryObjectIds=function(){var b=f._asyncToGenerator(function*(a,c){return l.queryObjectIds(this,
a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.queryFeatureCount=function(){var b=f._asyncToGenerator(function*(a,c){return l.queryFeatureCount(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.queryExtent=function(){var b=f._asyncToGenerator(function*(a,c){return l.queryExtent(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.queryRelatedFeatures=function(){var b=f._asyncToGenerator(function*(a,
c){return l.queryRelatedFeatures(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.queryRelatedFeaturesCount=function(){var b=f._asyncToGenerator(function*(a,c){return l.queryRelatedFeaturesCount(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.write=function(b,a){const {origin:c,layerContainerType:m,messages:p}=a;if(this.isTable){if("web-scene"===c||"web-map"===c&&"tables"!==m)return p?.push(B(this,"using a table source cannot be written to web scenes and web maps")),
null}else if(this.loaded&&"web-map"===c&&"tables"===m)return p?.push(B(this,"using a non-table source cannot be written to tables in web maps")),null;return this.sublayers?.length?h.prototype.write.call(this,b,a):(p?.push(new q("web-document-write:invalid-property",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' has invalid value for 'sublayers' property. 'sublayers' collection should contain at least one sublayer`,{layer:this})),null)};d.serviceSupportsSpatialReference=function(b){return this.loaded?
ba.serviceSupportsSpatialReference(this,b):!1};d._getLayerDomain=function(b){return(b=this.fieldsIndex.get(b))?b.domain:null};d._initLayerProperties=function(){var b=f._asyncToGenerator(function*(a){this._set("source",a);({sourceJSON:a}=a);a&&(this.sourceJSON=a,this.read(a,{origin:"service",url:this.parsedUrl}));if(this.isTable)throw new q("subtype-grouplayer:unsupported-source","SubtypeGroupLayer cannot be created using a layer with table source");if(!this.subtypes?.length)throw new q("subtype-grouplayer:missing-subtypes",
"SubtypeGroupLayer must be created using a layer with subtypes");this._verifyFields();Y.fixTimeInfoFields(this.timeInfo,this.fieldsIndex)});return function(a){return b.apply(this,arguments)}}();d.hasDataChanged=function(){var b=f._asyncToGenerator(function*(){return l.hasDataChanged(this)});return function(){return b.apply(this,arguments)}}();d._verifyFields=function(){const b=this.parsedUrl?.path??"undefined";this.objectIdField||console.log("SubtypeGroupLayer: 'objectIdField' property is not defined (url: "+
b+")");this.isTable||-1!==b.search(/\/FeatureServer\//i)||this.fields?.some(a=>"geometry"===a.type)||console.log("SubtypeGroupLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+b+")")};d._handleSublayersChange=function(b,a){a&&(a.forEach(c=>{c.parent=null}),this.handles.remove("sublayers-owner"),this._sublayerLookup.clear());b&&(b.forEach(c=>{c.parent=this;this._sublayerLookup.set(c.subtypeCode,c)}),
this._sublayersCollectionChanged=!1,this.handles.add([b.on("after-add",({item:c})=>{c.parent=this;this._sublayerLookup.set(c.subtypeCode,c)}),b.on("after-remove",({item:c})=>{c.parent=null;this._sublayerLookup.delete(c.subtypeCode)}),b.on("after-changes",()=>{this._sublayersCollectionChanged=!0})],"sublayers-owner"))};f._createClass(n,[{key:"createQueryVersion",get:function(){this.commitProperty("definitionExpression");this.commitProperty("timeExtent");this.commitProperty("timeOffset");this.commitProperty("geometryType");
this.commitProperty("gdbVersion");this.commitProperty("historicMoment");this.commitProperty("returnZ");this.commitProperty("capabilities");this.commitProperty("returnM");return(this._get("createQueryVersion")??0)+1}},{key:"editingEnabled",get:function(){return this.loaded&&null!=this.capabilities&&this.capabilities.operations.supportsEditing&&this.userHasEditingPrivileges}},{key:"effectiveEditingEnabled",get:function(){return l.computeEffectiveEditingEnabled(this)}},{key:"parsedUrl",get:function(){const b=
A.urlToObject(this.url);null!=b&&null!=this.layerId&&(b.path=A.join(b.path,this.layerId.toString()));return b}},{key:"source",set:function(b){this._get("source")!==b&&this._set("source",b)}}]);return n}(P.FeatureLayerBase(O.EditBusLayer(M.BlendLayer(U.TemporalLayer(T.ScaleRangeLayer(S.RefreshableLayer(L.ArcGISService(Q.OperationalLayer(R.PortalLayer(F.MultiOriginJSONMixin(N.CustomParametersMixin(K.APIKeyMixin(e.HandleOwnerMixin(J))))))))))))));g.__decorate([k.property({readOnly:!0})],e.prototype,
"createQueryVersion",null);g.__decorate([k.property({readOnly:!0})],e.prototype,"editingEnabled",null);g.__decorate([k.property({readOnly:!0})],e.prototype,"effectiveEditingEnabled",null);g.__decorate([k.property({...t.fields,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],e.prototype,"fields",void 0);g.__decorate([k.property(t.fieldsIndex)],e.prototype,"fieldsIndex",void 0);g.__decorate([k.property(W.id)],e.prototype,"id",void 0);g.__decorate([k.property({type:["show","hide","hide-children"]})],
e.prototype,"listMode",void 0);g.__decorate([k.property({value:"SubtypeGroupLayer",type:["SubtypeGroupLayer"]})],e.prototype,"operationalLayerType",void 0);g.__decorate([k.property(t.outFields)],e.prototype,"outFields",void 0);g.__decorate([k.property({readOnly:!0})],e.prototype,"parsedUrl",null);g.__decorate([k.property()],e.prototype,"source",null);g.__decorate([k.property({type:[Z],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],e.prototype,"subtypes",void 0);g.__decorate([k.property({type:v.ofType(u),
json:{origins:{service:{read:{source:"subtypes",reader:(h,n,d)=>{h=h.map(({code:b})=>{b=new u({subtypeCode:b});b.read(n,d);return b});return new (v.ofType(u))(h)}}}},name:"layers",write:{overridePolicy(h,n,d){n=this.originOf("sublayers");const b=x.OriginId.PORTAL_ITEM;let a=!0;x.nameToId(n)===b&&x.nameToId(d.origin)>b&&(h=h.some(c=>c.hasUserOverrides()),a=this._sublayersCollectionChanged||h);return{enabled:a,ignoreOrigin:!0}}}}})],e.prototype,"sublayers",void 0);g.__decorate([k.property({type:aa})],
e.prototype,"timeInfo",void 0);g.__decorate([k.property({json:{origins:{"portal-item":{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}}}})],e.prototype,"title",void 0);g.__decorate([H.reader("service","title",["name"])],e.prototype,"readTitleFromService",null);g.__decorate([k.property({json:{read:!1}})],e.prototype,"type",void 0);return e=g.__decorate([I.subclass("esri.layers.SubtypeGroupLayer")],e)});